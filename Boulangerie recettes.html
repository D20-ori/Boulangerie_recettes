<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚜️ Boulangerie Artisanale Française - Gestion des Recettes</title>
    <style>
        /* Variables CSS pour le thème Bannette */
        :root {
            --bg-primary: #F5F5DC;
            --accent-brown: #8B4513;
            --cream-white: #FFFACD;
            --olive-green: #556B2F;
            --text-dark: #3E2723;
            --border-radius: 8px;
            --shadow: 0 2px 8px rgba(139, 69, 19, 0.2);
        }

        /* Variables CSS pour le thème sombre */
        [data-theme="dark"] {
            --bg-primary: #2B2B2B;
            --accent-brown: #CD853F;
            --cream-white: #3E3E3E;
            --olive-green: #90C695;
            --text-dark: #E8E8E8;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] body {
            background: linear-gradient(135deg, 
                #2C2416 0%, 
                #3E3325 25%, 
                #4A3728 50%, 
                #563D2A 75%, 
                #4D3319 100%);
        }

        [data-theme="dark"] body::before {
            background: linear-gradient(
                45deg,
                rgba(205, 133, 63, 0.1) 0%,
                rgba(160, 82, 45, 0.12) 25%,
                rgba(139, 69, 19, 0.15) 50%,
                rgba(101, 67, 33, 0.1) 75%,
                rgba(43, 43, 43, 0.05) 100%
            );
            opacity: 0.4;
        }

        /* Styles hover spécifiques au mode sombre */
        [data-theme="dark"] .tab-button:hover {
            background: rgba(205, 133, 63, 0.2);
            box-shadow: 0 4px 12px rgba(205, 133, 63, 0.3);
        }

        [data-theme="dark"] .family-tab:hover,
        [data-theme="dark"] .custom-tab:hover,
        [data-theme="dark"] .right-tab:hover {
            background: rgba(205, 133, 63, 0.2);
            border-color: #DAA520;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #F5E6D3 0%, #E8D5B7 25%, #F0E68C 50%, #D2B48C 75%, #DEB887 100%);
            color: #3E2723;
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                45deg,
                rgba(139, 69, 19, 0.05) 0%,
                rgba(160, 82, 45, 0.08) 25%,
                rgba(210, 180, 140, 0.1) 50%,
                rgba(222, 184, 135, 0.05) 75%,
                rgba(245, 245, 220, 0.03) 100%
            );
            z-index: -1;
        }

        /* Header et Navigation */
        .header {
            background: linear-gradient(135deg, var(--accent-brown), #A0522D);
            padding: 1.5rem 0;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 100%;
            margin: 0;
            padding: 0 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
        }

        .logo {
            color: var(--cream-white);
            font-size: 5rem;
            font-weight: bold;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.4);
            text-align: center;
            margin-bottom: 1rem;
            line-height: 1.1;
        }



        .dark-mode-toggle {
            background: var(--cream-white);
            border: 2px solid var(--accent-brown);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .dark-mode-toggle:hover {
            background: var(--olive-green);
            color: var(--cream-white);
            border-color: var(--olive-green);
        }

        .navigation-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 0;
            padding: 0 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            margin: 0 1rem;
        }

        .left-tabs {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
            flex-shrink: 0;
            padding: 0.5rem;
            border-right: 2px solid rgba(255, 255, 255, 0.2);
        }

        .family-tabs {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            justify-content: center;
            flex: 1;
            min-width: 0;
            padding: 0.5rem;
            flex-wrap: wrap;
        }

        .right-tabs {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            align-items: center;
            flex-shrink: 0;
            padding: 0.5rem;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }

        .right-tabs-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .tab-button {
            border: 2px solid var(--accent-brown);
            padding: 0.6rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            background: var(--cream-white);
            color: var(--accent-brown);
            font-size: 0.85rem;
        }

        .tab-button:hover {
            background: rgba(139, 69, 19, 0.1);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
        }

        .tab-button.active {
            background: var(--accent-brown);
            color: var(--cream-white);
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.4);
        }

        /* Boutons principaux Accueil/Levains */
        .main-tab {
            font-size: 0.9rem;
            padding: 0.7rem 1rem;
            background: var(--olive-green);
            color: var(--cream-white);
            border-color: var(--olive-green);
            font-weight: bold;
            position: relative;
            overflow: hidden;
        }

        .main-tab:hover {
            background: #6B8E2F;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(85, 107, 47, 0.3);
        }

        .main-tab.active {
            background: #4A5D23;
            color: var(--cream-white);
            box-shadow: 0 3px 10px rgba(85, 107, 47, 0.5);
        }

        /* Animation de bulles pour le bouton levain */
        .main-tab[data-tab="levains"]::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            pointer-events: none;
            z-index: 1;
        }

        .main-tab[data-tab="levains"]::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            pointer-events: none;
            z-index: 1;
        }

        /* Bulles animées */
        .bubble {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
            animation: bubbleRise 3s linear infinite;
        }

        @keyframes bubbleRise {
            0% {
                transform: translateY(100%) scale(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100%) scale(1);
                opacity: 0;
            }
        }

        /* Animation de bulles pour levain selon l'âge - Supprimée pour éviter la double animation */

        /* Amélioration de l'animation des bulles */
        .bubble {
            position: absolute;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.4) 70%, rgba(255, 255, 255, 0.1) 100%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 2;
            animation: bubbleRise 3s linear infinite;
            box-shadow: 0 0 4px rgba(255, 255, 255, 0.6);
        }

        /* Bulles spéciales pour les vignettes de levain (plus visibles) */
        .levain-card .bubble {
            background: radial-gradient(circle, rgba(85, 107, 47, 0.8) 0%, rgba(85, 107, 47, 0.4) 70%, rgba(85, 107, 47, 0.1) 100%);
            box-shadow: 0 0 4px rgba(85, 107, 47, 0.6);
        }

        @keyframes bubbleRise {
            0% {
                transform: translateY(100%) scale(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
                transform: translateY(90%) scale(0.3) rotate(0deg);
            }
            50% {
                opacity: 0.8;
                transform: translateY(50%) scale(0.8) rotate(180deg);
            }
            90% {
                opacity: 0.6;
                transform: translateY(10%) scale(1) rotate(360deg);
            }
            100% {
                transform: translateY(-100%) scale(1.2) rotate(720deg);
                opacity: 0;
            }
        }

        /* Effet de brillance sur les bulles */
        .bubble::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 30%;
            height: 30%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
            border-radius: 50%;
            pointer-events: none;
        }

        /* Effet de brillance pour les bulles des vignettes de levain */
        .levain-card .bubble::after {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.5) 50%, transparent 100%);
        }

        /* Boutons familles - les plus larges */
        .family-tab {
            background: var(--cream-white);
            color: var(--accent-brown);
            border-color: var(--accent-brown);
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            min-height: 44px;
            line-height: 1.2;
        }

        .family-tab:hover {
            background: rgba(139, 69, 19, 0.1);
            border-color: #A0522D;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
        }

        .family-tab.active {
            background: var(--accent-brown);
            color: var(--cream-white);
            border-color: var(--accent-brown);
            box-shadow: 0 3px 10px rgba(139, 69, 19, 0.4);
        }

        /* Bouton conseils */
        .support-tab {
            background: #4A90E2;
            color: white;
            border-color: #4A90E2;
            padding: 0.6rem 1rem;
            font-size: 0.85rem;
        }

        .support-tab:hover {
            background: #357ABD;
            border-color: #357ABD;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
        }

        .support-tab.active {
            background: #2C5F91;
            color: white;
            border-color: #2C5F91;
            box-shadow: 0 3px 10px rgba(74, 144, 226, 0.5);
        }

        /* Bouton sauvegarde - plus gros */
        .save-tab {
            background: var(--olive-green);
            color: var(--cream-white);
            border-color: var(--olive-green);
            padding: 0.7rem 1.2rem;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .save-tab:hover {
            background: #6B8E2F;
            border-color: #6B8E2F;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(85, 107, 47, 0.3);
        }

        .save-tab.active {
            background: #4A5D23;
            color: var(--cream-white);
            border-color: #4A5D23;
            box-shadow: 0 3px 10px rgba(85, 107, 47, 0.5);
        }



        /* Boutons de droite */
        .right-tab {
            background: var(--cream-white);
            border: 2px solid var(--accent-brown);
            padding: 0.6rem 0.9rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            color: var(--accent-brown);
            transition: all 0.3s ease;
            font-size: 0.8rem;
            white-space: nowrap;
        }

        .right-tab:hover {
            background: rgba(139, 69, 19, 0.1);
            border-color: #A0522D;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
        }

        .right-tab.active {
            background: var(--accent-brown);
            color: var(--cream-white);
            border-color: var(--accent-brown);
            box-shadow: 0 3px 10px rgba(139, 69, 19, 0.4);
        }

        .custom-tab {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            position: relative;
            background: var(--cream-white);
            color: var(--accent-brown);
            border-color: var(--accent-brown);
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            font-weight: bold;
            min-height: 44px;
            line-height: 1.2;
        }

        .custom-tab:hover {
            background: rgba(139, 69, 19, 0.1);
            border-color: #A0522D;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 69, 19, 0.2);
        }

        /* Bouton BETA - Couleur fleur de lis */
        .beta-container {
            display: flex;
            align-items: center;
            flex-shrink: 0;
            padding: 0.5rem;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
            border-right: 2px solid rgba(255, 255, 255, 0.2);
        }

        .beta-btn {
            background: #D2691E;
            color: white;
            border: 3px solid #D2691E;
            padding: 0.6rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(210, 105, 30, 0.3);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
        }

        .beta-btn:hover {
            background: #B8860B;
            border-color: #B8860B;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(210, 105, 30, 0.4);
        }

        .beta-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(210, 105, 30, 0.3);
        }

        .custom-tab.active {
            background: var(--accent-brown);
            color: var(--cream-white);
            border-color: var(--accent-brown);
            box-shadow: 0 3px 10px rgba(139, 69, 19, 0.4);
        }





        /* Responsive ajusté */
        @media (max-width: 1200px) {
            .navigation-container {
                gap: 1.5rem;
            }
            
            .family-tabs {
                gap: 0.6rem;
            }

            .tab-button {
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }

            .main-tab {
                padding: 0.6rem 0.9rem;
                font-size: 0.85rem;
            }

            .family-tab {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
                min-height: 40px;
            }



            .custom-tab {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
                min-height: 40px;
            }
        }

        @media (max-width: 1000px) {
            .logo {
                font-size: 4rem;
            }

            .header-top {
                gap: 0.7rem;
            }

            .navigation-container {
                gap: 0.8rem;
            }

            .tab-button {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }

            .main-tab {
                padding: 0.5rem 0.8rem;
                font-size: 0.85rem;
            }

            .utility-btn {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }

            .custom-tab {
                padding: 0.5rem 0.8rem;
                font-size: 0.85rem;
                min-height: 36px;
            }
        }

        @media (max-width: 800px) {
            .header-content {
                gap: 1rem;
                padding: 1rem;
            }

            .header-top {
                flex-direction: column;
                gap: 0.6rem;
            }

            .navigation-container {
                flex-direction: column;
                gap: 0.8rem;
                width: 100%;
            }

            .left-tabs, .family-tabs, .right-tabs {
                justify-content: center;
                flex-wrap: wrap;
            }



            .custom-tab {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
                min-height: 32px;
            }

            .family-tabs {
                gap: 0.5rem;
            }

            .right-tabs {
                gap: 0.3rem;
            }

            .right-tabs-row {
                gap: 0.4rem;
            }

            .dark-mode-toggle {
                width: 35px;
                height: 35px;
                font-size: 1rem;
            }
        }

        @media (max-width: 600px) {
            .logo {
                font-size: 3rem;
            }

            .header-top {
                gap: 0.5rem;
            }

            .tab-button {
                padding: 0.4rem 0.5rem;
                font-size: 0.7rem;
            }

            .main-tab {
                padding: 0.5rem 0.7rem;
                font-size: 0.8rem;
            }
        }

        /* Container principal */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Pages content */
        .page-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Styles pour page Accueil */
        .stats-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--cream-white);
            border: 2px solid var(--accent-brown);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(139, 69, 19, 0.3);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-brown);
            margin-bottom: 0.3rem;
        }

        .stat-label {
            color: var(--text-dark);
            font-size: 1rem;
        }

        .images-gallery {
            margin: 3rem 0;
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }



        .section-title {
            color: var(--accent-brown);
            font-size: 1.8rem;
            font-weight: bold;
        }



        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .gallery-item {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .gallery-item:hover {
            transform: scale(1.05);
        }

        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .gallery-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 1rem;
            font-weight: bold;
        }

        .gallery-delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: rgba(211, 47, 47, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
            opacity: 0;
        }

        .gallery-item:hover .gallery-delete-btn {
            opacity: 1;
        }

        .gallery-delete-btn:hover {
            background: #B71C1C;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(211, 47, 47, 0.4);
        }

        /* Tableau top recettes */
        .top-recipes-table {
            background: var(--cream-white);
            border: 2px solid var(--accent-brown);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .top-recipes-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .top-recipes-table th {
            background: var(--accent-brown);
            color: var(--cream-white);
            padding: 1rem;
            text-align: left;
            font-weight: bold;
        }

        .top-recipes-table td {
            padding: 1rem;
            border-bottom: 1px solid #DDD;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .top-recipes-table tr:hover td {
            background: #F0F0F0;
        }

        /* Styles pour vignettes recettes */
        .recipes-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .sort-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .sort-select {
            padding: 0.5rem;
            border: 2px solid var(--accent-brown);
            border-radius: var(--border-radius);
            font-family: inherit;
            background: var(--cream-white);
        }

        .recipes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .recipe-card {
            background: var(--cream-white);
            border: 2px solid var(--accent-brown);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            position: relative;
        }

        .recipe-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(139, 69, 19, 0.3);
        }



        .recipe-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-brown);
            margin-bottom: 1rem;
        }

        .recipe-ingredients {
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .recipe-rating {
            display: flex;
            gap: 0.2rem;
            margin-bottom: 0.5rem;
        }

        .star {
            color: #FFD700;
            font-size: 1.2rem;
        }

        .star.empty {
            color: #DDD;
        }

        .recipe-comment {
            color: #666;
            font-style: italic;
            font-size: 0.9rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
            max-height: 2.8em; /* 2 lignes × 1.4 line-height */
            white-space: pre-line; /* Respecter les sauts de lignes */
        }

        /* Indicateurs de statut de recette */
        .recipe-status-new {
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: #FF0000;
            border-radius: 0 0 0 100%;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
            padding: 8px 12px 0 0;
            box-shadow: 0 4px 12px rgba(255, 0, 0, 0.6);
            z-index: 10;
            font-size: 1.1rem;
            font-weight: 900;
            color: white;
            text-transform: uppercase;
            animation: cornerPulse 2s ease-in-out infinite;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        @keyframes cornerPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .recipe-status-slider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--cream-white);
            border-radius: var(--border-radius);
            border: 1px solid var(--accent-brown);
        }

        .status-slider {
            flex: 1;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            outline: none;
            cursor: pointer;
            border: 2px solid var(--accent-brown);
        }

        .status-slider::-webkit-slider-thumb {
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-brown);
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            border: 3px solid white;
        }

        .status-slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-brown);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
        }

        .status-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--accent-brown);
            font-weight: bold;
        }

        .status-value {
            font-weight: bold;
            color: var(--accent-brown);
            margin-left: 1rem;
        }

        /* Styles pour levains */
        .levain-card {
            background: var(--cream-white);
            border: 2px solid var(--olive-green);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
            position: relative;
        }

        .levain-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(85, 107, 47, 0.3);
        }

        .levain-avatar {
            transition: transform 0.3s ease;
        }

        .levain-card:hover .levain-avatar {
            transform: scale(1.1);
        }

        .levain-name {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-brown);
            margin-bottom: 1rem;
        }

        .levain-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .time-since-refresh {
            font-weight: bold;
        }

        .time-since-refresh.warning {
            color: #FF6B35;
        }

        .levain-age {
            color: var(--olive-green);
            font-weight: bold;
        }



        /* Modales */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 15000;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--cream-white);
            border: 3px solid var(--accent-brown);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-content.large {
            max-width: 1200px;
            max-height: 100vh;
            height: 80vh;
            width: 95vw;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--accent-brown);
            padding-bottom: 1rem;
        }

        .modal-title {
            color: var(--accent-brown);
            font-size: 1.5rem;
            font-weight: bold;
        }



        /* Formulaires */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--accent-brown);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid var(--accent-brown);
            border-radius: var(--border-radius);
            font-family: inherit;
            font-size: 1rem;
            background: white;
        }

        /* Style spécifique pour les champs datetime-local */
        input[type="datetime-local"].form-input {
            color: var(--text-dark);
        }

        input[type="datetime-local"].form-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: invert(0.5);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--olive-green);
            box-shadow: 0 0 0 3px rgba(85, 107, 47, 0.2);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Boutons - Styles uniformisés */
        .btn, .upload-btn, .refresh-btn, .chat-send-btn {
            background: var(--olive-green);
            color: var(--cream-white);
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            text-align: center;
            min-height: 44px;
            box-shadow: 0 2px 4px rgba(85, 107, 47, 0.2);
        }

        .btn:hover, .upload-btn:hover, .refresh-btn:hover, .chat-send-btn:hover {
            background: #6B8E23;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(85, 107, 47, 0.3);
        }

        .btn:active, .upload-btn:active, .refresh-btn:active, .chat-send-btn:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(85, 107, 47, 0.2);
        }

        .btn-secondary {
            background: var(--cream-white);
            color: var(--accent-brown);
            border: 2px solid var(--accent-brown);
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            text-align: center;
            min-height: 44px;
            box-shadow: 0 2px 4px rgba(139, 69, 19, 0.1);
        }

        .btn-secondary:hover {
            background: var(--accent-brown);
            color: var(--cream-white);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(139, 69, 19, 0.2);
        }

        .btn-secondary:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(139, 69, 19, 0.1);
        }

        .btn-danger {
            background: #D32F2F;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            text-align: center;
            min-height: 44px;
            box-shadow: 0 2px 4px rgba(211, 47, 47, 0.2);
        }

        .btn-danger:hover {
            background: #B71C1C;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(211, 47, 47, 0.3);
        }

        .btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 1px 2px rgba(211, 47, 47, 0.2);
        }

        /* Bouton d'ajout d'image */
        .add-image-btn {
            background: var(--accent-brown);
            color: var(--cream-white);
            border: none;
            padding: 0.3rem 0.6rem;
            border-radius: 50%;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            text-align: center;
            width: 32px;
            height: 32px;
            margin-left: 0.5rem;
            box-shadow: 0 2px 4px rgba(139, 69, 19, 0.2);
            vertical-align: middle;
        }

        .add-image-btn:hover {
            background: #A0522D;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(139, 69, 19, 0.3);
        }

        .add-image-btn:active {
            transform: scale(1.05);
            box-shadow: 0 1px 2px rgba(139, 69, 19, 0.2);
        }

        /* Bouton fermer modal unifié */
        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--accent-brown);
            padding: 0.5rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--accent-brown);
            color: var(--cream-white);
            transform: scale(1.1);
        }

        /* Boutons compacts pour les petits espaces */
        .btn-compact, .hierarchy-item button {
            background: var(--cream-white);
            border: 1px solid var(--accent-brown);
            color: var(--accent-brown);
            border-radius: 4px;
            padding: 0.4rem 0.8rem;
            margin: 0.1rem;
            cursor: pointer;
            font-size: 0.85rem;
            font-family: inherit;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 32px;
        }

        .btn-compact:hover, .hierarchy-item button:hover {
            background: var(--accent-brown);
            color: var(--cream-white);
            transform: translateY(-1px);
        }

        .btn-compact:disabled, .hierarchy-item button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Boutons spéciaux */
        .chat-send-btn {
            border-radius: 50%;
            width: 44px;
            height: 44px;
            padding: 0;
            margin-left: 0.5rem;
        }

        .add-tab-btn {
            background: var(--olive-green);
            color: var(--cream-white);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 0.5rem;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(85, 107, 47, 0.2);
        }

        .add-tab-btn:hover {
            background: #6B8E23;
            transform: translateY(-1px) scale(1.1);
            box-shadow: 0 4px 8px rgba(85, 107, 47, 0.3);
        }

        /* Boutons de suppression dans les onglets personnalisés */
        .custom-tab .remove-tab-btn {
            background: none;
            border: none;
            color: #b71c1c;
            font-size: 1rem;
            margin-left: 0.3rem;
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 50%;
            transition: all 0.2s ease;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .custom-tab .remove-tab-btn:hover {
            background: #ffeaea;
            transform: scale(1.2);
        }

        /* États désactivés pour tous les boutons */
        .btn:disabled, .btn-secondary:disabled, .btn-danger:disabled, 
        .upload-btn:disabled, .refresh-btn:disabled, .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Groupes de boutons */
        .btn-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn-group .btn, .btn-group .btn-secondary, .btn-group .btn-danger {
            margin: 0;
        }

        /* Responsive pour boutons */
        @media (max-width: 768px) {
            .btn, .btn-secondary, .btn-danger, .upload-btn, .refresh-btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                min-height: 40px;
            }
            
            .btn-group {
                justify-content: center;
            }
            
            .chat-send-btn {
                width: 40px;
                height: 40px;
            }
        }

        @media (max-width: 480px) {
            .btn, .btn-secondary, .btn-danger, .upload-btn, .refresh-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.85rem;
                min-height: 36px;
            }
            
            .btn-group {
                flex-direction: column;
                width: 100%;
            }
            
            .btn-group .btn, .btn-group .btn-secondary, .btn-group .btn-danger {
                width: 100%;
            }
        }

        /* Animations Tamagotchi pour levain */
        .tamagotchi-container {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #FFF8DC, #F0E68C);
            border-radius: var(--border-radius);
            margin: 2rem 0;
        }

        .levain-avatar {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--olive-green), #90C695);
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .mixing-animation {
            animation: mixing 1s ease-in-out;
        }

        @keyframes mixing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        /* Chat bot flottant */
        .chat-bubble {
            position: fixed;
            bottom: 30px;
            left: 30px;
            z-index: 1000;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }

        .chat-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(139, 69, 19, 0.3);
        }

        .chat-bubble-content {
            background: linear-gradient(135deg, var(--accent-brown), #A0522D);
            color: var(--cream-white);
            padding: 1rem 1.5rem;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3);
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-weight: bold;
            font-size: 0.9rem;
            border: 2px solid var(--cream-white);
        }

        .chat-bubble-icon {
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Styles spécifiques pour le bouton chronomètre */
        .chronometre-style {
            background: linear-gradient(135deg, #FF6B35, #F7931E) !important;
            border-radius: 60px !important;
            padding: 1.2rem 2rem !important;
            border: 3px solid #FFD700 !important;
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4) !important;
            position: relative;
            overflow: hidden;
        }

        .chronometre-style::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 215, 0, 0.3), transparent);
            animation: rotate 4s linear infinite;
            z-index: -1;
        }

        .chronometre-style .chat-bubble-icon {
            font-size: 1.5rem !important;
            animation: tick 1s ease-in-out infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes tick {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        #tempsBubble:hover .chronometre-style {
            transform: scale(1.15);
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.6) !important;
        }

        /* Chat bot modal */
        .chat-modal {
            position: fixed;
            bottom: 100px;
            left: 30px;
            z-index: 1001;
            background: var(--cream-white);
            border: 3px solid var(--accent-brown);
            border-radius: var(--border-radius);
            width: 400px;
            max-height: 500px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            display: none;
            animation: slideIn 0.3s ease;
        }

        .chat-modal.active {
            display: block;
        }

        @keyframes slideIn {
            from { 
                opacity: 0; 
                transform: translateY(20px) scale(0.9); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1); 
            }
        }

        .chat-header {
            background: var(--accent-brown);
            color: var(--cream-white);
            padding: 1rem;
            font-weight: bold;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header .close-chat {
            background: none;
            border: none;
            color: var(--cream-white);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .chat-header .close-chat:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .chat-message {
            max-width: 80%;
            padding: 0.8rem 1rem;
            border-radius: 20px;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: var(--olive-green);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .chat-message.bot {
            background: #F0F0F0;
            color: var(--text-dark);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chat-input-container {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #DDD;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 2px solid var(--accent-brown);
            border-radius: 20px;
            margin-right: 1rem;
            font-family: inherit;
        }

        /* Responsive pour le chat */
        @media (max-width: 768px) {
            .chat-modal {
                width: 90vw;
                left: 5vw;
                bottom: 80px;
            }
            
            .chat-bubble {
                bottom: 20px;
                left: 20px;
            }
            
            .chat-bubble-content {
                padding: 0.8rem 1.2rem;
                font-size: 0.8rem;
            }
            
            #calculsBubble {
                right: 20px;
            }
        }



        /* Utilitaires */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mb-2 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 1rem; }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { align-items: center; }
        .gap-1 { gap: 1rem; }

        .accent-export {
            background: #f0e6d2;
            color: var(--accent-brown);
            border: 2px solid var(--accent-brown);
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(139, 69, 19, 0.08);
            transition: background 0.3s;
        }
        .accent-export:hover {
            background: var(--accent-brown);
            color: var(--cream-white);
        }
        .custom-tab {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            position: relative;
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .custom-tab .remove-tab-btn {
            background: none;
            border: none;
            color: #b71c1c;
            font-size: 1.1rem;
            margin-left: 0.2rem;
            cursor: pointer;
            padding: 0 0.2rem;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .custom-tab .remove-tab-btn:hover {
            background: #ffeaea;
        }

        /* Styles pour l'autocomplétion des ingrédients */
        .ingredient-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--accent-brown);
            border-top: none;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .suggestion-item {
            padding: 0.8rem;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa !important;
            transform: translateX(2px);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .ingredient-row {
            position: relative;
        }

        .nav-tabs-row1, .nav-tabs-row2 {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.2rem;
            flex-wrap: wrap;
        }
        .nav-tabs-row1 {
            justify-content: flex-start;
        }
        .nav-tabs-row2 {
            justify-content: flex-start;
        }
        @media (max-width: 768px) {
            .nav-tabs-row1, .nav-tabs-row2 {
                flex-wrap: wrap;
                justify-content: center;
            }
        }

        /* Styles pour l'interface vocale */
        .audio-recording {
            background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            position: relative;
            overflow: hidden;
        }

        .audio-recording:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6);
        }

        .audio-recording.recording {
            background: linear-gradient(135deg, #FF0000, #FF4444);
            animation: pulseRecording 1.5s ease-in-out infinite;
        }

        @keyframes pulseRecording {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 0, 0, 0.4);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 6px 25px rgba(255, 0, 0, 0.6);
            }
        }

        /* Indicateur de volume */
        .volume-indicator {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--cream-white);
            border: 2px solid var(--accent-brown);
            border-radius: var(--border-radius);
        }

        .volume-bar {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .volume-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #66BB6A, #81C784);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 10px;
        }

        .volume-text {
            font-weight: bold;
            color: var(--accent-brown);
            min-width: 60px;
            text-align: center;
        }

        .volume-icon {
            font-size: 1.2rem;
            color: var(--accent-brown);
        }

        .audio-status {
            text-align: center;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: var(--border-radius);
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .audio-status.listening {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
            color: white;
            animation: pulseStatus 2s ease-in-out infinite;
        }

        .audio-status.processing {
            background: linear-gradient(135deg, #FF9800, #FFB74D);
            color: white;
        }

        .audio-status.error {
            background: linear-gradient(135deg, #F44336, #EF5350);
            color: white;
        }

        @keyframes pulseStatus {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .transcript-display {
            background: var(--cream-white);
            border: 2px solid var(--accent-brown);
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .ingredient-preview {
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
            border: 2px solid #2196F3;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
        }

        .ingredient-preview h4 {
            color: #1976D2;
            margin-bottom: 0.5rem;
        }

        .ingredient-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
            margin: 0.25rem 0;
            border-left: 3px solid #2196F3;
        }

        .ingredient-item .ingredient-name {
            font-weight: bold;
            color: var(--accent-brown);
        }

        .ingredient-item .ingredient-quantity {
            color: #666;
            font-size: 0.9rem;
        }

        .audio-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .audio-instructions {
            background: linear-gradient(135deg, #FFF3E0, #FFE0B2);
            border: 2px solid #FF9800;
            border-radius: var(--border-radius);
            padding: 1rem;
            margin: 1rem 0;
        }

        .audio-instructions h4 {
            color: #E65100;
            margin-bottom: 0.5rem;
        }

        .audio-instructions ul {
            margin: 0;
            padding-left: 1.5rem;
        }

        .audio-instructions li {
            margin-bottom: 0.3rem;
            color: #BF360C;
        }
    </style>
</head>
<body>
    <!-- Header avec navigation -->
    <div class="header">
        <div class="header-content">
            <!-- Titre centré -->
            <div class="header-top">
                <div></div> <!-- Espaceur gauche -->
                <div class="logo-section">
                    <div class="logo">⚜️ Boulangerie Artisanale Française 🥖</div>
                </div>
                <button class="dark-mode-toggle" id="darkModeToggle" title="Basculer le mode sombre">🌙</button>
            </div>
            
            <!-- Navigation principale en trois sections -->
            <div class="navigation-container">
                <!-- Section gauche : Accueil et Levains -->
                <div class="left-tabs">
                    <button class="tab-button main-tab" data-tab="accueil">🏠 Accueil</button>
                    <button class="tab-button main-tab" data-tab="levains">🧪 Levains</button>
                </div>
                
                <!-- Section centre : Familles de recettes -->
                <div class="family-tabs" id="familyTabsContainer">
                    <button class="tab-button family-tab" data-tab="pain">🥖 Pain</button>
                    <button class="tab-button family-tab" data-tab="pates">🍝 Pâtes</button>
                    <button class="tab-button family-tab" data-tab="viennoiseries">🥐 Viennoiseries</button>
                    <!-- Les onglets personnalisés seront insérés ici dynamiquement -->
                    <button class="add-tab-btn" id="addTabBtn" title="Ajouter un onglet personnalisé">+</button>
                </div>
                
                <!-- Bouton BETA - Collé à droite -->
                <div class="beta-container">
                    <button class="beta-btn" id="betaBtn" title="Fonctions BETA - Fonctionnalités expérimentales">BETA</button>
                </div>
                
                <!-- Section droite : Outils et paramètres -->
                <div class="right-tabs">
                    <div class="right-tabs-row">
                        <button class="tab-button save-tab" id="exportBtn">💾 Sauvegarde</button>
                        <button class="tab-button right-tab" id="importBtn">📤 Import</button>
                    </div>
                    <div class="right-tabs-row">
                        <button class="tab-button support-tab" data-tab="conseils">💡 Conseils</button>
                        <button class="tab-button right-tab" id="settingsBtn">⚙️ Paramètres</button>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- Container principal -->
    <div class="main-container">
        <!-- Page Accueil -->
        <div class="page-content active" id="page-accueil">
            <!-- Stats Section -->
            <div class="stats-section" id="statsSection">
                <!-- Les stats seront générées dynamiquement -->
            </div>

            <!-- Galerie d'images -->
            <div class="images-gallery">
                <div class="gallery-header">
                    <h2 class="section-title">
                        Galerie Photos
                        <button class="add-image-btn" id="uploadImageBtn" title="Ajouter des images">➕</button>
                    </h2>
                    <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                </div>
                <div class="gallery-grid" id="galleryGrid">
                    <!-- Images seront générées dynamiquement -->
                </div>
            </div>

            <!-- Top 5 recettes -->
            <div class="top-recipes-section">
                <h2 class="section-title mb-2">Top 5 Meilleures Recettes</h2>
                <div class="top-recipes-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Note</th>
                                <th>Aperçu Ingrédients</th>
                            </tr>
                        </thead>
                        <tbody id="topRecipesTableBody">
                            <!-- Contenu dynamique -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Pages Recettes (générées dynamiquement) -->
        <div class="page-content" id="page-pain">
            <div class="recipes-controls">
                <h2 class="section-title">Recettes Pain</h2>
                <div class="sort-controls">
                    <label>Trier par :</label>
                    <select class="sort-select" data-family="pain">
                        <option value="name">Nom</option>
                        <option value="rating">Note</option>
                        <option value="date">Date</option>
                        <option value="status">Statut</option>
                    </select>
                </div>
                <button class="btn" onclick="openAddRecipeModal('pain')">➕ Ajouter Recette</button>
                <button class="btn btn-secondary" onclick="openAudioRecipeModal('pain')" title="Saisir une recette par reconnaissance vocale">🎤 Recette Audio</button>
            </div>
            <div class="recipes-grid" id="recipes-pain">
                <!-- Recettes dynamiques -->
            </div>
        </div>

        <div class="page-content" id="page-pates">
            <div class="recipes-controls">
                <h2 class="section-title">Recettes Pâtes</h2>
                <div class="sort-controls">
                    <label>Trier par :</label>
                    <select class="sort-select" data-family="pates">
                        <option value="name">Nom</option>
                        <option value="rating">Note</option>
                        <option value="date">Date</option>
                        <option value="status">Statut</option>
                    </select>
                </div>
                <button class="btn" onclick="openAddRecipeModal('pates')">➕ Ajouter Recette</button>
                <button class="btn btn-secondary" onclick="openAudioRecipeModal('pates')" title="Saisir une recette par reconnaissance vocale">🎤 Recette Audio</button>
            </div>
            <div class="recipes-grid" id="recipes-pates">
                <!-- Recettes dynamiques -->
            </div>
        </div>

        <div class="page-content" id="page-viennoiseries">
            <div class="recipes-controls">
                <h2 class="section-title">Recettes Viennoiseries</h2>
                <div class="sort-controls">
                    <label>Trier par :</label>
                    <select class="sort-select" data-family="viennoiseries">
                        <option value="name">Nom</option>
                        <option value="rating">Note</option>
                        <option value="date">Date</option>
                        <option value="status">Statut</option>
                    </select>
                </div>
                <button class="btn" onclick="openAddRecipeModal('viennoiseries')">➕ Ajouter Recette</button>
                <button class="btn btn-secondary" onclick="openAudioRecipeModal('viennoiseries')" title="Saisir une recette par reconnaissance vocale">🎤 Recette Audio</button>
            </div>
            <div class="recipes-grid" id="recipes-viennoiseries">
                <!-- Recettes dynamiques -->
            </div>
        </div>

        <!-- Page Levains -->
        <div class="page-content" id="page-levains">
            <div class="recipes-controls">
                <h2 class="section-title">Gestion des Levains</h2>
                <button class="btn" onclick="openAddLevainModal()">➕ Ajouter Levain</button>
            </div>
            <div class="recipes-grid" id="levainsGrid">
                <!-- Levains dynamiques -->
            </div>
        </div>

        <!-- Page Conseils -->
        <div class="page-content" id="page-conseils">
            <h2 class="section-title">Conseils & Support</h2>
            
            <div class="mb-2">
                <h3>Conseils Pratiques</h3>
                <div style="padding: 1.5rem; background: var(--cream-white); border-radius: var(--border-radius); margin: 1rem 0; border: 2px solid var(--accent-brown);">
                    <h4 style="color: var(--accent-brown); font-size: 1.3rem; margin-bottom: 1.5rem; text-align: center;">🌾 Conseils indispensables pour réussir son pain maison</h4>
                    
                    <div style="margin-bottom: 2rem; padding: 1rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 8px; border-left: 4px solid #4A90E2;">
                        <h5 style="color: #4A90E2; font-size: 1.1rem; margin-bottom: 1rem;">1. Maîtriser la température de l'eau 💧</h5>
                        <p style="margin-bottom: 1rem; line-height: 1.6;">
                            Pour une pâte bien levée, la température de l'eau est cruciale. En boulangerie, on parle de la <strong>Température de Base (TB)</strong> : elle permet d'obtenir une pâte idéale, entre 23°C et 25°C en fin de pétrissage.
                        </p>
                        <p style="margin-bottom: 1rem; line-height: 1.6;">
                            C'est la température parfaite pour activer la levure et réussir la fermentation.
                        </p>
                        
                        <div style="background: white; padding: 1rem; border-radius: 6px; margin: 1rem 0; border: 1px solid #dee2e6;">
                            <h6 style="color: var(--accent-brown); font-weight: bold; margin-bottom: 0.5rem;">📐 Comment calculer la température de l'eau ?</h6>
                            <p style="margin-bottom: 0.5rem; font-weight: bold;">On utilise la formule suivante :</p>
                            <p style="background: #f8f9fa; padding: 0.8rem; border-radius: 4px; font-family: monospace; font-weight: bold; color: var(--accent-brown);">
                                TB = Température de l'air + Température de la farine + Température de l'eau
                            </p>
                        </div>
                        
                        <div style="background: white; padding: 1rem; border-radius: 6px; margin: 1rem 0; border: 1px solid #dee2e6;">
                            <h6 style="color: var(--accent-brown); font-weight: bold; margin-bottom: 0.5rem;">📝 Un exemple classique :</h6>
                            <p style="margin-bottom: 0.5rem;">
                                Si la recette indique TB 60, et que l'air est à 25°C, la farine à 20°C,
                            </p>
                            <p style="background: #e8f5e8; padding: 0.8rem; border-radius: 4px; font-weight: bold; color: #2d5a2d;">
                                👉 il faudra une eau à 15°C (60 - 25 - 20 = 15).
                            </p>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 1rem; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #ffc107;">
                            <h6 style="color: #856404; font-weight: bold; margin-bottom: 0.5rem;">💡 À retenir :</h6>
                            <ul style="margin: 0; padding-left: 1.2rem;">
                                <li style="margin-bottom: 0.3rem;"><strong>En été :</strong> l'air est plus chaud, donc on utilise de l'eau très fraîche.</li>
                                <li style="margin-bottom: 0.3rem;"><strong>En hiver :</strong> l'eau à température ambiante suffit la plupart du temps.</li>
                            </ul>
                            <p style="margin-top: 0.8rem; margin-bottom: 0; font-style: italic; color: #856404;">
                                Cela permet de garder le contrôle sur la fermentation et d'obtenir un pain parfait à chaque fois !
                            </p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1rem; padding: 1rem; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 8px; border-left: 4px solid #dc3545;">
                        <h5 style="color: #dc3545; font-size: 1.1rem; margin-bottom: 1rem;">2. Préparer la cuisson au four 🔥</h5>
                        <p style="margin-bottom: 1rem; line-height: 1.6;">
                            Les bonnes pratiques avant d'enfourner :
                        </p>
                        
                        <div style="background: white; padding: 1rem; border-radius: 6px; margin: 1rem 0; border: 1px solid #dee2e6;">
                            <h6 style="color: var(--accent-brown); font-weight: bold; margin-bottom: 0.5rem;">✂️ Faire les grignes :</h6>
                            <p style="margin-bottom: 0.5rem;">
                                Utilise une lame de rasoir pour inciser le pain juste avant la cuisson. Cela permet au pain de bien se développer et d'obtenir une jolie forme.
                            </p>
                        </div>
                        
                        <div style="background: white; padding: 1rem; border-radius: 6px; margin: 1rem 0; border: 1px solid #dee2e6;">
                            <h6 style="color: var(--accent-brown); font-weight: bold; margin-bottom: 0.5rem;">💨 Créer de la vapeur :</h6>
                            <p style="margin-bottom: 0.5rem;">
                                Verse un peu d'eau dans la lèchefrite du four au moment d'enfourner.
                            </p>
                            <p style="margin-bottom: 0;">
                                Cela augmente l'humidité et favorise la réaction de Maillard, pour une croûte dorée et croustillante.
                            </p>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #d1ecf1, #bee5eb); padding: 1rem; border-radius: 6px; margin: 1rem 0; border-left: 4px solid #17a2b8;">
                            <h6 style="color: #0c5460; font-weight: bold; margin-bottom: 0.5rem;">💡 Astuce :</h6>
                            <p style="margin-bottom: 0; color: #0c5460;">
                                Si tu cuis ton pain en cocotte, pas besoin d'ajouter de l'eau dans le four, la cocotte garde naturellement l'humidité.
                            </p>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem; padding: 1rem; background: linear-gradient(135deg, #d4edda, #c3e6cb); border-radius: 8px; border: 2px solid #28a745;">
                        <h5 style="color: #155724; font-size: 1.2rem; margin-bottom: 0.5rem;">🥖 Bon pain !</h5>
                        <p style="margin-bottom: 0; color: #155724; font-style: italic;">
                        </p>
                    </div>
                </div>
            </div>

            <div class="mb-2">
                <h3>Ressources Vidéos</h3>
                <div style="padding: 1rem; background: var(--cream-white); border-radius: var(--border-radius);">
                    <p style="margin-bottom: 1rem; font-weight: bold; color: var(--accent-brown);">📺 Chaîne Boulangerie Pas à Pas</p>
                    <p><a href="https://www.youtube.com/c/BoulangeriePas%C3%A0pas" target="_blank">🎥 Chaîne complète - Boulangerie Pas à Pas</a></p>
                    
                    <p style="margin: 1.5rem 0 0.5rem 0; font-weight: bold; color: var(--accent-brown);">🍞 Vidéos recommandées :</p>
                    <p><a href="https://www.youtube.com/watch?v=vD_aufrBTjU&ab_channel=BoulangeriePas%C3%A0pas" target="_blank">🧫 Fabrication du levain</a></p>
                    <p><a href="https://www.youtube.com/watch?v=PP1b4XWXOk0&ab_channel=BoulangeriePas%C3%A0pas" target="_blank">🥖 Nourrissage du levain</a></p>
                    <p><a href="https://www.youtube.com/watch?v=lq_pxzzCF4g&ab_channel=BoulangeriePas%C3%A0pas" target="_blank">🍳 Pain en cocotte (recette infaillible)</a></p>
                    <p><a href="https://www.youtube.com/watch?v=60K3Fe5j_J8&ab_channel=BoulangeriePas%C3%A0pas" target="_blank">👐 Pain au levain - Pétrissage à la main</a></p>
                </div>
            </div>

        </div>
    </div>

    <!-- Chatbot flottant - Visible sur toutes les pages -->
    <div class="chat-bubble" id="chatBubble">
        <div class="chat-bubble-content">
            <span class="chat-bubble-icon">👨‍💼📞</span>
            <span>Tu as une question ?</span>
        </div>
    </div>

    <!-- Bouton Gestion du temps - Visible sur toutes les pages -->
    <div class="chat-bubble" id="tempsBubble" style="left: auto; right: 30px; bottom: 120px;">
        <div class="chat-bubble-content chronometre-style">
            <span class="chat-bubble-icon">⏱️</span>
            <span>Gestion du temps</span>
        </div>
    </div>

    <!-- Bouton Calculs et conversions - Visible sur toutes les pages -->
    <div class="chat-bubble" id="calculsBubble" style="left: auto; right: 30px;">
        <div class="chat-bubble-content">
            <span class="chat-bubble-icon">🧮</span>
            <span>Calculs et conversions</span>
        </div>
    </div>

    <!-- Chat modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-header">
            <span>🤖 Assistant Boulanger</span>
            <button class="close-chat" onclick="toggleChat()">×</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message bot">
                Bonjour ! Je suis votre assistant boulanger virtuel. Posez-moi vos questions sur la boulangerie, les recettes, ou les problèmes que vous rencontrez !
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Tapez votre question..." />
            <button class="chat-send-btn" id="chatSendBtn">Envoyer</button>
        </div>
    </div>

    <!-- Modales (seront créées dynamiquement) -->
    <div id="modalContainer"></div>

    <script>
        // Variables globales
        let currentData = {
            recipes: {},
            levains: [],
            gallery: [],
            settings: {
                ingredientHierarchy: ['Farine T65', 'Farine T45', 'Farine T00', 'Eau', 'Sel', 'Levure sèche', 'Levain liquide', 'Sucre', 'Beurre', 'Œufs', 'Lait'],
                customTabs: []
            }
        };

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            loadDataFromStorage();
            setupEventListeners();
            setupDarkMode();
            setupLevainBubbleAnimation();
            renderStats();
            renderGallery();
            renderTopRecipes();
            renderAllRecipes();
            renderLevains();
            renderCustomTabs();
            // Initialiser la gestion du temps (timer, rappels, etc.)
            initialiserGestionTemps();
            // Afficher la page d'accueil par défaut et activer le bouton
            showPage('accueil');
            document.querySelectorAll('.left-tabs .tab-button, .family-tabs .tab-button, .right-tabs .tab-button').forEach(b => b.classList.remove('active'));
            document.querySelector('.left-tabs .tab-button[data-tab="accueil"]')?.classList.add('active');
        }

        // Gestion du mode sombre
        function setupDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const savedTheme = localStorage.getItem('theme') || 'light';
            
            // Appliquer le thème sauvegardé
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                darkModeToggle.textContent = '☀️';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                darkModeToggle.textContent = '🌙';
            }
            
            // Gestionnaire d'événement pour le bouton
            darkModeToggle.addEventListener('click', function() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                
                darkModeToggle.textContent = newTheme === 'dark' ? '☀️' : '🌙';
            });
        }

        function loadDataFromStorage() {
            const stored = localStorage.getItem('bakeryData');
            if (stored) {
                try {
                    const parsed = JSON.parse(stored);
                    currentData = { ...currentData, ...parsed };
                    
                    // Convertir les anciens statuts "testee" en "nouvelle"
                    Object.keys(currentData.recipes).forEach(family => {
                        currentData.recipes[family].forEach(recipe => {
                            if (recipe.status === 'testee') {
                                recipe.status = 'nouvelle';
                            }
                        });
                    });
                } catch (e) {
                    console.error('Erreur lors du chargement des données:', e);
                }
            }
            
            // Initialiser les familles de recettes si elles n'existent pas
            if (!currentData.recipes.pain) currentData.recipes.pain = [];
            if (!currentData.recipes.pates) currentData.recipes.pates = [];
            if (!currentData.recipes.viennoiseries) currentData.recipes.viennoiseries = [];
        }

        function saveDataToStorage() {
            try {
                localStorage.setItem('bakeryData', JSON.stringify(currentData));
            } catch (e) {
                console.error('Erreur lors de la sauvegarde:', e);
                alert('Erreur lors de la sauvegarde des données');
            }
        }

        function setupEventListeners() {
            // Navigation tabs - tous les boutons
            const tabButtons = document.querySelectorAll('.left-tabs .tab-button, .family-tabs .tab-button, .right-tabs .tab-button[data-tab]');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.getAttribute('data-tab');
                    showPage(tabId);
                    // Mettre à jour les boutons actifs
                    document.querySelectorAll('.left-tabs .tab-button, .family-tabs .tab-button, .right-tabs .tab-button[data-tab]').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                });
            });

            // Upload d'images
            document.getElementById('uploadImageBtn').addEventListener('click', () => {
                document.getElementById('imageUpload').click();
            });

            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);

            // Import/Export
            document.getElementById('exportBtn').addEventListener('click', exportData);
            document.getElementById('importBtn').addEventListener('click', () => {
                document.getElementById('importFile').click();
            });
            document.getElementById('importFile').addEventListener('change', importData);

            // Chatbot flottant
            document.getElementById('chatBubble').addEventListener('click', toggleChat);
            document.getElementById('chatSendBtn').addEventListener('click', sendChatMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });

            // Bouton Calculs et conversions
            document.getElementById('calculsBubble').addEventListener('click', openCalculsModal);

            // Bouton Gestion du temps
            document.getElementById('tempsBubble').addEventListener('click', openTempsModal);

            // Paramètres
            document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);

                    // Bouton BETA
        document.getElementById('betaBtn').addEventListener('click', openBetaModal);

        // Calibrateur de four
        function openCalibrateurFourModal() {
            const modal = createModal('Calibrateur de Four 🔥', 'large');
            modal.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; height: 100%;">
                    <!-- Section gauche : Test de température -->
                    <div style="border-right: 2px solid var(--accent-brown); padding-right: 1rem;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1.5rem; text-align: center;">🌡️ Test de Température</h3>
                        
                        <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #ffc107;">
                            <h4 style="color: #856404; margin-bottom: 1rem;">📋 Guide de test sans thermomètre</h4>
                            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h5 style="color: var(--accent-brown); margin-bottom: 0.5rem;">1. Test du papier</h5>
                                <p style="margin-bottom: 0.5rem;">Placez une feuille de papier blanc au centre du four préchauffé à 180°C.</p>
                                <ul style="margin: 0; padding-left: 1.2rem;">
                                    <li><strong>2-3 minutes :</strong> Four trop chaud</li>
                                    <li><strong>4-5 minutes :</strong> Four correct</li>
                                    <li><strong>6+ minutes :</strong> Four trop froid</li>
                                </ul>
                            </div>
                            
                            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h5 style="color: var(--accent-brown); margin-bottom: 0.5rem;">2. Test du sucre</h5>
                                <p style="margin-bottom: 0.5rem;">Placez 1 cuillère à soupe de sucre blanc au centre du four à 180°C.</p>
                                <ul style="margin: 0; padding-left: 1.2rem;">
                                    <li><strong>2-3 minutes :</strong> Four trop chaud</li>
                                    <li><strong>4-6 minutes :</strong> Four correct</li>
                                    <li><strong>7+ minutes :</strong> Four trop froid</li>
                                </ul>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #d1ecf1, #bee5eb); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #17a2b8;">
                            <h4 style="color: #0c5460; margin-bottom: 1rem;">🎯 Placement optimal du pain</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                    <h6 style="color: #0c5460; margin-bottom: 0.5rem;">Four classique</h6>
                                    <p style="margin: 0; font-size: 0.9rem;">Placez au centre, sur la grille du milieu</p>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                    <h6 style="color: #0c5460; margin-bottom: 0.5rem;">Four à convection</h6>
                                    <p style="margin: 0; font-size: 0.9rem;">Placez sur la grille du bas</p>
                                </div>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #28a745;">
                            <h4 style="color: #155724; margin-bottom: 1rem;">⚙️ Calibration manuelle</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Température affichée :</label>
                                    <input type="number" id="tempAffichage" class="form-input" placeholder="180" min="50" max="300">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Température réelle :</label>
                                    <input type="number" id="tempReelle" class="form-input" placeholder="175" min="50" max="300">
                                </div>
                            </div>
                            <button class="btn" onclick="calculerCorrection()" style="width: 100%;">🔧 Calculer la correction</button>
                        </div>
                    </div>

                    <!-- Section droite : Profils et corrections -->
                    <div style="padding-left: 1rem;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1.5rem; text-align: center;">⚙️ Profils de Cuisson</h3>
                        
                        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #2196f3;">
                            <h4 style="color: #1976d2; margin-bottom: 1rem;">📊 Résultat de calibration</h4>
                            <div id="resultatCalibration" style="background: white; padding: 1rem; border-radius: 8px; min-height: 80px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc;">
                                <p style="color: #666; margin: 0; text-align: center;">Effectuez un test de calibration pour voir les résultats</p>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #9c27b0;">
                            <h4 style="color: #7b1fa2; margin-bottom: 1rem;">💾 Profils sauvegardés</h4>
                            <div id="profilsFour" style="max-height: 200px; overflow-y: auto;">
                                <!-- Les profils seront affichés ici -->
                            </div>
                            <button class="btn btn-secondary" onclick="sauvegarderProfil()" style="width: 100%; margin-top: 1rem;">💾 Sauvegarder ce profil</button>
                        </div>

                        <div style="background: linear-gradient(135deg, #fff8e1, #ffecb3); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #ff9800;">
                            <h4 style="color: #e65100; margin-bottom: 1rem;">🔄 Correction automatique des recettes</h4>
                            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h5 style="color: var(--accent-brown); margin-bottom: 0.5rem;">Recettes à corriger :</h5>
                                <div id="recettesACorriger" style="max-height: 150px; overflow-y: auto;">
                                    <!-- Les recettes seront listées ici -->
                                </div>
                            </div>
                            <button class="btn" onclick="appliquerCorrections()" style="width: 100%;">🔄 Appliquer les corrections</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Charger les profils existants
            chargerProfilsFour();
            // Charger les recettes à corriger
            chargerRecettesACorriger();
            
            showModal(modal);
        }

        // Fonctions pour le calibrateur de four
        function calculerCorrection() {
            const tempAffichage = parseFloat(document.getElementById('tempAffichage').value);
            const tempReelle = parseFloat(document.getElementById('tempReelle').value);
            
            if (!tempAffichage || !tempReelle) {
                alert('Veuillez saisir les deux températures');
                return;
            }
            
            const difference = tempReelle - tempAffichage;
            const pourcentage = ((difference / tempAffichage) * 100).toFixed(1);
            
            let resultatHTML = '';
            let couleur = '';
            
            if (Math.abs(difference) <= 5) {
                resultatHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">✅</div>
                        <h5 style="color: #28a745; margin-bottom: 0.5rem;">Four bien calibré</h5>
                        <p style="margin-bottom: 0.5rem;">Différence : ${difference > 0 ? '+' : ''}${difference}°C</p>
                        <p style="margin-bottom: 0; font-size: 0.9rem; color: #666;">Aucune correction nécessaire</p>
                    </div>
                `;
                couleur = '#28a745';
            } else if (Math.abs(difference) <= 15) {
                resultatHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">⚠️</div>
                        <h5 style="color: #ffc107; margin-bottom: 0.5rem;">Correction recommandée</h5>
                        <p style="margin-bottom: 0.5rem;">Différence : ${difference > 0 ? '+' : ''}${difference}°C (${pourcentage}%)</p>
                        <p style="margin-bottom: 0; font-size: 0.9rem; color: #666;">Ajustez la température de ${difference > 0 ? '-' : '+'}${Math.abs(difference)}°C</p>
                    </div>
                `;
                couleur = '#ffc107';
            } else {
                resultatHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔧</div>
                        <h5 style="color: #dc3545; margin-bottom: 0.5rem;">Calibration nécessaire</h5>
                        <p style="margin-bottom: 0.5rem;">Différence : ${difference > 0 ? '+' : ''}${difference}°C (${pourcentage}%)</p>
                        <p style="margin-bottom: 0; font-size: 0.9rem; color: #666;">Ajustez la température de ${difference > 0 ? '-' : '+'}${Math.abs(difference)}°C</p>
                    </div>
                `;
                couleur = '#dc3545';
            }
            
            document.getElementById('resultatCalibration').innerHTML = resultatHTML;
            document.getElementById('resultatCalibration').style.borderColor = couleur;
            
            // Sauvegarder le résultat pour les corrections automatiques
            window.derniereCalibration = {
                tempAffichage,
                tempReelle,
                difference,
                pourcentage,
                date: new Date().toISOString()
            };
        }

        function sauvegarderProfil() {
            if (!window.derniereCalibration) {
                alert('Effectuez d\'abord un test de calibration');
                return;
            }
            
            const nomProfil = prompt('Nom du profil de four :');
            if (!nomProfil) return;
            
            // Charger les profils existants
            let profils = JSON.parse(localStorage.getItem('profilsFour') || '[]');
            
            // Ajouter le nouveau profil
            profils.push({
                id: Date.now(),
                nom: nomProfil,
                ...window.derniereCalibration,
                dateCreation: new Date().toISOString()
            });
            
            // Sauvegarder
            localStorage.setItem('profilsFour', JSON.stringify(profils));
            
            // Recharger l'affichage
            chargerProfilsFour();
            
            alert('Profil sauvegardé avec succès !');
        }

        function chargerProfilsFour() {
            const profils = JSON.parse(localStorage.getItem('profilsFour') || '[]');
            const container = document.getElementById('profilsFour');
            
            if (profils.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">Aucun profil sauvegardé</p>';
                return;
            }
            
            container.innerHTML = profils.map(profil => `
                <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid var(--accent-brown);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--accent-brown);">${profil.nom}</strong>
                            <br>
                            <span style="font-size: 0.9rem; color: #666;">
                                ${profil.tempAffichage}°C → ${profil.tempReelle}°C (${profil.difference > 0 ? '+' : ''}${profil.difference}°C)
                            </span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-compact" onclick="utiliserProfil(${profil.id})">Utiliser</button>
                            <button class="btn-compact btn-danger" onclick="supprimerProfil(${profil.id})">Supprimer</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function utiliserProfil(profilId) {
            const profils = JSON.parse(localStorage.getItem('profilsFour') || '[]');
            const profil = profils.find(p => p.id === profilId);
            
            if (profil) {
                document.getElementById('tempAffichage').value = profil.tempAffichage;
                document.getElementById('tempReelle').value = profil.tempReelle;
                calculerCorrection();
            }
        }

        function supprimerProfil(profilId) {
            if (!confirm('Supprimer ce profil ?')) return;
            
            let profils = JSON.parse(localStorage.getItem('profilsFour') || '[]');
            profils = profils.filter(p => p.id !== profilId);
            localStorage.setItem('profilsFour', JSON.stringify(profils));
            
            chargerProfilsFour();
        }

        function chargerRecettesACorriger() {
            const recettes = [];
            
            // Parcourir toutes les familles de recettes
            Object.keys(currentData.recipes).forEach(famille => {
                currentData.recipes[famille].forEach(recette => {
                    if (recette.temperature || recette.tempsCuisson) {
                        recettes.push({
                            ...recette,
                            famille
                        });
                    }
                });
            });
            
            const container = document.getElementById('recettesACorriger');
            
            if (recettes.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">Aucune recette avec température/temps</p>';
                return;
            }
            
            container.innerHTML = recettes.map(recette => `
                <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid var(--accent-brown);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--accent-brown);">${recette.name}</strong>
                            <br>
                            <span style="font-size: 0.85rem; color: #666;">
                                ${recette.temperature ? `${recette.temperature}°C` : ''} 
                                ${recette.tempsCuisson ? `• ${recette.tempsCuisson}min` : ''}
                            </span>
                        </div>
                        <div style="font-size: 0.8rem; color: #666;">
                            ${recette.famille}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function appliquerCorrections() {
            if (!window.derniereCalibration) {
                alert('Effectuez d\'abord un test de calibration');
                return;
            }
            
            const { difference } = window.derniereCalibration;
            let correctionsAppliquees = 0;
            
            // Parcourir toutes les familles de recettes
            Object.keys(currentData.recipes).forEach(famille => {
                currentData.recipes[famille].forEach(recette => {
                    if (recette.temperature) {
                        const nouvelleTemp = Math.round(recette.temperature + difference);
                        recette.temperature = nouvelleTemp;
                        correctionsAppliquees++;
                    }
                });
            });
            
            // Sauvegarder les modifications
            saveDataToStorage();
            
            alert(`${correctionsAppliquees} recettes ont été corrigées avec succès !`);
            
            // Recharger l'affichage des recettes
            renderAllRecipes();
        }

            // Sort controls
            document.querySelectorAll('.sort-select').forEach(select => {
                select.addEventListener('change', (e) => {
                    const family = e.target.getAttribute('data-family');
                    const sortBy = e.target.value;
                    sortAndRenderRecipes(family, sortBy);
                });
            });
        }

        // Animation des bulles pour le bouton levain
        function setupLevainBubbleAnimation() {
            const levainButton = document.querySelector('.main-tab[data-tab="levains"]');
            if (!levainButton) return;

            // Nettoyer les bulles existantes
            const existingBubbles = levainButton.querySelectorAll('.bubble');
            existingBubbles.forEach(bubble => bubble.remove());

            // Trouver le levain le moins frais (le plus ancien)
            let oldestDaysSinceRefresh = 0;
            if (currentData.levains.length > 0) {
                currentData.levains.forEach(levain => {
                    if (levain.lastRefresh) {
                        const daysSince = Math.floor((Date.now() - new Date(levain.lastRefresh).getTime()) / (1000 * 60 * 60 * 24));
                        if (daysSince > oldestDaysSinceRefresh) {
                            oldestDaysSinceRefresh = daysSince;
                        }
                    } else {
                        // Si jamais rafraîchi, considérer comme très ancien
                        oldestDaysSinceRefresh = Math.max(oldestDaysSinceRefresh, 999);
                    }
                });
            }

            // Définir les paramètres selon le levain le moins frais
            let bubbleCount, interval;
            if (oldestDaysSinceRefresh <= 10) {
                // 0-10 jours : beaucoup de bulles
                bubbleCount = 15;
                interval = 200; // 200ms entre chaque bulle
            } else if (oldestDaysSinceRefresh <= 20) {
                // 11-20 jours : bulles moyennes
                bubbleCount = 10;
                interval = 300; // 300ms entre chaque bulle
            } else {
                // Plus de 20 jours : très peu de bulles
                bubbleCount = 3;
                interval = 800; // 800ms entre chaque bulle
            }

            // Créer une animation en boucle permanente
            createContinuousBubbles(levainButton, bubbleCount, interval);
        }

        function setupLevainCardBubbles(levain) {
            const card = document.querySelector(`.levain-card-${levain.id}`);
            if (!card) return;

            // Nettoyer les bulles existantes
            const existingBubbles = card.querySelectorAll('.bubble');
            existingBubbles.forEach(bubble => bubble.remove());

            // Calculer le temps depuis le dernier rafraîchissement
            let daysSinceRefresh = 999;
            if (levain.lastRefresh) {
                daysSinceRefresh = Math.floor((Date.now() - new Date(levain.lastRefresh).getTime()) / (1000 * 60 * 60 * 24));
            }

            // Définir les paramètres selon le temps écoulé
            let bubbleCount, interval;
            if (daysSinceRefresh <= 10) {
                // 0-10 jours : beaucoup de bulles
                bubbleCount = 8;
                interval = 300; // 300ms entre chaque bulle
            } else if (daysSinceRefresh <= 20) {
                // 11-20 jours : bulles moyennes
                bubbleCount = 5;
                interval = 500; // 500ms entre chaque bulle
            } else {
                // Plus de 20 jours : très peu de bulles
                bubbleCount = 2;
                interval = 1000; // 1000ms entre chaque bulle
            }

            // Créer une animation en boucle permanente pour la vignette
            createContinuousBubbles(card, bubbleCount, interval);
        }

        function createContinuousBubbles(button, bubbleCount, interval) {
            // Stocker les paramètres sur le bouton pour pouvoir les réutiliser
            button.bubbleAnimation = {
                count: bubbleCount,
                interval: interval,
                active: true
            };

            function createSingleBubble() {
                if (!button.bubbleAnimation || !button.bubbleAnimation.active) return;

                const bubble = document.createElement('div');
                bubble.className = 'bubble';
                
                // Taille aléatoire entre 4px et 12px
                const size = Math.random() * 8 + 4;
                bubble.style.width = size + 'px';
                bubble.style.height = size + 'px';
                
                // Position horizontale aléatoire avec plus de variation
                const left = Math.random() * 85 + 7.5; // 7.5% à 92.5% de la largeur
                bubble.style.left = left + '%';
                
                // Durée d'animation légèrement variable pour plus de naturel
                const duration = 3 + (Math.random() - 0.5) * 1; // Entre 2.5s et 3.5s
                bubble.style.animationDuration = duration + 's';
                
                button.appendChild(bubble);
                
                // Supprimer la bulle après l'animation
                setTimeout(() => {
                    if (bubble.parentNode) {
                        bubble.remove();
                    }
                }, duration * 1000);
            }

            // Créer la première bulle immédiatement
            createSingleBubble();

            // Créer des bulles en continu selon l'intervalle
            const bubbleInterval = setInterval(() => {
                if (!button.bubbleAnimation || !button.bubbleAnimation.active) {
                    clearInterval(bubbleInterval);
                    return;
                }
                createSingleBubble();
            }, interval);

            // Stocker l'intervalle pour pouvoir l'arrêter plus tard
            button.bubbleInterval = bubbleInterval;
        }

        function showPage(pageId) {
            // Cacher toutes les pages
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            
            // Afficher la page demandée
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
            }
        }

        // Suite du JavaScript - Partie 2

        // Fonctions pour la page d'accueil
        function renderStats() {
            const statsSection = document.getElementById('statsSection');
            const stats = calculateStats();
            
            statsSection.innerHTML = `
                <div class="stat-card levain-stat-card" onclick="showStatDetail('levain')" style="position: relative; overflow: hidden;">
                    <div class="stat-value">${stats.freshestLevain}</div>
                    <div class="stat-label">${stats.freshestLevainAge}</div>
                </div>
                <div class="stat-card" onclick="showStatDetail('recipes')">
                    <div class="stat-value">${stats.totalRecipes}</div>
                    <div class="stat-label">Nombre de recettes</div>
                </div>
                <div class="stat-card" onclick="showStatDetail('rating')">
                    <div class="stat-value">${stats.avgRating}/5</div>
                    <div class="stat-label">Note moyenne des recettes</div>
                </div>
            `;
            
            // Mettre à jour l'animation des bulles du bouton levain
            setupLevainBubbleAnimation();
            
            // Ajouter l'animation de bulles sur l'indicateur de levain de la page d'accueil
            setupLevainStatBubbleAnimation();
        }

        function calculateStats() {
            let totalRecipes = 0;
            let totalRating = 0;
            let ratedRecipes = 0;
            
            Object.values(currentData.recipes).forEach(family => {
                totalRecipes += family.length;
                family.forEach(recipe => {
                    if (recipe.rating && recipe.rating > 0) {
                        totalRating += recipe.rating;
                        ratedRecipes++;
                    }
                });
            });

            let freshestLevain = 'Aucun levain';
            let freshestLevainAge = '';
            
            if (currentData.levains.length > 0) {
                // Trouver le levain le plus frais (le plus récemment rafraîchi)
                let freshestLevainObj = null;
                let freshestDays = 999;
                
                currentData.levains.forEach(levain => {
                    if (levain.lastRefresh) {
                        const daysSince = Math.floor((Date.now() - new Date(levain.lastRefresh).getTime()) / (1000 * 60 * 60 * 24));
                        if (daysSince < freshestDays) {
                            freshestDays = daysSince;
                            freshestLevainObj = levain;
                        }
                    } else {
                        // Si jamais rafraîchi, considérer comme très ancien
                        if (999 < freshestDays) {
                            freshestDays = 999;
                            freshestLevainObj = levain;
                        }
                    }
                });
                
                if (freshestLevainObj) {
                    const timeText = freshestDays === 0 ? 'Aujourd\'hui' : 
                                   freshestDays === 1 ? 'Hier' : 
                                   `Il y a ${freshestDays} jour${freshestDays > 1 ? 's' : ''}`;
                    freshestLevain = `${freshestLevainObj.name}`;
                    freshestLevainAge = `Rafraîchi ${timeText}`;
                    
                    if (freshestLevainObj.createdDate) {
                        const ageResult = calculateLevainAge(freshestLevainObj.createdDate);
                        freshestLevainAge += `<br>Âge : ${ageResult.text}`;
                    } else {
                        freshestLevainAge += '<br>Âge : Inconnu';
                    }
                }
            }

            return {
                totalRecipes,
                avgRating: ratedRecipes > 0 ? (totalRating / ratedRecipes).toFixed(1) : '0.0',
                freshestLevain,
                freshestLevainAge
            };
        }

        function showStatDetail(type) {
            let content = '';
            let title = '';
            
            switch(type) {
                case 'levain':
                    title = 'État des Levains';
                    if (currentData.levains.length > 0) {
                        // Trouver le levain le plus frais
                        let freshestLevain = null;
                        let freshestDays = 999;
                        
                        currentData.levains.forEach(levain => {
                            if (levain.lastRefresh) {
                                const daysSince = Math.floor((Date.now() - new Date(levain.lastRefresh).getTime()) / (1000 * 60 * 60 * 24));
                                if (daysSince < freshestDays) {
                                    freshestDays = daysSince;
                                    freshestLevain = levain;
                                }
                            } else {
                                if (999 < freshestDays) {
                                    freshestDays = 999;
                                    freshestLevain = levain;
                                }
                            }
                        });
                        
                        content = `
                            <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 2rem; border: 2px solid var(--olive-green);">
                                <h3 style="color: var(--olive-green); margin-bottom: 1rem;">🧪 Levain le plus frais : ${freshestLevain.name}</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--olive-green);">
                                        <strong>Dernier rafraîchissement :</strong><br>
                                        ${freshestLevain.lastRefresh ? new Date(freshestLevain.lastRefresh).toLocaleString() : 'Jamais'}
                                    </div>
                                    <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--accent-brown);">
                                        <strong>Âge :</strong><br>
                                        ${freshestLevain.createdDate ? calculateLevainAge(freshestLevain.createdDate).text : 'Inconnu'}
                                    </div>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #4A90E2;">
                                    <strong>État :</strong> ${freshestDays === 0 ? '🟢 Excellent' : 
                                                           freshestDays <= 3 ? '🟡 Bon' : 
                                                           freshestDays <= 7 ? '🟠 À surveiller' : 
                                                           '🔴 Nécessite rafraîchissement'}
                                </div>
                            </div>
                            
                            <h4 style="color: var(--accent-brown); margin-bottom: 1rem;">📊 Vue d'ensemble de tous les levains :</h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${currentData.levains.map(levain => {
                                    const timeSince = calculateTimeSinceRefresh(levain.lastRefresh);
                                    const age = calculateLevainAge(levain.createdDate);
                                    const isUrgent = timeSince.days > 7;
                                    
                                    return `
                                        <div style="background: ${isUrgent ? '#fff3cd' : 'var(--cream-white)'}; 
                                                    padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; 
                                                    border: 2px solid ${isUrgent ? '#ffc107' : 'var(--accent-brown)'};">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <strong style="color: var(--accent-brown);">${levain.name}</strong>
                                                    <br>
                                                    <span style="font-size: 0.9rem; color: #666;">
                                                        ${timeSince.text} • Âge : ${age.text}
                                                    </span>
                                                </div>
                                                <button class="btn-compact" onclick="showLevainDetail('${levain.id}'); closeModal();">
                                                    Voir détails
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    } else {
                        content = `
                            <div style="text-align: center; padding: 2rem;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">🧪</div>
                                <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">Aucun levain créé</h3>
                                <p style="color: var(--text-dark);">Commencez par créer votre premier levain !</p>
                                <button class="btn" onclick="openAddLevainModal(); closeModal();" style="margin-top: 1rem;">
                                    ➕ Créer un levain
                                </button>
                            </div>
                        `;
                    }
                    break;
                    
                case 'recipes':
                    title = 'Répartition des Recettes';
                    // Filtrer les familles qui ont des recettes et inclure les onglets personnalisés
                    const allFamilies = [...Object.keys(currentData.recipes)];
                    if (currentData.settings.customTabs) {
                        currentData.settings.customTabs.forEach((tab, idx) => {
                            allFamilies.push(`custom-${idx}`);
                        });
                    }
                    
                    // Supprimer les doublons et filtrer les familles avec des recettes
                    const uniqueFamilies = [...new Set(allFamilies)];
                    const familiesWithRecipes = uniqueFamilies.filter(family => {
                        const recipes = currentData.recipes[family] || [];
                        return recipes.length > 0;
                    });
                    
                    if (familiesWithRecipes.length === 0) {
                        content = `
                            <div style="text-align: center; padding: 2rem;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">📝</div>
                                <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">Aucune recette trouvée</h3>
                                <p style="color: var(--text-dark);">Commencez par ajouter vos premières recettes dans les différentes familles !</p>
                            </div>
                        `;
                        break;
                    }
                    
                    // Couleurs et icônes pour chaque famille
                    const familyConfig = {
                        'pain': { color: '#D2691E', gradient: '#F4A460', icon: '🥖' },
                        'pates': { color: '#DAA520', gradient: '#F0E68C', icon: '🍝' },
                        'viennoiseries': { color: '#CD853F', gradient: '#DEB887', icon: '🥐' }
                    };
                    
                    // Calculer le nombre total et le maximum pour l'échelle
                    const totalRecipes = familiesWithRecipes.reduce((sum, family) => {
                        const recipes = currentData.recipes[family] || [];
                        return sum + recipes.length;
                    }, 0);
                    
                    const maxCount = Math.max(...familiesWithRecipes.map(family => 
                        (currentData.recipes[family] || []).length
                    ));
                    
                    // Graphique plus grand et professionnel
                    const chartWidth = Math.max(1000, familiesWithRecipes.length * 180);
                    const chartHeight = 600;
                    const barWidth = Math.min(120, (chartWidth - 250) / familiesWithRecipes.length - 50);
                    
                    // Préparer les données pour les tooltips
                    const chartData = familiesWithRecipes.map((family, index) => {
                        const recipes = currentData.recipes[family] || [];
                        const count = recipes.length;
                        const percentage = Math.round((count/totalRecipes)*100);
                        
                        // Nom d'affichage pour les familles personnalisées
                        let displayName = family;
                        let icon = familyConfig[family]?.icon || '📝';
                        
                        if (family.startsWith('custom-')) {
                            const customIndex = parseInt(family.split('-')[1]);
                            const customTab = currentData.settings.customTabs[customIndex];
                            if (customTab) {
                                displayName = customTab.name;
                                icon = customTab.icon || '📝';
                            }
                        }
                        
                        // Liste des recettes pour le tooltip
                        const recipeNames = recipes.map(r => r.name).join(', ');
                        
                        return {
                            family,
                            displayName,
                            icon,
                            count,
                            percentage,
                            recipes: recipes,
                            recipeNames,
                            config: familyConfig[family] || { color: '#8B4513', gradient: '#D2691E' }
                        };
                    });
                    
                    content = `
                        <div style="text-align: center; margin-bottom: 2rem;">
                            <div style="display: inline-block; background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 2rem; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.15);">
                                <svg width="${chartWidth}" height="${chartHeight}" viewBox="0 0 ${chartWidth} ${chartHeight}" style="overflow: visible;">
                                    <!-- Grille de fond -->
                                    <defs>
                                        ${chartData.map((data, index) => {
                                            return `
                                                <linearGradient id="gradient-${index}" x1="0%" y1="0%" x2="0%" y2="100%">
                                                    <stop offset="0%" style="stop-color:${data.config.gradient};stop-opacity:1" />
                                                    <stop offset="100%" style="stop-color:${data.config.color};stop-opacity:1" />
                                                </linearGradient>
                                                <filter id="shadow-${index}" x="-20%" y="-20%" width="140%" height="140%">
                                                    <feDropShadow dx="3" dy="3" stdDeviation="4" flood-color="rgba(0,0,0,0.4)"/>
                                                </filter>
                                            `;
                                        }).join('')}
                                    </defs>
                                    
                                    <!-- Lignes de grille -->
                                    ${Array.from({length: 8}, (_, i) => {
                                        const y = 480 - (i * 60);
                                        const value = Math.ceil((maxCount / 7) * i);
                                        return `
                                            <line x1="100" y1="${y}" x2="${chartWidth - 100}" y2="${y}" stroke="#e0e0e0" stroke-width="1" stroke-dasharray="3,3"/>
                                            <text x="85" y="${y + 4}" text-anchor="end" font-size="14" fill="#666" font-weight="bold">${value}</text>
                                        `;
                                    }).join('')}
                                    
                                    <!-- Barres interactives -->
                                    ${chartData.map((data, index) => {
                                        const barHeight = (data.count / maxCount) * 360;
                                        const y = 480 - barHeight;
                                        const x = 150 + index * (barWidth + 80);
                                        
                                        return `
                                            <!-- Groupe interactif pour la barre -->
                                            <g class="bar-group" data-family="${data.family}" style="cursor: pointer;">
                                                <!-- Barre principale avec effet de survol -->
                                                <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" 
                                                      fill="url(#gradient-${index})" rx="12" ry="12" 
                                                      filter="url(#shadow-${index})"
                                                      class="bar-rect"
                                                      data-tooltip="${data.displayName}|${data.count} recette${data.count > 1 ? 's' : ''} (${data.percentage}%)|${data.recipeNames}"
                                                      onmouseover="showTooltip(event, '${data.displayName}', ${data.count}, ${data.percentage}, '${data.recipeNames.replace(/'/g, '\\\'')}')"
                                                      onmouseout="hideTooltip()"
                                                      style="transition: all 0.3s ease;"
                                                      onmouseenter="this.style.transform='scale(1.05)'; this.style.filter='url(#shadow-${index}) brightness(1.1)'"
                                                      onmouseleave="this.style.transform='scale(1)'; this.style.filter='url(#shadow-${index})'"/>
                                                
                                                <!-- Effet de brillance -->
                                                <rect x="${x + 6}" y="${y + 6}" width="${barWidth * 0.4}" height="${barHeight * 0.7}" 
                                                      fill="rgba(255,255,255,0.4)" rx="8" ry="8" />
                                                
                                                <!-- Icône -->
                                                <text x="${x + barWidth/2}" y="${y - 45}" text-anchor="middle" font-size="40" font-weight="bold">${data.icon}</text>
                                                
                                                <!-- Nom de famille -->
                                                <text x="${x + barWidth/2}" y="520" text-anchor="middle" font-size="16" font-weight="bold" fill="var(--text-dark)">${data.displayName}</text>
                                                
                                                <!-- Nombre -->
                                                <text x="${x + barWidth/2}" y="${y - 20}" text-anchor="middle" font-size="20" font-weight="bold" fill="var(--accent-brown)">${data.count}</text>
                                                
                                                <!-- Pourcentage -->
                                                <text x="${x + barWidth/2}" y="540" text-anchor="middle" font-size="14" fill="#666" font-weight="bold">${data.percentage}%</text>
                                            </g>
                                        `;
                                    }).join('')}
                                    
                                    <!-- Titre du graphique -->
                                    <text x="${chartWidth/2}" y="40" text-anchor="middle" font-size="24" font-weight="bold" fill="var(--accent-brown)">Répartition par famille</text>
                                    
                                    <!-- Sous-titre -->
                                    <text x="${chartWidth/2}" y="70" text-anchor="middle" font-size="16" fill="#666">Total : ${totalRecipes} recette${totalRecipes > 1 ? 's' : ''}</text>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Tooltip flottant -->
                        <div id="chartTooltip" style="position: absolute; background: rgba(0,0,0,0.9); color: white; padding: 12px 16px; border-radius: 8px; font-size: 14px; pointer-events: none; z-index: 10000; display: none; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                            <div id="tooltipTitle" style="font-weight: bold; margin-bottom: 4px;"></div>
                            <div id="tooltipCount" style="margin-bottom: 4px;"></div>
                            <div id="tooltipRecipes" style="font-size: 12px; opacity: 0.9;"></div>
                        </div>
                        
                        <!-- Résumé compact -->
                        <div style="background: var(--cream-white); border-radius: 12px; padding: 1.5rem; border: 2px solid var(--accent-brown); text-align: center;">
                            <h4 style="color: var(--accent-brown); margin-bottom: 1rem;">📊 Résumé</h4>
                            <div style="display: flex; justify-content: center; align-items: center; gap: 2rem; flex-wrap: wrap;">
                                <div style="background: white; padding: 1rem 1.5rem; border-radius: 8px; border-left: 4px solid var(--accent-brown); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--accent-brown);">${totalRecipes}</div>
                                    <div style="font-size: 0.9rem; color: #666;">Total recettes</div>
                                </div>
                                <div style="background: white; padding: 1rem 1.5rem; border-radius: 8px; border-left: 4px solid var(--olive-green); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: var(--olive-green);">${familiesWithRecipes.length}</div>
                                    <div style="font-size: 0.9rem; color: #666;">Familles</div>
                                </div>
                                <div style="background: white; padding: 1rem 1.5rem; border-radius: 8px; border-left: 4px solid #4A90E2; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: #4A90E2;">${Math.round(totalRecipes/familiesWithRecipes.length)}</div>
                                    <div style="font-size: 0.9rem; color: #666;">Moyenne/famille</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'rating':
                    title = 'Répartition des Notes';
                    const ratings = [1, 2, 3, 4, 5];
                    const ratingCounts = {};
                    ratings.forEach(r => ratingCounts[r] = 0);
                    
                    Object.values(currentData.recipes).forEach(family => {
                        family.forEach(recipe => {
                            if (recipe.rating) ratingCounts[recipe.rating]++;
                        });
                    });
                    
                    content = `
                        <div style="text-align: center;">
                            <svg width="300" height="150" viewBox="0 0 300 150">
                                ${ratings.map((rating, index) => {
                                    const count = ratingCounts[rating];
                                    const barHeight = count * 15;
                                    const y = 130 - barHeight;
                                    const x = 30 + index * 50;
                                    return `
                                        <rect x="${x}" y="${y}" width="30" height="${barHeight}" fill="#FFD700" />
                                        <text x="${x + 15}" y="145" text-anchor="middle" font-size="12">${'★'.repeat(rating)}</text>
                                        <text x="${x + 15}" y="${y - 5}" text-anchor="middle" font-size="10">${count}</text>
                                    `;
                                }).join('')}
                            </svg>
                        </div>
                    `;
                    break;
                    
                case 'levainAge':
                    title = 'Évolution du Levain';
                    const stats = calculateStats();
                    let levainDays = 0;
                    if (currentData.levains.length > 0 && currentData.levains[0].createdDate) {
                        const ageResult = calculateLevainAge(currentData.levains[0].createdDate);
                        levainDays = ageResult.days;
                    }
                    content = `
                        <p>Votre levain principal a <strong>${stats.levainAge}</strong>.</p>
                        <div style="margin: 1rem 0; padding: 1rem; background: var(--cream-white); border-radius: var(--border-radius);">
                            ${levainDays < 7 ? 
                                '🐣 <strong>Phase jeune :</strong> Votre levain est encore en développement. Rafraîchissez-le quotidiennement.' :
                                levainDays < 30 ?
                                '🌱 <strong>Phase adolescente :</strong> Votre levain gagne en force. Continuez les rafraîchissements réguliers.' :
                                '🏆 <strong>Levain mature :</strong> Félicitations ! Votre levain est maintenant bien établi et stable.'
                            }
                        </div>
                    `;
                    break;
            }
            
            showModal(title, content);
        }

        function renderGallery() {
            const galleryGrid = document.getElementById('galleryGrid');
            
            if (currentData.gallery.length === 0) {
                galleryGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--accent-brown);">
                        📸 Aucune image pour le moment. Uploadez vos premières photos de créations !
                    </div>
                `;
                return;
            }
            
            galleryGrid.innerHTML = currentData.gallery.map(image => `
                <div class="gallery-item" onclick="showImageDetail('${image.id}')">
                    <img src="${image.data}" alt="${image.name}" />
                    <div class="gallery-overlay">
                        ${image.linkedRecipe ? `📖 ${image.linkedRecipe}` : '📷 ' + image.name}
                    </div>
                    <button class="gallery-delete-btn" onclick="event.stopPropagation(); deleteImageFromGallery('${image.id}')" title="Supprimer cette image">×</button>
                </div>
            `).join('');
        }

        function showImageDetail(imageId) {
            const image = currentData.gallery.find(img => img.id === imageId);
            if (!image) return;
            
            if (image.linkedRecipe) {
                // Trouver et afficher directement la recette sans confirmation
                let foundRecipe = null;
                let foundFamily = null;
                
                Object.keys(currentData.recipes).forEach(family => {
                    const recipe = currentData.recipes[family].find(r => r.name === image.linkedRecipe);
                    if (recipe) {
                        foundRecipe = recipe;
                        foundFamily = family;
                    }
                });
                
                if (foundRecipe) {
                    showRecipeDetail(foundRecipe, foundFamily);
                } else {
                    // Si la recette n'est pas trouvée, afficher un message d'erreur
                    alert(`Recette "${image.linkedRecipe}" non trouvée.`);
                }
            } else {
                showModal('Image', `
                    <img src="${image.data}" style="max-width: 100%; border-radius: var(--border-radius);" />
                    <p style="margin-top: 1rem;"><strong>Nom :</strong> ${image.name}</p>
                    <p><strong>Ajoutée le :</strong> ${new Date(image.uploadDate).toLocaleDateString()}</p>
                    ${image.linkedRecipe ? `<p><strong>Liée à la recette :</strong> ${image.linkedRecipe}</p>` : ''}
                    
                    <div class="btn-group" style="margin-top: 2rem;">
                        <button class="btn-danger" onclick="deleteImage('${imageId}')">🗑️ Supprimer</button>
                        <button class="btn" onclick="closeModal()">Fermer</button>
                    </div>
                `);
            }
        }

        function deleteImage(imageId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette image ? Cette action est irréversible.')) {
                // Trouver l'index de l'image à supprimer
                const imageIndex = currentData.gallery.findIndex(img => img.id === imageId);
                if (imageIndex !== -1) {
                    // Supprimer l'image du tableau
                    currentData.gallery.splice(imageIndex, 1);
                    
                    // Sauvegarder les modifications
                    saveDataToStorage();
                    
                    // Rafraîchir l'affichage de la galerie
                    renderGallery();
                    
                    // Fermer la modal
                    closeModal();
                    
                    // Notification de succès
                    alert('Image supprimée avec succès !');
                }
            }
        }

        function deleteImageFromGallery(imageId) {
            const image = currentData.gallery.find(img => img.id === imageId);
            if (!image) return;
            
            const imageName = image.name || 'cette image';
            if (confirm(`Êtes-vous sûr de vouloir supprimer "${imageName}" ?\n\nCette action est irréversible.`)) {
                // Trouver l'index de l'image à supprimer
                const imageIndex = currentData.gallery.findIndex(img => img.id === imageId);
                if (imageIndex !== -1) {
                    // Supprimer l'image du tableau
                    currentData.gallery.splice(imageIndex, 1);
                    
                    // Sauvegarder les modifications
                    saveDataToStorage();
                    
                    // Rafraîchir l'affichage de la galerie
                    renderGallery();
                    
                    // Petit feedback visuel
                    const notification = document.createElement('div');
                    notification.textContent = `✅ Image "${imageName}" supprimée`;
                    notification.style.cssText = `
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        background: var(--olive-green);
                        color: white;
                        padding: 1rem;
                        border-radius: var(--border-radius);
                        z-index: 3000;
                        animation: slideIn 0.3s ease;
                        max-width: 300px;
                    `;
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }
            }
        }



        function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    compressAndAddImage(file);
                }
            });
            
            event.target.value = ''; // Reset input
        }

        function compressAndAddImage(file) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Calculer les nouvelles dimensions (max 800px)
                let { width, height } = img;
                const maxSize = 800;
                
                if (width > height && width > maxSize) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                } else if (height > maxSize) {
                    width = (width * maxSize) / height;
                    height = maxSize;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Dessiner l'image redimensionnée
                ctx.drawImage(img, 0, 0, width, height);
                
                // Compression (ajuster la qualité pour ~200Ko)
                let quality = 0.7;
                let dataUrl = canvas.toDataURL('image/jpeg', quality);
                
                // Réduire la qualité si l'image est encore trop lourde
                while (dataUrl.length > 300000 && quality > 0.1) { // ~200Ko en base64
                    quality -= 0.1;
                    dataUrl = canvas.toDataURL('image/jpeg', quality);
                }
                
                // Ajouter à la galerie
                const imageData = {
                    id: Date.now().toString(),
                    name: file.name,
                    data: dataUrl,
                    uploadDate: new Date().toISOString(),
                    linkedRecipe: null
                };
                
                currentData.gallery.push(imageData);
                saveDataToStorage();
                renderGallery();
                
                // Demander si on veut lier à une recette
                askForRecipeLink(imageData.id);
            };
            
            img.src = URL.createObjectURL(file);
        }

        function askForRecipeLink(imageId) {
            const allRecipes = [];
            Object.keys(currentData.recipes).forEach(family => {
                currentData.recipes[family].forEach(recipe => {
                    allRecipes.push(recipe.name);
                });
            });
            
            if (allRecipes.length === 0) return;
            
            const recipeOptions = allRecipes.map(name => `<option value="${name}">${name}</option>`).join('');
            
            showModal('Lier l\'image à une recette', `
                <p>Voulez-vous associer cette image à une recette existante ?</p>
                <div class="form-group">
                    <select class="form-select" id="linkRecipeSelect">
                        <option value="">-- Aucune liaison --</option>
                        ${recipeOptions}
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="linkImageToRecipe('${imageId}')">Associer</button>
                    <button class="btn-secondary" onclick="closeModal()">Ignorer</button>
                </div>
            `);
        }

        function linkImageToRecipe(imageId) {
            const select = document.getElementById('linkRecipeSelect');
            const recipeName = select.value;
            
            if (recipeName) {
                const image = currentData.gallery.find(img => img.id === imageId);
                if (image) {
                    image.linkedRecipe = recipeName;
                    saveDataToStorage();
                    renderGallery();
                }
            }
            
            closeModal();
        }

        function renderTopRecipes() {
            const tbody = document.getElementById('topRecipesTableBody');
            const allRecipes = [];
            
            Object.keys(currentData.recipes).forEach(family => {
                currentData.recipes[family].forEach(recipe => {
                    allRecipes.push({...recipe, family});
                });
            });
            
            // Trier par note (décroissant)
            allRecipes.sort((a, b) => (b.rating || 0) - (a.rating || 0));
            
            const top5 = allRecipes.slice(0, 5);
            
            if (top5.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" style="text-align: center; color: var(--accent-brown); padding: 2rem;">
                            Aucune recette pour le moment. Commencez par ajouter vos premières recettes !
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = top5.map(recipe => `
                <tr onclick="showRecipeDetailFromTable('${recipe.name}', '${recipe.family}')">
                    <td><strong>${recipe.name}</strong></td>
                    <td>${generateStars(recipe.rating || 0)}</td>
                    <td>${getIngredientsPreview(recipe.ingredients)}</td>
                </tr>
            `).join('');
        }

        function showRecipeDetailFromTable(recipeName, family) {
            const recipe = currentData.recipes[family].find(r => r.name === recipeName);
            if (recipe) {
                showRecipeDetail(recipe, family);
            }
        }

        function getIngredientsPreview(ingredients) {
            if (!ingredients || ingredients.length === 0) return 'Aucun ingrédient';
            
            const sorted = sortIngredientsByHierarchy(ingredients);
                            const preview = sorted.slice(0, 3).map(ing => `${ing.name} (${ing.quantity} ${ing.unit})`).join(', ');
            
            return sorted.length > 3 ? preview + '...' : preview;
        }

        // Fonctions pour les recettes
        function renderAllRecipes() {
            Object.keys(currentData.recipes).forEach(family => {
                renderRecipesForFamily(family);
            });
            // Pour les onglets personnalisés
            if (currentData.settings && currentData.settings.customTabs) {
                currentData.settings.customTabs.forEach((tab, idx) => {
                    renderRecipesForFamily('custom-' + idx);
                });
            }
        }

        function renderRecipesForFamily(family) {
            let container = document.getElementById(`recipes-${family}`);
            if (!container) {
                // Créer dynamiquement le conteneur si custom
                if (family.startsWith('custom-')) {
                    const mainContainer = document.querySelector('.main-container');
                    const div = document.createElement('div');
                    div.className = 'page-content';
                    div.id = 'page-' + family;
                    div.innerHTML = `<div class='recipes-controls'><h2 class='section-title'>${currentData.settings.customTabs[parseInt(family.split('-')[1])]?.icon || '📝'} ${currentData.settings.customTabs[parseInt(family.split('-')[1])]?.name || ''}</h2><div class="sort-controls"><label>Trier par :</label><select class="sort-select" data-family="${family}"><option value="name">Nom</option><option value="rating">Note</option><option value="date">Date</option><option value="status">Statut</option></select></div><button class='btn' onclick='openAddRecipeModal("${family}")'>➕ Ajouter Recette</button></div><div class='recipes-grid' id='recipes-${family}'></div>`;
                    mainContainer.appendChild(div);
                    container = document.getElementById(`recipes-${family}`);
                    
                    // Ajouter l'event listener pour le tri
                    const sortSelect = div.querySelector('.sort-select');
                    if (sortSelect) {
                        sortSelect.addEventListener('change', (e) => {
                            const family = e.target.getAttribute('data-family');
                            const sortBy = e.target.value;
                            sortAndRenderRecipes(family, sortBy);
                        });
                    }
                } else {
                    return;
                }
            }
            const recipes = currentData.recipes[family] || [];
            if (recipes.length === 0) {
                container.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--accent-brown);">📝 Aucune recette dans cette famille. Ajoutez votre première recette !</div>`;
                return;
            }
            container.innerHTML = recipes.map(recipe => createRecipeCard(recipe, family)).join('');
        }

        function createRecipeCard(recipe, family) {
            const ingredients = sortIngredientsByHierarchy(recipe.ingredients || []);
            const status = recipe.status || 'nouvelle';
            
            return `
                <div class="recipe-card" onclick="showRecipeDetail(${JSON.stringify(recipe).replace(/"/g, '&quot;')}, '${family}')">
                    <!-- Indicateur NEW uniquement pour les nouvelles recettes -->
                    ${status === 'nouvelle' ? '<div class="recipe-status-new">NEW</div>' : ''}
                    
                    <div class="recipe-name">${recipe.name}</div>
                    <div class="recipe-ingredients">
                        ${ingredients.slice(0, 5).map(ing => 
                            `• ${ing.name}: ${ing.quantity} ${ing.unit}`
                        ).join('<br>')}
                        ${ingredients.length > 5 ? '<br>...' : ''}
                    </div>
                    <div class="recipe-rating">
                        ${generateStars(recipe.rating || 0)}
                    </div>
                    <div class="recipe-comment">
                        ${truncateComment(recipe.comment || 'Aucun commentaire')}
                    </div>
                </div>
            `;
        }

        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<span class="star ${i <= rating ? '' : 'empty'}">★</span>`;
            }
            return stars;
        }

        function updateRecipeStatusFromSlider(recipeId, family, sliderValue) {
            const recipes = currentData.recipes[family] || [];
            const recipeIndex = recipes.findIndex(r => r.id === recipeId);
            
            if (recipeIndex !== -1) {
                const newStatus = sliderValue === '0' ? 'nouvelle' : 'validee';
                currentData.recipes[family][recipeIndex].status = newStatus;
                saveDataToStorage();
                renderRecipesForFamily(family);
                
                const statusLabels = {
                    'nouvelle': 'nouvelle',
                    'validee': 'validée'
                };
                
                showSuccessNotification(`Recette marquée comme ${statusLabels[newStatus]}`);
            }
        }

        function updateStatusValue(slider) {
            const statusValue = slider.parentElement.querySelector('.status-value');
            const value = slider.value === '0' ? 'Nouvelle' : 'Validée';
            statusValue.textContent = value;
        }

        function showSuccessNotification(message) {
            // Créer une notification discrète
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: var(--olive-green);
                color: white;
                padding: 0.8rem 1.2rem;
                border-radius: var(--border-radius);
                z-index: 5000;
                font-size: 0.9rem;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                animation: slideInRight 0.3s ease;
                max-width: 300px;
            `;
            
            // Ajouter l'animation CSS
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Supprimer après 3 secondes
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 2700);
        }

        function truncateComment(comment) {
            if (!comment) return 'Aucun procédé défini';
            
            // Diviser en lignes pour respecter la structure
            const lines = comment.split('\n');
            const maxLength = 100;
            
            // Si le texte est court, le retourner tel quel
            if (comment.length <= maxLength) {
                return comment;
            }
            
            // Essayer de garder les premières lignes complètes dans la limite
            let result = '';
            let totalLength = 0;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                // Si ajouter cette ligne dépasse la limite
                if (totalLength + line.length + (i > 0 ? 1 : 0) > maxLength) {
                    // Si on n'a encore rien ajouté, tronquer cette ligne
                    if (result === '') {
                        result = line.substring(0, maxLength - 3).trim() + '...';
                    } else {
                        result += '...';
                    }
                    break;
                }
                
                // Ajouter la ligne
                if (i > 0) result += '\n';
                result += line;
                totalLength += line.length + (i > 0 ? 1 : 0);
            }
            
            return result;
        }

        // Fonction pour obtenir le nom d'affichage d'une famille
        function getFamilyDisplayName(family) {
            if (!family) return 'Famille non définie';
            
            // Si c'est une famille personnalisée
            if (family.startsWith('custom-')) {
                const idx = parseInt(family.replace('custom-', ''));
                const customTab = currentData.settings.customTabs[idx];
                if (customTab) {
                    return `${customTab.icon} ${customTab.name}`;
                }
                return `Famille personnalisée ${idx + 1}`;
            }
            
            // Familles standard
            const familyNames = {
                'pain': '🥖 Pain',
                'pates': '🍝 Pâtes',
                'viennoiseries': '🥐 Viennoiseries'
            };
            
            return familyNames[family] || family.charAt(0).toUpperCase() + family.slice(1);
        }

        function sortIngredientsByHierarchy(ingredients) {
            if (!ingredients) return [];
            
            return [...ingredients].sort((a, b) => {
                const indexA = currentData.settings.ingredientHierarchy.indexOf(a.name);
                const indexB = currentData.settings.ingredientHierarchy.indexOf(b.name);
                
                // Si les deux sont dans la hiérarchie, utiliser l'ordre de la hiérarchie
                if (indexA !== -1 && indexB !== -1) {
                    return indexA - indexB;
                }
                
                // Si seul A est dans la hiérarchie, A vient en premier
                if (indexA !== -1) return -1;
                
                // Si seul B est dans la hiérarchie, B vient en premier
                if (indexB !== -1) return 1;
                
                // Si aucun n'est dans la hiérarchie, ordre alphabétique
                return a.name.localeCompare(b.name);
            });
        }

        function sortAndRenderRecipes(family, sortBy) {
            const recipes = currentData.recipes[family] || [];
            
            recipes.sort((a, b) => {
                switch(sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'rating':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'date':
                        return new Date(b.createdDate || 0) - new Date(a.createdDate || 0);
                    case 'status':
                        // Ordre de priorité : nouvelle, validee
                        const statusOrder = { 'nouvelle': 0, 'validee': 1 };
                        const statusA = statusOrder[a.status || 'nouvelle'] || 0;
                        const statusB = statusOrder[b.status || 'nouvelle'] || 0;
                        return statusA - statusB;
                    default:
                        return 0;
                }
            });
            
            renderRecipesForFamily(family);
        }

        function openAddRecipeModal(family) {
            showModal('Ajouter une Recette', `
                <form id="addRecipeForm">
                    <div class="form-group">
                        <label class="form-label">Nom de la recette *</label>
                        <input type="text" class="form-input" id="recipeName" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Note (1-5)</label>
                        <select class="form-select" id="recipeRating">
                            <option value="">-- Pas de note --</option>
                            <option value="1">⭐ 1</option>
                            <option value="2">⭐⭐ 2</option>
                            <option value="3">⭐⭐⭐ 3</option>
                            <option value="4">⭐⭐⭐⭐ 4</option>
                            <option value="5">⭐⭐⭐⭐⭐ 5</option>
                        </select>
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn" onclick="proceedToIngredients('${family}')">Suivant: Ingrédients</button>
                        <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
                    </div>
                </form>
            `);
        }



        function proceedToIngredients(family) {
            const form = document.getElementById('addRecipeForm');
            const formData = new FormData(form);
            
            const name = document.getElementById('recipeName').value.trim();
            
            if (!name) {
                alert('Veuillez remplir le nom de la recette');
                return;
            }
            
            // Initialiser la famille si elle n'existe pas encore
            if (!currentData.recipes[family]) {
                currentData.recipes[family] = [];
            }
            
            // Vérifier que le nom n'existe pas déjà
            if (currentData.recipes[family].some(r => r.name === name)) {
                alert('Une recette avec ce nom existe déjà dans cette famille');
                return;
            }
            
            const rating = document.getElementById('recipeRating').value;
            
            // Stocker temporairement les données de base
            window.tempRecipeData = {
                name,
                rating: rating ? parseInt(rating) : null,
                family,
                createdDate: new Date().toISOString()
            };
            
            showIngredientsModal();
        }

        function showIngredientsModal() {
            showModal('Ingrédients - ' + window.tempRecipeData.name, `
                <div class="mb-2">
                    <div class="flex flex-between flex-center">
                        <h4>Liste des ingrédients</h4>
                        <div class="btn-group">
                            <button type="button" class="btn-secondary" onclick="showAddIngredientForm()">🆕 Créer ingrédient</button>
                            <button type="button" class="btn" onclick="addIngredientRow()">➕ Ajouter ligne</button>
                        </div>
                    </div>
                </div>

                <div id="newIngredientForm" style="display: none; background: #f0f8ff; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem; border: 2px solid var(--olive-green);">
                    <h5 style="margin-bottom: 0.5rem; color: var(--olive-green);">Créer un nouvel ingrédient</h5>
                    <div class="flex gap-1">
                        <input type="text" id="newIngredientName" placeholder="Nom du nouvel ingrédient" class="form-input" style="flex: 1;" onkeypress="if(event.key==='Enter') createAndUseNewIngredient()">
                        <button type="button" class="btn" onclick="createAndUseNewIngredient()">✅ Créer</button>
                        <button type="button" class="btn-secondary" onclick="hideAddIngredientForm()">❌</button>
                    </div>
                </div>
                
                <div id="ingredientsList">
                    <div class="ingredient-row flex gap-1 mb-2">
                        <div style="flex: 2; position: relative;">
                            <input type="text" class="form-input ingredient-input" placeholder="Nom ingrédient" autocomplete="off" onkeyup="showIngredientSuggestions(this)" onfocus="showIngredientSuggestions(this)" onblur="hideIngredientSuggestions(this)">
                            <div class="ingredient-suggestions" style="display: none;"></div>
                        </div>
                        <input type="number" class="form-input" placeholder="Quantité" style="flex: 1;">
                        <select class="form-select" style="flex: 1;">
                            <option value="g">g</option>
                            <option value="kg">kg</option>
                            <option value="ml">ml</option>
                            <option value="cl">cl</option>
                            <option value="l">l</option>
                            <option value="cuillères">cuillères</option>
                            <option value="pièces">pièces</option>
                        </select>
                        <button type="button" class="btn-danger" onclick="removeIngredientRow(this)" style="flex: 0;">🗑️</button>
                    </div>
                </div>
                
                <div class="btn-group mt-2">
                    <button type="button" class="btn" onclick="proceedToProcedure()">Suivant: Procédé</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
                </div>
            `, true); // true pour utiliser la classe large
        }

        function addIngredientRow() {
            const container = document.getElementById('ingredientsList');
            const newRow = document.createElement('div');
            newRow.className = 'ingredient-row flex gap-1 mb-2';
            newRow.innerHTML = `
                <div style="flex: 2; position: relative;">
                    <input type="text" class="form-input ingredient-input" placeholder="Nom ingrédient" autocomplete="off" onkeyup="showIngredientSuggestions(this)" onfocus="showIngredientSuggestions(this)" onblur="hideIngredientSuggestions(this)">
                    <div class="ingredient-suggestions" style="display: none;"></div>
                </div>
                <input type="number" class="form-input" placeholder="Quantité" style="flex: 1;">
                <select class="form-select" style="flex: 1;">
                    <option value="g">g</option>
                    <option value="kg">kg</option>
                    <option value="ml">ml</option>
                    <option value="cl">cl</option>
                    <option value="l">l</option>
                    <option value="cuillères">cuillères</option>
                    <option value="pièces">pièces</option>
                </select>
                <button type="button" class="btn-danger" onclick="removeIngredientRow(this)" style="flex: 0;">🗑️</button>
            `;
            container.appendChild(newRow);
        }

        function removeIngredientRow(button) {
            if (document.querySelectorAll('.ingredient-row').length > 1) {
                button.parentElement.remove();
            } else {
                alert('Vous devez garder au moins un ingrédient');
            }
        }

        // Fonctions pour l'auto-complétion des ingrédients
        function showIngredientSuggestions(input) {
            const suggestionBox = input.parentElement.querySelector('.ingredient-suggestions');
            const query = input.value.toLowerCase().trim();
            
            if (query.length === 0) {
                // Afficher les ingrédients les plus fréquemment utilisés
                displayMostUsedIngredients(suggestionBox);
                return;
            }
            
            // Recherche améliorée : début de mot en priorité, puis inclusion
            const availableIngredients = currentData.settings.ingredientHierarchy || [];
            const matchingIngredients = availableIngredients.filter(ingredient => {
                const ingredientLower = ingredient.toLowerCase();
                const queryLower = query.toLowerCase();
                
                // Recherche par début de mot (priorité haute)
                if (ingredientLower.startsWith(queryLower)) {
                    return true;
                }
                
                // Recherche par inclusion (priorité basse)
                if (ingredientLower.includes(queryLower)) {
                    return true;
                }
                
                return false;
            });
            
            // Trier par pertinence : début de mot en premier, puis inclusion
            matchingIngredients.sort((a, b) => {
                const aLower = a.toLowerCase();
                const bLower = b.toLowerCase();
                const queryLower = query.toLowerCase();
                
                const aStartsWith = aLower.startsWith(queryLower);
                const bStartsWith = bLower.startsWith(queryLower);
                
                if (aStartsWith && !bStartsWith) return -1;
                if (!aStartsWith && bStartsWith) return 1;
                
                return aLower.localeCompare(bLower);
            });
            
            if (matchingIngredients.length === 0) {
                // Proposer d'ajouter le nouvel ingrédient
                suggestionBox.innerHTML = `
                    <div class="suggestion-item" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee; color: var(--olive-green); font-weight: bold;" onclick="proposeNewIngredient('${input.value}', this)">
                        ➕ Ajouter "${input.value}" à la liste des ingrédients
                    </div>
                `;
            } else {
                suggestionBox.innerHTML = matchingIngredients.map(ingredient => `
                    <div class="suggestion-item" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectIngredient('${ingredient}', this)" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'">
                        ${ingredient}
                    </div>
                `).join('');
                
                // Ajouter l'option pour créer un nouvel ingrédient si la recherche ne correspond pas exactement
                if (!matchingIngredients.some(ing => ing.toLowerCase() === query)) {
                    suggestionBox.innerHTML += `
                        <div class="suggestion-item" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee; color: var(--olive-green); font-weight: bold;" onclick="proposeNewIngredient('${input.value}', this)">
                            ➕ Ajouter "${input.value}" à la liste des ingrédients
                        </div>
                    `;
                }
            }
            
            suggestionBox.style.display = 'block';
        }

        function displayAllIngredients(suggestionBox) {
            const availableIngredients = currentData.settings.ingredientHierarchy || [];
            suggestionBox.innerHTML = availableIngredients.map(ingredient => `
                <div class="suggestion-item" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee;" onclick="selectIngredient('${ingredient}', this)" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='white'">
                    ${ingredient}
                </div>
            `).join('');
            suggestionBox.style.display = 'block';
        }

        function displayMostUsedIngredients(suggestionBox) {
            const mostUsedIngredients = getMostUsedIngredients();
            const availableIngredients = currentData.settings.ingredientHierarchy || [];
            
            // Combiner les ingrédients les plus utilisés avec tous les ingrédients disponibles
            const allIngredients = [...new Set([...mostUsedIngredients, ...availableIngredients])];
            
            suggestionBox.innerHTML = allIngredients.map(ingredient => {
                const isMostUsed = mostUsedIngredients.includes(ingredient);
                const style = isMostUsed ? 
                    'padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee; background-color: #f8f9fa; font-weight: bold; color: var(--accent-brown);' :
                    'padding: 0.5rem; cursor: pointer; border-bottom: 1px solid #eee;';
                
                return `
                    <div class="suggestion-item" style="${style}" onclick="selectIngredient('${ingredient}', this)" onmouseover="this.style.backgroundColor='#f0f0f0'" onmouseout="this.style.backgroundColor='${isMostUsed ? '#f8f9fa' : 'white'}'">
                        ${isMostUsed ? '⭐ ' : ''}${ingredient}
                    </div>
                `;
            }).join('');
            
            suggestionBox.style.display = 'block';
        }

        function getMostUsedIngredients() {
            const ingredientCounts = {};
            
            // Compter l'utilisation de chaque ingrédient dans toutes les recettes
            Object.values(currentData.recipes).forEach(family => {
                family.forEach(recipe => {
                    if (recipe.ingredients) {
                        recipe.ingredients.forEach(ingredient => {
                            const ingredientName = ingredient.name;
                            ingredientCounts[ingredientName] = (ingredientCounts[ingredientName] || 0) + 1;
                        });
                    }
                });
            });
            
            // Trier par fréquence d'utilisation (décroissant)
            const sortedIngredients = Object.entries(ingredientCounts)
                .sort(([,a], [,b]) => b - a)
                .map(([name]) => name);
            
            // Retourner les 10 ingrédients les plus utilisés
            return sortedIngredients.slice(0, 10);
        }

        function selectIngredient(ingredient, element) {
            const input = element.parentElement.parentElement.querySelector('.ingredient-input');
            input.value = ingredient;
            hideIngredientSuggestions(input);
        }

        function hideIngredientSuggestions(input) {
            setTimeout(() => {
                const suggestionBox = input.parentElement.querySelector('.ingredient-suggestions');
                suggestionBox.style.display = 'none';
            }, 200); // Délai pour permettre le clic sur une suggestion
        }

        function proposeNewIngredient(ingredientName, element) {
            const input = element.parentElement.parentElement.querySelector('.ingredient-input');
            const cleanName = ingredientName.trim();
            
            if (confirm(`Voulez-vous ajouter "${cleanName}" à votre liste d'ingrédients ?\n\nCet ingrédient sera disponible pour toutes vos futures recettes.`)) {
                // Ajouter à la hiérarchie
                if (!currentData.settings.ingredientHierarchy.includes(cleanName)) {
                    currentData.settings.ingredientHierarchy.push(cleanName);
                    saveDataToStorage();
                }
                
                // Sélectionner l'ingrédient
                input.value = cleanName;
                hideIngredientSuggestions(input);
                
                // Notification de succès
                showSuccessNotification(`"${cleanName}" ajouté à vos ingrédients`);
            } else {
                hideIngredientSuggestions(input);
            }
        }

        function showAddIngredientForm() {
            const form = document.getElementById('newIngredientForm');
            form.style.display = 'block';
            document.getElementById('newIngredientName').focus();
        }

        function hideAddIngredientForm() {
            const form = document.getElementById('newIngredientForm');
            form.style.display = 'none';
            document.getElementById('newIngredientName').value = '';
        }

        function createAndUseNewIngredient() {
            const newIngredientName = document.getElementById('newIngredientName').value.trim();
            
            if (!newIngredientName) {
                alert('Veuillez saisir un nom d\'ingrédient');
                return;
            }
            
            // Vérifier si l'ingrédient existe déjà
            if (currentData.settings.ingredientHierarchy.includes(newIngredientName)) {
                alert('Cet ingrédient existe déjà dans votre liste');
                return;
            }
            
            // Ajouter à la hiérarchie
            currentData.settings.ingredientHierarchy.push(newIngredientName);
            saveDataToStorage();
            
            // Ajouter une nouvelle ligne d'ingrédient avec ce nom pré-rempli
            addIngredientRow();
            
            // Trouver la dernière ligne ajoutée et remplir le nom
            const lastRow = document.querySelector('#ingredientsList .ingredient-row:last-child');
            if (lastRow) {
                const nameInput = lastRow.querySelector('.ingredient-input');
                nameInput.value = newIngredientName;
                
                // Déplacer le focus sur la quantité
                const quantityInput = lastRow.querySelector('input[type="number"]');
                quantityInput.focus();
            }
            
            // Cacher le formulaire
            hideAddIngredientForm();
            
            // Notification de succès
            showSuccessNotification(`"${newIngredientName}" créé et ajouté à la recette`);
        }

        function showSuccessNotification(message) {
            const notification = document.createElement('div');
            notification.textContent = `✅ ${message}`;
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: var(--olive-green);
                color: white;
                padding: 1rem;
                border-radius: var(--border-radius);
                z-index: 3000;
                animation: slideIn 0.3s ease;
                max-width: 300px;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function createAndUseNewIngredientEdit() {
            const newIngredientName = document.getElementById('newIngredientName').value.trim();
            
            if (!newIngredientName) {
                alert('Veuillez saisir un nom d\'ingrédient');
                return;
            }
            
            // Vérifier si l'ingrédient existe déjà
            if (currentData.settings.ingredientHierarchy.includes(newIngredientName)) {
                alert('Cet ingrédient existe déjà dans votre liste');
                return;
            }
            
            // Ajouter à la hiérarchie
            currentData.settings.ingredientHierarchy.push(newIngredientName);
            saveDataToStorage();
            
            // Ajouter une nouvelle ligne d'ingrédient avec ce nom pré-rempli
            addEditIngredientRow();
            
            // Trouver la dernière ligne ajoutée et remplir le nom
            const lastRow = document.querySelector('#editIngredientsList .ingredient-row:last-child');
            if (lastRow) {
                const nameInput = lastRow.querySelector('.ingredient-input');
                nameInput.value = newIngredientName;
                
                // Déplacer le focus sur la quantité
                const quantityInput = lastRow.querySelector('input[type="number"]');
                quantityInput.focus();
            }
            
            // Cacher le formulaire
            hideAddIngredientForm();
            
            // Notification de succès
            showSuccessNotification(`"${newIngredientName}" créé et ajouté à la recette`);
        }

        function proceedToProcedure() {
            const ingredients = [];
            const rows = document.querySelectorAll('.ingredient-row');
            
            rows.forEach(row => {
                const nameInput = row.querySelector('.ingredient-input');
                const quantityInput = row.querySelector('input[type="number"]');
                const unitSelect = row.querySelector('select');
                const name = nameInput.value.trim();
                const quantity = quantityInput.value.trim();
                const unit = unitSelect.value;
                
                if (name && quantity) {
                    ingredients.push({ name, quantity, unit });
                }
            });
            
            if (ingredients.length === 0) {
                alert('Veuillez ajouter au moins un ingrédient');
                return;
            }
            
            // Stocker les ingrédients temporairement
            window.tempRecipeData.ingredients = sortIngredientsByHierarchy(ingredients);
            
            showProcedureModal();
        }

        function showProcedureModal() {
            showModal('Procédé - ' + window.tempRecipeData.name, `
                <div class="mb-2">
                    <h4>Récapitulatif de la recette</h4>
                    <div style="background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <p><strong>Nom :</strong> ${window.tempRecipeData.name}</p>
                        <p><strong>Note :</strong> ${window.tempRecipeData.rating ? '★'.repeat(window.tempRecipeData.rating) : 'Aucune'}</p>
                        <p><strong>Ingrédients :</strong> ${window.tempRecipeData.ingredients.length} ingrédient${window.tempRecipeData.ingredients.length > 1 ? 's' : ''}</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Procédé de fabrication *</label>
                    <textarea class="form-textarea" id="recipeProcedure" placeholder="Décrivez étape par étape le procédé de fabrication de cette recette..." rows="6"></textarea>
                </div>
                
                <div class="btn-group mt-2">
                    <button type="button" class="btn" onclick="saveRecipe()">💾 Sauvegarder Recette</button>
                    <button type="button" class="btn-secondary" onclick="showIngredientsModal()">Retour aux ingrédients</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
                </div>
            `);
        }

        function saveRecipe() {
            const procedure = document.getElementById('recipeProcedure').value.trim();
            
            const recipe = {
                ...window.tempRecipeData,
                comment: procedure, // On garde le nom "comment" en interne pour la compatibilité
                id: Date.now().toString(),
                status: 'nouvelle', // Statut par défaut pour les nouvelles recettes
                createdDate: new Date().toISOString() // Date de création
            };
            
            currentData.recipes[recipe.family].push(recipe);
            saveDataToStorage();
            renderRecipesForFamily(recipe.family);
            renderStats();
            renderTopRecipes();
            
            closeModal();
            delete window.tempRecipeData;
            
            alert('Recette ajoutée avec succès !');
        }

        function showRecipeDetail(recipe, family) {
            const ingredients = sortIngredientsByHierarchy(recipe.ingredients || []);
            const status = recipe.status || 'nouvelle';
            const statusLabels = {
                'nouvelle': 'Nouvelle',
                'validee': 'Validée'
            };
            
            showModal(recipe.name, `
                <div class="recipe-detail">
                    <div class="flex flex-between flex-center mb-2">
                        <div class="recipe-rating">
                            ${generateStars(recipe.rating || 0)}
                        </div>
                        <div class="recipe-status-slider">
                            <label style="font-size: 1rem; color: var(--accent-brown); font-weight: bold;">Statut :</label>
                            <input type="range" class="status-slider" min="0" max="1" value="${status === 'nouvelle' ? '0' : '1'}" 
                                   onchange="updateRecipeStatusFromSlider('${recipe.id}', '${family}', this.value)" 
                                   oninput="updateStatusValue(this)" 
                                   style="flex: 1; margin: 0 1rem; height: 8px;">
                            <span class="status-value" style="font-weight: bold; font-size: 1rem;">${status === 'nouvelle' ? 'Nouvelle' : 'Validée'}</span>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <h4>Ingrédients</h4>
                        <div style="background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius); margin: 1rem 0;">
                            ${ingredients.map(ing => 
                                `<div style="margin-bottom: 0.5rem;">• <strong>${ing.name}:</strong> ${ing.quantity} ${ing.unit}</div>`
                            ).join('')}
                        </div>
                    </div>
                    
                    ${recipe.comment ? `
                        <div class="mb-2">
                            <h4>Procédé</h4>
                            <div style="font-style: italic; padding: 1rem; background: #F9F9F9; border-radius: var(--border-radius); white-space: pre-line; line-height: 1.6;">
                                ${recipe.comment.trim()}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="mb-2">
                        <p><strong>Découverte le :</strong> ${new Date(recipe.createdDate).toLocaleDateString()}</p>
                        <p><strong>Famille :</strong> ${family}</p>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn-secondary" onclick="editRecipe('${recipe.id}', '${family}')">✏️ Modifier</button>
                        <button class="btn-danger" onclick="deleteRecipe('${recipe.id}', '${family}')">🗑️ Supprimer</button>
                        <button class="btn" onclick="closeModal()">Fermer</button>
                    </div>
                </div>
            `);
        }

        function editRecipe(recipeId, family) {
            const recipe = currentData.recipes[family].find(r => r.id === recipeId);
            if (!recipe) return;
            
            // Fermer la modal de détail actuelle
            closeModal();
            
            const familyOptions = Object.keys(currentData.recipes).map(fam => 
                `<option value="${fam}" ${family === fam ? 'selected' : ''}>${fam.charAt(0).toUpperCase() + fam.slice(1)}</option>`
            ).join('');
            
            // Ajouter les onglets personnalisés
            const customFamilyOptions = currentData.settings.customTabs.map((tab, idx) =>
                `<option value="custom-${idx}" ${family === `custom-${idx}` ? 'selected' : ''}>${tab.icon} ${tab.name}</option>`
            ).join('');
            
            showModal('Modifier la Recette', `
                <form id="editRecipeForm">
                    <div class="form-group">
                        <label class="form-label">Nom de la recette *</label>
                        <input type="text" class="form-input" id="editRecipeName" value="${recipe.name}" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Famille *</label>
                        <select class="form-select" id="editRecipeFamily" required>
                            ${familyOptions}
                            ${customFamilyOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Note (1-5)</label>
                        <select class="form-select" id="editRecipeRating">
                            <option value="">-- Pas de note --</option>
                            <option value="1" ${recipe.rating === 1 ? 'selected' : ''}>⭐ 1</option>
                            <option value="2" ${recipe.rating === 2 ? 'selected' : ''}>⭐⭐ 2</option>
                            <option value="3" ${recipe.rating === 3 ? 'selected' : ''}>⭐⭐⭐ 3</option>
                            <option value="4" ${recipe.rating === 4 ? 'selected' : ''}>⭐⭐⭐⭐ 4</option>
                            <option value="5" ${recipe.rating === 5 ? 'selected' : ''}>⭐⭐⭐⭐⭐ 5</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Procédé</label>
                        <textarea class="form-textarea" id="editRecipeComment" placeholder="Décrivez le procédé de fabrication...">${recipe.comment || ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Date de découverte</label>
                        <input type="date" class="form-input" id="editRecipeDate" value="${new Date(recipe.createdDate).toISOString().split('T')[0]}">
                    </div>
                    
                    <div class="btn-group">
                        <button type="button" class="btn" onclick="proceedToEditIngredients('${recipeId}', '${family}')">Suivant: Ingrédients</button>
                        <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
                    </div>
                </form>
            `);
        }

        function proceedToEditIngredients(recipeId, originalFamily) {
            const recipe = currentData.recipes[originalFamily].find(r => r.id === recipeId);
            if (!recipe) return;
            
            const name = document.getElementById('editRecipeName').value.trim();
            const newFamily = document.getElementById('editRecipeFamily').value;
            
            if (!name || !newFamily) {
                alert('Veuillez remplir les champs obligatoires');
                return;
            }
            
            // Vérifier que le nom n'existe pas déjà dans la nouvelle famille (sauf si c'est la même recette)
            const existingRecipe = currentData.recipes[newFamily].find(r => r.name === name && r.id !== recipeId);
            if (existingRecipe) {
                alert('Une recette avec ce nom existe déjà dans cette famille');
                return;
            }
            
            const rating = document.getElementById('editRecipeRating').value;
            const comment = document.getElementById('editRecipeComment').value.trim();
            const createdDate = document.getElementById('editRecipeDate').value;
            
            // Stocker temporairement les données de modification
            window.tempEditData = {
                recipeId,
                originalFamily,
                name,
                newFamily,
                rating: rating ? parseInt(rating) : null,
                comment,
                createdDate: createdDate ? new Date(createdDate).toISOString() : recipe.createdDate,
                originalIngredients: recipe.ingredients || []
            };
            
            showEditIngredientsModal();
        }

        function showEditIngredientsModal() {
            const ingredients = window.tempEditData.originalIngredients;
            
            showModal('Modifier les Ingrédients - ' + window.tempEditData.name, `
                <div class="mb-2">
                    <div class="flex flex-between flex-center">
                        <h4>Liste des ingrédients</h4>
                        <div class="btn-group">
                            <button type="button" class="btn-secondary" onclick="showAddIngredientForm()">🆕 Créer ingrédient</button>
                            <button type="button" class="btn" onclick="addEditIngredientRow()">➕ Ajouter ligne</button>
                        </div>
                    </div>
                </div>

                <div id="newIngredientForm" style="display: none; background: #f0f8ff; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem; border: 2px solid var(--olive-green);">
                    <h5 style="margin-bottom: 0.5rem; color: var(--olive-green);">Créer un nouvel ingrédient</h5>
                    <div class="flex gap-1">
                        <input type="text" id="newIngredientName" placeholder="Nom du nouvel ingrédient" class="form-input" style="flex: 1;" onkeypress="if(event.key==='Enter') createAndUseNewIngredientEdit()">
                        <button type="button" class="btn" onclick="createAndUseNewIngredientEdit()">✅ Créer</button>
                        <button type="button" class="btn-secondary" onclick="hideAddIngredientForm()">❌</button>
                    </div>
                </div>
                
                <div id="editIngredientsList">
                    ${ingredients.map(ing => `
                        <div class="ingredient-row flex gap-1 mb-2">
                            <div style="flex: 2; position: relative;">
                                <input type="text" class="form-input ingredient-input" placeholder="Nom ingrédient" value="${ing.name}" autocomplete="off" onkeyup="showIngredientSuggestions(this)" onfocus="showIngredientSuggestions(this)" onblur="hideIngredientSuggestions(this)">
                                <div class="ingredient-suggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--accent-brown); border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
                            </div>
                            <input type="number" class="form-input" placeholder="Quantité" value="${ing.quantity}" style="flex: 1;">
                            <select class="form-select" style="flex: 1;">
                                <option value="g" ${ing.unit === 'g' ? 'selected' : ''}>g</option>
                                <option value="kg" ${ing.unit === 'kg' ? 'selected' : ''}>kg</option>
                                <option value="ml" ${ing.unit === 'ml' ? 'selected' : ''}>ml</option>
                                <option value="cl" ${ing.unit === 'cl' ? 'selected' : ''}>cl</option>
                                <option value="l" ${ing.unit === 'l' ? 'selected' : ''}>l</option>
                                <option value="cuillères" ${ing.unit === 'cuillères' ? 'selected' : ''}>cuillères</option>
                                <option value="pièces" ${ing.unit === 'pièces' ? 'selected' : ''}>pièces</option>
                            </select>
                            <button type="button" class="btn-danger" onclick="removeIngredientRow(this)" style="flex: 0;">🗑️</button>
                        </div>
                    `).join('')}
                    ${ingredients.length === 0 ? `
                        <div class="ingredient-row flex gap-1 mb-2">
                            <div style="flex: 2; position: relative;">
                                <input type="text" class="form-input ingredient-input" placeholder="Nom ingrédient" autocomplete="off" onkeyup="showIngredientSuggestions(this)" onfocus="showIngredientSuggestions(this)" onblur="hideIngredientSuggestions(this)">
                                <div class="ingredient-suggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid var(--accent-brown); border-top: none; max-height: 200px; overflow-y: auto; z-index: 1000;"></div>
                            </div>
                            <input type="number" class="form-input" placeholder="Quantité" style="flex: 1;">
                            <select class="form-select" style="flex: 1;">
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                                <option value="ml">ml</option>
                                <option value="cl">cl</option>
                                <option value="l">l</option>
                                <option value="cuillères">cuillères</option>
                                <option value="pièces">pièces</option>
                            </select>
                            <button type="button" class="btn-danger" onclick="removeIngredientRow(this)" style="flex: 0;">🗑️</button>
                        </div>
                    ` : ''}
                </div>
                
                <div class="btn-group mt-2">
                    <button type="button" class="btn" onclick="saveEditedRecipe()">💾 Sauvegarder Modifications</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Annuler</button>
                </div>
            `, true); // true pour utiliser la classe large
        }

        function addEditIngredientRow() {
            const container = document.getElementById('editIngredientsList');
            const newRow = document.createElement('div');
            newRow.className = 'ingredient-row flex gap-1 mb-2';
            newRow.innerHTML = `
                <div style="flex: 2; position: relative;">
                    <input type="text" class="form-input ingredient-input" placeholder="Nom ingrédient" autocomplete="off" onkeyup="showIngredientSuggestions(this)" onfocus="showIngredientSuggestions(this)" onblur="hideIngredientSuggestions(this)">
                    <div class="ingredient-suggestions" style="display: none;"></div>
                </div>
                <input type="number" class="form-input" placeholder="Quantité" style="flex: 1;">
                <select class="form-select" style="flex: 1;">
                    <option value="g">g</option>
                    <option value="kg">kg</option>
                    <option value="ml">ml</option>
                    <option value="cl">cl</option>
                    <option value="l">l</option>
                    <option value="cuillères">cuillères</option>
                    <option value="pièces">pièces</option>
                </select>
                <button type="button" class="btn-danger" onclick="removeIngredientRow(this)" style="flex: 0;">🗑️</button>
            `;
            container.appendChild(newRow);
        }

        function saveEditedRecipe() {
            const ingredients = [];
            const rows = document.querySelectorAll('#editIngredientsList .ingredient-row');
            
            rows.forEach(row => {
                const nameInput = row.querySelector('.ingredient-input');
                const quantityInput = row.querySelector('input[type="number"]');
                const unitSelect = row.querySelector('select');
                const name = nameInput.value.trim();
                const quantity = quantityInput.value.trim();
                const unit = unitSelect.value;
                
                if (name && quantity) {
                    ingredients.push({ name, quantity, unit });
                }
            });
            
            if (ingredients.length === 0) {
                alert('Veuillez ajouter au moins un ingrédient');
                return;
            }
            
            // Trier les ingrédients selon l'ordre de priorité défini dans les paramètres
            const sortedIngredients = sortIngredientsByHierarchy(ingredients);
            
            const { recipeId, originalFamily, newFamily, name, rating, comment, createdDate } = window.tempEditData;
            
            // Trouver la recette originale
            const recipeIndex = currentData.recipes[originalFamily].findIndex(r => r.id === recipeId);
            if (recipeIndex === -1) return;
            
            const originalRecipe = currentData.recipes[originalFamily][recipeIndex];
            
            // Créer la recette modifiée
            const editedRecipe = {
                ...originalRecipe,
                name,
                rating,
                comment,
                createdDate: createdDate,
                ingredients: sortedIngredients,
                modifiedDate: new Date().toISOString()
            };
            
            // Si la famille a changé, déplacer la recette
            if (originalFamily !== newFamily) {
                // Supprimer de l'ancienne famille
                currentData.recipes[originalFamily].splice(recipeIndex, 1);
                
                // Ajouter à la nouvelle famille
                if (!currentData.recipes[newFamily]) {
                    currentData.recipes[newFamily] = [];
                }
                currentData.recipes[newFamily].push(editedRecipe);
                
                // Rafraîchir les deux familles
                renderRecipesForFamily(originalFamily);
                renderRecipesForFamily(newFamily);
                
                alert(`Recette modifiée et déplacée vers ${newFamily} !`);
            } else {
                // Remplacer dans la même famille
                currentData.recipes[originalFamily][recipeIndex] = editedRecipe;
                renderRecipesForFamily(originalFamily);
                alert('Recette modifiée avec succès !');
            }
            
            saveDataToStorage();
            renderStats();
            renderTopRecipes();
            
            closeModal();
            delete window.tempEditData;
        }

        function deleteRecipe(recipeId, family) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cette recette ?')) {
                currentData.recipes[family] = currentData.recipes[family].filter(r => r.id !== recipeId);
                saveDataToStorage();
                renderRecipesForFamily(family);
                renderStats();
                renderTopRecipes();
                closeModal();
                alert('Recette supprimée');
            }
        }

        // Fonction utilitaire pour les modales
        function showModal(title, content, large = false) {
            const modalContainer = document.getElementById('modalContainer');
            
            // Utiliser automatiquement la classe large pour la répartition des recettes
            const shouldBeLarge = large || title === 'Répartition des Recettes';
            
            modalContainer.innerHTML = `
                <div class="modal active" onclick="handleModalClick(event)">
                    <div class="modal-content ${shouldBeLarge ? 'large' : ''}">
                        <div class="modal-header">
                            <h2 class="modal-title">${title}</h2>
                            <button class="close-btn" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${content}
                        </div>
                    </div>
                </div>
            `;
            
            // Initialiser les améliorations du graphique si c'est la répartition des recettes
            if (title === 'Répartition des Recettes') {
                setTimeout(() => {
                    enhanceChartInteractivity();
                    initializeChartEnhancements();
                }, 100);
            }
        }

        // Fonction pour gérer le clic sur la modale
        function handleModalClick(event) {
            // Si on clique sur le fond de la modale (pas sur le contenu), fermer la modale
            if (event.target.classList.contains('modal')) {
                closeModal();
            }
        }

        function closeModal() {
            // Nettoyer les ressources audio si la modale audio est ouverte
            if (isRecording) {
                cleanupAudioResources();
            }
            
            const modalContainer = document.getElementById('modalContainer');
            modalContainer.innerHTML = '';
        }

        // Export des données
        function exportData() {
            // Vérification de l'intégrité des données avant export
            const dataToExport = {
                recipes: currentData.recipes || {},
                levains: currentData.levains || [],
                gallery: currentData.gallery || [],
                settings: {
                    ingredientHierarchy: currentData.settings?.ingredientHierarchy || ['Farine T65', 'Farine T45', 'Farine T00', 'Eau', 'Sel', 'Levure sèche', 'Levain liquide', 'Sucre', 'Beurre', 'Œufs', 'Lait'],
                    customTabs: currentData.settings?.customTabs || []
                },
                              // Données BETA
              beta: {
                  ingredientsPersonnalises: JSON.parse(localStorage.getItem('ingredientsPersonnalises')) || [],
                  listeCourses: JSON.parse(localStorage.getItem('listeCourses')) || [],
                  levainsData: JSON.parse(localStorage.getItem('levainsData')) || [],
                  ingredientsData: JSON.parse(localStorage.getItem('ingredientsData')) || [],
                  recettesPasAPas: JSON.parse(localStorage.getItem('recettesPasAPas')) || [],
                  iaPredictiveData: JSON.parse(localStorage.getItem('iaPredictiveData')) || []
              },
                              exportDate: new Date().toISOString(),
              version: '1.4'
            };
            
            // Compter les éléments pour confirmation
            const recipeCount = Object.values(dataToExport.recipes).flat().length;
            const levainCount = dataToExport.levains.length;
            const imageCount = dataToExport.gallery.length;
            const customTabCount = dataToExport.settings.customTabs.length;
            
            console.log('Export summary:', {
                recipes: recipeCount,
                levains: levainCount,
                images: imageCount,
                customTabs: customTabCount,
                ingredientHierarchy: dataToExport.settings.ingredientHierarchy.length
            });
            
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `boulangerie-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`Données exportées avec succès !\n\n📊 Résumé :\n• ${recipeCount} recette${recipeCount > 1 ? 's' : ''}\n• ${levainCount} levain${levainCount > 1 ? 's' : ''}\n• ${imageCount} image${imageCount > 1 ? 's' : ''}\n• ${customTabCount} famille${customTabCount > 1 ? 's' : ''} personnalisée${customTabCount > 1 ? 's' : ''}`);
        }

        // Import des données
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    // Vérification de l'intégrité des données importées
                    if (!imported || typeof imported !== 'object') {
                        throw new Error('Format de fichier invalide');
                    }
                    
                    // Compter les éléments importés
                    const recipeCount = imported.recipes ? Object.values(imported.recipes).flat().length : 0;
                    const levainCount = imported.levains ? imported.levains.length : 0;
                    const imageCount = imported.gallery ? imported.gallery.length : 0;
                    const customTabCount = imported.settings?.customTabs ? imported.settings.customTabs.length : 0;
                    
                    // Compter les données BETA
                    const ingredientsPersonnalisesCount = imported.beta?.ingredientsPersonnalises ? imported.beta.ingredientsPersonnalises.length : 0;
                    const listeCoursesCount = imported.beta?.listeCourses ? imported.beta.listeCourses.length : 0;
                    
                    let confirmMessage = `Cette action remplacera toutes vos données actuelles.\n\n📊 Données à importer :\n• ${recipeCount} recette${recipeCount > 1 ? 's' : ''}\n• ${levainCount} levain${levainCount > 1 ? 's' : ''}\n• ${imageCount} image${imageCount > 1 ? 's' : ''}\n• ${customTabCount} famille${customTabCount > 1 ? 's' : ''} personnalisée${customTabCount > 1 ? 's' : ''}`;
                    
                    if (imported.beta) {
                        confirmMessage += `\n\n🧪 Données BETA :\n• ${ingredientsPersonnalisesCount} ingrédient${ingredientsPersonnalisesCount > 1 ? 's' : ''} personnalisé${ingredientsPersonnalisesCount > 1 ? 's' : ''}\n• ${listeCoursesCount} article${listeCoursesCount > 1 ? 's' : ''} en liste de courses`;
                    }
                    
                    confirmMessage += `\n\nÊtes-vous sûr ?`;
                    
                    if (confirm(confirmMessage)) {
                        // Restructurer les données importées pour assurer la compatibilité
                        currentData = {
                            recipes: imported.recipes || {},
                            levains: imported.levains || [],
                            gallery: imported.gallery || [],
                            settings: {
                                ingredientHierarchy: imported.settings?.ingredientHierarchy || ['Farine T65', 'Farine T45', 'Farine T00', 'Eau', 'Sel', 'Levure sèche', 'Levain liquide', 'Sucre', 'Beurre', 'Œufs', 'Lait'],
                                customTabs: imported.settings?.customTabs || []
                            }
                        };
                        
                        console.log('Import summary:', {
                            recipes: recipeCount,
                            levains: levainCount,
                            images: imageCount,
                            customTabs: customTabCount,
                            version: imported.version || 'inconnue'
                        });
                        
                        // Importer les données BETA si disponibles
                        if (imported.beta) {
                            if (imported.beta.ingredientsPersonnalises) {
                                localStorage.setItem('ingredientsPersonnalises', JSON.stringify(imported.beta.ingredientsPersonnalises));
                            }
                            if (imported.beta.listeCourses) {
                                localStorage.setItem('listeCourses', JSON.stringify(imported.beta.listeCourses));
                            }
                            if (imported.beta.levainsData) {
                                localStorage.setItem('levainsData', JSON.stringify(imported.beta.levainsData));
                            }
                                              if (imported.beta.ingredientsData) {
                      localStorage.setItem('ingredientsData', JSON.stringify(imported.beta.ingredientsData));
                  }
                  if (imported.beta.recettesPasAPas) {
                      localStorage.setItem('recettesPasAPas', JSON.stringify(imported.beta.recettesPasAPas));
                  }
                  if (imported.beta.iaPredictiveData) {
                      localStorage.setItem('iaPredictiveData', JSON.stringify(imported.beta.iaPredictiveData));
                  }
                        }
                        
                        saveDataToStorage();
                        location.reload(); // Recharge la page pour appliquer les nouvelles données
                    }
                } catch (error) {
                    console.error('Erreur d\'import:', error);
                    alert(`Erreur lors de l'import :\n${error.message}\n\nVérifiez que le fichier est un export valide de l'application.`);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // Suite du JavaScript - Partie 3 - Gestion des Levains

        // Fonctions pour la gestion des levains
        function renderLevains() {
            const container = document.getElementById('levainsGrid');
            
            if (currentData.levains.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: var(--accent-brown);">
                        🧄 Aucun levain pour le moment. Créez votre premier levain !
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentData.levains.map(levain => createLevainCard(levain)).join('');
            
            // Ajouter l'animation de bulles pour chaque vignette de levain
            setTimeout(() => {
                currentData.levains.forEach(levain => {
                    setupLevainCardBubbles(levain);
                });
            }, 100);
        }

        function getLevainAvatar(timeSinceRefresh, phase) {
            if (phase === 'birth') {
                return '🐣'; // Levain en naissance
            }
            
            const days = timeSinceRefresh.days;
            
            if (days <= 7) {
                return '😊'; // Heureux - moins d'1 semaine
            } else if (days <= 14) {
                return '😐'; // Moins heureux - 1-2 semaines  
            } else if (days <= 21) {
                return '😕'; // Un peu inquiet - 2-3 semaines
            } else {
                return '😴'; // Fatigué/soif - plus de 3 semaines
            }
        }

        function createLevainCard(levain) {
            const timeSinceRefresh = calculateTimeSinceRefresh(levain.lastRefresh);
            const age = calculateLevainAge(levain.createdDate);
            const isWarning = timeSinceRefresh.days > 3;
            const avatar = getLevainAvatar(timeSinceRefresh, levain.phase);
            
            return `
                <div class="levain-card levain-card-${levain.id}" onclick="showLevainDetailModal('${levain.id}')" data-levain-id="${levain.id}" data-days-since="${timeSinceRefresh.days}">
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <div class="levain-avatar" style="font-size: 3rem; margin-bottom: 0.5rem;">${avatar}</div>
                    </div>
                    <div class="levain-name">${levain.name}</div>
                    <div class="levain-status">
                        <div class="time-since-refresh ${isWarning ? 'warning' : ''}">
                            ⏰ ${timeSinceRefresh.text}
                        </div>
                        <div class="levain-age">
                            🎂 ${age.text}
                        </div>
                    </div>
                    <div style="margin-top: 1rem;">
                        <button class="refresh-btn" onclick="event.stopPropagation(); confirmRefreshLevain('${levain.id}', '${levain.name}')">
                            🔄 Rafraîchir
                        </button>
                    </div>
                    ${levain.phase === 'birth' ? `
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: var(--olive-green);">
                            🐣 Phase naissance - Étape ${levain.currentStep || 1}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function calculateTimeSinceRefresh(lastRefresh) {
            if (!lastRefresh) {
                return { days: 999, text: 'Jamais rafraîchi' };
            }
            
            const now = new Date();
            const refreshDate = new Date(lastRefresh);
            const diffMs = now - refreshDate;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            
            if (diffDays === 0) {
                if (diffHours === 0) {
                    return { days: 0, text: 'Moins d\'1 heure' };
                }
                return { days: 0, text: `Il y a ${diffHours}h` };
            } else if (diffDays === 1) {
                return { days: 1, text: 'Il y a 1 jour' };
            } else {
                return { days: diffDays, text: `Il y a ${diffDays} jours` };
            }
        }

        function calculateLevainAge(createdDate) {
            if (!createdDate) return { days: 0, text: '0 jour' };
            
            const now = new Date();
            const created = new Date(createdDate);
            
            let years = now.getFullYear() - created.getFullYear();
            let months = now.getMonth() - created.getMonth();
            let days = now.getDate() - created.getDate();
            
            // Ajuster si les jours sont négatifs
            if (days < 0) {
                months--;
                const daysInPrevMonth = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
                days += daysInPrevMonth;
            }
            
            // Ajuster si les mois sont négatifs
            if (months < 0) {
                years--;
                months += 12;
            }
            
            // Construire le texte d'affichage (sans les jours)
            let text = '';
            if (years > 0) {
                text += `${years} an${years > 1 ? 's' : ''}`;
            }
            if (months > 0) {
                if (text) text += ' et ';
                text += `${months} mois`;
            }
            
            // Si moins d'un mois, afficher "moins d'1 mois"
            if (!years && !months) {
                text = 'moins d\'1 mois';
            }
            
            const totalDays = Math.floor((now - created) / (1000 * 60 * 60 * 24));
            
            return { days: totalDays, text: text };
        }

        function openAddLevainModal() {
            showModal('Créer un Levain', `
                <div class="text-center mb-2">
                    <h3>Quel type de levain souhaitez-vous créer ?</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
                    <div class="levain-type-card" onclick="startNewLevain()" style="cursor: pointer; padding: 2rem; background: var(--cream-white); border: 2px solid var(--olive-green); border-radius: var(--border-radius); text-align: center; transition: all 0.3s ease;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🐣</div>
                        <h4>Nouveau Levain</h4>
                        <p>Phase naissance avec guide étape par étape</p>
                    </div>
                    
                    <div class="levain-type-card" onclick="addExistingLevain()" style="cursor: pointer; padding: 2rem; background: var(--cream-white); border: 2px solid var(--olive-green); border-radius: var(--border-radius); text-align: center; transition: all 0.3s ease;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">🏆</div>
                        <h4>Levain Existant</h4>
                        <p>Ajouter un levain déjà mature</p>
                    </div>
                </div>
                
                <style>
                    .levain-type-card:hover {
                        transform: translateY(-5px);
                        box-shadow: 0 4px 16px rgba(139, 69, 19, 0.3);
                    }
                </style>
                
                <div class="text-center">
                    <button class="btn-secondary" onclick="closeModal()">Annuler</button>
                </div>
            `);
        }

        function startNewLevain() {
            showModal('Nouveau Levain - Phase Naissance', `
                <div class="tamagotchi-container">
                    <div class="levain-avatar">🥖</div>
                    <h3>Bienvenue dans l'aventure levain !</h3>
                    <p>Votre petit levain va naître et grandir sous vos soins attentifs.</p>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Donnez un nom à votre levain</label>
                    <input type="text" class="form-input" id="newLevainName" placeholder="Ex: Bubulle, Levainstein, Pépé Pain...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Choisissez une recette de démarrage</label>
                    <select class="form-select" id="startingRecipe">
                        <option value="pomme">🍎 Démarrage avec pomme fermentée (4 jours)</option>
                        <option value="classique">🌾 Démarrage classique farine/eau (7 jours)</option>
                        <option value="autre">📝 Autre</option>
                    </select>
                </div>
                
                <div class="form-group" id="customRecipeGroup" style="display: none;">
                    <label class="form-label">Nom de votre recette personnalisée</label>
                    <input type="text" class="form-input" id="customRecipeName" placeholder="Ex: Démarrage au miel, Levain express...">
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="createNewLevain()">🐣 Commencer l'aventure</button>
                    <button class="btn-secondary" onclick="closeModal()">Annuler</button>
                </div>
            `);
            
            // Gérer l'affichage du champ personnalisé
            document.getElementById('startingRecipe').addEventListener('change', function() {
                const customGroup = document.getElementById('customRecipeGroup');
                if (this.value === 'autre') {
                    customGroup.style.display = 'block';
                } else {
                    customGroup.style.display = 'none';
                }
            });
        }

        function createNewLevain() {
            const name = document.getElementById('newLevainName').value.trim();
            const recipe = document.getElementById('startingRecipe').value;
            let recipeName = recipe;
            
            if (!name) {
                alert('Veuillez donner un nom à votre levain');
                return;
            }
            
            // Gérer le cas "Autre" avec nom personnalisé
            if (recipe === 'autre') {
                const customName = document.getElementById('customRecipeName').value.trim();
                if (!customName) {
                    alert('Veuillez saisir le nom de votre recette personnalisée');
                    return;
                }
                recipeName = 'autre';
            }
            
            const newLevain = {
                id: Date.now().toString(),
                name: name,
                createdDate: new Date().toISOString(),
                lastRefresh: null,
                phase: 'birth',
                recipe: recipeName,
                customRecipeName: recipe === 'autre' ? document.getElementById('customRecipeName').value.trim() : null,
                currentStep: 1,
                notes: [],
                birthSteps: getBirthSteps(recipeName)
            };
            
            currentData.levains.push(newLevain);
            saveDataToStorage();
            renderLevains();
            renderStats();
            closeModal();
            
            // Lancer immédiatement la phase naissance
            startBirthPhase(newLevain.id);
        }

        function getBirthSteps(recipe) {
            const steps = {
                pomme: [
                    { step: 1, title: "Recette de démarrage", description: "Pomme en morceaux 170gr - Miel 30gr - Eau tiède 300gr. Laisser reposer 48 heures à température ambiante. Cela va commencer à mousser et sentir la fermentation rapidement.", duration: 0, action: "mix" },
                    { step: 2, title: "Premier mélange", description: "Filtrer 250gr de jus et mélanger avec 150gr de farine T65 de qualité, toujours :) Laisser reposer 24h. à température ambiante.", duration: 0, action: "wait" },
                    { step: 3, title: "Deuxième fermentation", description: "Continuer la fermentation à température ambiante 24 heures.", duration: 0, action: "wait" },
                    { step: 4, title: "Premier rafraîchissement", description: "Mélanger 200gr de votre souche de levain mère avec 100 gr d'eau et 150 gr de farine T65 (à ajuster l'eau les prochaines fois en fonctions de vos paramètres personnels). Rafraîchissez-le tous les 5 à 10 jours s'il est au frigo. Il doublera de volume quand il sera actif. Attendez ce moment précis pour l'utiliser avec un résultat optimal.", duration: 0, action: "mature" }
                ],
                classique: [
                    { step: 1, title: "Mélange initial", description: "Mélanger 50g de farine T65 + 50g d'eau", duration: 0, action: "mix" },
                    { step: 2, title: "Premier repos", description: "Couvrir et laisser 24h à température ambiante", duration: 1440, action: "wait" },
                    { step: 3, title: "Premier rafraîchissement", description: "Jeter la moitié, ajouter 25g farine + 25g eau", duration: 0, action: "refresh" },
                    { step: 4, title: "Deuxième repos", description: "Laisser fermenter 24h", duration: 1440, action: "wait" },
                    { step: 5, title: "Deuxième rafraîchissement", description: "Répéter l'opération: jeter moitié, ajouter farine+eau", duration: 0, action: "refresh" },
                    { step: 6, title: "Maturation finale", description: "Dernière fermentation avant maturité", duration: 1440, action: "mature" }
                ],
                autre: [
                    { step: 1, title: "Étape 1 personnalisée", description: "Suivez votre recette personnalisée pour cette première étape", duration: 0, action: "mix" },
                    { step: 2, title: "Étape 2 personnalisée", description: "Continuez selon votre méthode", duration: 0, action: "wait" },
                    { step: 3, title: "Étape 3 personnalisée", description: "Dernière étape avant maturation", duration: 0, action: "wait" },
                    { step: 4, title: "Félicitations !", description: "Votre levain personnalisé est prêt ! Rafraîchissez-le tous les 5 à 10 jours s'il est au frigo. Il doublera de volume quand il sera actif. Attendez ce moment précis pour l'utiliser avec un résultat optimal.", duration: 0, action: "mature" }
                ]
            };
            
            return steps[recipe] || steps.classique;
        }

        function startBirthPhase(levainId) {
            const levain = currentData.levains.find(l => l.id === levainId);
            if (!levain || levain.phase !== 'birth') return;
            
            showBirthPhaseInterface(levain);
        }

        function showBirthPhaseInterface(levain) {
            const currentStepData = levain.birthSteps[levain.currentStep - 1];
            const isLastStep = levain.currentStep >= levain.birthSteps.length;
            
            if (isLastStep) {
                completeBirthPhase(levain.id);
                return;
            }
            
            showModal(`${levain.name} - Étape ${levain.currentStep}/${levain.birthSteps.length}`, `
                <div class="tamagotchi-container">
                    <div class="levain-avatar ${currentStepData.action === 'mix' ? 'mixing-animation' : ''}" id="levainAvatar">
                        ${getAvatarForStep(currentStepData.action)}
                    </div>
                    <h3>${currentStepData.title}</h3>
                    <p style="font-size: 1.1rem; margin: 1rem 0;">${currentStepData.description}</p>
                    

                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="completeCurrentStep('${levain.id}')">
                        ✅ Étape terminée
                    </button>
                    <button class="btn-secondary" onclick="addBirthNote('${levain.id}')">
                        📝 Ajouter une note
                    </button>
                    <button class="btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            `);
        }

        function getAvatarForStep(action) {
            const avatars = {
                'mix': '🌪️',
                'wait': '😴',
                'refresh': '💧',
                'mature': '🎯'
            };
            return avatars[action] || '🥖';
        }

        function formatDuration(minutes) {
            if (minutes < 60) return `${minutes} min`;
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours < 24) return `${hours}h${mins > 0 ? mins + 'min' : ''}`;
            const days = Math.floor(hours / 24);
            const remainingHours = hours % 24;
            return `${days} jour${days > 1 ? 's' : ''}${remainingHours > 0 ? ' ' + remainingHours + 'h' : ''}`;
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function startStepTimer(durationMinutes, levainId) {
            const totalSeconds = durationMinutes * 60;
            let remainingSeconds = totalSeconds;
            
            const timerElement = document.getElementById('timer');
            const startButton = document.getElementById('startTimer');
            
            if (startButton) startButton.style.display = 'none';
            
            const interval = setInterval(() => {
                remainingSeconds--;
                if (timerElement) {
                    timerElement.textContent = formatTime(remainingSeconds);
                    
                    // Changer la couleur quand il reste moins de 5 minutes
                    if (remainingSeconds < 300) {
                        timerElement.style.color = '#FF6B35';
                    }
                }
                
                if (remainingSeconds <= 0) {
                    clearInterval(interval);
                    if (timerElement) {
                        timerElement.textContent = '⏰ TEMPS ÉCOULÉ !';
                        timerElement.style.color = '#D32F2F';
                    }
                    
                    // Notification sonore simulée (alerte visuelle)
                    alert(`⏰ Timer terminé pour ${currentData.levains.find(l => l.id === levainId)?.name} !\n\nVous pouvez passer à l'étape suivante.`);
                }
            }, 1000);
            
            // Stocker l'interval pour pouvoir l'arrêter si nécessaire
            window.currentTimer = interval;
        }

        function completeCurrentStep(levainId) {
            const levain = currentData.levains.find(l => l.id === levainId);
            if (!levain) return;
            
            levain.currentStep++;
            
            // Ajouter une note automatique
            levain.notes.push({
                date: new Date().toISOString(),
                comment: `Étape ${levain.currentStep - 1} terminée: ${levain.birthSteps[levain.currentStep - 2]?.title}`,
                automatic: true
            });
            
            saveDataToStorage();
            renderLevains();
            
            // Arrêter le timer s'il y en a un
            if (window.currentTimer) {
                clearInterval(window.currentTimer);
                window.currentTimer = null;
            }
            
            // Passer à l'étape suivante ou terminer la phase naissance
            if (levain.currentStep > levain.birthSteps.length) {
                completeBirthPhase(levainId);
            } else {
                showBirthPhaseInterface(levain);
            }
        }

        function completeBirthPhase(levainId) {
            const levain = currentData.levains.find(l => l.id === levainId);
            if (!levain) return;
            
            levain.phase = 'adult';
            levain.lastRefresh = new Date().toISOString();
            levain.notes.push({
                date: new Date().toISOString(),
                comment: '🎉 Phase naissance terminée ! Votre levain est maintenant mature et prêt à être utilisé pour vos créations boulangères.',
                automatic: true
            });
            
            saveDataToStorage();
            renderLevains();
            renderStats();
            
            showModal('🎉 Félicitations !', `
                <div class="tamagotchi-container">
                    <div class="levain-avatar" style="animation: pulse 1s infinite;">🏆</div>
                    <h3>Votre levain "${levain.name}" est né !</h3>
                    <p>Il a maintenant terminé sa phase de naissance et est prêt à être utilisé pour vos créations boulangères.</p>
                    <div style="background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius); margin: 1rem 0;">
                        <strong>Conseils pour la suite :</strong>
                        <p style="text-align: left; margin: 0.5rem 0;">
                            Rafraîchissez-le tous les 5 à 10 jours s'il est au frigo. Il doublera de volume quand il sera actif. Attendez ce moment précis pour l'utiliser avec un résultat optimal.
                        </p>
                    </div>
                </div>
                <div class="text-center">
                    <button class="btn" onclick="closeModal()">🎉 Super !</button>
                </div>
            `);
        }

        function addBirthNote(levainId) {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date().toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
            
            showModal('Ajouter une Note', `
                <div class="form-group">
                    <label class="form-label">Date et heure de l'observation</label>
                    <input type="datetime-local" class="form-input" id="birthNoteDate" value="${now}">
                </div>
                <div class="form-group">
                    <label class="form-label">Vos observations</label>
                    <textarea class="form-textarea" id="birthNote" placeholder="Ex: Odeur agréable, bulles visibles, texture collante..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="saveBirthNote('${levainId}')">💾 Sauvegarder</button>
                    <button class="btn-secondary" onclick="showBirthPhaseInterface(currentData.levains.find(l => l.id === '${levainId}'))">Retour</button>
                </div>
            `);
        }

        function saveBirthNote(levainId) {
            const noteText = document.getElementById('birthNote').value.trim();
            const noteDate = document.getElementById('birthNoteDate').value;
            
            if (!noteText) {
                alert('Veuillez saisir une observation');
                return;
            }
            
            if (!noteDate) {
                alert('Veuillez sélectionner une date et heure');
                return;
            }
            
            const levain = currentData.levains.find(l => l.id === levainId);
            if (levain) {
                levain.notes.push({
                    date: new Date(noteDate).toISOString(),
                    comment: noteText,
                    automatic: false
                });
                saveDataToStorage();
            }
            
            showBirthPhaseInterface(levain);
        }

        function addExistingLevain() {
            showModal('Ajouter un Levain Existant', `
                <div class="form-group">
                    <label class="form-label">Nom du levain *</label>
                    <input type="text" class="form-input" id="existingLevainName" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Date de création</label>
                    <input type="date" class="form-input" id="existingLevainDate" value="${new Date().toISOString().split('T')[0]}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Dernier rafraîchissement</label>
                    <input type="datetime-local" class="form-input" id="existingLevainRefresh">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notes initiales</label>
                    <textarea class="form-textarea" id="existingLevainNotes" placeholder="Historique, origine, caractéristiques..."></textarea>
                </div>
                
                <div class="btn-group">
                    <button class="btn" onclick="saveExistingLevain()">💾 Ajouter</button>
                    <button class="btn-secondary" onclick="closeModal()">Annuler</button>
                </div>
            `);
        }

        function saveExistingLevain() {
            const name = document.getElementById('existingLevainName').value.trim();
            const createdDate = document.getElementById('existingLevainDate').value;
            const lastRefresh = document.getElementById('existingLevainRefresh').value;
            const notes = document.getElementById('existingLevainNotes').value.trim();
            
            if (!name) {
                alert('Veuillez donner un nom au levain');
                return;
            }
            
            const newLevain = {
                id: Date.now().toString(),
                name: name,
                createdDate: createdDate ? new Date(createdDate).toISOString() : new Date().toISOString(),
                lastRefresh: lastRefresh ? new Date(lastRefresh).toISOString() : null,
                phase: 'adult',
                notes: notes ? [{
                    date: new Date().toISOString(),
                    comment: notes,
                    automatic: false
                }] : []
            };
            
            currentData.levains.push(newLevain);
            saveDataToStorage();
            renderLevains();
            renderStats();
            closeModal();
            
            alert('Levain ajouté avec succès !');
        }

        function confirmRefreshLevain(levainId, levainName) {
            if (confirm(`Voulez-vous rafraîchir "${levainName}" ?\n\nCela va mettre à jour la date de dernier rafraîchissement et ajouter une note automatique.`)) {
                refreshLevain(levainId);
            }
        }

        function refreshLevain(levainId) {
            const levain = currentData.levains.find(l => l.id === levainId);
            if (!levain) return;
            
            levain.lastRefresh = new Date().toISOString();
            levain.notes.push({
                date: new Date().toISOString(),
                comment: 'Rafraîchissement effectué',
                automatic: true
            });
            
            saveDataToStorage();
            renderLevains();
            renderStats();
            setupLevainBubbleAnimation(); // Mettre à jour l'animation des bulles du bouton
            
            // Notification de succès avec le nouvel avatar
            const timeSinceRefresh = calculateTimeSinceRefresh(levain.lastRefresh);
            const newAvatar = getLevainAvatar(timeSinceRefresh, levain.phase);
            showSuccessNotification(`${newAvatar} "${levain.name}" rafraîchi avec succès !`);
        }

        function showLevainDetail(levainId) {
            const levain = currentData.levains.find(l => l.id === levainId);
            if (!levain) return;
            
            // Fermer la modale actuelle si elle existe
            closeModal();
            
            // Naviguer vers la page des levains
            showPage('levains');
            
            // Activer le bon onglet
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            const levainTab = document.querySelector('.tab-button[data-tab="levains"]');
            if (levainTab) levainTab.classList.add('active');
            
            // Afficher les détails du levain sélectionné
            showLevainDetailModal(levainId);
        }

        function showLevainDetailModal(levainId) {
            const levain = currentData.levains.find(l => l.id === levainId);
            if (!levain) return;
            
            const age = calculateLevainAge(levain.createdDate);
            const timeSinceRefresh = calculateTimeSinceRefresh(levain.lastRefresh);
            
            showModal(levain.name, `
                <div class="levain-detail">
                    <div class="tamagotchi-container" style="margin-bottom: 2rem;">
                        <div class="levain-avatar">${levain.phase === 'birth' ? '🐣' : '🏆'}</div>
                        <h3>${levain.phase === 'birth' ? 'En cours de naissance' : 'Levain mature'}</h3>
                    </div>
                    
                    <div class="mb-2">
                        <h4>Informations générales</h4>
                        <div style="background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius);">
                            <p><strong>Âge :</strong> ${age.text}</p>
                            <p><strong>Créé le :</strong> ${new Date(levain.createdDate).toLocaleDateString()}</p>
                            <p><strong>Dernier rafraîchissement :</strong> ${levain.lastRefresh ? new Date(levain.lastRefresh).toLocaleString() : 'Jamais'}</p>
                            <p><strong>Temps écoulé :</strong> <span class="${timeSinceRefresh.days > 3 ? 'time-since-refresh warning' : ''}">${timeSinceRefresh.text}</span></p>
                            ${levain.phase === 'birth' ? `<p><strong>Phase :</strong> Naissance (étape ${levain.currentStep}/${levain.birthSteps?.length || 0})</p>` : ''}
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <h4>Historique des notes</h4>
                        <div style="max-height: 300px; overflow-y: auto; background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius);">
                            ${levain.notes.length > 0 ? 
                                levain.notes.slice().sort((a, b) => new Date(b.date) - new Date(a.date)).map((note, index) => `
                                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #DDD; position: relative;">
                                        <div style="font-weight: bold; color: var(--accent-brown); display: flex; justify-content: space-between; align-items: center;">
                                            <span>
                                                ${new Date(note.date).toLocaleString()}
                                                ${note.automatic ? '<span style="font-size: 0.8rem; color: #666;"> (auto)</span>' : ''}
                                            </span>
                                            ${!note.automatic ? `<button class="btn-danger" style="font-size: 0.8rem; padding: 0.2rem 0.5rem; margin-left: 0.5rem;" onclick="deleteLevainNote('${levain.id}', ${index})" title="Supprimer cette note">🗑️</button>` : ''}
                                        </div>
                                        <div style="margin-top: 0.5rem;">${note.comment}</div>
                                    </div>
                                `).join('') :
                                '<p style="text-align: center; color: #666;">Aucune note pour le moment</p>'
                            }
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        ${levain.phase === 'birth' ? 
                            `<button class="btn" onclick="closeModal(); startBirthPhase('${levain.id}')">🐣 Continuer naissance</button>` :
                            `<button class="btn" onclick="refreshLevain('${levain.id}'); closeModal();">🔄 Rafraîchir</button>`
                        }
                        <button class="btn-secondary" onclick="addLevainNote('${levain.id}')">📝 Ajouter note</button>
                        <button class="btn-danger" onclick="deleteLevain('${levain.id}')">🗑️ Supprimer</button>
                        <button class="btn" onclick="closeModal()">Fermer</button>
                    </div>
                </div>
            `);
        }

        function addLevainNote(levainId) {
            const today = new Date().toISOString().split('T')[0];
            const now = new Date().toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
            
            showModal('Ajouter une Note', `
                <div class="form-group">
                    <label class="form-label">Date et heure de l'observation</label>
                    <input type="datetime-local" class="form-input" id="levainNoteDate" value="${now}">
                </div>
                <div class="form-group">
                    <label class="form-label">Vos observations</label>
                    <textarea class="form-textarea" id="levainNote" placeholder="Ex: Bonne activité, odeur fruitée, a doublé de volume..."></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="saveLevainNote('${levainId}')">💾 Sauvegarder</button>
                                            <button class="btn-secondary" onclick="showLevainDetailModal('${levainId}')">Retour</button>
                </div>
            `);
        }

        function saveLevainNote(levainId) {
            const noteText = document.getElementById('levainNote').value.trim();
            const noteDate = document.getElementById('levainNoteDate').value;
            
            if (!noteText) {
                alert('Veuillez saisir une observation');
                return;
            }
            
            if (!noteDate) {
                alert('Veuillez sélectionner une date et heure');
                return;
            }
            
            const levain = currentData.levains.find(l => l.id === levainId);
            if (levain) {
                levain.notes.push({
                    date: new Date(noteDate).toISOString(),
                    comment: noteText,
                    automatic: false
                });
                saveDataToStorage();
            }
            
            showLevainDetailModal(levainId);
        }

        function deleteLevainNote(levainId, noteIndex) {
            const levain = currentData.levains.find(l => l.id === levainId);
            if (!levain || !levain.notes || noteIndex >= levain.notes.length) {
                alert('Note introuvable');
                return;
            }
            
            const note = levain.notes[noteIndex];
            if (note.automatic) {
                alert('Impossible de supprimer une note automatique');
                return;
            }
            
            if (confirm(`Êtes-vous sûr de vouloir supprimer cette note du ${new Date(note.date).toLocaleString()} ?\n\n"${note.comment}"`)) {
                levain.notes.splice(noteIndex, 1);
                saveDataToStorage();
                showLevainDetailModal(levainId);
                alert('Note supprimée');
            }
        }

        function deleteLevain(levainId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce levain ? Cette action est irréversible.')) {
                currentData.levains = currentData.levains.filter(l => l.id !== levainId);
                saveDataToStorage();
                renderLevains();
                renderStats();
                closeModal();
                alert('Levain supprimé');
            }
        }

        // Fonctions de gestion avancée des données
        function migrateOldData() {
            // Migration automatique des anciennes versions de données
            if (!currentData.settings) {
                currentData.settings = {
                    ingredientHierarchy: ['Farine T65', 'Farine T45', 'Farine T00', 'Eau', 'Sel', 'Levure sèche', 'Levain liquide', 'Sucre', 'Beurre', 'Œufs', 'Lait'],
                    customTabs: []
                };
            }
            
            // Migrer les recettes sans ID
            Object.keys(currentData.recipes).forEach(family => {
                currentData.recipes[family].forEach(recipe => {
                    if (!recipe.id) {
                        recipe.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                    }
                    if (!recipe.createdDate) {
                        recipe.createdDate = new Date().toISOString();
                    }
                });
            });
            
            // Migrer les levains sans ID
            currentData.levains.forEach(levain => {
                if (!levain.id) {
                    levain.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                }
                if (!levain.notes) {
                    levain.notes = [];
                }
                if (!levain.phase) {
                    levain.phase = 'adult';
                }
            });
            
            // Migrer les images de galerie sans ID
            currentData.gallery.forEach(image => {
                if (!image.id) {
                    image.id = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                }
                if (!image.uploadDate) {
                    image.uploadDate = new Date().toISOString();
                }
            });
        }

        function validateData() {
            // Validation et nettoyage des données
            let hasChanges = false;
            
            // Supprimer les recettes corrompues
            Object.keys(currentData.recipes).forEach(family => {
                const validRecipes = currentData.recipes[family].filter(recipe => 
                    recipe.name && recipe.name.trim() !== ''
                );
                if (validRecipes.length !== currentData.recipes[family].length) {
                    currentData.recipes[family] = validRecipes;
                    hasChanges = true;
                }
            });
            
            // Supprimer les levains corrompus
            const validLevains = currentData.levains.filter(levain => 
                levain.name && levain.name.trim() !== ''
            );
            if (validLevains.length !== currentData.levains.length) {
                currentData.levains = validLevains;
                hasChanges = true;
            }
            
            // Supprimer les images corrompues
            const validImages = currentData.gallery.filter(image => 
                image.name && image.data && image.data.startsWith('data:image/')
            );
            if (validImages.length !== currentData.gallery.length) {
                currentData.gallery = validImages;
                hasChanges = true;
            }
            
            if (hasChanges) {
                saveDataToStorage();
                console.log('Données nettoyées automatiquement');
            }
        }

        function checkStorageQuota() {
            // Vérifier l'espace de stockage disponible
            if (typeof Storage !== 'undefined') {
                try {
                    const dataSize = JSON.stringify(currentData).length;
                    const maxSize = 5 * 1024 * 1024; // 5MB approximatif pour localStorage
                    
                    if (dataSize > maxSize * 0.8) { // Alerte à 80%
                        console.warn('Attention: Espace de stockage bientôt plein');
                        
                        if (dataSize > maxSize * 0.9) { // Action à 90%
                            alert('Attention: Votre espace de stockage est presque plein. Pensez à exporter vos données et à supprimer les anciennes images.');
                        }
                    }
                } catch (e) {
                    console.error('Erreur lors de la vérification du stockage:', e);
                }
            }
        }

        // Sauvegarde enrichie avec vérifications
        function saveDataToStorageWithValidation() {
            try {
                migrateOldData();
                validateData();
                checkStorageQuota();
                localStorage.setItem('bakeryData', JSON.stringify(currentData));
            } catch (e) {
                console.error('Erreur lors de la sauvegarde:', e);
                if (e.name === 'QuotaExceededError') {
                    alert('Espace de stockage insuffisant. Veuillez supprimer des données ou exporter puis réimporter vos données.');
                } else {
                    alert('Erreur lors de la sauvegarde des données');
                }
            }
        }

        // Remplacer la fonction de sauvegarde simple
        function saveDataToStorage() {
            saveDataToStorageWithValidation();
        }

        // Suite du JavaScript - Partie 4 - Chatbot et fonctionnalités finales

        // Chatbot flottant
        function toggleChat() {
            const chatModal = document.getElementById('chatModal');
            const chatBubble = document.getElementById('chatBubble');
            
            if (chatModal.classList.contains('active')) {
                // Fermer le chat
                chatModal.classList.remove('active');
                chatBubble.style.display = 'block';
            } else {
                // Ouvrir le chat
                chatModal.classList.add('active');
                chatBubble.style.display = 'none';
                
                // Focus sur l'input
                setTimeout(() => {
                    document.getElementById('chatInput').focus();
                }, 300);
            }
        }

        // Chatbot intelligent
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Ajouter le message de l'utilisateur
            addChatMessage(message, 'user');
            input.value = '';
            
            // Traiter la réponse du bot avec un petit délai pour simulation
            setTimeout(() => {
                const response = processChatMessage(message);
                addChatMessage(response, 'bot');
            }, 500);
        }

        function addChatMessage(message, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;
            messageDiv.innerHTML = message;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function processChatMessage(message) {
            const msg = message.toLowerCase();
            
            // Salutations et conversations basiques
            if (msg.includes('bonjour') || msg.includes('salut') || msg.includes('hello') || msg.includes('hi') || 
                msg.includes('bonsoir') || msg.includes('coucou') || msg.includes('hey') || msg.includes('yo')) {
                const greetings = [
                    `👋 <strong>Bonjour !</strong><br><br>Ravi de vous rencontrer ! Je suis votre assistant boulanger virtuel. Comment puis-je vous aider aujourd'hui ?`,
                    `🥖 <strong>Salut !</strong><br><br>Bienvenue dans votre atelier boulangerie numérique ! Prêt(e) à créer de délicieuses recettes ?`,
                    `🌾 <strong>Hello !</strong><br><br>Bonjour cher(e) boulanger(e) ! Avez-vous des questions sur vos recettes ou vos levains ?`,
                    `👨‍🍳 <strong>Coucou !</strong><br><br>Salut ! Je suis là pour vous aider avec toutes vos questions de boulangerie !`,
                    `✨ <strong>Hey !</strong><br><br>Bonjour ! Prêt(e) à faire de la magie en cuisine ? Je suis votre assistant boulanger !`
                ];
                return greetings[Math.floor(Math.random() * greetings.length)];
            }
            
            if (msg.includes('comment ça va') || msg.includes('comment ca va') || msg.includes('ça va') || msg.includes('ca va') ||
                msg.includes('comment tu vas') || msg.includes('comment vas-tu') || msg.includes('comment allez-vous') ||
                msg.includes('tu vas bien') || msg.includes('ça va bien') || msg.includes('ca va bien') ||
                msg.includes('comment ça va ?') || msg.includes('comment ca va ?') || msg.includes('ça va ?') || msg.includes('ca va ?') ||
                msg.includes('comment tu vas ?') || msg.includes('comment vas-tu ?') || msg.includes('comment allez-vous ?') ||
                msg.includes('tu vas bien ?') || msg.includes('ça va bien ?') || msg.includes('ca va bien ?')) {
                
                const responses = [
                    `😊 <strong>Très bien, merci !</strong><br><br>Je suis toujours prêt à vous aider avec vos questions de boulangerie. Et vous, comment se passe votre aventure culinaire ?<br><br>💡 N'hésitez pas à me demander des conseils sur vos recettes, levains, ou techniques !`,
                    `🌟 <strong>Parfaitement !</strong><br><br>Je suis en pleine forme et prêt à vous accompagner dans vos créations boulangères ! Comment se passe votre journée ?<br><br>💡 Avez-vous des questions sur vos recettes ou vos levains ?`,
                    `🥖 <strong>Très bien, merci !</strong><br><br>Je suis toujours là pour vous aider avec la boulangerie. Et vous, comment se passe votre expérience culinaire ?<br><br>💡 N'hésitez pas à me poser des questions !`
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
            
            if (msg.includes('au revoir') || msg.includes('bye') || msg.includes('ciao') || msg.includes('à bientôt') || 
                msg.includes('a bientot') || msg.includes('à plus') || msg.includes('a plus') || msg.includes('salut') ||
                msg.includes('bye bye') || msg.includes('goodbye') || msg.includes('à la prochaine') || msg.includes('a la prochaine')) {
                
                const goodbyes = [
                    `👋 <strong>Au revoir !</strong><br><br>Bon boulange et à bientôt ! N'oubliez pas : un bon pain se fait avec patience et amour ! 🥖✨`,
                    `🌟 <strong>À bientôt !</strong><br><br>Merci pour cette conversation ! Bonne continuation dans vos aventures boulangères ! 🍞✨`,
                    `😊 <strong>Salut !</strong><br><br>À la prochaine ! N'oubliez pas que je suis toujours là pour vous aider ! 🥖💫`
                ];
                return goodbyes[Math.floor(Math.random() * goodbyes.length)];
            }
            
            // Easter eggs et réponses amusantes
            if (msg.includes('baguette') && (msg.includes('magique') || msg.includes('magic'))) {
                return `🪄 <strong>Baguette magique ?</strong><br><br>Ah ! Vous cherchez la baguette de Dumbledore ? 😄<br><br>Dans notre univers, la vraie magie c'est la fermentation ! ✨<br><br>💡 <em>PS : Si vous trouvez une baguette qui vole, partagez la recette !</em>`;
            }
            
            if (msg.includes('croissant') && msg.includes('lune')) {
                return `🌙 <strong>Croissant de lune ?</strong><br><br>Ah ! Vous voulez faire des croissants lunaires ? 🌙<br><br>La vraie question est : voulez-vous les manger en regardant la lune ?<br><br>💡 <em>Astuce : Les croissants sont meilleurs au petit matin, comme la lune qui se couche !</em>`;
            }
            
            if (msg.includes('pain') && msg.includes('chocolat')) {
                return `🍫 <strong>Pain au chocolat vs Chocolatine ?</strong><br><br>Ah ! Le débat éternel ! 😄<br><br>Dans notre application, on dit "Pain au chocolat" (désolé les Sudistes !) 🥐<br><br>💡 <em>Le plus important : qu'il soit bien doré et croustillant !</em>`;
            }
            
            if (msg.includes('levure') && msg.includes('boulanger')) {
                return `🧑‍🍳 <strong>Levure de boulanger ?</strong><br><br>Ah ! Vous voulez devenir boulanger professionnel ? 🏪<br><br>La levure de boulanger est différente de la levure fraîche du commerce. Elle est plus active et se conserve mieux !<br><br>💡 <em>Conseil : Gardez-la au frigo et elle vous accompagnera pendant des mois !</em>`;
            }
            
            // Nouveaux easter eggs (6-15)
            if (msg.includes('pizza') && (msg.includes('italienne') || msg.includes('italien'))) {
                return `🇮🇹 <strong>Pizza italienne ?</strong><br><br>Ah ! Vous voulez la vraie pizza napolitaine ? 🍕<br><br>Le secret : farine 00, cuisson à 400°C, et beaucoup d'amour !<br><br>💡 <em>Fun fact : La pizza Margherita a été créée en 1889 pour honorer la reine d'Italie !</em>`;
            }
            
            if (msg.includes('sourdough') || msg.includes('pain au levain')) {
                return `🌾 <strong>Sourdough ?</strong><br><br>Ah ! Vous parlez anglais maintenant ? 😄<br><br>En français, on dit "pain au levain" ou "pain de campagne" !<br><br>💡 <em>Le sourdough est devenu très tendance pendant le confinement, vous vous souvenez ?</em>`;
            }
            
            if (msg.includes('baguette') && msg.includes('parisienne')) {
                return `🗼 <strong>Baguette parisienne ?</strong><br><br>Ah ! La vraie baguette de Paris ! 🥖<br><br>Le secret : farine T55, pâte ferme, et grignes bien marquées !<br><br>💡 <em>Saviez-vous que la baguette a été inventée pour les ouvriers ? Plus facile à transporter que les grosses miches !</em>`;
            }
            
            if (msg.includes('croissant') && (msg.includes('viennois') || msg.includes('viennoise'))) {
                return `🥐 <strong>Croissant viennois ?</strong><br><br>Ah ! Vous voulez le vrai croissant à la viennoise !<br><br>Le secret : beurre AOP, pâte feuilletée inversée, et beaucoup de patience !<br><br>💡 <em>Le croissant n'est pas français mais autrichien ! Il a été importé par Marie-Antoinette !</em>`;
            }
            
            if (msg.includes('brioche') && (msg.includes('nanterre') || msg.includes('tressée'))) {
                return `🍞 <strong>Brioche de Nanterre ?</strong><br><br>Ah ! La brioche tressée par excellence !<br><br>Le secret : beaucoup de beurre, œufs frais, et le tressage traditionnel !<br><br>💡 <em>La brioche de Nanterre est née dans les années 1800, elle était offerte aux pauvres le dimanche !</em>`;
            }
            
            if (msg.includes('fougasse') || msg.includes('fougasse')) {
                return `🌿 <strong>Fougasse ?</strong><br><br>Ah ! La fougasse provençale !<br><br>Le secret : olives, herbes de Provence, et la forme caractéristique !<br><br>💡 <em>La fougasse était autrefois utilisée pour tester la température du four avant d'enfourner le pain !</em>`;
            }
            
            if (msg.includes('pain') && (msg.includes('complet') || msg.includes('intégral'))) {
                return `🌾 <strong>Pain complet ?</strong><br><br>Ah ! Le pain des nutritionnistes !<br><br>Riche en fibres, vitamines, et minéraux !<br><br>💡 <em>Le pain complet était autrefois le pain des pauvres, maintenant c'est le plus cher !</em>`;
            }
            
            if (msg.includes('ciabatta') || msg.includes('ciabatta')) {
                return `🇮🇹 <strong>Ciabatta ?</strong><br><br>Ah ! Le pain italien par excellence !<br><br>Le secret : hydratation élevée (75-80%) et forme de pantoufle !<br><br>💡 <em>La ciabatta a été inventée en 1982 pour concurrencer la baguette française !</em>`;
            }
            
            if (msg.includes('pain') && (msg.includes('au lait') || msg.includes('lait'))) {
                return `🥛 <strong>Pain au lait ?</strong><br><br>Ah ! Le pain doux et moelleux !<br><br>Parfait pour les enfants et les goûters !<br><br>💡 <em>Le pain au lait est très populaire en Asie, notamment au Japon et en Corée !</em>`;
            }
            
            if (msg.includes('challah') || msg.includes('challah')) {
                return `🕯️ <strong>Challah ?</strong><br><br>Ah ! Le pain tressé juif !<br><br>Le secret : œufs, miel, et le tressage traditionnel à 6 brins !<br><br>💡 <em>La challah est bénie avant le repas du shabbat, elle symbolise la manne du désert !</em>`;
            }
            
            if (msg.includes('pain') && (msg.includes('sans gluten') || msg.includes('gluten'))) {
                return `🌾 <strong>Pain sans gluten ?</strong><br><br>Ah ! Le défi technique !<br><br>Le secret : mélange de farines (riz, sarrasin, quinoa) et gomme xanthane !<br><br>💡 <em>Le gluten est une protéine qui donne l'élasticité à la pâte, sans lui, c'est plus difficile !</em>`;
            }
            
            if (msg.includes('soda bread') || msg.includes('pain soda')) {
                return `🍞 <strong>Soda bread ?</strong><br><br>Ah ! Le pain irlandais !<br><br>Le secret : bicarbonate de soude au lieu de levure !<br><br>💡 <em>Le soda bread était le pain des pauvres en Irlande, pas besoin d'attendre la fermentation !</em>`;
            }
            
            if (msg.includes('focaccia') || msg.includes('focaccia')) {
                return `🇮🇹 <strong>Focaccia ?</strong><br><br>Ah ! Le pain italien aux herbes !<br><br>Le secret : beaucoup d'huile d'olive et les empreintes du bout des doigts !<br><br>💡 <em>La focaccia vient de Gênes, elle était le pain des marins et des voyageurs !</em>`;
            }
            
            if (msg.includes('pain') && (msg.includes('de mie') || msg.includes('mie'))) {
                return `🍞 <strong>Pain de mie ?</strong><br><br>Ah ! Le pain des sandwichs !<br><br>Le secret : moule à couvercle et croûte tendre !<br><br>💡 <em>Le pain de mie a été inventé par les Anglais, d'où le nom "toast bread" !</em>`;
            }
            
            if (msg.includes('pretzel') || msg.includes('pretzel')) {
                return `🥨 <strong>Pretzel ?</strong><br><br>Ah ! Le pain allemand en forme de nœud !<br><br>Le secret : bain de soude avant cuisson pour la croûte brillante !<br><br>💡 <em>Le pretzel symbolise les bras croisés en prière, d'où sa forme caractéristique !</em>`;
            }
            
            // Recherche de recettes améliorée
            if (msg.includes('recette') || msg.includes('recettes')) {
                // Recherche spécifique pour pain au levain
                if (msg.includes('pain au levain') || msg.includes('levain')) {
                    // Priorité 1: Recettes de la famille "pain" avec levain
                    const painLevainRecipes = searchRecipesInFamily('pain', ['levain', 'levure']);
                    
                    // Priorité 2: Autres recettes avec levain dans d'autres familles
                    const otherLevainRecipes = searchRecipesByKeywords(['levain', 'levure']).filter(recipe => recipe.family !== 'pain');
                    
                    if (painLevainRecipes.length > 0) {
                        let response = `🥖 <strong>Recettes de pain au levain trouvées :</strong><br><br>`;
                        
                        // Afficher d'abord les recettes de pain
                        response += `<strong>🍞 Famille Pain :</strong><br>`;
                        painLevainRecipes.forEach(recipe => {
                            response += `• <a href="#" onclick="showRecipeInChat('${recipe.name}', '${recipe.family}')" style="color: var(--olive-green); text-decoration: underline;">${recipe.name}</a> ${recipe.rating ? '(' + '★'.repeat(recipe.rating) + ')' : ''}<br>`;
                        });
                        
                        // Afficher les autres recettes avec levain si il y en a
                        if (otherLevainRecipes.length > 0) {
                            response += `<br><strong>📝 Autres recettes avec levain :</strong><br>`;
                            otherLevainRecipes.forEach(recipe => {
                                response += `• <a href="#" onclick="showRecipeInChat('${recipe.name}', '${recipe.family}')" style="color: var(--accent-brown); text-decoration: underline;">${recipe.name}</a> ${recipe.rating ? '(' + '★'.repeat(recipe.rating) + ')' : ''} (${getFamilyDisplayName(recipe.family)})<br>`;
                            });
                        }
                        
                        response += `<br>💡 Cliquez sur une recette pour voir les détails !`;
                        return response;
                    } else if (otherLevainRecipes.length > 0) {
                        return `🥖 <strong>Recettes avec levain trouvées :</strong><br><br>
                            ${otherLevainRecipes.map(recipe => 
                                `• <a href="#" onclick="showRecipeInChat('${recipe.name}', '${recipe.family}')" style="color: var(--olive-green); text-decoration: underline;">${recipe.name}</a> ${recipe.rating ? '(' + '★'.repeat(recipe.rating) + ')' : ''} (${getFamilyDisplayName(recipe.family)})<br>`
                            ).join('')}
                            <br>💡 Cliquez sur une recette pour voir les détails !`;
                    } else {
                        return `🥖 <strong>Recettes de pain au levain :</strong><br><br>
                            Je n'ai trouvé aucune recette de pain au levain dans votre collection.<br><br>
                            <strong>Suggestions :</strong><br>
                            • Créez votre première recette de pain au levain<br>
                            • Commencez par un levain simple (farine + eau)<br>
                            • Ajoutez progressivement de la farine T65<br><br>
                            💡 Voulez-vous que je vous aide à créer une recette ?`;
                    }
                }
                
                // Recherche pour pain en général
                if (msg.includes('pain') || msg.includes('baguette')) {
                    const painRecipes = searchRecipesInFamily('pain', ['pain', 'baguette']);
                    if (painRecipes.length > 0) {
                        return `🍞 <strong>Recettes de pain trouvées :</strong><br><br>
                            ${painRecipes.map(recipe => 
                                `• <a href="#" onclick="showRecipeInChat('${recipe.name}', '${recipe.family}')" style="color: var(--olive-green); text-decoration: underline;">${recipe.name}</a> ${recipe.rating ? '(' + '★'.repeat(recipe.rating) + ')' : ''}<br>`
                            ).join('')}
                            <br>💡 Cliquez sur une recette pour voir les détails !`;
                    }
                }
                
                // Recherche pour viennoiseries
                if (msg.includes('viennoiserie') || msg.includes('croissant') || msg.includes('pâte feuilletée')) {
                    const viennoiserieRecipes = searchRecipesInFamily('viennoiseries', ['croissant', 'viennoiserie', 'pâte feuilletée']);
                    if (viennoiserieRecipes.length > 0) {
                        return `🥐 <strong>Recettes de viennoiseries trouvées :</strong><br><br>
                            ${viennoiserieRecipes.map(recipe => 
                                `• <a href="#" onclick="showRecipeInChat('${recipe.name}', '${recipe.family}')" style="color: var(--olive-green); text-decoration: underline;">${recipe.name}</a> ${recipe.rating ? '(' + '★'.repeat(recipe.rating) + ')' : ''}<br>`
                            ).join('')}
                            <br>💡 Cliquez sur une recette pour voir les détails !`;
                    }
                }
                
                // Recherche générale
                const allRecipes = getAllRecipes();
                if (allRecipes.length > 0) {
                    return `📝 <strong>Voici toutes vos recettes :</strong><br><br>
                        ${allRecipes.map(recipe => 
                            `• <a href="#" onclick="showRecipeInChat('${recipe.name}', '${recipe.family}')" style="color: var(--olive-green); text-decoration: underline;">${recipe.name}</a> ${recipe.rating ? '(' + '★'.repeat(recipe.rating) + ')' : ''}<br>`
                        ).join('')}
                        <br>💡 Cliquez sur une recette pour voir les détails !`;
                } else {
                    return `📝 <strong>Vos recettes :</strong><br><br>
                        Vous n'avez encore aucune recette enregistrée.<br><br>
                        💡 Commencez par ajouter votre première recette en cliquant sur "Ajouter Recette" dans l'onglet de votre choix !`;
                }
            }
            
            // Patterns de reconnaissance avec réponses intelligentes
            if (msg.includes('pâte molle') || msg.includes('pate molle') || msg.includes('trop molle')) {
                return `🤲 <strong>Pâte trop molle ?</strong><br><br>
                    Voici mes conseils :<br>
                    • Graissez vos mains à l'huile d'olive<br>
                    • Effectuez des rabats successifs toutes les 30min<br>
                    • Ajoutez un peu de farine progressivement<br>
                    • Vérifiez l'hydratation de votre recette<br><br>
                    💡 <em>Astuce :</em> Une pâte molle n'est pas forcément ratée, elle peut juste nécessiter plus de temps !`;
            }
            
            if (msg.includes('levain') && (msg.includes('mort') || msg.includes('inactif') || msg.includes('ne monte pas'))) {
                return `😰 <strong>Levain inactif ?</strong><br><br>
                    Ne paniquez pas ! Voici le plan de sauvetage :<br>
                    • Température : gardez-le entre 24-26°C<br>
                    • Rafraîchissez avec de l'eau tiède (pas chaude !)<br>
                    • Ratio 1:1:1 (levain:farine:eau)<br>
                    • Attendez 4-8h pour voir l'activité<br>
                    • Si toujours rien après 24h, recommencez les rafraîchissements<br><br>
                    🏥 <strong>SOS Levain :</strong> Un levain peut sembler "mort" mais se réveiller après quelques rafraîchissements !`;
            }
            
            if (msg.includes('pétrissage') || msg.includes('petrir')) {
                return `💪 <strong>Techniques de pétrissage :</strong><br><br>
                    <strong>Pétrissage classique :</strong><br>
                    • 10 min à vitesse lente, puis 8-10 min rapide<br>
                    • Test du voile : la pâte doit être élastique<br><br>
                    <strong>Autolyse :</strong><br>
                    • Mélangez farine + eau, laissez reposer 30 min<br>
                    • Ajoutez sel et levure, pétrissez moins longtemps<br><br>
                    <strong>Rabats :</strong><br>
                    • Technique douce, 4 rabats toutes les 30 min<br>
                    • Parfait pour les pâtes hydratées !`;
            }
            
            if (msg.includes('recette') && (msg.includes('sans levure') || msg.includes('sans levain'))) {
                const unleavenedRecipes = getRecipesWithoutYeast();
                if (unleavenedRecipes.length > 0) {
                    return `🌾 <strong>Recettes sans levure trouvées :</strong><br><br>
                        ${unleavenedRecipes.map(recipe => 
                            `• <a href="#" onclick="showRecipeFromChat('${recipe.name}', '${recipe.family}')" style="color: var(--olive-green); text-decoration: underline;">${recipe.name}</a><br>`
                        ).join('')}
                        <br>Cliquez sur une recette pour voir les détails !`;
                } else {
                    return `🌾 <strong>Recettes sans levure :</strong><br><br>
                        Je n'ai trouvé aucune recette sans levure dans votre collection.<br><br>
                        <strong>Suggestions :</strong><br>
                        • Pain azyme (farine + eau + sel)<br>
                        • Galettes de sarrasin<br>
                        • Crackers aux graines<br>
                        • Pain soda (bicarbonate + babeurre)<br><br>
                        💡 Voulez-vous que je vous aide à créer une de ces recettes ?`;
                }
            }
            
            if (msg.includes('température') || msg.includes('cuisson')) {
                return `🔥 <strong>Guide des températures :</strong><br><br>
                    <strong>Four :</strong><br>
                    • Pain : 230°C puis 200°C<br>
                    • Viennoiseries : 180-200°C<br>
                    • Pizza : 250°C maximum<br><br>
                    <strong>Pâte :</strong><br>
                    • Fermentation : 24-26°C<br>
                    • Pousse finale : 28-30°C<br><br>
                    <strong>Test de cuisson :</strong><br>
                    • Tapotez le dessous : son creux = cuit<br>
                    • Thermomètre : cœur à 95-98°C`;
            }
            
            if (msg.includes('farine') || msg.includes('type')) {
                return `🌾 <strong>Guide des farines :</strong><br><br>
                    <strong>T45 :</strong> Viennoiseries, pâtes<br>
                    <strong>T55 :</strong> Pain blanc, pizza<br>
                    <strong>T65 :</strong> Pain de campagne, levain<br>
                    <strong>T80 :</strong> Pain bis<br>
                    <strong>T110 :</strong> Pain complet<br>
                    <strong>T150 :</strong> Pain intégral<br><br>
                    💡 <em>Plus le chiffre est élevé, plus la farine est complète et riche en minéraux !</em>`;
            }
            
            if (msg.includes('hydratation') || msg.includes('eau')) {
                return `💧 <strong>Maîtriser l'hydratation :</strong><br><br>
                    <strong>Taux d'hydratation :</strong><br>
                    • Pain classique : 60-65%<br>
                    • Pain de campagne : 70-75%<br>
                    • Ciabatta : 75-80%<br>
                    • Focaccia : 80-85%<br><br>
                    <strong>Calcul :</strong> (Eau / Farine) × 100<br><br>
                    ⚠️ <em>Plus d'hydratation = pâte plus difficile à travailler mais mie plus alvéolée !</em>`;
            }
            
            if (msg.includes('conservation') || msg.includes('conserver')) {
                return `📦 <strong>Conservation optimale :</strong><br><br>
                    <strong>Pain :</strong><br>
                    • Torchon dans endroit sec : 2-3 jours<br>
                    • Congélation : jusqu'à 3 mois<br>
                    • ❌ Jamais au frigo (durcit)<br><br>
                    <strong>Levain :</strong><br>
                    • Température ambiante : 2-3 jours<br>
                    • Frigo : 1 semaine<br>
                    • Congélation : plusieurs mois<br><br>
                    <strong>Pâte :</strong><br>
                    • Frigo : 24-48h<br>
                    • Congélation après première fermentation : 1 mois`;
            }
            
            if (msg.includes('problème') || msg.includes('raté') || msg.includes('échec')) {
                return `🔧 <strong>Diagnostic de problèmes :</strong><br><br>
                    <strong>Pain trop dense :</strong><br>
                    • Levain pas assez actif<br>
                    • Pas assez de fermentation<br>
                    • Trop de farine ajoutée<br><br>
                    <strong>Ne lève pas :</strong><br>
                    • Levure périmée ou eau trop chaude<br>
                    • Température trop froide<br>
                    • Trop de sel (tue la levure)<br><br>
                    <strong>Croûte trop dure :</strong><br>
                    • Four trop chaud<br>
                    • Manque de vapeur<br><br>
                    💡 Décrivez-moi votre problème précis pour un diagnostic personnalisé !`;
            }
            
            // Réponses de gratitude et encouragements
            if (msg.includes('merci') || msg.includes('super') || msg.includes('parfait') || msg.includes('génial') || 
                msg.includes('genial') || msg.includes('excellent') || msg.includes('bravo') || msg.includes('cool') ||
                msg.includes('merci beaucoup') || msg.includes('merci bien') || msg.includes('parfait !') || 
                msg.includes('super !') || msg.includes('génial !') || msg.includes('genial !')) {
                
                const thanks = [
                    `😊 <strong>De rien !</strong><br><br>C'est un plaisir de vous aider dans vos aventures boulangères !<br><br>💡 N'hésitez pas à me poser d'autres questions ou à partager vos réussites en ajoutant des notes à vos recettes !<br><br>🥖 Bonne boulange !`,
                    `🌟 <strong>Avec plaisir !</strong><br><br>Je suis ravi d'avoir pu vous aider ! Continuez vos expérimentations culinaires !<br><br>💡 N'hésitez pas à revenir si vous avez d'autres questions !`,
                    `✨ <strong>Pas de souci !</strong><br><br>C'est pour ça que je suis là ! Bonne continuation dans vos créations boulangères !<br><br>🥖 À bientôt !`
                ];
                return thanks[Math.floor(Math.random() * thanks.length)];
            }

            // Questions sur l'identité et les capacités
            if (msg.includes('qui es-tu') || msg.includes('qui es tu') || msg.includes('tu es qui') || 
                msg.includes('c\'est quoi ton nom') || msg.includes('comment tu t\'appelles') || 
                msg.includes('que peux-tu faire') || msg.includes('que peux tu faire') || 
                msg.includes('tu peux faire quoi') || msg.includes('tes capacités') || msg.includes('tes capacites')) {
                
                return `🤖 <strong>Je suis votre assistant boulanger virtuel !</strong><br><br>
                    <strong>Mes capacités :</strong><br>
                    • 🔍 <strong>Recherche de recettes</strong> : Trouver vos recettes par mots-clés<br>
                    • 💡 <strong>Conseils techniques</strong> : Problèmes de pâte, levain, cuisson<br>
                    • 📚 <strong>Guide des ingrédients</strong> : Farines, hydratation, conservation<br>
                    • 🧄 <strong>Gestion des levains</strong> : État, âge, entretien<br>
                    • 🎯 <strong>Diagnostic de problèmes</strong> : Pain dense, croûte dure, etc.<br><br>
                    💡 Posez-moi n'importe quelle question sur la boulangerie !`;
            }

            // Questions sur l'aide
            if (msg.includes('peux-tu m\'aider') || msg.includes('peux tu m\'aider') || 
                msg.includes('tu peux m\'aider') || msg.includes('aide-moi') || msg.includes('aide moi') ||
                msg.includes('j\'ai besoin d\'aide') || msg.includes('j\'ai besoin d\'aide') ||
                msg.includes('je ne sais pas') || msg.includes('je ne sais pas quoi faire')) {
                
                return `🤝 <strong>Bien sûr, je peux vous aider !</strong><br><br>
                    <strong>Voici ce que je peux faire pour vous :</strong><br>
                    • 🔍 <strong>Trouver des recettes</strong> : "recette de pain au levain"<br>
                    • 💡 <strong>Résoudre des problèmes</strong> : "pâte trop molle", "levain inactif"<br>
                    • 📚 <strong>Expliquer des techniques</strong> : "pétrissage", "température"<br>
                    • 🧄 <strong>Gérer vos levains</strong> : "mes levains", "état du levain"<br>
                    • 🎯 <strong>Conseils pratiques</strong> : "farine", "hydratation", "conservation"<br><br>
                    💡 Dites-moi ce qui vous pose problème !`;
            }

            // Questions sur la création de levain
            if (msg.includes('comment faire du levain') || msg.includes('comment créer un levain') || 
                msg.includes('comment créer levain') || msg.includes('comment faire levain') ||
                msg.includes('créer un levain') || msg.includes('creer un levain') || 
                msg.includes('faire un levain') || msg.includes('démarrer un levain') ||
                msg.includes('demarrer un levain') || msg.includes('commencer un levain') ||
                msg.includes('nouveau levain') || msg.includes('levain maison') ||
                msg.includes('comment démarrer') || msg.includes('comment demarrer') ||
                msg.includes('comment commencer') || msg.includes('débuter levain') ||
                msg.includes('debuter levain')) {
                
                return `🧄 <strong>Excellente question !</strong><br><br>
                    <strong>Comment créer votre premier levain :</strong><br><br>
                    <strong>📋 Matériel nécessaire :</strong><br>
                    • Farine T65 ou T80 (bio de préférence)<br>
                    • Eau de source ou filtrée<br>
                    • Un bocal en verre propre<br>
                    • Un torchon ou couvercle non hermétique<br><br>
                    
                    <strong>🌱 Étapes de base :</strong><br>
                    • <strong>Jour 1 :</strong> 50g farine + 50g eau tiède (25°C)<br>
                    • <strong>Jour 2-3 :</strong> Rafraîchir avec 25g farine + 25g eau<br>
                    • <strong>Jour 4-7 :</strong> Rafraîchir matin et soir<br>
                    • <strong>Signe de réussite :</strong> Bulles et odeur acidulée<br><br>
                    
                    <strong>🎯 Voulez-vous que je vous guide étape par étape ?</strong><br><br>
                    <button class="btn" onclick="goToLevainsPage()" style="margin-right: 0.5rem;">🧄 Aller à la page Levains</button>
                    <button class="btn-secondary" onclick="closeModal()">Continuer le chat</button><br><br>
                    
                    💡 <em>Conseil :</em> La patience est la clé ! Un levain prend 7-10 jours pour être prêt.<br><br>
                    
                    <strong>📺 Vidéo recommandée :</strong><br>
                    <a href="https://www.youtube.com/watch?v=vD_aufrBTjU&ab_channel=BoulangeriePas%C3%A0pas" target="_blank" style="color: var(--olive-green); text-decoration: underline;">🧫 Fabrication du levain - Boulangerie Pas à Pas</a>`;
            }

            // Questions sur le nombre de levains
            if (msg.includes('combien de levain') || msg.includes('combien de levains') ||
                msg.includes('j\'ai combien de levain') || msg.includes('j\'ai combien de levains') ||
                msg.includes('nombre de levain') || msg.includes('nombre de levains') ||
                msg.includes('j\'ai combien') || msg.includes('mes levains') || 
                msg.includes('liste levain') || msg.includes('liste levains') ||
                msg.includes('mes levain') || msg.includes('combien') ||
                msg.includes('compte levain') || msg.includes('total levain')) {
                
                const count = currentData.levains.length;
                if (count === 0) {
                    return `🧄 <strong>Vos levains :</strong><br><br>
                        Vous n'avez aucun levain pour le moment.<br><br>
                        💡 <strong>Envie de commencer ?</strong><br>
                        • Créer un levain prend 7-10 jours<br>
                        • C'est très gratifiant !<br>
                        • Je peux vous guider étape par étape<br><br>
                        <button class="btn" onclick="goToLevainsPage()" style="margin-right: 0.5rem;">🧄 Créer mon premier levain</button><br><br>
                        <strong>📺 Vidéo recommandée :</strong><br>
                        <a href="https://www.youtube.com/watch?v=vD_aufrBTjU&ab_channel=BoulangeriePas%C3%A0pas" target="_blank" style="color: var(--olive-green); text-decoration: underline;">🧫 Fabrication du levain - Boulangerie Pas à Pas</a>`;
                } else {
                    return getAllLevainsInfo();
                }
            }

            // Questions sur l'état et l'âge des levains
            if (msg.includes('âge') || msg.includes('age') || msg.includes('age') ||
                msg.includes('quel âge') || msg.includes('quel age') || msg.includes('quel age') ||
                msg.includes('combien de temps') || msg.includes('depuis quand') ||
                msg.includes('depuis combien') || msg.includes('dernier rafraîchissement') ||
                msg.includes('dernier rafraichissement') || msg.includes('rafraîchissement') ||
                msg.includes('rafraichissement') || msg.includes('rafraîchir') || msg.includes('rafraichir') ||
                msg.includes('nourrir') || msg.includes('entretien') || msg.includes('maintenir') ||
                msg.includes('état') || msg.includes('etat') || msg.includes('comment va') ||
                msg.includes('va bien') || msg.includes('actif') || msg.includes('inactif') ||
                msg.includes('mort') || msg.includes('vivant') || msg.includes('santé') ||
                msg.includes('sante') || msg.includes('forme') || msg.includes('condition')) {
                
                // Vérifier si le message contient des noms de levains spécifiques
                const levainNames = currentData.levains.map(l => l.name.toLowerCase());
                const mentionedLevain = levainNames.find(name => msg.includes(name));
                
                if (mentionedLevain) {
                    // Réponse pour un levain spécifique
                    const levain = currentData.levains.find(l => l.name.toLowerCase() === mentionedLevain);
                    return getSpecificLevainInfo(levain);
                } else {
                    // Réponse pour tous les levains
                    return getAllLevainsInfo();
                }
            }

            // Recommandations de vidéos Boulangerie Pas à Pas
            if (msg.includes('vidéo') || msg.includes('video') || msg.includes('tutoriel') || 
                msg.includes('youtube') || msg.includes('chaîne') || msg.includes('chaine') ||
                msg.includes('boulangerie pas à pas') || msg.includes('boulangerie pas a pas') ||
                msg.includes('apprendre') || msg.includes('technique') || msg.includes('méthode') ||
                msg.includes('methode') || msg.includes('comment faire') || msg.includes('comment faire')) {
                
                return getVideoRecommendations(msg);
            }

            // Questions sur le nombre de recettes
            if (msg.includes('combien de recette') || msg.includes('combien de recettes') ||
                msg.includes('j\'ai combien de recette') || msg.includes('j\'ai combien de recettes') ||
                msg.includes('nombre de recette') || msg.includes('nombre de recettes') ||
                msg.includes('total recette') || msg.includes('total recettes') ||
                msg.includes('compte recette') || msg.includes('compte recettes')) {
                
                return getRecipesList();
            }

            // Questions sur l'heure et le temps
            if (msg.includes('quelle heure') || msg.includes('il est quelle heure') ||
                msg.includes('heure est-il') || msg.includes('temps de cuisson') ||
                msg.includes('temps de fermentation') || msg.includes('combien de temps pour') ||
                msg.includes('durée') || msg.includes('temps nécessaire')) {
                
                const responses = [
                    `🕒 <strong>Questions de temps :</strong><br><br>
                        Je ne peux pas vous donner l'heure, mais je peux vous aider avec les temps de boulangerie !<br><br>
                        <strong>⏱️ Temps typiques :</strong><br>
                        • <strong>Pétrissage :</strong> 10-15 minutes<br>
                        • <strong>Première fermentation :</strong> 2-4 heures<br>
                        • <strong>Façonnage :</strong> 10-15 minutes<br>
                        • <strong>Pousse finale :</strong> 1-2 heures<br>
                        • <strong>Cuisson :</strong> 30-45 minutes<br><br>
                        💡 Chaque pâte est unique, surveillez l'évolution !`,
                    `⏰ <strong>Gestion du temps en boulangerie :</strong><br><br>
                        Le temps est l'ingrédient secret du boulanger !<br><br>
                        <strong>🎯 Conseils timing :</strong><br>
                        • Planifiez votre journée la veille<br>
                        • Respectez les temps de repos<br>
                        • La patience donne de meilleurs résultats<br>
                        • Adaptez selon la température ambiante<br><br>
                        💡 "Le pain dicte son rythme, pas l'inverse !"`
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            // Questions sur l'apprentissage et les difficultés
            if (msg.includes('difficile') || msg.includes('dur') || msg.includes('compliqué') ||
                msg.includes('galère') || msg.includes('chiant') || msg.includes('impossible') ||
                msg.includes('j\'y arrive pas') || msg.includes('je n\'y arrive pas') ||
                msg.includes('trop compliqué') || msg.includes('trop dur') ||
                msg.includes('apprendre') || msg.includes('débutant') || msg.includes('debutant') ||
                msg.includes('commencer') || msg.includes('débuter') || msg.includes('debuter')) {
                
                return `💪 <strong>Courage, futur boulanger !</strong><br><br>
                    La boulangerie demande de la patience, mais c'est très gratifiant !<br><br>
                    <strong>🎯 Mes conseils pour débuter :</strong><br>
                    • <strong>Commencez simple :</strong> Pain en cocotte<br>
                    • <strong>Un ingrédient à la fois :</strong> Maîtrisez la base<br>
                    • <strong>Tenez un carnet :</strong> Notez vos essais<br>
                    • <strong>Patience :</strong> Chaque échec enseigne<br>
                    • <strong>Communauté :</strong> Échangez avec d'autres boulangers<br><br>
                    💡 <em>"Le pain pardonne beaucoup d'erreurs, laissez-vous du temps !"</em><br><br>
                    <strong>📺 Parfait pour débuter :</strong><br>
                    <a href="https://www.youtube.com/watch?v=lq_pxzzCF4g&ab_channel=BoulangeriePas%C3%A0pas" target="_blank" style="color: var(--olive-green); text-decoration: underline;">🍳 Pain en cocotte (recette infaillible)</a>`;
            }

            // Questions sur la motivation et l'encouragement
            if (msg.includes('motivé') || msg.includes('motivation') || msg.includes('envie') ||
                msg.includes('découragé') || msg.includes('decourage') || msg.includes('abandonner') ||
                msg.includes('lassé') || msg.includes('lasse') || msg.includes('fatigué') ||
                msg.includes('fatigue') || msg.includes('plus envie') || msg.includes('ras le bol')) {
                
                const motivations = [
                    `🌟 <strong>Gardez la flamme !</strong><br><br>
                        La boulangerie est un art qui demande du temps, mais quelle satisfaction !<br><br>
                        <strong>🎯 Rappels motivants :</strong><br>
                        • L'odeur du pain frais dans votre cuisine<br>
                        • La fierté de nourrir sa famille<br>
                        • Chaque pain unique raconte votre histoire<br>
                        • La thérapie du pétrissage après une dure journée<br><br>
                        💡 <em>"Chaque boulanger a commencé par un premier pain raté !"</em>`,
                    `💫 <strong>Persévérez, vous êtes sur la bonne voie !</strong><br><br>
                        Même les grands boulangers ont eu des moments de doute !<br><br>
                        <strong>✨ Ce qui vous attend :</strong><br>
                        • Des petits-déjeuners magiques<br>
                        • L'admiration de vos proches<br>
                        • Une compétence pour la vie<br>
                        • Des moments de méditation en pétrissant<br><br>
                        💡 <em>"Le pain récompense la patience et la persévérance !"</em>`
                ];
                return motivations[Math.floor(Math.random() * motivations.length)];
            }

            // Questions sur l'humeur et les émotions
            if (msg.includes('content') || msg.includes('heureux') || msg.includes('joie') ||
                msg.includes('triste') || msg.includes('déprimé') || msg.includes('deprime') ||
                msg.includes('stressé') || msg.includes('stress') || msg.includes('angoissé') ||
                msg.includes('angoisse') || msg.includes('énervé') || msg.includes('enerve') ||
                msg.includes('en colère') || msg.includes('colere')) {
                
                return `😊 <strong>Les émotions du boulanger !</strong><br><br>
                    La boulangerie est un excellent remède contre le stress !<br><br>
                    <strong>🧘 Thérapie par le pain :</strong><br>
                    • <strong>Pétrissage :</strong> Évacue le stress et la colère<br>
                    • <strong>Patience :</strong> Apprend à ralentir<br>
                    • <strong>Création :</strong> Apporte de la fierté<br>
                    • <strong>Partage :</strong> Crée du lien social<br>
                    • <strong>Méditation :</strong> Le rythme apaise l'esprit<br><br>
                    💡 <em>"Transformer ses émotions en bon pain, c'est de l'alchimie !"</em>`;
            }

            // Questions sur l'application et ses fonctionnalités
            if (msg.includes('comment ça marche') || msg.includes('comment ca marche') ||
                msg.includes('fonctionnement') || msg.includes('utiliser') || msg.includes('naviguer') ||
                msg.includes('aide app') || msg.includes('aide application') ||
                msg.includes('bug') || msg.includes('problème app') || msg.includes('probleme app') ||
                msg.includes('sauvegarde') || msg.includes('export') || msg.includes('import')) {
                
                return `📱 <strong>Guide de l'application :</strong><br><br>
                    <strong>🧭 Navigation :</strong><br>
                    • <strong>Accueil :</strong> Statistiques et galerie photos<br>
                    • <strong>Pain/Pâtes/Viennoiseries :</strong> Vos recettes par famille<br>
                    • <strong>Levains :</strong> Gestion de vos levains<br>
                    • <strong>Conseils :</strong> Aide et vidéos<br><br>
                    
                    <strong>💾 Sauvegarde :</strong><br>
                    • Automatique dans le navigateur<br>
                    • Export JSON possible<br>
                    • Import de données<br><br>
                    
                    <strong>🎨 Fonctionnalités :</strong><br>
                    • Mode sombre disponible 🌙<br>
                    • Onglets personnalisés<br>
                    • Galerie photos<br>
                    • Assistant chatbot (moi ! 😊)<br><br>
                    
                    💡 Des questions spécifiques ? Demandez-moi !`;
            }

            // Questions sur le temps et la météo (pour plus de naturel)
            if (msg.includes('il fait beau') || msg.includes('il pleut') || msg.includes('il fait chaud') || 
                msg.includes('il fait froid') || msg.includes('météo') || msg.includes('meteo') ||
                msg.includes('temps qu\'il fait') || msg.includes('temps qu\'il fait')) {
                
                return `🌤️ <strong>Ah, la météo !</strong><br><br>
                    C'est important pour la boulangerie !<br><br>
                    <strong>Conseils météo :</strong><br>
                    • 🌞 <strong>Chaud et sec</strong> : Réduisez l'hydratation, pétrissez moins<br>
                    • 🌧️ <strong>Humide</strong> : Augmentez légèrement la farine<br>
                    • ❄️ <strong>Froid</strong> : Augmentez la température de l'eau<br>
                    • 🌪️ <strong>Vent</strong> : Protégez votre pâte du courant d'air<br><br>
                    💡 La météo influence beaucoup la fermentation !`;
            }

            // Expressions familières et argot
            if (msg.includes('ouf') || msg.includes('dingue') || msg.includes('ohlala') ||
                msg.includes('oh la la') || msg.includes('purée') || msg.includes('wahou') ||
                msg.includes('génial') || msg.includes('genial') || msg.includes('top') ||
                msg.includes('trop bien') || msg.includes('mortel') || msg.includes('stylé') ||
                msg.includes('style') || msg.includes('cool') || msg.includes('kiffant') ||
                msg.includes('kiffe') || msg.includes('grave') || msg.includes('carrément') ||
                msg.includes('carrement')) {
                
                return `😎 <strong>On est sur la même longueur d'onde !</strong><br><br>
                    J'adore votre enthousiasme pour la boulangerie !<br><br>
                    <strong>🔥 Le pain, c'est :</strong><br>
                    • Stylé quand ça sort du four<br>
                    • Mortel en tartine beurrée<br>
                    • Ouf l'odeur dans la cuisine<br>
                    • Génial à partager<br>
                    • Top niveau satisfaction<br><br>
                    💡 Continuez comme ça, vous êtes sur la bonne voie !`;
            }
            
            if (msg.includes('recipe') || msg.includes('liste recettes') || msg.includes('mes recettes')) {
                return getRecipesList();
            }
            
            if (msg.includes('levains') || msg.includes('mes levains')) {
                return getLevainsList();
            }
            
            // Réponse par défaut avec suggestions
            return `🤔 <strong>Je ne suis pas sûr de comprendre...</strong><br><br>
                Voici ce que je peux vous aider à résoudre :<br>
                • <strong>Recherche :</strong> "recette de pain", "pain au levain", "viennoiseries"<br>
                • <strong>Problèmes de pâte :</strong> "pâte trop molle", "ne lève pas"<br>
                • <strong>Levain :</strong> "levain inactif", "levain mort"<br>
                • <strong>Techniques :</strong> "pétrissage", "température", "cuisson"<br>
                • <strong>Ingrédients :</strong> "farine", "hydratation"<br>
                • <strong>Vos données :</strong> "mes recettes", "mes levains"<br><br>
                💬 Reformulez votre question ou utilisez un de ces mots-clés !`;
        }

        function getRecipesWithoutYeast() {
            const allRecipes = [];
            Object.keys(currentData.recipes).forEach(family => {
                currentData.recipes[family].forEach(recipe => {
                    if (recipe.ingredients) {
                        const hasYeast = recipe.ingredients.some(ing => 
                            ing.name.toLowerCase().includes('levure') || 
                            ing.name.toLowerCase().includes('levain')
                        );
                        if (!hasYeast) {
                            allRecipes.push({...recipe, family});
                        }
                    }
                });
            });
            return allRecipes;
        }

        // Nouvelles fonctions de recherche améliorées
        function searchRecipesByKeywords(keywords) {
            const matchingRecipes = [];
            Object.keys(currentData.recipes).forEach(family => {
                currentData.recipes[family].forEach(recipe => {
                    const recipeText = (recipe.name + ' ' + (recipe.comment || '') + ' ' + 
                        (recipe.ingredients ? recipe.ingredients.map(ing => ing.name).join(' ') : '')).toLowerCase();
                    
                    const matches = keywords.some(keyword => 
                        recipeText.includes(keyword.toLowerCase())
                    );
                    
                    if (matches) {
                        matchingRecipes.push({...recipe, family});
                    }
                });
            });
            return matchingRecipes;
        }

        function getAllRecipes() {
            const allRecipes = [];
            Object.keys(currentData.recipes).forEach(family => {
                currentData.recipes[family].forEach(recipe => {
                    allRecipes.push({...recipe, family});
                });
            });
            return allRecipes;
        }

        // Nouvelle fonction pour rechercher dans une famille spécifique
        function searchRecipesInFamily(family, keywords) {
            const familyRecipes = currentData.recipes[family] || [];
            const matchingRecipes = [];
            
            familyRecipes.forEach(recipe => {
                const recipeText = (recipe.name + ' ' + (recipe.comment || '') + ' ' + 
                    (recipe.ingredients ? recipe.ingredients.map(ing => ing.name).join(' ') : '')).toLowerCase();
                
                const matches = keywords.some(keyword => 
                    recipeText.includes(keyword.toLowerCase())
                );
                
                if (matches) {
                    matchingRecipes.push({...recipe, family});
                }
            });
            
            return matchingRecipes;
        }

        // Nouvelle fonction pour afficher une recette dans le chat
        function showRecipeInChat(recipeName, family) {
            const recipe = currentData.recipes[family].find(r => r.name === recipeName);
            if (recipe) {
                // Créer le contenu de la recette
                const ingredients = sortIngredientsByHierarchy(recipe.ingredients || []);
                const ingredientsList = ingredients.map(ing => 
                    `• ${ing.name}: ${ing.quantity} ${ing.unit}`
                ).join('<br>');
                
                const content = `
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid var(--accent-brown); margin: 1rem 0;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">${recipe.name}</h3>
                        
                        ${recipe.rating ? `<div style="margin-bottom: 1rem;">${generateStars(recipe.rating)}</div>` : ''}
                        
                        <div style="margin-bottom: 1rem;">
                            <h4 style="color: var(--accent-brown); margin-bottom: 0.5rem;">📝 Ingrédients :</h4>
                            <div style="background: white; padding: 1rem; border-radius: 6px; border: 1px solid #dee2e6;">
                                ${ingredientsList}
                            </div>
                        </div>
                        
                        ${recipe.comment ? `
                            <div style="margin-bottom: 1rem;">
                                <h4 style="color: var(--accent-brown); margin-bottom: 0.5rem;">👨‍🍳 Procédé :</h4>
                                <div style="background: white; padding: 1rem; border-radius: 6px; border: 1px solid #dee2e6; white-space: pre-line;">
                                    ${recipe.comment}
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="text-align: center; margin-top: 1rem;">
                            <button class="btn" onclick="closeModal()" style="margin-right: 0.5rem;">Fermer</button>
                            <button class="btn-secondary" onclick="editRecipeFromChat('${recipe.name}', '${family}')">Modifier</button>
                        </div>
                    </div>
                `;
                
                // Afficher la recette dans une modale
                showModal(recipe.name, content);
            }
        }

        function editRecipeFromChat(recipeName, family) {
            closeModal();
            // Rediriger vers la page de la famille et ouvrir la modal d'édition
            showPage(family);
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${family}"]`)?.classList.add('active');
            
            setTimeout(() => {
                const recipe = currentData.recipes[family].find(r => r.name === recipeName);
                if (recipe) {
                    showRecipeDetail(recipe, family);
                }
            }, 300);
        }

        // Fonction pour aller à la page levains depuis le chat
        function goToLevainsPage() {
            closeModal();
            // Aller à la page levains
            showPage('levains');
            
            // Mettre à jour la navigation
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.left-tabs .tab-button[data-tab="levains"]')?.classList.add('active');
            
            // Ouvrir la modal de création de levain après un court délai
            setTimeout(() => {
                openAddLevainModal();
            }, 500);
        }

        // Base de données des vidéos Boulangerie Pas à Pas
        const videoDatabase = {
            'levain': {
                title: '🧫 Fabrication du levain',
                url: 'https://www.youtube.com/watch?v=vD_aufrBTjU&ab_channel=BoulangeriePas%C3%A0pas',
                keywords: ['levain', 'starter', 'sourdough', 'fermentation', 'créer', 'faire', 'démarrer', 'commencer', 'nouveau', 'maison', 'naturel']
            },
            'nourrissage': {
                title: '🥖 Nourrissage du levain',
                url: 'https://www.youtube.com/watch?v=PP1b4XWXOk0&ab_channel=BoulangeriePas%C3%A0pas',
                keywords: ['nourrir', 'rafraîchir', 'rafraichir', 'entretien', 'maintenir', 'alimenter', 'soigner', 'prendre soin', 'garder', 'conserver']
            },
            'pain_cocotte': {
                title: '🍳 Pain en cocotte (recette infaillible)',
                url: 'https://www.youtube.com/watch?v=lq_pxzzCF4g&ab_channel=BoulangeriePas%C3%A0pas',
                keywords: ['cocotte', 'dutch oven', 'pain cocotte', 'pain cocotte', 'infaillible', 'facile', 'simple', 'débutant', 'debutant', 'recette facile']
            },
            'petrissage_manuel': {
                title: '👐 Pain au levain - Pétrissage à la main',
                url: 'https://www.youtube.com/watch?v=60K3Fe5j_J8&ab_channel=BoulangeriePas%C3%A0pas',
                keywords: ['pétrissage', 'petrir', 'manuel', 'main', 'technique', 'méthode', 'methode', 'façon', 'faccon', 'comment', 'pétrir', 'petrir', 'malaxer', 'travailler']
            },
            'pain_levain': {
                title: '🥖 Pain au levain complet',
                url: 'https://www.youtube.com/c/BoulangeriePas%C3%A0pas',
                keywords: ['pain levain', 'pain au levain', 'sourdough bread', 'pain complet', 'pain naturel', 'pain traditionnel', 'pain artisanal']
            },
            'viennoiseries': {
                title: '🥐 Viennoiseries et croissants',
                url: 'https://www.youtube.com/c/BoulangeriePas%C3%A0pas',
                keywords: ['croissant', 'viennoiserie', 'pâte feuilletée', 'pate feuilletee', 'chocolatine', 'pain au chocolat', 'brioche', 'danish', 'kouign amann']
            },
            'techniques_base': {
                title: '👨‍🍳 Techniques de base',
                url: 'https://www.youtube.com/c/BoulangeriePas%C3%A0pas',
                keywords: ['technique', 'base', 'fondamentaux', 'apprendre', 'débutant', 'debutant', 'commencer', 'premiers pas', 'initiation', 'formation']
            },
            'problemes': {
                title: '🔧 Résolution de problèmes',
                url: 'https://www.youtube.com/c/BoulangeriePas%C3%A0pas',
                keywords: ['problème', 'probleme', 'raté', 'rate', 'échec', 'echec', 'erreur', 'difficile', 'marche pas', 'ne fonctionne pas', 'aide', 'sauvetage']
            }
        };

        // Fonction pour recommander des vidéos selon le contexte
        function getVideoRecommendations(message) {
            const msg = message.toLowerCase();
            let recommendations = [];
            
            // Chercher les mots-clés dans le message
            Object.keys(videoDatabase).forEach(key => {
                const video = videoDatabase[key];
                const hasKeyword = video.keywords.some(keyword => 
                    msg.includes(keyword.toLowerCase())
                );
                
                if (hasKeyword) {
                    recommendations.push(video);
                }
            });
            
            // Si aucune correspondance spécifique, proposer des vidéos générales
            if (recommendations.length === 0) {
                recommendations = [
                    videoDatabase.levain,
                    videoDatabase.pain_cocotte,
                    videoDatabase.petrissage_manuel
                ];
            }
            
            // Limiter à 3 recommandations maximum
            recommendations = recommendations.slice(0, 3);
            
            let response = `📺 <strong>Vidéos recommandées - Boulangerie Pas à Pas :</strong><br><br>`;
            
            recommendations.forEach(video => {
                response += `<a href="${video.url}" target="_blank" style="color: var(--olive-green); text-decoration: underline;">${video.title}</a><br>`;
            });
            
            response += `<br>💡 <em>Ces vidéos vous aideront à progresser en boulangerie !</em><br><br>`;
            response += `<a href="https://www.youtube.com/c/BoulangeriePas%C3%A0pas" target="_blank" style="color: var(--accent-brown); text-decoration: underline;">📺 Voir toute la chaîne Boulangerie Pas à Pas</a>`;
            
            return response;
        }

        // Fonction pour obtenir des informations détaillées sur un levain spécifique
        function getSpecificLevainInfo(levain) {
            const ageResult = calculateLevainAge(levain.createdDate);
            const timeSinceRefresh = calculateTimeSinceRefresh(levain.lastRefresh);
            
            let status = '';
            let statusColor = '';
            
            if (levain.phase === 'birth') {
                status = '🐣 En phase de naissance';
                statusColor = '#FFA500';
            } else if (timeSinceRefresh.days > 3) {
                status = '⚠️ Nécessite un rafraîchissement';
                statusColor = '#FF6B35';
            } else {
                status = '✅ En bonne forme';
                statusColor = '#28A745';
            }
            
            let response = `🧄 <strong>Informations détaillées - ${levain.name}</strong><br><br>`;
            
            response += `<div style="background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius); border-left: 4px solid ${statusColor}; margin-bottom: 1rem;">`;
            response += `<strong>📊 Statut :</strong> ${status}<br>`;
            response += `<strong>🎂 Âge :</strong> ${ageResult.text}<br>`;
            
            if (levain.lastRefresh) {
                response += `<strong>🕒 Dernier rafraîchissement :</strong> ${timeSinceRefresh.text}<br>`;
            } else {
                response += `<strong>🕒 Dernier rafraîchissement :</strong> Jamais rafraîchi<br>`;
            }
            
            response += `<strong>📅 Créé le :</strong> ${new Date(levain.createdDate).toLocaleDateString()}<br>`;
            response += `</div>`;
            
            // Conseils selon l'état
            if (levain.phase === 'birth') {
                response += `<div style="background: #fff3cd; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">`;
                response += `<strong>💡 Conseils pour la phase de naissance :</strong><br>`;
                response += `• Rafraîchissez matin et soir<br>`;
                response += `• Gardez une température stable (24-26°C)<br>`;
                response += `• Surveillez l'apparition de bulles<br>`;
                response += `• L'odeur doit devenir acidulée<br>`;
                response += `</div>`;
            } else if (timeSinceRefresh.days > 3) {
                response += `<div style="background: #f8d7da; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">`;
                response += `<strong>⚠️ Action recommandée :</strong><br>`;
                response += `• Rafraîchissez votre levain dès que possible<br>`;
                response += `• Utilisez un ratio 1:1:1 (levain:farine:eau)<br>`;
                response += `• Attendez 4-6h avant utilisation<br>`;
                response += `</div>`;
            } else {
                response += `<div style="background: #d4edda; padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">`;
                response += `<strong>✅ Votre levain est en forme !</strong><br>`;
                response += `• Prêt à être utilisé dans vos recettes<br>`;
                response += `• Continuez les rafraîchissements réguliers<br>`;
                response += `• Conservez au frigo si non utilisé<br>`;
                response += `</div>`;
            }
            
            response += `<br><strong>📺 Vidéos recommandées :</strong><br>`;
            response += `<a href="https://www.youtube.com/watch?v=PP1b4XWXOk0&ab_channel=BoulangeriePas%C3%A0pas" target="_blank" style="color: var(--olive-green); text-decoration: underline;">🥖 Nourrissage du levain - Boulangerie Pas à Pas</a><br>`;
            response += `<a href="https://www.youtube.com/watch?v=vD_aufrBTjU&ab_channel=BoulangeriePas%C3%A0pas" target="_blank" style="color: var(--olive-green); text-decoration: underline;">🧫 Fabrication du levain - Boulangerie Pas à Pas</a>`;
            
            return response;
        }

        // Fonction pour obtenir des informations sur tous les levains
        function getAllLevainsInfo() {
            if (currentData.levains.length === 0) {
                return `🧄 <strong>Vos levains :</strong><br><br>
                    Vous n'avez encore aucun levain.<br><br>
                    💡 Créez votre premier levain dans l'onglet "Levains" - je vous guiderai étape par étape !<br><br>
                    
                    <strong>📺 Vidéo recommandée :</strong><br>
                    <a href="https://www.youtube.com/watch?v=vD_aufrBTjU&ab_channel=BoulangeriePas%C3%A0pas" target="_blank" style="color: var(--olive-green); text-decoration: underline;">🧫 Fabrication du levain - Boulangerie Pas à Pas</a>`;
            }
            
            let response = `🧄 <strong>Informations sur vos ${currentData.levains.length} levain${currentData.levains.length > 1 ? 's' : ''} :</strong><br><br>`;
            
            currentData.levains.forEach((levain, index) => {
                const ageResult = calculateLevainAge(levain.createdDate);
                const timeSinceRefresh = calculateTimeSinceRefresh(levain.lastRefresh);
                
                let status = '';
                if (levain.phase === 'birth') {
                    status = '🐣 Naissance';
                } else if (timeSinceRefresh.days > 3) {
                    status = '⚠️ À rafraîchir';
                } else {
                    status = '✅ En forme';
                }
                
                response += `<div style="background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 0.5rem; border-left: 4px solid var(--accent-brown);">`;
                response += `<strong>${levain.name}</strong><br>`;
                response += `• <strong>Âge :</strong> ${ageResult.text}<br>`;
                response += `• <strong>Statut :</strong> ${status}<br>`;
                
                if (levain.lastRefresh) {
                    response += `• <strong>Dernier rafraîchissement :</strong> ${timeSinceRefresh.text}<br>`;
                } else {
                    response += `• <strong>Dernier rafraîchissement :</strong> Jamais<br>`;
                }
                
                response += `</div>`;
            });
            
            response += `<br><strong>💡 Conseil :</strong> Demandez-moi "quel âge a [nom du levain] ?" pour des informations détaillées sur un levain spécifique !<br><br>`;
            
            response += `<strong>📺 Vidéos recommandées :</strong><br>`;
            response += `<a href="https://www.youtube.com/watch?v=PP1b4XWXOk0&ab_channel=BoulangeriePas%C3%A0pas" target="_blank" style="color: var(--olive-green); text-decoration: underline;">🥖 Nourrissage du levain - Boulangerie Pas à Pas</a><br>`;
            response += `<a href="https://www.youtube.com/watch?v=vD_aufrBTjU&ab_channel=BoulangeriePas%C3%A0pas" target="_blank" style="color: var(--olive-green); text-decoration: underline;">🧫 Fabrication du levain - Boulangerie Pas à Pas</a>`;
            
            return response;
        }

        function getRecipesList() {
            let totalRecipes = 0;
            let recipesByFamily = '';
            
            Object.keys(currentData.recipes).forEach(family => {
                const familyRecipes = currentData.recipes[family];
                totalRecipes += familyRecipes.length;
                
                if (familyRecipes.length > 0) {
                    recipesByFamily += `<br><strong>${family.charAt(0).toUpperCase() + family.slice(1)} (${familyRecipes.length}) :</strong><br>`;
                    familyRecipes.forEach(recipe => {
                        recipesByFamily += `• <a href="#" onclick="showRecipeFromChat('${recipe.name}', '${family}')" style="color: var(--olive-green); text-decoration: underline;">${recipe.name}</a> ${recipe.rating ? '(' + '★'.repeat(recipe.rating) + ')' : ''}<br>`;
                    });
                }
            });
            
            if (totalRecipes === 0) {
                return `📝 <strong>Vos recettes :</strong><br><br>
                    Vous n'avez encore aucune recette enregistrée.<br><br>
                    💡 Commencez par ajouter votre première recette en cliquant sur "Ajouter Recette" dans l'onglet de votre choix !`;
            }
            
            return `📝 <strong>Vos ${totalRecipes} recettes :</strong><br>${recipesByFamily}<br>
                💡 Cliquez sur une recette pour voir ses détails !`;
        }

        function getLevainsList() {
            if (currentData.levains.length === 0) {
                return `🧄 <strong>Vos levains :</strong><br><br>
                    Vous n'avez encore aucun levain.<br><br>
                    💡 Créez votre premier levain dans l'onglet "Levains" - je vous guiderai étape par étape !`;
            }
            
            let levainsList = `🧄 <strong>Vos ${currentData.levains.length} levain${currentData.levains.length > 1 ? 's' : ''} :</strong><br><br>`;
            
            currentData.levains.forEach(levain => {
                const age = calculateLevainAge(levain.createdDate);
                const timeSinceRefresh = calculateTimeSinceRefresh(levain.lastRefresh);
                const status = levain.phase === 'birth' ? '🐣 Naissance' : 
                              timeSinceRefresh.days > 3 ? '⚠️ À rafraîchir' : '✅ En forme';
                
                levainsList += `• <strong>${levain.name}</strong> - ${age.text} - ${status}<br>`;
            });
            
            levainsList += `<br>💡 Consultez l'onglet "Levains" pour plus de détails !`;
            return levainsList;
        }

        function showRecipeFromChat(recipeName, family) {
            const recipe = currentData.recipes[family].find(r => r.name === recipeName);
            if (recipe) {
                closeModal(); // Fermer le chatbot si ouvert dans une modale
                showPage(family); // Aller à la page de la famille
                
                // Mettre à jour la navigation
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-tab="${family}"]`)?.classList.add('active');
                
                // Afficher le détail de la recette après un court délai
                setTimeout(() => {
                    showRecipeDetail(recipe, family);
                }, 300);
            }
        }

        // Gestion des paramètres avancés
        function openSettingsModal() {
            showModal('⚙️ Paramètres', `
                <div class="settings-container">
                    <div class="mb-2">
                        <h4>Hiérarchie des Ingrédients</h4>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                            Définissez l'ordre d'affichage des ingrédients dans vos recettes.
                        </p>
                        <div id="ingredientHierarchy">
                            ${currentData.settings.ingredientHierarchy.map((ingredient, index) => `
                                <div class="hierarchy-item flex flex-between flex-center" style="padding: 0.5rem; background: var(--cream-white); margin-bottom: 0.5rem; border-radius: 4px;">
                                    <span>${index + 1}. ${ingredient}</span>
                                    <div>
                                        <button onclick="moveIngredient(${index}, -1)" ${index === 0 ? 'disabled' : ''}>▲</button>
                                        <button onclick="moveIngredient(${index}, 1)" ${index === currentData.settings.ingredientHierarchy.length - 1 ? 'disabled' : ''}>▼</button>
                                        <button onclick="removeIngredient(${index})" style="color: red;">🗑️</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="btn-group mt-2">
                            <input type="text" id="newIngredient" placeholder="Nouvel ingrédient" class="form-input" style="flex: 1;">
                            <button class="btn" onclick="addIngredientToHierarchy()">Ajouter</button>
                        </div>

                    </div>
                    

                    
                    <div class="mb-2">
                        <h4>Gestion des Données</h4>
                        <div style="background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius);">
                            <p><strong>Taille des données :</strong> ${formatBytes(JSON.stringify(currentData).length)}</p>
                            <p><strong>Nombre de recettes :</strong> ${Object.values(currentData.recipes).flat().length}</p>
                            <p><strong>Nombre d'images :</strong> ${currentData.gallery.length}</p>
                            <p><strong>Nombre de levains :</strong> ${currentData.levains.length}</p>
                        </div>
                        <div class="btn-group mt-2">
                            <button class="btn-danger" onclick="resetAllData()">🗑️ Tout réinitialiser</button>
                            <button class="btn-secondary" onclick="compressImages()">🗜️ Compresser images</button>
                        </div>
                    </div>

                    <div class="mb-2">
                        <h4>Export PDF</h4>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
                            Générer un rapport PDF complet avec vos recettes, levains et statistiques.
                        </p>
                        <div class="btn-group mt-2">
                            <button class="btn" onclick="exportToPDF()">📄 Exporter en PDF</button>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group mt-2">
                    <button class="btn" onclick="saveSettings()">💾 Sauvegarder</button>
                    <button class="btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            `);
            

        }

        // Modal pour les fonctions BETA
        function openBetaModal() {
            // Créer la grande fenêtre BETA
            const betaModal = document.createElement('div');
            betaModal.id = 'betaModal';
            betaModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(10px);
            `;

            betaModal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #F5E6D3, #E8D5B7);
                    border: 3px solid #8B4513;
                    border-radius: 20px;
                    width: 95vw;
                    height: 90vh;
                    padding: 30px;
                    overflow-y: auto;
                    position: relative;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
                ">
                    <!-- Bouton de fermeture -->
                    <button onclick="closeBetaModal()" style="
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: #8B4513;
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        font-size: 20px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10001;
                    ">✕</button>

                    <!-- Titre principal -->
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="font-size: 3.5rem; color: #8B4513; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                            🧪 CENTRE DE FORMATION PROFESSIONNEL BETA
                        </h1>
                        <p style="font-size: 1.3rem; color: #5D4037; font-weight: bold;">
                            Outils Avancés pour l'Excellence Boulangère
                        </p>
                    </div>

                    <!-- Grille des gros boutons -->
                    <div style="
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
                        gap: 25px;
                        margin-bottom: 30px;
                    ">
                        <!-- Analyse Recettes -->
                        <div class="beta-big-btn" onclick="analyzeRecipes()" style="
                            background: linear-gradient(135deg, #FF6B35, #F7931E);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            border: 3px solid #E65100;
                            transition: all 0.3s ease;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 15px;">🔍</div>
                            <h3 style="color: white; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Analyse Recettes</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">Analysez vos recettes pour optimisations</p>
                        </div>

                        <!-- Suivi Levains -->
                        <div class="beta-big-btn" onclick="suiviLevains()" style="
                            background: linear-gradient(135deg, #4CAF50, #8BC34A);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            border: 3px solid #388E3C;
                            transition: all 0.3s ease;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 15px;">🫓</div>
                            <h3 style="color: white; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Suivi Levains</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">Gérez vos levains et fermentations</p>
                        </div>

                        <!-- Gestion Ingrédients -->
                        <div class="beta-big-btn" onclick="gestionIngredients()" style="
                            background: linear-gradient(135deg, #9C27B0, #673AB7);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            border: 3px solid #7B1FA2;
                            transition: all 0.3s ease;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 15px;">📦</div>
                            <h3 style="color: white; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Gestion Ingrédients</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">Stocks et approvisionnements</p>
                        </div>

                        <!-- Liste Courses -->
                        <div class="beta-big-btn" onclick="listeCourses()" style="
                            background: linear-gradient(135deg, #00BCD4, #03A9F4);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            border: 3px solid #0097A7;
                            transition: all 0.3s ease;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 15px;">🛒</div>
                            <h3 style="color: white; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Liste Courses</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">Listes automatiques intelligentes</p>
                        </div>

                        <!-- Mode Pas-à-Pas -->
                        <div class="beta-big-btn" onclick="modePasAPas()" style="
                            background: linear-gradient(135deg, #795548, #8D6E63);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            border: 3px solid #5D4037;
                            transition: all 0.3s ease;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 15px;">👨‍🍳</div>
                            <h3 style="color: white; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Mode Pas-à-Pas</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">Guidage détaillé des recettes</p>
                        </div>

                        <!-- IA Prédictive -->
                        <div class="beta-big-btn" onclick="iaPredictive()" style="
                            background: linear-gradient(135deg, #E91E63, #F06292);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            border: 3px solid #C2185B;
                            transition: all 0.3s ease;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 15px;">🤖</div>
                            <h3 style="color: white; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">IA Prédictive</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">Suggestions intelligentes avancées</p>
                        </div>

                        <!-- Calibrateur Four -->
                        <div class="beta-big-btn" onclick="openCalibrateurFourModal(); closeBetaModal();" style="
                            background: linear-gradient(135deg, #FF5722, #FF7043);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            border: 3px solid #D84315;
                            transition: all 0.3s ease;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 15px;">🔥</div>
                            <h3 style="color: white; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Calibrateur Four</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">Testez et calibrez votre four</p>
                        </div>

                        <!-- Examens CAP - BOUTON PRINCIPAL -->
                        <div class="beta-big-btn" onclick="examensCAP()" style="
                            background: linear-gradient(135deg, #FFD700, #FFA000);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 12px 20px rgba(0,0,0,0.3);
                            border: 4px solid #FF8F00;
                            transition: all 0.3s ease;
                            position: relative;
                            overflow: hidden;
                        ">
                            <div style="position: absolute; top: 10px; right: 10px; background: #D32F2F; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">⭐ PREMIUM</div>
                            <div style="font-size: 3rem; margin-bottom: 15px;">🎓</div>
                            <h3 style="color: #8B4513; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); font-weight: bold;">Examens CAP Boulanger</h3>
                            <p style="color: #5D4037; font-size: 1rem; font-weight: bold;">Formation & Certification Officielle</p>
                        </div>

                        <!-- Bibliothèque Techniques -->
                        <div class="beta-big-btn" onclick="openBibliothequeTechniques()" style="
                            background: linear-gradient(135deg, #607D8B, #78909C);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            border: 3px solid #455A64;
                            transition: all 0.3s ease;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 15px;">📚</div>
                            <h3 style="color: white; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Bibliothèque Techniques</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">Compendium des techniques pro</p>
                        </div>

                        <!-- Partage Recettes -->
                        <div class="beta-big-btn" onclick="openPartageRecettes()" style="
                            background: linear-gradient(135deg, #3F51B5, #5C6BC0);
                            padding: 30px;
                            border-radius: 15px;
                            cursor: pointer;
                            text-align: center;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            border: 3px solid #303F9F;
                            transition: all 0.3s ease;
                        ">
                            <div style="font-size: 3rem; margin-bottom: 15px;">🌐</div>
                            <h3 style="color: white; font-size: 1.4rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Partage Recettes</h3>
                            <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">Communauté de boulangers</p>
                        </div>
                    </div>

                    <!-- Notice informative -->
                    <div style="background: linear-gradient(135deg, #FFF3E0, #FFE0B2); padding: 20px; border-radius: 15px; border: 2px solid #FF8F00; text-align: center;">
                        <h4 style="color: #E65100; margin-bottom: 10px;">⚠️ Fonctionnalités Expérimentales</h4>
                        <p style="color: #E65100; font-size: 0.95rem; margin: 0;">
                            Ces outils avancés sont en cours de développement. Certaines fonctions peuvent être limitées ou nécessiter des améliorations.
                        </p>
                    </div>
                </div>
            `;

            document.body.appendChild(betaModal);

            // Effet d'apparition
            betaModal.style.opacity = '0';
            setTimeout(() => {
                betaModal.style.transition = 'opacity 0.3s ease';
                betaModal.style.opacity = '1';
            }, 10);

            // Effet hover pour les boutons
            const style = document.createElement('style');
            style.textContent = `
                .beta-big-btn:hover {
                    transform: translateY(-5px) scale(1.02);
                    box-shadow: 0 15px 25px rgba(0,0,0,0.3) !important;
                }
            `;
            document.head.appendChild(style);
        }

        // Fonction pour fermer la modal BETA
        function closeBetaModal() {
            const modal = document.getElementById('betaModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }
        }

        // =============================================================================
        // FONCTIONS BETA - SYSTÈME COMPLET D'EXAMENS CAP BOULANGER
        // =============================================================================

        // Fonction principale pour les examens CAP
        function examensCAP() {
            closeBetaModal();
            
            // Charger les données d'examens
            const examData = getExamData();
            
            const examModal = document.createElement('div');
            examModal.id = 'examModal';
            examModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(15px);
            `;

            examModal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1A1A1A, #2D2D2D);
                    border: 3px solid #FFD700;
                    border-radius: 20px;
                    width: 95vw;
                    height: 90vh;
                    padding: 30px;
                    overflow-y: auto;
                    position: relative;
                    box-shadow: 0 20px 40px rgba(255, 215, 0, 0.3);
                ">
                    <!-- Bouton de fermeture -->
                    <button onclick="closeExamModal()" style="
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: #FFD700;
                        color: #1A1A1A;
                        border: none;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        font-size: 20px;
                        font-weight: bold;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10001;
                    ">✕</button>

                    <!-- En-tête officiel CAP -->
                    <div style="text-align: center; margin-bottom: 40px; color: white;">
                        <div style="background: linear-gradient(135deg, #FFD700, #FFA000); padding: 20px; border-radius: 15px; margin-bottom: 20px; position: relative;">
                            <!-- Drapeau français -->
                            <div style="
                                position: absolute;
                                top: -15px;
                                left: 20px;
                                width: 80px;
                                height: 50px;
                                background: linear-gradient(to right, 
                                    #002395 0%, #002395 33.33%, 
                                    #FFFFFF 33.33%, #FFFFFF 66.66%, 
                                    #ED2939 66.66%, #ED2939 100%);
                                border: 2px solid #1A1A1A;
                                border-radius: 5px;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                                transform: rotate(-5deg);
                                z-index: 10;
                            ">
                                <!-- Mât du drapeau -->
                                <div style="
                                    position: absolute;
                                    left: -8px;
                                    top: 0;
                                    width: 4px;
                                    height: 100%;
                                    background: linear-gradient(to bottom, #8B4513, #A0522D);
                                    border-radius: 2px;
                                "></div>
                                <!-- Effet de vent sur le drapeau -->
                                <div style="
                                    position: absolute;
                                    top: 0;
                                    left: 0;
                                    width: 100%;
                                    height: 100%;
                                    background: linear-gradient(45deg, 
                                        transparent 0%, 
                                        rgba(255,255,255,0.1) 50%, 
                                        transparent 100%);
                                    border-radius: 3px;
                                "></div>
                            </div>
                            
                            <h1 style="font-size: 3.5rem; color: #1A1A1A; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                                🎓 EXAMENS CAP BOULANGER OFFICIELS
                            </h1>
                            <p style="font-size: 1.2rem; color: #5D4037; font-weight: bold;">
                                Centre de Formation & Certification Professionnelle
                            </p>
                        </div>
                        <p style="font-size: 1.1rem; color: #FFD700; margin-bottom: 10px;">
                            ⭐ Entraînez-vous avec les vrais sujets d'examen
                        </p>
                        <p style="color: #B8B8B8; font-size: 0.95rem;">
                            Système de notation officiel - Corrections détaillées - Suivi des progrès
                        </p>
                    </div>

                    <!-- Sélection de l'année -->
                    <div style="margin-bottom: 40px;">
                        <h2 style="color: #FFD700; text-align: center; margin-bottom: 30px; font-size: 2rem;">
                            📅 Sélectionnez l'année d'examen
                        </h2>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                            <!-- Année 2024 -->
                            <div onclick="selectExamYear(2024)" style="
                                background: linear-gradient(135deg, #4CAF50, #66BB6A);
                                padding: 25px;
                                border-radius: 15px;
                                cursor: pointer;
                                text-align: center;
                                box-shadow: 0 8px 16px rgba(0,0,0,0.3);
                                border: 3px solid #388E3C;
                                transition: all 0.3s ease;
                                position: relative;
                            " class="exam-year-btn">
                                <div style="position: absolute; top: 10px; right: 10px; background: #FF5722; color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">NOUVEAU</div>
                                <div style="font-size: 2.5rem; margin-bottom: 15px;">📊</div>
                                <h3 style="color: white; font-size: 1.8rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Session 2024</h3>
                                <p style="color: rgba(255,255,255,0.9); font-size: 1rem; margin-bottom: 15px;">Sujets officiels récents</p>
                                <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 10px;">
                                    <p style="color: white; font-size: 0.9rem; margin: 0;">
                                        ✅ 2 examens disponibles<br>
                                        📈 Statistiques complètes
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Années futures -->
                            <div style="
                                background: linear-gradient(135deg, #9E9E9E, #757575);
                                padding: 25px;
                                border-radius: 15px;
                                text-align: center;
                                box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                                border: 3px solid #616161;
                                opacity: 0.6;
                            ">
                                <div style="font-size: 2.5rem; margin-bottom: 15px;">🔒</div>
                                <h3 style="color: white; font-size: 1.8rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Sessions 2025+</h3>
                                <p style="color: rgba(255,255,255,0.7); font-size: 1rem;">Disponibles prochainement</p>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques générales -->
                    <div style="background: linear-gradient(135deg, #37474F, #455A64); padding: 25px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="color: #FFD700; text-align: center; margin-bottom: 20px; font-size: 1.5rem;">📈 Vos Statistiques</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                            <div>
                                <div style="font-size: 2rem; color: #4CAF50;">${examData.stats.totalExams}</div>
                                <div style="color: #B8B8B8;">Examens passés</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; color: #FFD700;">${examData.stats.averageScore.toFixed(1)}/20</div>
                                <div style="color: #B8B8B8;">Moyenne générale</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; color: #FF5722;">${examData.stats.bestScore}/20</div>
                                <div style="color: #B8B8B8;">Meilleur score</div>
                            </div>
                            <div>
                                <div style="font-size: 2rem; color: #9C27B0;">${examData.stats.timeSpent}h</div>
                                <div style="color: #B8B8B8;">Temps d'étude</div>
                            </div>
                        </div>
                    </div>

                    <!-- Notice -->
                    <div style="background: linear-gradient(135deg, #FFF3E0, #FFE0B2); padding: 20px; border-radius: 15px; border: 2px solid #FF8F00; text-align: center;">
                        <h4 style="color: #E65100; margin-bottom: 10px;">📋 Informations</h4>
                        <p style="color: #E65100; font-size: 0.95rem; margin: 0;">
                            Les examens sont reproduits fidèlement selon les sujets officiels. Chaque session comprend les 3 épreuves : Technologie, Sciences Appliquées et Gestion.
                        </p>
                    </div>
                </div>
            `;

            document.body.appendChild(examModal);

            // Effet d'apparition
            examModal.style.opacity = '0';
            setTimeout(() => {
                examModal.style.transition = 'opacity 0.3s ease';
                examModal.style.opacity = '1';
            }, 10);

            // Ajouter les styles hover
            const examStyle = document.createElement('style');
            examStyle.textContent = `
                .exam-year-btn:hover {
                    transform: translateY(-5px) scale(1.02);
                    box-shadow: 0 15px 25px rgba(0,0,0,0.4) !important;
                }
            `;
            document.head.appendChild(examStyle);
        }

        // Fonction pour fermer la modal des examens
        function closeExamModal() {
            const modal = document.getElementById('examModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Fonction pour sélectionner une année d'examen
        function selectExamYear(year) {
            if (year === 2024) {
                showExam2024();
            } else {
                showAlert('⏳ Cette session n\'est pas encore disponible', 'warning');
            }
        }

        // Fonction pour afficher les examens 2024
        function showExam2024() {
            closeExamModal();
            
            const examData = getExamData();
            const exams2024 = examData.sessions["2024"];
            
            const exam2024Modal = document.createElement('div');
            exam2024Modal.id = 'exam2024Modal';
            exam2024Modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.95);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(15px);
            `;

            exam2024Modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #0D47A1, #1565C0);
                    border: 3px solid #FFD700;
                    border-radius: 20px;
                    width: 95vw;
                    height: 90vh;
                    padding: 30px;
                    overflow-y: auto;
                    position: relative;
                    box-shadow: 0 20px 40px rgba(255, 215, 0, 0.3);
                ">
                    <!-- Bouton retour -->
                    <button onclick="backToExamMenu()" style="
                        position: absolute;
                        top: 20px;
                        left: 20px;
                        background: #FFD700;
                        color: #1A1A1A;
                        border: none;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        font-size: 20px;
                        font-weight: bold;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10001;
                    ">⬅</button>

                    <!-- Bouton de fermeture -->
                    <button onclick="closeExam2024Modal()" style="
                        position: absolute;
                        top: 20px;
                        right: 20px;
                        background: #FFD700;
                        color: #1A1A1A;
                        border: none;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        font-size: 20px;
                        font-weight: bold;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10001;
                    ">✕</button>

                    <!-- En-tête 2024 -->
                    <div style="text-align: center; margin-bottom: 40px; color: white;">
                        <h1 style="font-size: 3rem; color: #FFD700; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                            📅 SESSION 2024 - CAP BOULANGER
                        </h1>
                        <p style="font-size: 1.2rem; color: #E3F2FD; margin-bottom: 20px;">
                            Épreuves EP1 - Technologie professionnelle, sciences appliquées et gestion appliquée
                        </p>
                    </div>

                    <!-- Liste des examens disponibles -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 40px;">
                        <!-- Examen Juin 2024 -->
                        <div style="
                            background: linear-gradient(135deg, #4CAF50, #66BB6A);
                            padding: 30px;
                            border-radius: 15px;
                            position: relative;
                            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
                            border: 3px solid #388E3C;
                        ">
                            ${getExamStatusBadge('juin2024', exams2024.juin)}
                            
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 3rem; margin-bottom: 15px;">📝</div>
                                <h3 style="color: white; font-size: 1.8rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                                    Examen Juin 2024
                                </h3>
                                <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">
                                    Sujet officiel - Session normale
                                </p>
                            </div>

                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; color: white;">
                                    <div>
                                        <div style="font-size: 1.2rem; font-weight: bold;">${exams2024.juin.attempts}</div>
                                        <div style="font-size: 0.9rem; opacity: 0.8;">Tentatives</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.2rem; font-weight: bold;">${exams2024.juin.bestScore}/20</div>
                                        <div style="font-size: 0.9rem; opacity: 0.8;">Meilleur score</div>
                                    </div>
                                </div>
                                ${exams2024.juin.lastScore > 0 ? `
                                    <div style="text-align: center; margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 8px;">
                                        <span style="color: white; font-size: 0.9rem;">Dernière note: ${exams2024.juin.lastScore}/20</span>
                                        <span style="color: #FFD700; font-weight: bold; margin-left: 10px;">${getScoreMention(exams2024.juin.lastScore)}</span>
                                    </div>
                                ` : ''}
                            </div>

                            <div style="text-align: center;">
                                <button onclick="startExam('juin2024')" style="
                                    background: #FFD700;
                                    color: #1A1A1A;
                                    border: none;
                                    padding: 15px 30px;
                                    border-radius: 25px;
                                    font-size: 1.1rem;
                                    font-weight: bold;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    🚀 Commencer l'examen
                                </button>
                                ${exams2024.juin.completed ? `
                                    <button onclick="viewCorrection('juin2024')" style="
                                        background: transparent;
                                        color: white;
                                        border: 2px solid white;
                                        padding: 10px 20px;
                                        border-radius: 20px;
                                        font-size: 0.9rem;
                                        cursor: pointer;
                                        margin-left: 10px;
                                        transition: all 0.3s ease;
                                    ">
                                        📖 Voir la correction
                                    </button>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Examen Septembre 2024 -->
                        <div style="
                            background: linear-gradient(135deg, #FF9800, #FFB74D);
                            padding: 30px;
                            border-radius: 15px;
                            position: relative;
                            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
                            border: 3px solid #F57C00;
                        ">
                            ${getExamStatusBadge('septembre2024', exams2024.septembre)}
                            
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 3rem; margin-bottom: 15px;">📋</div>
                                <h3 style="color: white; font-size: 1.8rem; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                                    Examen Septembre 2024
                                </h3>
                                <p style="color: rgba(255,255,255,0.9); font-size: 1rem;">
                                    Sujet officiel - Session rattrapage
                                </p>
                            </div>

                            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; text-align: center; color: white;">
                                    <div>
                                        <div style="font-size: 1.2rem; font-weight: bold;">${exams2024.septembre.attempts}</div>
                                        <div style="font-size: 0.9rem; opacity: 0.8;">Tentatives</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 1.2rem; font-weight: bold;">${exams2024.septembre.bestScore}/20</div>
                                        <div style="font-size: 0.9rem; opacity: 0.8;">Meilleur score</div>
                                    </div>
                                </div>
                                ${exams2024.septembre.lastScore > 0 ? `
                                    <div style="text-align: center; margin-top: 10px; padding: 8px; background: rgba(255,255,255,0.3); border-radius: 8px;">
                                        <span style="color: white; font-size: 0.9rem;">Dernière note: ${exams2024.septembre.lastScore}/20</span>
                                        <span style="color: #FFD700; font-weight: bold; margin-left: 10px;">${getScoreMention(exams2024.septembre.lastScore)}</span>
                                    </div>
                                ` : ''}
                            </div>

                            <div style="text-align: center;">
                                <button onclick="startExam('septembre2024')" style="
                                    background: #FFD700;
                                    color: #1A1A1A;
                                    border: none;
                                    padding: 15px 30px;
                                    border-radius: 25px;
                                    font-size: 1.1rem;
                                    font-weight: bold;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
                                " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                    🚀 Commencer l'examen
                                </button>
                                ${exams2024.septembre.completed ? `
                                    <button onclick="viewCorrection('septembre2024')" style="
                                        background: transparent;
                                        color: white;
                                        border: 2px solid white;
                                        padding: 10px 20px;
                                        border-radius: 20px;
                                        font-size: 0.9rem;
                                        cursor: pointer;
                                        margin-left: 10px;
                                        transition: all 0.3s ease;
                                    ">
                                        📖 Voir la correction
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(exam2024Modal);

            // Effet d'apparition
            exam2024Modal.style.opacity = '0';
            setTimeout(() => {
                exam2024Modal.style.transition = 'opacity 0.3s ease';
                exam2024Modal.style.opacity = '1';
            }, 10);
        }

        // Fonction pour fermer la modal 2024
        function closeExam2024Modal() {
            const modal = document.getElementById('exam2024Modal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }
        }

        // Fonction pour retourner au menu principal des examens
        function backToExamMenu() {
            closeExam2024Modal();
            examensCAP();
        }

        // Fonction pour obtenir le badge de statut d'un examen
        function getExamStatusBadge(examId, examData) {
            if (examData.completed) {
                const scoreColor = examData.bestScore >= 16 ? '#4CAF50' : 
                                 examData.bestScore >= 14 ? '#FF9800' : 
                                 examData.bestScore >= 10 ? '#FFC107' : '#F44336';
                return `
                    <div style="position: absolute; top: 15px; right: 15px; background: ${scoreColor}; color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                        ✅ ${examData.bestScore}/20
                    </div>
                `;
            } else {
                return `
                    <div style="position: absolute; top: 15px; right: 15px; background: #9E9E9E; color: white; padding: 8px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: bold;">
                        📝 Non passé
                    </div>
                `;
            }
        }

        // Fonction pour obtenir la mention selon la note
        function getScoreMention(score) {
            if (score >= 18) return "🥇 Excellent !";
            if (score >= 16) return "🥈 Très bien";
            if (score >= 14) return "🥉 Bien";
            if (score >= 12) return "👍 Assez bien";
            if (score >= 10) return "✅ Passable";
            return "❌ Insuffisant";
        }

        // Fonction pour démarrer un examen
        function startExam(examId) {
            if (examId === 'juin2024') {
                startJuin2024Exam();
            } else if (examId === 'septembre2024') {
                startSeptembre2024Exam();
            } else {
                showAlert('📅 Cet examen n\'est pas encore disponible', 'info');
            }
        }

        // Gestion des données d'examens
        function getExamData() {
            const stored = localStorage.getItem('examData');
            if (stored) {
                return JSON.parse(stored);
            }
            
            // Données par défaut
            const defaultData = {
                stats: {
                    totalExams: 0,
                    averageScore: 0,
                    bestScore: 0,
                    timeSpent: 0
                },
                sessions: {
                    "2024": {
                        juin: {
                            attempts: 0,
                            completed: false,
                            bestScore: 0,
                            lastScore: 0,
                            answers: {},
                            timeSpent: 0
                        },
                        septembre: {
                            attempts: 0,
                            completed: false,
                            bestScore: 0,
                            lastScore: 0,
                            answers: {},
                            timeSpent: 0
                        }
                    }
                }
            };
            
            saveExamData(defaultData);
            return defaultData;
        }

        function saveExamData(data) {
            localStorage.setItem('examData', JSON.stringify(data));
        }

        // Fonctions pour les autres boutons BETA (placeholders)
        function analyzeRecipes() {
            showAlert('🔍 Analyse de Recettes - Fonction en développement', 'info');
        }

        function suiviLevains() {
            closeBetaModal();
            createSuiviLevainsModal();
        }

        function gestionIngredients() {
            closeBetaModal();
            createGestionIngredientsModal();
        }

        function listeCourses() {
            closeBetaModal();
            createListeCoursesModal();
        }

        function modePasAPas() {
            closeBetaModal();
            createModePasAPasModal();
        }

        function iaPredictive() {
            closeBetaModal();
            createIAPredictiveModal();
        }

        function calibrateurFour() {
            showAlert('🔥 Calibrateur Four - Fonction en développement', 'info');
        }

        function bibliothequeTechniques() {
            showAlert('📚 Bibliothèque Techniques - Fonction en développement', 'info');
        }

        function partageRecettes() {
            showAlert('🌐 Partage Recettes - Fonction en développement', 'info');
        }

        // =============================================================================
        // FONCTIONS BETA COMPLÈTES - SUIVI LEVAINS, GESTION INGRÉDIENTS, LISTE COURSES
        // =============================================================================

        // FONCTION 2: SUIVI DES LEVAINS
        function createSuiviLevainsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'suiviLevainsModal';
            
            modal.innerHTML = `
                <div class="modal-content large">
                    <div class="modal-header">
                        <h2 class="modal-title">🫓 Suivi des Levains</h2>
                        <button onclick="closeSuiviLevainsModal()" style="
                            background: none;
                            border: none;
                            font-size: 2rem;
                            cursor: pointer;
                            color: #8B4513;
                        ">×</button>
                    </div>
                    
                    <div style="display: flex; gap: 20px; height: 70vh;">
                        <!-- Panneau gauche: Liste des levains -->
                        <div style="flex: 1; border: 2px solid #8B4513; border-radius: 10px; padding: 15px; background: #FFF8DC;">
                            <h3 style="color: #8B4513; margin-bottom: 15px;">Mes Levains</h3>
                            <button onclick="ajouterLevain()" style="
                                background: #4CAF50;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 5px;
                                cursor: pointer;
                                margin-bottom: 15px;
                                width: 100%;
                            ">+ Nouveau Levain</button>
                            <div id="listeLevainsContainer">
                                <!-- Les levains seront ajoutés ici -->
                            </div>
                        </div>
                        
                        <!-- Panneau central: Graphiques et données -->
                        <div style="flex: 2; border: 2px solid #8B4513; border-radius: 10px; padding: 15px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #8B4513; margin: 0;" id="titreGraphique">Sélectionnez un levain</h3>
                                <select id="periodeGraphique" onchange="updateGraphique()" style="
                                    padding: 5px 10px;
                                    border: 2px solid #8B4513;
                                    border-radius: 5px;
                                ">
                                    <option value="7">7 derniers jours</option>
                                    <option value="30">30 derniers jours</option>
                                    <option value="90">3 derniers mois</option>
                                </select>
                            </div>
                            <div id="graphiqueContainer" style="height: 300px; border: 1px solid #ddd; border-radius: 5px; display: flex; align-items: center; justify-content: center; background: #f9f9f9;">
                                <span style="color: #666;">Sélectionnez un levain pour voir son évolution</span>
                            </div>
                            
                            <!-- Prédictions -->
                            <div id="predictionsContainer" style="margin-top: 20px; padding: 15px; background: #E8F5E8; border-radius: 10px;">
                                <h4 style="color: #2E7D32; margin-bottom: 10px;">🔮 Prédictions IA</h4>
                                <div id="predictionsContent">
                                    <p style="color: #666; font-style: italic;">Sélectionnez un levain pour voir les prédictions</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panneau droit: Historique -->
                        <div style="flex: 1; border: 2px solid #8B4513; border-radius: 10px; padding: 15px; background: #FFF8DC;">
                            <h3 style="color: #8B4513; margin-bottom: 15px;">Historique</h3>
                            <button onclick="ajouterRafraichissement()" style="
                                background: #FF9800;
                                color: white;
                                border: none;
                                padding: 8px 15px;
                                border-radius: 5px;
                                cursor: pointer;
                                margin-bottom: 15px;
                                width: 100%;
                                font-size: 0.9rem;
                            ">+ Rafraîchissement</button>
                            <div id="historiqueContainer" style="max-height: 400px; overflow-y: auto;">
                                <!-- L'historique sera ajouté ici -->
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadLevainsData();
        }

        function closeSuiviLevainsModal() {
            const modal = document.getElementById('suiviLevainsModal');
            if (modal) modal.remove();
        }

        // Gestion des données levains
        if (typeof levainsData === 'undefined') {
            var levainsData = JSON.parse(localStorage.getItem('levainsData')) || [];
        }
        if (typeof selectedLevainId === 'undefined') {
            var selectedLevainId = null;
        }

        function loadLevainsData() {
            const container = document.getElementById('listeLevainsContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Récupérer les vraies données des levains depuis l'application principale
            if (typeof currentData !== 'undefined' && currentData.levains && currentData.levains.length > 0) {
                // Convertir les levains existants au format BETA
                levainsData = currentData.levains.map(levain => {
                    // Vérifier si ce levain existe déjà dans levainsData
                    const existingLevain = levainsData.find(l => l.id === levain.id);
                    
                    return {
                        id: levain.id,
                        nom: levain.name,
                        type: levain.recipe || 'Classique',
                        dateCreation: levain.createdDate,
                        historique: existingLevain ? existingLevain.historique : generateHistoriqueFromLevain(levain),
                        rafraichissements: existingLevain ? existingLevain.rafraichissements : generateRafraichissementsFromLevain(levain)
                    };
                });
                localStorage.setItem('levainsData', JSON.stringify(levainsData));
            } else if (levainsData.length === 0) {
                // Si aucun levain dans l'application principale, afficher un message
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px; font-style: italic;">Aucun levain trouvé.<br>Créez d\'abord des levains dans l\'onglet "Levains" principal.</p>';
                return;
            }
            
            levainsData.forEach(levain => {
                const levainElement = document.createElement('div');
                levainElement.style.cssText = `
                    padding: 12px;
                    margin-bottom: 10px;
                    border: 2px solid #8B4513;
                    border-radius: 8px;
                    background: white;
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                
                levainElement.innerHTML = `
                    <div style="font-weight: bold; color: #8B4513; margin-bottom: 5px;">${levain.nom}</div>
                    <div style="font-size: 0.9rem; color: #666;">Type: ${levain.type}</div>
                    <div style="font-size: 0.8rem; color: #999; margin-top: 5px;">
                        Créé le ${new Date(levain.dateCreation).toLocaleDateString('fr-FR')}
                    </div>
                `;
                
                levainElement.onclick = () => selectLevain(levain.id);
                container.appendChild(levainElement);
            });
        }

        function selectLevain(id) {
            selectedLevainId = id;
            const levain = levainsData.find(l => l.id === id);
            
            // Mettre à jour l'affichage
            document.getElementById('titreGraphique').textContent = `Évolution - ${levain.nom}`;
            
            // Mettre en surbrillance le levain sélectionné
            const containers = document.querySelectorAll('#listeLevainsContainer > div');
            containers.forEach(container => {
                container.style.background = 'white';
                container.style.borderColor = '#8B4513';
            });
            
            const selectedContainer = containers[levainsData.findIndex(l => l.id === id)];
            if (selectedContainer) {
                selectedContainer.style.background = '#E8F5E8';
                selectedContainer.style.borderColor = '#4CAF50';
            }
            
            updateGraphique();
            updateHistorique();
            updatePredictions();
        }

        function generateHistoriqueFromLevain(levain) {
            const data = [];
            const now = new Date();
            const creationDate = new Date(levain.createdDate);
            const daysSinceCreation = Math.floor((now - creationDate) / (1000 * 60 * 60 * 24));
            
            // Générer des données d'historique depuis la création jusqu'à maintenant
            for (let i = Math.min(daysSinceCreation, 30); i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                
                // Créer des données réalistes basées sur l'âge et les rafraîchissements
                let activiteBase = 60;
                if (levain.lastRefresh) {
                    const daysSinceRefresh = Math.floor((date - new Date(levain.lastRefresh)) / (1000 * 60 * 60 * 24));
                    activiteBase = Math.max(20, 90 - (daysSinceRefresh * 8));
                }
                
                data.push({
                    date: date.toISOString(),
                    volume: 100 + Math.sin(i * 0.2) * 15 + (Math.random() - 0.5) * 10,
                    activite: activiteBase + Math.sin(i * 0.3) * 20 + (Math.random() - 0.5) * 15,
                    acidite: 3.5 + Math.sin(i * 0.1) * 0.4 + (Math.random() - 0.5) * 0.2,
                    temperature: 22 + (Math.random() - 0.5) * 4
                });
            }
            
            return data;
        }

        function generateRafraichissementsFromLevain(levain) {
            const rafraichissements = [];
            
            // Si le levain a un lastRefresh, créer une entrée
            if (levain.lastRefresh) {
                rafraichissements.push({
                    date: levain.lastRefresh,
                    farine: levain.recipe === 'seigle' ? 'Seigle T130' : 'T65',
                    ratio: '1:1:1',
                    temperature: 22,
                    notes: 'Rafraîchissement récupéré depuis les données existantes'
                });
            }
            
            return rafraichissements;
        }

        function updateGraphique() {
            if (!selectedLevainId) return;
            
            const levain = levainsData.find(l => l.id === selectedLevainId);
            const periode = parseInt(document.getElementById('periodeGraphique').value);
            const container = document.getElementById('graphiqueContainer');
            
            // Filtrer les données selon la période
            const now = new Date();
            const startDate = new Date(now);
            startDate.setDate(startDate.getDate() - periode);
            
            const donneesFiltered = levain.historique.filter(d => new Date(d.date) >= startDate);
            
            // Créer un graphique simple avec canvas
            container.innerHTML = `
                <canvas id="graphiqueLevain" width="600" height="280" style="border: 1px solid #ddd;"></canvas>
            `;
            
            const canvas = document.getElementById('graphiqueLevain');
            const ctx = canvas.getContext('2d');
            
            // Nettoyer le canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Dessiner les axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(50, 250);
            ctx.lineTo(580, 250); // Axe X
            ctx.moveTo(50, 250);
            ctx.lineTo(50, 30); // Axe Y
            ctx.stroke();
            
            if (donneesFiltered.length > 0) {
                // Dessiner la courbe de volume
                ctx.strokeStyle = '#4CAF50';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                donneesFiltered.forEach((point, index) => {
                    const x = 50 + (index / (donneesFiltered.length - 1)) * 530;
                    const y = 250 - ((point.volume - 80) / 60) * 220;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // Dessiner la courbe d'activité
                ctx.strokeStyle = '#FF9800';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                donneesFiltered.forEach((point, index) => {
                    const x = 50 + (index / (donneesFiltered.length - 1)) * 530;
                    const y = 250 - (point.activite / 100) * 220;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
            }
            
            // Légende
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(60, 10, 15, 15);
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.fillText('Volume', 80, 22);
            
            ctx.fillStyle = '#FF9800';
            ctx.fillRect(150, 10, 15, 15);
            ctx.fillStyle = '#333';
            ctx.fillText('Activité', 170, 22);
        }

        function updateHistorique() {
            if (!selectedLevainId) return;
            
            const levain = levainsData.find(l => l.id === selectedLevainId);
            const container = document.getElementById('historiqueContainer');
            
            container.innerHTML = '';
            
            levain.rafraichissements.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(rafr => {
                const rafrElement = document.createElement('div');
                rafrElement.style.cssText = `
                    padding: 10px;
                    margin-bottom: 8px;
                    border: 1px solid #ddd;
                    border-radius: 5px;
                    background: white;
                    font-size: 0.85rem;
                `;
                
                rafrElement.innerHTML = `
                    <div style="font-weight: bold; color: #8B4513;">${new Date(rafr.date).toLocaleDateString('fr-FR')}</div>
                    <div style="color: #666; margin-top: 3px;">Farine: ${rafr.farine}</div>
                    <div style="color: #666;">Ratio: ${rafr.ratio}</div>
                    <div style="color: #666;">T°: ${rafr.temperature}°C</div>
                    ${rafr.notes ? `<div style="color: #999; font-style: italic; margin-top: 5px;">${rafr.notes}</div>` : ''}
                `;
                
                container.appendChild(rafrElement);
            });
            
            if (levain.rafraichissements.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; text-align: center;">Aucun rafraîchissement enregistré</p>';
            }
        }

        function updatePredictions() {
            if (!selectedLevainId) return;
            
            const levain = levainsData.find(l => l.id === selectedLevainId);
            const container = document.getElementById('predictionsContent');
            
            // Analyser les dernières données
            const dernieresDonnees = levain.historique.slice(-7);
            const moyenneActivite = dernieresDonnees.reduce((sum, d) => sum + d.activite, 0) / dernieresDonnees.length;
            const tendanceVolume = dernieresDonnees[dernieresDonnees.length-1].volume - dernieresDonnees[0].volume;
            
            let predictions = [];
            
            if (moyenneActivite > 70) {
                predictions.push('🟢 Levain très actif - Prêt pour utilisation immédiate');
                predictions.push('⏰ Utilisation optimale dans les 2-4h prochaines');
            } else if (moyenneActivite > 40) {
                predictions.push('🟡 Activité modérée - Prévoir rafraîchissement sous 12h');
                predictions.push('📈 Pic d\'activité attendu dans 6-8h');
            } else {
                predictions.push('🔴 Faible activité - Rafraîchissement nécessaire');
                predictions.push('⚠️ Vérifier la température ambiante et la qualité de la farine');
            }
            
            if (tendanceVolume > 0) {
                predictions.push('📊 Volume en augmentation - Fermentation active');
            } else {
                predictions.push('📉 Volume stable/décroissant - Phase de maturation');
            }
            
            container.innerHTML = predictions.map(p => `<div style="margin-bottom: 8px; padding: 5px; background: rgba(255,255,255,0.7); border-radius: 3px;">${p}</div>`).join('');
        }

        function ajouterLevain() {
            // Fermer la modal de suivi des levains
            closeSuiviLevainsModal();
            
            // Rediriger vers l'onglet principal des levains pour créer un nouveau levain
            if (typeof showPage === 'function') {
                showPage('levains');
            }
            
            // Afficher un message informatif
            showAlert('Pour créer un nouveau levain, utilisez l\'onglet "Levains" principal. Il apparaîtra ensuite automatiquement ici.', 'info');
        }

        function ajouterRafraichissement() {
            if (!selectedLevainId) {
                alert('Veuillez d\'abord sélectionner un levain');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Nouveau Rafraîchissement</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    <form onsubmit="enregistrerRafraichissement(event)">
                        <div class="form-group">
                            <label class="form-label">Date et heure:</label>
                            <input type="datetime-local" id="rafr_date" class="form-input" value="${new Date().toISOString().slice(0,16)}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Type de farine:</label>
                            <input type="text" id="rafr_farine" class="form-input" value="T65" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Ratio (levain:farine:eau):</label>
                            <input type="text" id="rafr_ratio" class="form-input" value="1:1:1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Température ambiante (°C):</label>
                            <input type="number" id="rafr_temp" class="form-input" value="22" min="15" max="35" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Notes (optionnel):</label>
                            <textarea id="rafr_notes" class="form-textarea" placeholder="Observations, changements notés..."></textarea>
                        </div>
                        <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">Enregistrer</button>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function enregistrerRafraichissement(event) {
            event.preventDefault();
            
            const rafraichissement = {
                date: document.getElementById('rafr_date').value,
                farine: document.getElementById('rafr_farine').value,
                ratio: document.getElementById('rafr_ratio').value,
                temperature: parseFloat(document.getElementById('rafr_temp').value),
                notes: document.getElementById('rafr_notes').value
            };
            
            const levain = levainsData.find(l => l.id === selectedLevainId);
            levain.rafraichissements.push(rafraichissement);
            
            // Ajouter un point de données d'historique
            levain.historique.push({
                date: rafraichissement.date,
                volume: 100 + Math.random() * 20,
                activite: 80 + Math.random() * 20,
                acidite: 3.5 + Math.random() * 0.5,
                temperature: rafraichissement.temperature
            });
            
            // Synchroniser avec l'application principale
            if (typeof currentData !== 'undefined' && currentData.levains) {
                const mainLevain = currentData.levains.find(l => l.id === selectedLevainId);
                if (mainLevain) {
                    mainLevain.lastRefresh = rafraichissement.date;
                    // Sauvegarder dans le système principal
                    if (typeof saveDataToStorage === 'function') {
                        saveDataToStorage();
                    }
                    // Mettre à jour l'affichage principal si nécessaire
                    if (typeof renderLevains === 'function') {
                        renderLevains();
                    }
                }
            }
            
            localStorage.setItem('levainsData', JSON.stringify(levainsData));
            
            // Fermer la modal et mettre à jour l'affichage
            event.target.closest('.modal').remove();
            updateHistorique();
            updateGraphique();
            updatePredictions();
            
            showAlert('Rafraîchissement enregistré avec succès!', 'success');
        }

        // FONCTION 3: GESTION DES INGRÉDIENTS
        function createGestionIngredientsModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'gestionIngredientsModal';
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    max-width: 1400px;
                    max-height: 90vh;
                    height: 85vh;
                    width: 95vw;
                ">
                    <div class="modal-header">
                        <h2 class="modal-title">📦 Gestionnaire d'Ingrédients</h2>
                        <button onclick="closeGestionIngredientsModal()" style="
                            background: none;
                            border: none;
                            font-size: 2rem;
                            cursor: pointer;
                            color: #8B4513;
                        ">×</button>
                    </div>
                    
                    <div style="display: flex; gap: 20px; height: 75vh;">
                        <!-- Panneau gauche: Inventaire -->
                        <div style="flex: 3; border: 2px solid #9C27B0; border-radius: 10px; padding: 15px; background: #F3E5F5;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #7B1FA2; margin: 0;">Inventaire</h3>
                                <button onclick="ajouterIngredient()" style="
                                    background: #9C27B0;
                                    color: white;
                                    border: none;
                                    padding: 8px 15px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                ">+ Ajouter</button>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 2.5fr 1fr 1fr 1.3fr 1.5fr; gap: 15px; margin-bottom: 10px; font-weight: bold; color: #7B1FA2; padding-bottom: 5px; border-bottom: 2px solid #9C27B0;">
                                <div>Ingrédient</div>
                                <div>Stock</div>
                                <div>Unité</div>
                                <div>Péremption</div>
                                <div>Statut</div>
                            </div>
                            
                            <div id="inventaireContainer" style="max-height: 550px; overflow-y: auto;">
                                <!-- L'inventaire sera chargé ici -->
                            </div>
                        </div>
                        
                        <!-- Panneau droit: Alertes et calculs -->
                        <div style="flex: 1.5; display: flex; flex-direction: column; gap: 20px;">
                            <!-- Alertes -->
                            <div style="border: 2px solid #FF5722; border-radius: 10px; padding: 15px; background: #FFEBEE;">
                                <h3 style="color: #D32F2F; margin-bottom: 15px;">🚨 Alertes Stock</h3>
                                <div id="alertesContainer">
                                    <!-- Les alertes seront chargées ici -->
                                </div>
                            </div>
                            
                            <!-- Calculs pour recettes -->
                            <div style="border: 2px solid #2196F3; border-radius: 10px; padding: 15px; background: #E3F2FD;">
                                <h3 style="color: #1976D2; margin-bottom: 15px;">🧮 Calcul Besoins</h3>
                                <select id="recetteSelect" onchange="calculerBesoins()" style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #2196F3; border-radius: 5px;">
                                    <option value="">Sélectionner une recette</option>
                                </select>
                                <div id="besoinsContainer">
                                    <p style="color: #666; font-style: italic;">Sélectionnez une recette pour voir les besoins</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadIngredientsData();
        }

        function closeGestionIngredientsModal() {
            const modal = document.getElementById('gestionIngredientsModal');
            if (modal) modal.remove();
        }

        // Gestion des données ingrédients
        if (typeof ingredientsData === 'undefined') {
            var ingredientsData = JSON.parse(localStorage.getItem('ingredientsData')) || [];
        }

        function loadIngredientsData() {
            if (ingredientsData.length === 0) {
                // Créer des données d'exemple
                ingredientsData = [
                    { id: 'farine_t65', nom: 'Farine T65', stock: 2.5, unite: 'kg', peremption: '2024-12-31', seuilAlerte: 1.0 },
                    { id: 'farine_t55', nom: 'Farine T55', stock: 0.8, unite: 'kg', peremption: '2024-11-15', seuilAlerte: 1.0 },
                    { id: 'sel', nom: 'Sel fin', stock: 500, unite: 'g', peremption: '2025-06-01', seuilAlerte: 200 },
                    { id: 'levure', nom: 'Levure fraîche', stock: 100, unite: 'g', peremption: '2024-02-28', seuilAlerte: 50 },
                    { id: 'beurre', nom: 'Beurre doux', stock: 250, unite: 'g', peremption: '2024-03-15', seuilAlerte: 200 },
                    { id: 'sucre', nom: 'Sucre blanc', stock: 1200, unite: 'g', peremption: '2025-01-01', seuilAlerte: 500 }
                ];
                localStorage.setItem('ingredientsData', JSON.stringify(ingredientsData));
            }
            
            updateInventaireDisplay();
            updateAlertesDisplay();
            loadRecettesSelect();
        }

        function updateInventaireDisplay() {
            const container = document.getElementById('inventaireContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            ingredientsData.forEach(ingredient => {
                const row = document.createElement('div');
                row.style.cssText = `
                    display: grid;
                    grid-template-columns: 2.5fr 1fr 1fr 1.3fr 1.5fr;
                    gap: 15px;
                    padding: 10px 0;
                    border-bottom: 1px solid #ddd;
                    align-items: center;
                `;
                
                const today = new Date();
                const peremption = new Date(ingredient.peremption);
                const joursRestants = Math.ceil((peremption - today) / (1000 * 60 * 60 * 24));
                
                let statutStyle = 'background: #4CAF50; color: white;';
                let statutText = '✓ OK';
                
                if (ingredient.stock <= ingredient.seuilAlerte) {
                    statutStyle = 'background: #FF5722; color: white;';
                    statutText = '⚠️ STOCK BAS';
                } else if (joursRestants <= 7) {
                    statutStyle = 'background: #FF9800; color: white;';
                    statutText = '⏰ EXPIRE BIENTÔT';
                } else if (joursRestants <= 0) {
                    statutStyle = 'background: #F44336; color: white;';
                    statutText = '❌ EXPIRÉ';
                }
                
                row.innerHTML = `
                    <div style="font-weight: bold; color: #7B1FA2;">${ingredient.nom}</div>
                    <div style="text-align: center;">${ingredient.stock}</div>
                    <div style="text-align: center;">${ingredient.unite}</div>
                    <div style="text-align: center; font-size: 0.9rem; color: #555;">${new Date(ingredient.peremption).toLocaleDateString('fr-FR')}</div>
                    <div style="text-align: center;">
                        <span style="
                            padding: 5px 10px;
                            border-radius: 15px;
                            font-size: 0.75rem;
                            font-weight: bold;
                            white-space: nowrap;
                            display: inline-block;
                            min-width: 90px;
                            ${statutStyle}
                        ">${statutText}</span>
                    </div>
                `;
                
                // Ajouter event listener pour édition
                row.onclick = () => editerIngredient(ingredient.id);
                row.style.cursor = 'pointer';
                
                container.appendChild(row);
            });
        }

        function updateAlertesDisplay() {
            const container = document.getElementById('alertesContainer');
            if (!container) return;
            
            const alertes = [];
            const today = new Date();
            
            ingredientsData.forEach(ingredient => {
                const peremption = new Date(ingredient.peremption);
                const joursRestants = Math.ceil((peremption - today) / (1000 * 60 * 60 * 24));
                
                if (ingredient.stock <= ingredient.seuilAlerte) {
                    alertes.push({
                        type: 'stock',
                        message: `Stock bas: ${ingredient.nom} (${ingredient.stock} ${ingredient.unite})`,
                        priorite: 1
                    });
                }
                
                if (joursRestants <= 7 && joursRestants > 0) {
                    alertes.push({
                        type: 'peremption',
                        message: `Expire dans ${joursRestants} jour(s): ${ingredient.nom}`,
                        priorite: 2
                    });
                } else if (joursRestants <= 0) {
                    alertes.push({
                        type: 'expire',
                        message: `EXPIRÉ: ${ingredient.nom}`,
                        priorite: 0
                    });
                }
            });
            
            alertes.sort((a, b) => a.priorite - b.priorite);
            
            if (alertes.length === 0) {
                container.innerHTML = '<p style="color: #4CAF50; font-style: italic;">✅ Aucune alerte</p>';
                return;
            }
            
            container.innerHTML = alertes.map(alerte => {
                const couleur = alerte.priorite === 0 ? '#F44336' : alerte.priorite === 1 ? '#FF5722' : '#FF9800';
                return `
                    <div style="
                        padding: 8px;
                        margin-bottom: 8px;
                        background: white;
                        border-left: 4px solid ${couleur};
                        border-radius: 3px;
                        font-size: 0.9rem;
                    ">${alerte.message}</div>
                `;
            }).join('');
        }

        function ajouterIngredient() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Nouvel Ingrédient</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    <form onsubmit="enregistrerIngredient(event)">
                        <div class="form-group">
                            <label class="form-label">Nom de l'ingrédient:</label>
                            <input type="text" id="ing_nom" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Stock actuel:</label>
                            <input type="number" id="ing_stock" class="form-input" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unité:</label>
                            <select id="ing_unite" class="form-select" required>
                                <option value="g">grammes (g)</option>
                                <option value="kg">kilogrammes (kg)</option>
                                <option value="ml">millilitres (ml)</option>
                                <option value="l">litres (l)</option>
                                <option value="pièce">pièce(s)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date de péremption:</label>
                            <input type="date" id="ing_peremption" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seuil d'alerte:</label>
                            <input type="number" id="ing_seuil" class="form-input" step="0.1" required>
                        </div>
                        <button type="submit" class="btn" style="width: 100%; margin-top: 20px;">Ajouter</button>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function enregistrerIngredient(event) {
            event.preventDefault();
            
            const newIngredient = {
                id: 'ing_' + Date.now(),
                nom: document.getElementById('ing_nom').value,
                stock: parseFloat(document.getElementById('ing_stock').value),
                unite: document.getElementById('ing_unite').value,
                peremption: document.getElementById('ing_peremption').value,
                seuilAlerte: parseFloat(document.getElementById('ing_seuil').value)
            };
            
            ingredientsData.push(newIngredient);
            localStorage.setItem('ingredientsData', JSON.stringify(ingredientsData));
            
            event.target.closest('.modal').remove();
            updateInventaireDisplay();
            updateAlertesDisplay();
        }

        function editerIngredient(ingredientId) {
            const ingredient = ingredientsData.find(i => i.id === ingredientId);
            if (!ingredient) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Modifier: ${ingredient.nom}</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    <form onsubmit="sauvegarderModificationIngredient(event, '${ingredientId}')">
                        <div class="form-group">
                            <label class="form-label">Stock actuel:</label>
                            <input type="number" id="edit_stock" class="form-input" step="0.1" value="${ingredient.stock}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Date de péremption:</label>
                            <input type="date" id="edit_peremption" class="form-input" value="${ingredient.peremption}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Seuil d'alerte:</label>
                            <input type="number" id="edit_seuil" class="form-input" step="0.1" value="${ingredient.seuilAlerte}" required>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="submit" class="btn" style="flex: 1;">Sauvegarder</button>
                            <button type="button" onclick="supprimerIngredient('${ingredientId}')" style="
                                background: #F44336;
                                color: white;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 5px;
                                cursor: pointer;
                                flex: 1;
                            ">Supprimer</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function sauvegarderModificationIngredient(event, ingredientId) {
            event.preventDefault();
            
            const ingredient = ingredientsData.find(i => i.id === ingredientId);
            if (!ingredient) return;
            
            ingredient.stock = parseFloat(document.getElementById('edit_stock').value);
            ingredient.peremption = document.getElementById('edit_peremption').value;
            ingredient.seuilAlerte = parseFloat(document.getElementById('edit_seuil').value);
            
            localStorage.setItem('ingredientsData', JSON.stringify(ingredientsData));
            
            event.target.closest('.modal').remove();
            updateInventaireDisplay();
            updateAlertesDisplay();
        }

        function supprimerIngredient(ingredientId) {
            if (confirm('Êtes-vous sûr de vouloir supprimer cet ingrédient?')) {
                ingredientsData = ingredientsData.filter(i => i.id !== ingredientId);
                localStorage.setItem('ingredientsData', JSON.stringify(ingredientsData));
                
                // Fermer la modal
                const modal = document.querySelector('.modal.active');
                if (modal) modal.remove();
                
                updateInventaireDisplay();
                updateAlertesDisplay();
            }
        }

        function loadRecettesSelect() {
            const select = document.getElementById('recetteSelect');
            if (!select) return;
            
            // Récupérer les recettes depuis le localStorage (si elles existent)
            const recettes = JSON.parse(localStorage.getItem('recettes')) || [
                { nom: 'Pain de campagne', ingredients: [
                    { nom: 'Farine T65', quantite: 500, unite: 'g' },
                    { nom: 'Sel fin', quantite: 10, unite: 'g' },
                    { nom: 'Levain Chef', quantite: 100, unite: 'g' }
                ]},
                { nom: 'Baguette tradition', ingredients: [
                    { nom: 'Farine T55', quantite: 1000, unite: 'g' },
                    { nom: 'Sel fin', quantite: 20, unite: 'g' },
                    { nom: 'Levure fraîche', quantite: 5, unite: 'g' }
                ]},
                { nom: 'Croissants', ingredients: [
                    { nom: 'Farine T55', quantite: 500, unite: 'g' },
                    { nom: 'Beurre doux', quantite: 250, unite: 'g' },
                    { nom: 'Sucre blanc', quantite: 50, unite: 'g' }
                ]}
            ];
            
            select.innerHTML = '<option value="">Sélectionner une recette</option>';
            recettes.forEach((recette, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = recette.nom;
                select.appendChild(option);
            });
            
            // Stocker les recettes pour utilisation
            window.tempRecettes = recettes;
        }

        function calculerBesoins() {
            const select = document.getElementById('recetteSelect');
            const container = document.getElementById('besoinsContainer');
            
            if (!select.value) {
                container.innerHTML = '<p style="color: #666; font-style: italic;">Sélectionnez une recette pour voir les besoins</p>';
                return;
            }
            
            const recette = window.tempRecettes[parseInt(select.value)];
            let besoinsHTML = `<h4 style="color: #1976D2; margin-bottom: 10px;">${recette.nom}</h4>`;
            
            recette.ingredients.forEach(ing => {
                const stockActuel = ingredientsData.find(i => i.nom === ing.nom);
                const disponible = stockActuel ? stockActuel.stock : 0;
                const manque = Math.max(0, ing.quantite - disponible);
                
                const couleur = manque > 0 ? '#F44336' : '#4CAF50';
                const statut = manque > 0 ? `❌ Manque ${manque} ${ing.unite}` : '✅ Disponible';
                
                besoinsHTML += `
                    <div style="
                        padding: 8px;
                        margin-bottom: 5px;
                        border: 1px solid #ddd;
                        border-radius: 3px;
                        background: white;
                        font-size: 0.9rem;
                    ">
                        <div style="font-weight: bold;">${ing.nom}: ${ing.quantite} ${ing.unite}</div>
                        <div style="color: ${couleur}; font-size: 0.8rem;">${statut}</div>
                    </div>
                `;
            });
            
            container.innerHTML = besoinsHTML;
        }

        // FONCTION 5: MODE RECETTE PAS-À-PAS
        function createModePasAPasModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'modePasAPasModal';
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    max-width: 1200px;
                    max-height: 90vh;
                    height: 85vh;
                    width: 95vw;
                ">
                    <div class="modal-header">
                        <h2 class="modal-title">👨‍🍳 Mode Recette Pas-à-Pas</h2>
                        <button onclick="closeModePasAPasModal()" style="
                            background: none;
                            border: none;
                            font-size: 2rem;
                            cursor: pointer;
                            color: #8B4513;
                        ">×</button>
                    </div>
                    
                    <div style="display: flex; gap: 20px; height: 75vh;">
                        <!-- Panneau gauche: Sélection de recette -->
                        <div style="flex: 1; border: 2px solid #8B4513; border-radius: 10px; padding: 15px; background: #FFF8DC;">
                            <h3 style="color: #8B4513; margin-bottom: 15px;">📋 Choisir une recette</h3>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #8B4513;">Recette:</label>
                                <select id="recettePasAPas" onchange="chargerRecettePasAPas()" style="
                                    width: 100%;
                                    padding: 8px;
                                    border: 2px solid #8B4513;
                                    border-radius: 5px;
                                    font-size: 14px;
                                ">
                                    <option value="">Sélectionner une recette...</option>
                                </select>
                            </div>
                            
                            <div id="recetteInfo" style="display: none; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 id="recetteNom" style="color: #8B4513; margin-bottom: 10px;"></h4>
                                <p id="recetteDescription" style="color: #666; font-size: 14px; margin-bottom: 15px;"></p>
                                <div id="recetteIngredients" style="margin-bottom: 15px;"></div>
                                
                                <!-- Gestion des étapes -->
                                <div style="margin-bottom: 15px;">
                                    <h5 style="color: #8B4513; margin-bottom: 10px;">📝 Étapes personnalisées</h5>
                                    <div id="etapesList" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #f9f9f9; margin-bottom: 10px;">
                                        <p style="color: #666; font-style: italic; text-align: center; margin: 0;">Aucune étape définie</p>
                                    </div>
                                    
                                    <button onclick="ajouterEtape()" style="
                                        background: #2196F3;
                                        color: white;
                                        border: none;
                                        padding: 8px 15px;
                                        border-radius: 5px;
                                        cursor: pointer;
                                        width: 100%;
                                        margin-bottom: 10px;
                                    ">➕ Ajouter une étape</button>
                                    
                                    <button onclick="memoriserRecette()" style="
                                        background: #FF9800;
                                        color: white;
                                        border: none;
                                        padding: 8px 15px;
                                        border-radius: 5px;
                                        cursor: pointer;
                                        width: 100%;
                                        margin-bottom: 10px;
                                    ">💾 Mémoriser cette recette</button>
                                </div>
                                
                                <button onclick="demarrerModePasAPas()" style="
                                    background: #4CAF50;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                    width: 100%;
                                    font-weight: bold;
                                ">🚀 Commencer le mode pas-à-pas</button>
                            </div>
                        </div>
                        
                        <!-- Panneau central: Étapes guidées -->
                        <div style="flex: 2; border: 2px solid #8B4513; border-radius: 10px; padding: 15px; background: white;">
                            <div id="etapesContainer" style="height: 100%; display: flex; flex-direction: column;">
                                <div style="text-align: center; padding: 40px; color: #666;">
                                    <h3 style="color: #8B4513; margin-bottom: 20px;">👨‍🍳 Mode Pas-à-Pas</h3>
                                    <p style="font-size: 16px; margin-bottom: 15px;">Sélectionnez une recette pour commencer votre aventure boulangère !</p>
                                    <p style="font-size: 14px; color: #888;">Chaque étape sera guidée avec des explications claires et des photos pour vous accompagner.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panneau droit: Progression et aide -->
                        <div style="flex: 1; border: 2px solid #8B4513; border-radius: 10px; padding: 15px; background: #F0F8FF;">
                            <h3 style="color: #8B4513; margin-bottom: 15px;">📊 Progression</h3>
                            
                            <div id="progressionContainer" style="margin-bottom: 20px;">
                                <div style="text-align: center; color: #666; font-style: italic;">
                                    Aucune recette en cours
                                </div>
                            </div>
                            
                            <div id="aideContainer" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="color: #8B4513; margin-bottom: 10px;">💡 Conseils</h4>
                                <ul style="color: #666; font-size: 14px; padding-left: 20px;">
                                    <li>Prenez votre temps à chaque étape</li>
                                    <li>Vérifiez la température de vos ingrédients</li>
                                    <li>N'hésitez pas à faire des pauses</li>
                                    <li>Prenez des photos de vos étapes</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            chargerRecettesPasAPas();
        }

        function closeModePasAPasModal() {
            const modal = document.getElementById('modePasAPasModal');
            if (modal) modal.remove();
        }

        function chargerRecettesPasAPas() {
            const select = document.getElementById('recettePasAPas');
            if (!select) return;
            
            // Récupérer les recettes depuis l'application principale
            let recettes = [];
            if (typeof currentData !== 'undefined' && currentData.recipes) {
                Object.keys(currentData.recipes).forEach(family => {
                    currentData.recipes[family].forEach(recipe => {
                        recettes.push({
                            id: recipe.id,
                            nom: recipe.name,
                            famille: family,
                            description: recipe.description || 'Recette traditionnelle',
                            ingredients: recipe.ingredients || [],
                            etapes: [] // Pas d'étapes par défaut, l'utilisateur les créera
                        });
                    });
                });
            }
            
            // Ajouter des recettes mémorisées
            const recettesMemorisees = JSON.parse(localStorage.getItem('recettesPasAPas')) || [];
            recettesMemorisees.forEach(recette => {
                recettes.push(recette);
            });
            
            select.innerHTML = '<option value="">Sélectionner une recette...</option>';
            recettes.forEach(recette => {
                const option = document.createElement('option');
                option.value = recette.id;
                option.textContent = recette.nom + (recette.memorisee ? ' (Mémorisée)' : '');
                option.dataset.recette = JSON.stringify(recette);
                select.appendChild(option);
            });
        }

        function chargerRecettePasAPas() {
            const select = document.getElementById('recettePasAPas');
            const infoDiv = document.getElementById('recetteInfo');
            const nomDiv = document.getElementById('recetteNom');
            const descDiv = document.getElementById('recetteDescription');
            const ingredientsDiv = document.getElementById('recetteIngredients');
            
            if (!select.value) {
                infoDiv.style.display = 'none';
                return;
            }
            
            const recette = JSON.parse(select.selectedOptions[0].dataset.recette);
            
            nomDiv.textContent = recette.nom;
            descDiv.textContent = recette.description;
            
            // Afficher les ingrédients
            ingredientsDiv.innerHTML = '<strong>Ingrédients:</strong><br>';
            recette.ingredients.forEach(ing => {
                ingredientsDiv.innerHTML += `• ${ing.name}: ${ing.quantity} ${ing.unit}<br>`;
            });
            
            // Afficher les étapes existantes
            afficherEtapes(recette.etapes || []);
            
            infoDiv.style.display = 'block';
        }

        function afficherEtapes(etapes) {
            const container = document.getElementById('etapesList');
            if (!container) return;
            
            if (etapes.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; margin: 0;">Aucune étape définie</p>';
                return;
            }
            
            container.innerHTML = '';
            etapes.forEach((etape, index) => {
                const etapeDiv = document.createElement('div');
                etapeDiv.style.cssText = 'background: white; padding: 10px; border-radius: 5px; margin-bottom: 8px; border: 1px solid #ddd;';
                etapeDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <strong style="color: #8B4513;">Étape ${etape.numero}</strong>
                        <button onclick="supprimerEtape(${index})" style="
                            background: #F44336;
                            color: white;
                            border: none;
                            padding: 2px 6px;
                            border-radius: 3px;
                            cursor: pointer;
                            font-size: 12px;
                        " title="Supprimer">×</button>
                    </div>
                    <div style="font-weight: bold; margin-bottom: 3px;">${etape.titre}</div>
                    <div style="color: #666; font-size: 12px; margin-bottom: 3px;">${etape.description}</div>
                    <div style="color: #888; font-size: 11px;">
                        ⏱️ ${etape.duree} | 💡 ${etape.conseils}
                    </div>
                `;
                container.appendChild(etapeDiv);
            });
        }

        function ajouterEtape() {
            const select = document.getElementById('recettePasAPas');
            if (!select.value) {
                showAlert('Veuillez d\'abord sélectionner une recette', 'warning');
                return;
            }
            
            const recette = JSON.parse(select.selectedOptions[0].dataset.recette);
            if (!recette.etapes) recette.etapes = [];
            
            const numero = recette.etapes.length + 1;
            
            const titre = prompt(`Titre de l'étape ${numero}:`);
            if (!titre) return;
            
            const description = prompt(`Description de l'étape ${numero}:`);
            if (!description) return;
            
            const duree = prompt(`Durée estimée (ex: 30 min):`);
            const conseils = prompt(`Conseils pour cette étape (optionnel):`);
            
            const nouvelleEtape = {
                numero: numero,
                titre: titre,
                description: description,
                duree: duree || 'Variable',
                conseils: conseils || 'Aucun conseil particulier'
            };
            
            recette.etapes.push(nouvelleEtape);
            
            // Mettre à jour l'option dans le select
            select.selectedOptions[0].dataset.recette = JSON.stringify(recette);
            
            afficherEtapes(recette.etapes);
            showAlert(`Étape ${numero} ajoutée !`, 'success');
        }

        function supprimerEtape(index) {
            const select = document.getElementById('recettePasAPas');
            const recette = JSON.parse(select.selectedOptions[0].dataset.recette);
            
            if (confirm(`Supprimer l'étape "${recette.etapes[index].titre}" ?`)) {
                recette.etapes.splice(index, 1);
                
                // Renuméroter les étapes
                recette.etapes.forEach((etape, i) => {
                    etape.numero = i + 1;
                });
                
                // Mettre à jour l'option dans le select
                select.selectedOptions[0].dataset.recette = JSON.stringify(recette);
                
                afficherEtapes(recette.etapes);
                showAlert('Étape supprimée !', 'success');
            }
        }

        function memoriserRecette() {
            const select = document.getElementById('recettePasAPas');
            const recette = JSON.parse(select.selectedOptions[0].dataset.recette);
            
            if (!recette.etapes || recette.etapes.length === 0) {
                showAlert('Ajoutez au moins une étape avant de mémoriser', 'warning');
                return;
            }
            
            // Marquer comme mémorisée
            recette.memorisee = true;
            recette.dateMemorisation = new Date().toISOString();
            
            // Sauvegarder dans localStorage
            const recettesMemorisees = JSON.parse(localStorage.getItem('recettesPasAPas')) || [];
            
            // Vérifier si la recette existe déjà
            const index = recettesMemorisees.findIndex(r => r.id === recette.id);
            if (index >= 0) {
                recettesMemorisees[index] = recette;
            } else {
                recettesMemorisees.push(recette);
            }
            
            localStorage.setItem('recettesPasAPas', JSON.stringify(recettesMemorisees));
            
            // Mettre à jour l'affichage
            select.selectedOptions[0].textContent = recette.nom + ' (Mémorisée)';
            select.selectedOptions[0].dataset.recette = JSON.stringify(recette);
            
            showAlert(`Recette "${recette.nom}" mémorisée avec ${recette.etapes.length} étapes !`, 'success');
        }

        function demarrerModePasAPas() {
            const select = document.getElementById('recettePasAPas');
            if (!select.value) return;
            
            const recette = JSON.parse(select.selectedOptions[0].dataset.recette);
            
            if (!recette.etapes || recette.etapes.length === 0) {
                showAlert('Ajoutez au moins une étape avant de commencer le mode pas-à-pas', 'warning');
                return;
            }
            
            afficherEtape(recette, 0);
            mettreAJourProgression(recette, 0);
        }

        function afficherEtape(recette, indexEtape) {
            const container = document.getElementById('etapesContainer');
            const etape = recette.etapes[indexEtape];
            
            if (!etape) {
                // Fin des étapes
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <h3 style="color: #4CAF50; margin-bottom: 20px;">🎉 Félicitations !</h3>
                        <p style="font-size: 18px; margin-bottom: 15px;">Vous avez terminé la recette "${recette.nom}"</p>
                        <p style="color: #666; margin-bottom: 20px;">Votre pain est maintenant en cours de cuisson.</p>
                        <button onclick="reinitialiserModePasAPas()" style="
                            background: #8B4513;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-weight: bold;
                        ">🔄 Recommencer une recette</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; height: 100%;">
                    <!-- En-tête de l'étape -->
                    <div style="background: linear-gradient(135deg, #8B4513, #A0522D); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0; font-size: 20px;">Étape ${etape.numero}</h3>
                            <span style="background: rgba(255,255,255,0.2); padding: 5px 10px; border-radius: 15px; font-size: 12px;">
                                ⏱️ ${etape.duree}
                            </span>
                        </div>
                        <h4 style="margin: 10px 0 0 0; font-size: 18px;">${etape.titre}</h4>
                    </div>
                    
                    <!-- Contenu de l'étape -->
                    <div style="flex: 1; display: flex; gap: 20px;">
                        <!-- Zone de description -->
                        <div style="flex: 2; background: #f9f9f9; padding: 20px; border-radius: 8px;">
                            <h5 style="color: #8B4513; margin-bottom: 15px;">📝 Instructions</h5>
                            <p style="font-size: 16px; line-height: 1.6; color: #333; margin-bottom: 20px;">
                                ${etape.description}
                            </p>
                            
                            <div style="background: #E8F5E8; padding: 15px; border-radius: 8px; border-left: 4px solid #4CAF50;">
                                <h6 style="color: #2E7D32; margin: 0 0 10px 0;">💡 Conseils</h6>
                                <p style="margin: 0; color: #2E7D32; font-size: 14px;">${etape.conseils}</p>
                            </div>
                        </div>
                        
                        <!-- Zone de photo (placeholder) -->
                        <div style="flex: 1; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc;">
                            <div style="text-align: center; color: #666;">
                                <div style="font-size: 48px; margin-bottom: 10px;">📸</div>
                                <p>Photo de l'étape</p>
                                <small>À venir</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Boutons de navigation -->
                    <div style="display: flex; justify-content: space-between; margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                        <button onclick="etapePrecedente(${indexEtape})" style="
                            background: #666;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            ${indexEtape === 0 ? 'opacity: 0.5; cursor: not-allowed;' : ''}
                        " ${indexEtape === 0 ? 'disabled' : ''}>⬅️ Précédente</button>
                        
                        <button onclick="validerEtape(${indexEtape})" style="
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 10px 30px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-weight: bold;
                        ">✅ Valider cette étape</button>
                        
                        <button onclick="etapeSuivante(${indexEtape})" style="
                            background: #2196F3;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                        ">Suivante ➡️</button>
                    </div>
                </div>
            `;
        }

        function validerEtape(indexEtape) {
            const select = document.getElementById('recettePasAPas');
            const recette = JSON.parse(select.selectedOptions[0].dataset.recette);
            
            // Marquer l'étape comme validée
            if (!recette.etapesValidees) recette.etapesValidees = [];
            recette.etapesValidees[indexEtape] = true;
            
            // Passer à l'étape suivante
            afficherEtape(recette, indexEtape + 1);
            mettreAJourProgression(recette, indexEtape + 1);
            
            showAlert(`Étape ${indexEtape + 1} validée !`, 'success');
        }

        function etapePrecedente(indexEtape) {
            if (indexEtape <= 0) return;
            
            const select = document.getElementById('recettePasAPas');
            const recette = JSON.parse(select.selectedOptions[0].dataset.recette);
            afficherEtape(recette, indexEtape - 1);
            mettreAJourProgression(recette, indexEtape - 1);
        }

        function etapeSuivante(indexEtape) {
            const select = document.getElementById('recettePasAPas');
            const recette = JSON.parse(select.selectedOptions[0].dataset.recette);
            
            if (indexEtape >= recette.etapes.length - 1) {
                // Dernière étape
                validerEtape(indexEtape);
            } else {
                afficherEtape(recette, indexEtape + 1);
                mettreAJourProgression(recette, indexEtape + 1);
            }
        }

        function mettreAJourProgression(recette, indexEtape) {
            const container = document.getElementById('progressionContainer');
            const totalEtapes = recette.etapes.length;
            const pourcentage = Math.round((indexEtape / totalEtapes) * 100);
            
            container.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: bold; color: #8B4513;">Progression</span>
                        <span style="color: #666;">${indexEtape}/${totalEtapes} étapes</span>
                    </div>
                    <div style="background: #f0f0f0; height: 20px; border-radius: 10px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #4CAF50, #8BC34A); height: 100%; width: ${pourcentage}%; transition: width 0.3s ease;"></div>
                    </div>
                </div>
                
                <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
                    <h5 style="color: #8B4513; margin: 0 0 10px 0;">📋 Étapes</h5>
                    ${recette.etapes.map((etape, index) => `
                        <div style="display: flex; align-items: center; padding: 3px 0; font-size: 12px;">
                            <span style="
                                width: 16px;
                                height: 16px;
                                border-radius: 50%;
                                display: inline-block;
                                margin-right: 8px;
                                ${index < indexEtape ? 'background: #4CAF50;' : index === indexEtape ? 'background: #FF9800;' : 'background: #ddd;'}
                            "></span>
                            <span style="${index <= indexEtape ? 'font-weight: bold;' : 'color: #999;'}">
                                ${etape.titre}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function reinitialiserModePasAPas() {
            const container = document.getElementById('etapesContainer');
            const progressionContainer = document.getElementById('progressionContainer');
            
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <h3 style="color: #8B4513; margin-bottom: 20px;">👨‍🍳 Mode Pas-à-Pas</h3>
                    <p style="font-size: 16px; margin-bottom: 15px;">Sélectionnez une recette pour commencer votre aventure boulangère !</p>
                    <p style="font-size: 14px; color: #888;">Chaque étape sera guidée avec des explications claires et des photos pour vous accompagner.</p>
                </div>
            `;
            
            progressionContainer.innerHTML = `
                <div style="text-align: center; color: #666; font-style: italic;">
                    Aucune recette en cours
                </div>
            `;
        }

        // FONCTION 6: IA PRÉDICTIVE
        function createIAPredictiveModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'iaPredictiveModal';
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    max-width: 1400px;
                    max-height: 90vh;
                    height: 85vh;
                    width: 95vw;
                ">
                    <div class="modal-header">
                        <h2 class="modal-title">🤖 IA Prédictive Boulangère</h2>
                        <button onclick="closeIAPredictiveModal()" style="
                            background: none;
                            border: none;
                            font-size: 2rem;
                            cursor: pointer;
                            color: #8B4513;
                        ">×</button>
                    </div>
                    
                    <div style="display: flex; gap: 20px; height: 75vh;">
                        <!-- Panneau gauche: Analyse et paramètres -->
                        <div style="flex: 1; border: 2px solid #8B4513; border-radius: 10px; padding: 15px; background: #FFF8DC;">
                            <h3 style="color: #8B4513; margin-bottom: 15px;">🔍 Analyse des Conditions</h3>
                            
                            <!-- Conditions météo -->
                            <div style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="color: #8B4513; margin-bottom: 10px;">🌤️ Conditions météo</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Température (°C):</label>
                                        <input type="number" id="temperature" value="20" min="0" max="40" style="
                                            width: 100%;
                                            padding: 5px;
                                            border: 1px solid #ddd;
                                            border-radius: 3px;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Humidité (%):</label>
                                        <input type="number" id="humidite" value="60" min="0" max="100" style="
                                            width: 100%;
                                            padding: 5px;
                                            border: 1px solid #ddd;
                                            border-radius: 3px;
                                        ">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ingrédients disponibles -->
                            <div style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="color: #8B4513; margin-bottom: 10px;">📦 Inventaire</h4>
                                <div id="inventaireAnalyse" style="max-height: 150px; overflow-y: auto;">
                                    <p style="color: #666; font-style: italic; text-align: center;">Chargement de l'inventaire...</p>
                                </div>
                                <button onclick="analyserInventaire()" style="
                                    background: #2196F3;
                                    color: white;
                                    border: none;
                                    padding: 8px 15px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                    width: 100%;
                                    margin-top: 10px;
                                ">🔍 Analyser l'inventaire</button>
                            </div>
                            
                            <!-- Paramètres de cuisson -->
                            <div style="margin-bottom: 20px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="color: #8B4513; margin-bottom: 10px;">🔥 Four</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Température max (°C):</label>
                                        <input type="number" id="tempFour" value="250" min="150" max="300" style="
                                            width: 100%;
                                            padding: 5px;
                                            border: 1px solid #ddd;
                                            border-radius: 3px;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Type de four:</label>
                                        <select id="typeFour" style="
                                            width: 100%;
                                            padding: 5px;
                                            border: 1px solid #ddd;
                                            border-radius: 3px;
                                        ">
                                            <option value="electrique">Électrique</option>
                                            <option value="gaz">Gaz</option>
                                            <option value="pierre">Pierre réfractaire</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <button onclick="genererRecommandations()" style="
                                background: #4CAF50;
                                color: white;
                                border: none;
                                padding: 12px 20px;
                                border-radius: 5px;
                                cursor: pointer;
                                width: 100%;
                                font-weight: bold;
                                font-size: 16px;
                            ">🤖 Générer les recommandations IA</button>
                        </div>
                        
                        <!-- Panneau central: Recommandations -->
                        <div style="flex: 2; border: 2px solid #8B4513; border-radius: 10px; padding: 15px; background: white;">
                            <h3 style="color: #8B4513; margin-bottom: 15px;">💡 Recommandations IA</h3>
                            
                            <div id="recommandationsContainer" style="height: calc(100% - 50px); overflow-y: auto;">
                                <div style="text-align: center; padding: 40px; color: #666;">
                                    <h4 style="color: #8B4513; margin-bottom: 20px;">🤖 IA Prédictive</h4>
                                    <p style="font-size: 16px; margin-bottom: 15px;">Configurez les paramètres et cliquez sur "Générer les recommandations"</p>
                                    <p style="font-size: 14px; color: #888;">L'IA analysera vos conditions et vous proposera des recettes et conseils personnalisés.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panneau droit: Alertes et conseils -->
                        <div style="flex: 1; border: 2px solid #8B4513; border-radius: 10px; padding: 15px; background: #F0F8FF;">
                            <h3 style="color: #8B4513; margin-bottom: 15px;">⚠️ Alertes & Conseils</h3>
                            
                            <div id="alertesContainer" style="margin-bottom: 20px;">
                                <div style="text-align: center; color: #666; font-style: italic;">
                                    Aucune alerte pour le moment
                                </div>
                            </div>
                            
                            <div id="conseilsContainer" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                                <h4 style="color: #8B4513; margin-bottom: 10px;">💡 Conseils généraux</h4>
                                <ul style="color: #666; font-size: 14px; padding-left: 20px;">
                                    <li>Adaptez l'hydratation selon l'humidité</li>
                                    <li>Préchauffez votre four 30 min avant</li>
                                    <li>Utilisez un thermomètre pour la pâte</li>
                                    <li>Notez vos observations</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            chargerInventaireAnalyse();
        }

        function closeIAPredictiveModal() {
            const modal = document.getElementById('iaPredictiveModal');
            if (modal) modal.remove();
        }

        function chargerInventaireAnalyse() {
            const container = document.getElementById('inventaireAnalyse');
            if (!container) return;
            
            // Récupérer l'inventaire depuis le gestionnaire d'ingrédients
            let inventaire = [];
            if (typeof ingredientsData !== 'undefined' && ingredientsData.length > 0) {
                inventaire = ingredientsData.filter(item => item.stock > 0).map(item => ({
                    nom: item.nom,
                    stock: item.stock,
                    unite: item.unite
                }));
            }
            
            if (inventaire.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; text-align: center;">Aucun ingrédient en stock</p>';
                return;
            }
            
            container.innerHTML = '';
            inventaire.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'padding: 5px 0; border-bottom: 1px solid #f0f0f0; font-size: 12px;';
                itemDiv.innerHTML = `
                    <span style="font-weight: bold;">${item.nom}</span>
                    <span style="float: right; color: #666;">${item.stock} ${item.unite}</span>
                `;
                container.appendChild(itemDiv);
            });
        }

        function analyserInventaire() {
            const container = document.getElementById('inventaireAnalyse');
            if (!container) return;
            
            // Simuler une analyse
            container.innerHTML = '<p style="color: #4CAF50; text-align: center; font-weight: bold;">✅ Inventaire analysé</p>';
            
            setTimeout(() => {
                chargerInventaireAnalyse();
            }, 1000);
        }

        function genererRecommandations() {
            const temperature = parseInt(document.getElementById('temperature').value) || 20;
            const humidite = parseInt(document.getElementById('humidite').value) || 60;
            const tempFour = parseInt(document.getElementById('tempFour').value) || 250;
            const typeFour = document.getElementById('typeFour').value;
            
            const container = document.getElementById('recommandationsContainer');
            const alertesContainer = document.getElementById('alertesContainer');
            
            // Générer des recommandations basées sur les paramètres
            const recommandations = genererRecommandationsIA(temperature, humidite, tempFour, typeFour);
            const alertes = genererAlertesIA(temperature, humidite, tempFour, typeFour);
            
            // Afficher les recommandations
            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #8B4513; margin-bottom: 15px;">🍞 Recettes recommandées</h4>
                    ${recommandations.recettes.map(recette => `
                        <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #4CAF50;">
                            <h5 style="color: #2E7D32; margin: 0 0 8px 0;">${recette.nom}</h5>
                            <p style="margin: 0; color: #666; font-size: 14px;">${recette.raison}</p>
                            <div style="margin-top: 8px; font-size: 12px; color: #888;">
                                ⏱️ ${recette.duree} | 🔥 ${recette.temperature}°C | 💧 Hydratation: ${recette.hydratation}%
                            </div>
                        </div>
                    `).join('')}
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #8B4513; margin-bottom: 15px;">⚙️ Ajustements recommandés</h4>
                    ${recommandations.ajustements.map(ajustement => `
                        <div style="background: #E3F2FD; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #2196F3;">
                            <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">${ajustement.titre}</div>
                            <div style="color: #1976D2; font-size: 14px;">${ajustement.description}</div>
                        </div>
                    `).join('')}
                </div>
                
                <div>
                    <h4 style="color: #8B4513; margin-bottom: 15px;">🎯 Conseils personnalisés</h4>
                    ${recommandations.conseils.map(conseil => `
                        <div style="background: #FFF3E0; padding: 12px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #FF9800;">
                            <div style="font-weight: bold; color: #E65100; margin-bottom: 5px;">${conseil.categorie}</div>
                            <div style="color: #E65100; font-size: 14px;">${conseil.contenu}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Afficher les alertes
            alertesContainer.innerHTML = alertes.length > 0 ? alertes.map(alerte => `
                <div style="background: ${alerte.niveau === 'critique' ? '#FFEBEE' : '#FFF3E0'}; 
                            padding: 10px; border-radius: 5px; margin-bottom: 8px; 
                            border-left: 4px solid ${alerte.niveau === 'critique' ? '#F44336' : '#FF9800'};">
                    <div style="font-weight: bold; color: ${alerte.niveau === 'critique' ? '#D32F2F' : '#E65100'}; 
                                margin-bottom: 3px;">⚠️ ${alerte.titre}</div>
                    <div style="color: ${alerte.niveau === 'critique' ? '#D32F2F' : '#E65100'}; 
                                font-size: 12px;">${alerte.message}</div>
                </div>
            `).join('') : '<div style="text-align: center; color: #4CAF50; font-weight: bold;">✅ Aucun problème détecté</div>';
            
            showAlert('Recommandations IA générées avec succès !', 'success');
        }

        function genererRecommandationsIA(temperature, humidite, tempFour, typeFour) {
            const recommandations = {
                recettes: [],
                ajustements: [],
                conseils: []
            };
            
            // Recommandations basées sur la température
            if (temperature < 15) {
                recommandations.recettes.push({
                    nom: 'Pain de campagne rustique',
                    raison: 'Idéal pour les températures fraîches, fermentation plus lente',
                    duree: '4-5h',
                    temperature: '220',
                    hydratation: '65'
                });
                recommandations.ajustements.push({
                    titre: 'Température de fermentation',
                    description: 'Augmentez le temps de fermentation de 30% pour compenser la température basse'
                });
            } else if (temperature > 25) {
                recommandations.recettes.push({
                    nom: 'Pain rapide au levain',
                    raison: 'Fermentation accélérée par la chaleur',
                    duree: '2-3h',
                    temperature: '230',
                    hydratation: '70'
                });
                recommandations.ajustements.push({
                    titre: 'Contrôle de la fermentation',
                    description: 'Surveillez attentivement la pâte, elle peut doubler plus rapidement'
                });
            }
            
            // Recommandations basées sur l'humidité
            if (humidite < 50) {
                recommandations.ajustements.push({
                    titre: 'Hydratation adaptée',
                    description: 'Augmentez l\'hydratation de 5% pour compenser l\'air sec'
                });
                recommandations.conseils.push({
                    categorie: 'Conservation',
                    contenu: 'Stockez votre pain dans un sac en papier pour éviter qu\'il ne sèche trop vite'
                });
            } else if (humidite > 80) {
                recommandations.ajustements.push({
                    titre: 'Hydratation réduite',
                    description: 'Réduisez l\'hydratation de 3% pour éviter une pâte trop collante'
                });
            }
            
            // Recommandations basées sur le four
            if (typeFour === 'pierre') {
                recommandations.conseils.push({
                    categorie: 'Technique',
                    contenu: 'Préchauffez votre pierre réfractaire 45 minutes pour une cuisson optimale'
                });
            } else if (typeFour === 'gaz') {
                recommandations.conseils.push({
                    categorie: 'Cuisson',
                    contenu: 'Placez un récipient d\'eau dans le four pour créer de la vapeur'
                });
            }
            
            // Recommandations générales
            recommandations.conseils.push({
                categorie: 'Qualité',
                contenu: 'Utilisez de l\'eau filtrée pour une meilleure qualité de pâte'
            });
            
            return recommandations;
        }

        function genererAlertesIA(temperature, humidite, tempFour, typeFour) {
            const alertes = [];
            
            // Alertes de température
            if (temperature < 10) {
                alertes.push({
                    niveau: 'critique',
                    titre: 'Température trop basse',
                    message: 'La fermentation sera très lente. Considérez un endroit plus chaud.'
                });
            } else if (temperature > 30) {
                alertes.push({
                    niveau: 'critique',
                    titre: 'Température trop élevée',
                    message: 'Risque de sur-fermentation. Surveillez attentivement votre pâte.'
                });
            }
            
            // Alertes d'humidité
            if (humidite < 30) {
                alertes.push({
                    niveau: 'critique',
                    titre: 'Air très sec',
                    message: 'Votre pain risque de sécher rapidement. Augmentez l\'hydratation.'
                });
            }
            
            // Alertes de four
            if (tempFour < 200) {
                alertes.push({
                    niveau: 'critique',
                    titre: 'Température de four insuffisante',
                    message: 'Votre four ne peut pas atteindre la température recommandée pour le pain.'
                });
            }
            
            return alertes;
        }

        // FONCTION 4: LISTE DE COURSES
        function createListeCoursesModal() {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'listeCoursesModal';
            
            modal.innerHTML = `
                <div class="modal-content" style="
                    max-width: 1600px;
                    max-height: 95vh;
                    height: 90vh;
                    width: 98vw;
                ">
                    <div class="modal-header">
                        <h2 class="modal-title">🛒 Gestionnaire de Liste de Courses</h2>
                        <button onclick="closeListeCoursesModal()" style="
                            background: none;
                            border: none;
                            font-size: 2rem;
                            cursor: pointer;
                            color: #8B4513;
                        ">×</button>
                    </div>
                    
                    <div style="display: flex; gap: 20px; height: 82vh;">
                        <!-- Panneau gauche: Générateurs -->
                        <div style="flex: 1; border: 2px solid #00BCD4; border-radius: 10px; padding: 15px; background: #E0F2F1;">
                            <h3 style="color: #0097A7; margin-bottom: 20px;">🎯 Générateurs</h3>
                            
                            <!-- Sélections recettes et ingrédients -->
                            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #00BCD4;">
                                <h4 style="color: #0097A7; margin-bottom: 15px;">Sélections recettes et ingrédients</h4>
                                
                                <!-- Recettes -->
                                <div style="margin-bottom: 15px;">
                                    <h5 style="color: #0097A7; margin-bottom: 8px; font-size: 1rem;">📋 Recettes disponibles</h5>
                                    <div id="recettesCheckboxes" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                                        <!-- Les checkboxes des recettes seront chargées ici -->
                                    </div>
                                </div>
                                
                                <!-- Ingrédients personnalisés -->
                                <div style="margin-bottom: 15px;">
                                    <h5 style="color: #0097A7; margin-bottom: 8px; font-size: 1rem;">🥄 Ingrédients personnalisés</h5>
                                    <div id="ingredientsPersonnalises" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px; background: #f9f9f9;">
                                        <p style="color: #666; font-style: italic; text-align: center; margin: 0;">Aucun ingrédient personnalisé</p>
                                    </div>
                                </div>
                                

                            </div>
                            

                            
                            <!-- Ajout manuel -->
                            <div style="padding: 15px; background: white; border-radius: 8px; border: 1px solid #00BCD4;">
                                <h4 style="color: #0097A7; margin-bottom: 10px;">Ajout manuel</h4>
                                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                    <input type="text" id="nouvelItem" placeholder="Nouvel article..." style="
                                        flex: 1;
                                        padding: 6px;
                                        border: 1px solid #00BCD4;
                                        border-radius: 3px;
                                    ">
                                    <button onclick="ajouterItemManuel()" style="
                                        background: #4CAF50;
                                        color: white;
                                        border: none;
                                        padding: 6px 12px;
                                        border-radius: 3px;
                                        cursor: pointer;
                                    ">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panneau central: Liste de courses -->
                        <div style="flex: 2; border: 2px solid #00BCD4; border-radius: 10px; padding: 15px; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="color: #0097A7; margin: 0;">Ma Liste de Courses</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="viderListe()" style="
                                        background: #F44336;
                                        color: white;
                                        border: none;
                                        padding: 6px 12px;
                                        border-radius: 3px;
                                        cursor: pointer;
                                        font-size: 0.9rem;
                                    ">🗑️ Vider</button>
                                    <button onclick="exporterPDF()" style="
                                        background: #E91E63;
                                        color: white;
                                        border: none;
                                        padding: 6px 12px;
                                        border-radius: 3px;
                                        cursor: pointer;
                                        font-size: 0.9rem;
                                    ">📄 PDF</button>
                                    <button onclick="partagerListe()" style="
                                        background: #9C27B0;
                                        color: white;
                                        border: none;
                                        padding: 6px 12px;
                                        border-radius: 3px;
                                        cursor: pointer;
                                        font-size: 0.9rem;
                                    ">📤 Partager</button>
                                </div>
                            </div>
                            

                            
                            <div id="listeCoursesContainer" style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 10px;">
                                <p style="color: #666; font-style: italic; text-align: center;">Liste vide - Utilisez les générateurs pour la remplir</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            loadListeCoursesData();
        }

        function closeListeCoursesModal() {
            const modal = document.getElementById('listeCoursesModal');
            if (modal) modal.remove();
        }

        // Gestion de la liste de courses et ingrédients personnalisés
        if (typeof listeCoursesData === 'undefined') {
            var listeCoursesData = JSON.parse(localStorage.getItem('listeCourses')) || [];
        } else {
            // S'assurer que listeCoursesData est un tableau
            if (!Array.isArray(listeCoursesData)) {
                listeCoursesData = [];
            }
        }
        
        if (typeof ingredientsPersonnalises === 'undefined') {
            var ingredientsPersonnalises = JSON.parse(localStorage.getItem('ingredientsPersonnalises')) || [];
        } else {
            // S'assurer que ingredientsPersonnalises est un tableau
            if (!Array.isArray(ingredientsPersonnalises)) {
                ingredientsPersonnalises = [];
            }
        }

        function loadListeCoursesData() {
            loadRecettesCheckboxes();
            loadIngredientsPersonnalises();
            updateListeCoursesDisplay();
        }

        function loadRecettesCheckboxes() {
            const container = document.getElementById('recettesCheckboxes');
            if (!container) return;
            
            // Récupérer les vraies recettes depuis l'application ou utiliser des exemples
            let recettes = [];
            
            if (typeof currentData !== 'undefined' && currentData.recipes) {
                // Convertir les recettes de l'application principale
                Object.keys(currentData.recipes).forEach(family => {
                    currentData.recipes[family].forEach(recipe => {
                        if (recipe.ingredients && recipe.ingredients.length > 0) {
                            recettes.push({
                                nom: recipe.name,
                                ingredients: recipe.ingredients.map(ing => ({
                                    nom: ing.name,
                                    quantite: parseFloat(ing.quantity) || 100,
                                    unite: ing.unit || 'g'
                                }))
                            });
                        }
                    });
                });
            }
            
            // Si aucune recette trouvée, utiliser des exemples
            if (recettes.length === 0) {
                recettes = [
                    { nom: 'Pain de campagne', ingredients: [
                        { nom: 'Farine T65', quantite: 500, unite: 'g' },
                        { nom: 'Sel fin', quantite: 10, unite: 'g' }
                    ]},
                    { nom: 'Baguette tradition', ingredients: [
                        { nom: 'Farine T55', quantite: 1000, unite: 'g' },
                        { nom: 'Sel fin', quantite: 20, unite: 'g' }
                    ]},
                    { nom: 'Croissants', ingredients: [
                        { nom: 'Farine T55', quantite: 500, unite: 'g' },
                        { nom: 'Beurre doux', quantite: 250, unite: 'g' }
                    ]}
                ];
            }
            
            container.innerHTML = '';
            recettes.forEach((recette, index) => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'margin-bottom: 8px; display: flex; align-items: center; padding: 5px; border-radius: 3px; transition: background 0.2s ease;';
                
                // Vérifier si la recette est favorite (5 étoiles)
                const isFavorite = recette.favori || false;
                const backgroundColor = isFavorite ? '#FFF3CD' : 'transparent';
                const borderColor = isFavorite ? '#FFC107' : 'transparent';
                
                checkboxDiv.style.backgroundColor = backgroundColor;
                checkboxDiv.style.border = isFavorite ? `1px solid ${borderColor}` : 'none';
                
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="recette_${index}" onchange="toggleRecetteInListe(${index})" style="margin-right: 8px;">
                    <label for="recette_${index}" style="cursor: pointer; font-size: 0.9rem; flex: 1; ${isFavorite ? 'font-weight: bold;' : ''}">${recette.nom}</label>
                    <small style="color: #666; font-size: 0.8rem;">${recette.ingredients ? recette.ingredients.length : 0} ingrédients</small>
                    ${isFavorite ? '<span style="color: #FFC107; margin-left: 5px;">⭐</span>' : ''}
                `;
                container.appendChild(checkboxDiv);
            });
            
            window.tempRecettes = recettes;
        }

        function loadIngredientsPersonnalises() {
            const container = document.getElementById('ingredientsPersonnalises');
            if (!container) return;
            
            if (ingredientsPersonnalises.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; margin: 0;">Aucun ingrédient personnalisé</p>';
                return;
            }
            
            container.innerHTML = '';
            ingredientsPersonnalises.forEach((ingredient, index) => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.style.cssText = 'margin-bottom: 6px; display: flex; align-items: center; padding: 3px; border-radius: 3px;';
                checkboxDiv.innerHTML = `
                    <input type="checkbox" id="ingredient_${index}" onchange="toggleIngredientPersonnalise(${index})" style="margin-right: 8px;">
                    <label for="ingredient_${index}" style="cursor: pointer; font-size: 0.85rem; flex: 1;">${ingredient.nom}</label>
                    <button onclick="supprimerIngredientPersonnalise(${index})" style="
                        background: #F44336;
                        color: white;
                        border: none;
                        padding: 2px 6px;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.7rem;
                    " title="Supprimer">×</button>
                `;
                container.appendChild(checkboxDiv);
            });
        }

        function toggleRecetteInListe(index) {
            const checkbox = document.getElementById(`recette_${index}`);
            const recette = window.tempRecettes[index];
            
            // S'assurer que listeCoursesData est un tableau
            if (!Array.isArray(listeCoursesData)) {
                listeCoursesData = [];
            }
            
            if (checkbox.checked) {
                // Ajouter les ingrédients de la recette à la liste
                ajouterRecetteAListe(recette);
            } else {
                // Retirer les ingrédients de cette recette
                retirerRecetteDeListe(recette.nom);
            }
        }

        function ajouterRecetteAListe(recette) {
            // S'assurer que listeCoursesData est un tableau
            if (!Array.isArray(listeCoursesData)) {
                listeCoursesData = [];
            }
            
            // Créer un groupe pour cette recette
            const recetteId = 'recette_' + Date.now() + '_' + Math.random();
            
            recette.ingredients.forEach(ing => {
                listeCoursesData.push({
                    id: 'item_' + Date.now() + '_' + Math.random(),
                    nom: ing.nom,
                    quantite: ing.quantite,
                    unite: ing.unite,
                    coche: false,
                    type: 'recette',
                    recetteNom: recette.nom,
                    recetteId: recetteId
                });
            });
            
            localStorage.setItem('listeCourses', JSON.stringify(listeCoursesData));
            updateListeCoursesDisplay();
        }

        function retirerRecetteDeListe(nomRecette) {
            // S'assurer que listeCoursesData est un tableau
            if (!Array.isArray(listeCoursesData)) {
                listeCoursesData = [];
            }
            
            listeCoursesData = listeCoursesData.filter(item => item.recetteNom !== nomRecette);
            localStorage.setItem('listeCourses', JSON.stringify(listeCoursesData));
            updateListeCoursesDisplay();
            
            // Décocher la recette correspondante
            if (window.tempRecettes) {
                const recetteIndex = window.tempRecettes.findIndex(r => r.nom === nomRecette);
                if (recetteIndex !== -1) {
                    const checkbox = document.getElementById(`recette_${recetteIndex}`);
                    if (checkbox) checkbox.checked = false;
                }
            }
        }

        function toggleIngredientPersonnalise(index) {
            const checkbox = document.getElementById(`ingredient_${index}`);
            const ingredient = ingredientsPersonnalises[index];
            
            // S'assurer que listeCoursesData est un tableau
            if (!Array.isArray(listeCoursesData)) {
                listeCoursesData = [];
            }
            
            if (checkbox.checked) {
                // Ajouter à la liste de courses
                listeCoursesData.push({
                    id: 'item_' + Date.now(),
                    nom: ingredient.nom,
                    quantite: ingredient.quantite || 1,
                    unite: ingredient.unite || 'pièce',
                    coche: false,
                    type: 'personnalise'
                });
                
                localStorage.setItem('listeCourses', JSON.stringify(listeCoursesData));
                updateListeCoursesDisplay();
            } else {
                // Retirer de la liste de courses
                listeCoursesData = listeCoursesData.filter(item => 
                    !(item.nom === ingredient.nom && item.type === 'personnalise')
                );
                localStorage.setItem('listeCourses', JSON.stringify(listeCoursesData));
                updateListeCoursesDisplay();
            }
        }

        function supprimerIngredientPersonnalise(index) {
            if (confirm('Supprimer cet ingrédient personnalisé ?')) {
                ingredientsPersonnalises.splice(index, 1);
                localStorage.setItem('ingredientsPersonnalises', JSON.stringify(ingredientsPersonnalises));
                loadIngredientsPersonnalises();
            }
        }





        function ajouterItemManuel() {
            const input = document.getElementById('nouvelItem');
            const nom = input.value.trim();
            
            if (!nom) return;
            
            // S'assurer que les tableaux sont correctement initialisés
            if (!Array.isArray(listeCoursesData)) {
                listeCoursesData = [];
            }
            if (!Array.isArray(ingredientsPersonnalises)) {
                ingredientsPersonnalises = [];
            }
            
            // Vérifier si l'ingrédient existe déjà dans les personnalisés
            const existeDeja = ingredientsPersonnalises.find(ing => ing.nom.toLowerCase() === nom.toLowerCase());
            
            if (!existeDeja) {
                // Ajouter à la liste des ingrédients personnalisés
                ingredientsPersonnalises.push({
                    nom: nom,
                    quantite: 1,
                    unite: 'pièce',
                    dateAjout: new Date().toISOString()
                });
                localStorage.setItem('ingredientsPersonnalises', JSON.stringify(ingredientsPersonnalises));
                loadIngredientsPersonnalises();
            }
            
            // Ajouter à la liste de courses
            listeCoursesData.push({
                id: 'item_' + Date.now(),
                nom: nom,
                quantite: 1,
                unite: 'pièce',
                coche: false,
                type: 'manuel'
            });
            
            localStorage.setItem('listeCourses', JSON.stringify(listeCoursesData));
            updateListeCoursesDisplay();
            input.value = '';
            
            if (!existeDeja) {
                showAlert(`"${nom}" ajouté aux ingrédients personnalisés!`, 'success');
            }
        }

        function updateListeCoursesDisplay() {
            const container = document.getElementById('listeCoursesContainer');
            const header = document.getElementById('listeHeader');
            if (!container) return;
            
            // S'assurer que listeCoursesData est un tableau
            if (!Array.isArray(listeCoursesData)) {
                listeCoursesData = [];
                localStorage.setItem('listeCourses', JSON.stringify(listeCoursesData));
            }
            
            if (listeCoursesData.length === 0) {
                container.innerHTML = '<p style="color: #666; font-style: italic; text-align: center;">Liste vide - Utilisez les générateurs pour la remplir</p>';
                if (header) header.style.display = 'none';
                return;
            }
            
            // Afficher l'en-tête quand il y a des items
            if (header) header.style.display = 'block';
            
            container.innerHTML = '';
            
            // Grouper les éléments par recette
            const groupes = {};
            const itemsAutres = [];
            
            listeCoursesData.forEach(item => {
                if (item.recetteNom) {
                    if (!groupes[item.recetteNom]) {
                        groupes[item.recetteNom] = [];
                    }
                    groupes[item.recetteNom].push(item);
                } else {
                    itemsAutres.push(item);
                }
            });
            
            // Afficher les groupes de recettes
            Object.keys(groupes).forEach(nomRecette => {
                const items = groupes[nomRecette];
                
                // En-tête de groupe
                const groupeDiv = document.createElement('div');
                groupeDiv.style.cssText = `
                    margin-bottom: 15px;
                    border: 2px solid #4CAF50;
                    border-radius: 8px;
                    padding: 10px;
                    background: linear-gradient(135deg, #E8F5E8, #F1F8E9);
                `;
                
                const headerDiv = document.createElement('div');
                headerDiv.style.cssText = `
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    margin-bottom: 8px;
                    padding-bottom: 5px;
                    border-bottom: 1px solid #4CAF50;
                `;
                
                headerDiv.innerHTML = `
                    <strong style="color: #2E7D32; font-size: 1rem;">📋 ${nomRecette}</strong>
                    <button onclick="retirerRecetteDeListe('${nomRecette}')" style="
                        background: #F44336;
                        color: white;
                        border: none;
                        padding: 4px 8px;
                        border-radius: 3px;
                        cursor: pointer;
                        font-size: 0.8rem;
                    " title="Retirer toute la recette">✕ Retirer</button>
                `;
                
                groupeDiv.appendChild(headerDiv);
                
                // Afficher les ingrédients de cette recette
                items.forEach(item => {
                    const itemDiv = createItemDiv(item);
                    groupeDiv.appendChild(itemDiv);
                });
                
                container.appendChild(groupeDiv);
            });
            
            // Afficher les autres éléments
            if (itemsAutres.length > 0) {
                const autresDiv = document.createElement('div');
                autresDiv.style.cssText = `
                    margin-top: 15px;
                    padding-top: 15px;
                    border-top: 2px dashed #ccc;
                `;
                
                const headerAutres = document.createElement('h4');
                headerAutres.style.cssText = 'color: #0097A7; margin-bottom: 10px; font-size: 1rem;';
                headerAutres.textContent = '🛒 Autres articles';
                autresDiv.appendChild(headerAutres);
                
                itemsAutres.forEach(item => {
                    const itemDiv = createItemDiv(item);
                    autresDiv.appendChild(itemDiv);
                });
                
                container.appendChild(autresDiv);
            }
            
        }

        function showAlert(message, type = 'info') {
            // Créer une notification simple
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 300px;
                word-wrap: break-word;
                box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            `;
            
            // Couleurs selon le type
            switch(type) {
                case 'success':
                    alertDiv.style.background = '#4CAF50';
                    break;
                case 'warning':
                    alertDiv.style.background = '#FF9800';
                    break;
                case 'error':
                    alertDiv.style.background = '#F44336';
                    break;
                default:
                    alertDiv.style.background = '#2196F3';
            }
            
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // Supprimer après 3 secondes
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 3000);
        }

        function modifierQuantite(itemId) {
            const item = listeCoursesData.find(i => i.id === itemId);
            if (!item) return;
            
            const nouvelleQuantite = prompt(`Modifier la quantité pour "${item.nom}":`, item.quantite);
            if (nouvelleQuantite !== null && !isNaN(nouvelleQuantite)) {
                item.quantite = parseFloat(nouvelleQuantite);
                localStorage.setItem('listeCourses', JSON.stringify(listeCoursesData));
                updateListeCoursesDisplay();
                showAlert(`Quantité modifiée pour "${item.nom}"`, 'success');
            }
        }

        function createItemDiv(item) {
            const itemDiv = document.createElement('div');
            itemDiv.style.cssText = `
                display: flex;
                align-items: center;
                padding: 8px;
                margin-bottom: 5px;
                border: 1px solid #ddd;
                border-radius: 5px;
                background: white;
                transition: all 0.2s ease;
            `;
            
            const typeIcon = item.type === 'recette' ? '📋' : item.type === 'favori' ? '⭐' : item.type === 'personnalise' ? '🥄' : '✏️';
            
            // Bouton de modification pour les pièces
            const editButton = item.unite === 'pièce' ? `
                <button onclick="modifierQuantite('${item.id}')" style="
                    background: #2196F3;
                    color: white;
                    border: none;
                    padding: 4px 8px;
                    border-radius: 3px;
                    cursor: pointer;
                    font-size: 0.8rem;
                    margin-right: 5px;
                " title="Modifier la quantité">✏️</button>
            ` : '';
            
            itemDiv.innerHTML = `
                <span style="flex: 1; font-weight: bold; color: #0097A7;">${item.nom}</span>
                <span style="margin: 0 10px; font-size: 0.9rem; color: #666;">${item.quantite} ${item.unite}</span>
                <span style="margin-right: 10px; font-size: 0.8rem;">${typeIcon}</span>
                ${editButton}
                <button onclick="supprimerItem('${item.id}')" style="
                    background: #F44336;
                    color: white;
                    border: none;
                    padding: 4px 8px;
                    border-radius: 3px;
                    cursor: pointer;
                    font-size: 0.8rem;
                " title="Supprimer cet article">🗑️</button>
            `;
            
            return itemDiv;
        }





        function supprimerItem(itemId) {
            listeCoursesData = listeCoursesData.filter(item => item.id !== itemId);
            localStorage.setItem('listeCourses', JSON.stringify(listeCoursesData));
            updateListeCoursesDisplay();
        }



        function viderListe() {
            if (confirm('Êtes-vous sûr de vouloir vider toute la liste?')) {
                listeCoursesData = [];
                localStorage.setItem('listeCourses', JSON.stringify(listeCoursesData));
                updateListeCoursesDisplay();
            }
        }

        function exporterPDF() {
            if (listeCoursesData.length === 0) {
                alert('La liste est vide, rien à exporter');
                return;
            }
            
            // Créer le contenu HTML pour le PDF
            let htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Liste de Courses Boulangerie</title>
                    <style>
                        @page {
                            size: A4 portrait;
                            margin: 1cm;
                        }
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            margin: 0;
                            padding: 20px;
                            color: #333;
                            background: white;
                            font-size: 13px;
                            line-height: 1.5;
                            display: flex;
                            justify-content: center;
                        }
                        .content-container {
                            max-width: 400px;
                            width: 100%;
                            background: white;
                            padding: 20px;
                            box-shadow: 0 0 10px rgba(0,0,0,0.1);
                            border-radius: 8px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #8B4513;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        .title {
                            font-size: 20px;
                            font-weight: 600;
                            margin: 0;
                            color: #8B4513;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                        }
                        .date {
                            font-size: 11px;
                            margin: 8px 0;
                            color: #666;
                            font-style: italic;
                        }
                        .section {
                            margin: 18px 0;
                            page-break-inside: avoid;
                        }
                        .section-title {
                            font-size: 15px;
                            font-weight: 600;
                            text-transform: uppercase;
                            border-bottom: 2px solid #8B4513;
                            padding-bottom: 5px;
                            margin-bottom: 10px;
                            color: #8B4513;
                            letter-spacing: 0.5px;
                        }
                        .item {
                            display: flex;
                            align-items: center;
                            padding: 6px 0;
                            border-bottom: 1px dotted #ddd;
                            transition: background-color 0.2s ease;
                        }
                        .item:hover {
                            background-color: #f9f9f9;
                        }
                        .checkbox {
                            width: 16px;
                            height: 16px;
                            border: 2px solid #8B4513;
                            margin-right: 12px;
                            display: inline-block;
                            border-radius: 3px;
                            background: white;
                        }
                        .item-name {
                            flex: 1;
                            font-weight: 500;
                            color: #333;
                        }
                        .item-quantity {
                            text-align: right;
                            margin-left: 15px;
                            min-width: 70px;
                            font-weight: 600;
                            color: #8B4513;
                        }
                        .total-section {
                            margin-top: 25px;
                            border-top: 2px solid #8B4513;
                            padding-top: 15px;
                        }
                        .total-item {
                            display: flex;
                            justify-content: space-between;
                            padding: 4px 0;
                            font-weight: 600;
                        }
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 11px;
                            border-top: 1px solid #ddd;
                            padding-top: 15px;
                            color: #666;
                        }
                        .footer p {
                            margin: 5px 0;
                        }
                    </style>
                </head>
                <body>
                    <div class="content-container">
                        <div class="header">
                            <h1 class="title">🛒 Liste de Courses Boulangerie</h1>
                            <p class="date">Générée le ${new Date().toLocaleDateString('fr-FR')} à ${new Date().toLocaleTimeString('fr-FR')}</p>
                        </div>
            `;
            
            // Fonction pour déterminer le type d'ingrédient
            function getIngredientType(nom) {
                const nomLower = nom.toLowerCase();
                if (nomLower.includes('farine')) return 'Farines';
                if (nomLower.includes('levure') || nomLower.includes('levain')) return 'Levures & Levains';
                if (nomLower.includes('sel')) return 'Sel';
                if (nomLower.includes('sucre')) return 'Sucre';
                if (nomLower.includes('beurre') || nomLower.includes('huile')) return 'Matières grasses';
                if (nomLower.includes('œuf') || nomLower.includes('oeuf') || nomLower.includes('lait')) return 'Produits laitiers';
                if (nomLower.includes('eau')) return 'Eau';
                return 'Autres';
            }
            
            // Fonction pour convertir en grammes pour le tri
            function getWeightInGrams(item) {
                const quantite = parseFloat(item.quantite);
                const unite = item.unite.toLowerCase();
                
                if (unite === 'kg') return quantite * 1000;
                if (unite === 'g') return quantite;
                if (unite === 'ml' || unite === 'cl') return quantite;
                return 0; // Pour les pièces, on met à la fin
            }
            
            // Regrouper par type et trier par poids
            const groupesParType = {};
            
            listeCoursesData.forEach(item => {
                const type = getIngredientType(item.nom);
                if (!groupesParType[type]) {
                    groupesParType[type] = [];
                }
                groupesParType[type].push(item);
            });
            
            // Trier chaque groupe par poids décroissant
            Object.keys(groupesParType).forEach(type => {
                groupesParType[type].sort((a, b) => {
                    const poidsA = getWeightInGrams(a);
                    const poidsB = getWeightInGrams(b);
                    return poidsB - poidsA; // Décroissant
                });
            });
            
            // Afficher les groupes par type
            const ordreTypes = ['Farines', 'Levures & Levains', 'Eau', 'Sel', 'Sucre', 'Matières grasses', 'Produits laitiers', 'Autres'];
            
            ordreTypes.forEach(type => {
                if (groupesParType[type] && groupesParType[type].length > 0) {
                    htmlContent += `
                        <div class="section">
                            <div class="section-title">${type}</div>
                    `;
                    
                    groupesParType[type].forEach(item => {
                        htmlContent += `
                            <div class="item">
                                <div class="checkbox"></div>
                                <span class="item-name">${item.nom}</span>
                                <span class="item-quantity">${item.quantite} ${item.unite}</span>
                            </div>
                        `;
                    });
                    
                    htmlContent += `</div>`;
                }
            });
            
            // Ajouter un pied de page
            htmlContent += `
                        <div class="footer">
                            <p>Total: ${listeCoursesData.length} articles</p>
                            <p>Liste générée automatiquement par l'application Boulangerie</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            // Créer le blob et télécharger
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `liste-courses-boulangerie-${new Date().toISOString().split('T')[0]}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('Liste exportée avec succès !', 'success');
        }

        function partagerListe() {
            if (listeCoursesData.length === 0) {
                alert('La liste est vide, rien à partager');
                return;
            }
            
            let texte = 'Ma liste de courses boulangerie:\\n\\n';
            listeCoursesData.forEach(item => {
                texte += `• ${item.nom}: ${item.quantite} ${item.unite}\\n`;
            });
            
            // Simuler le partage
            if (navigator.share) {
                navigator.share({
                    title: 'Liste de courses boulangerie',
                    text: texte
                });
            } else {
                // Fallback: copier dans le presse-papiers
                navigator.clipboard.writeText(texte).then(() => {
                    showAlert('Liste copiée dans le presse-papiers!', 'success');
                }).catch(() => {
                    // Afficher le texte dans une modal
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>📤 Partager la liste</h3>
                                <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                            </div>
                            <textarea readonly style="width: 100%; height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;">${texte}</textarea>
                            <p style="color: #666; font-size: 0.9rem; margin-top: 10px;">
                                Copiez ce texte pour le partager via SMS, email, etc.
                            </p>
                            <button onclick="this.closest('.modal').remove()" class="btn" style="width: 100%; margin-top: 10px;">Fermer</button>
                        </div>
                    `;
                    document.body.appendChild(modal);
                });
            }
        }

        // =============================================================================
        // EXAMEN JUIN 2024 - MODE COMPLET AVEC INTERFACE PDF-LIKE
        // =============================================================================

        function startJuin2024Exam() {
            closeExam2024Modal();
            
            // Initialiser les données de l'examen
            const examStartTime = new Date().getTime();
            let examAnswers = {};
            
            // Créer la fenêtre d'examen sur fond noir
            const examWindow = document.createElement('div');
            examWindow.id = 'examWindow';
            examWindow.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: #000000;
                z-index: 15000;
                overflow-y: auto;
                font-family: 'Times New Roman', serif;
            `;

            examWindow.innerHTML = `
                <!-- Barre de navigation fixe -->
                <div id="examNavBar" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    padding: 10px 20px;
                    z-index: 15001;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 2px solid #FFD700;
                ">
                    <div style="color: #FFD700; font-weight: bold; font-size: 1.1rem;">
                        🎓 CAP Boulanger EP1 - Juin 2024
                    </div>
                    <div style="color: white; font-size: 1rem;" id="examTimer">
                        ⏱️ Temps: 00:00:00
                    </div>
                    <div style="display: flex; gap: 15px;">
                        <button onclick="saveExamProgress()" style="
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">💾 Sauvegarder</button>
                        <button onclick="submitExam()" style="
                            background: #FF5722;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">📝 Terminer</button>
                        <button onclick="exitExam()" style="
                            background: #FFD700;
                            color: #000;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 0.9rem;
                            font-weight: bold;
                        ">✕ Quitter</button>
                    </div>
                </div>

                <!-- Contenu de l'examen (reproduction exacte du PDF) -->
                <div style="
                    background: white;
                    max-width: 900px;
                    margin: 80px auto 40px auto;
                    padding: 40px;
                    box-shadow: 0 20px 40px rgba(255, 215, 0, 0.5);
                    border: 3px solid #FFD700;
                    border-radius: 10px;
                    color: black;
                    line-height: 1.4;
                ">
                    ${getJuin2024ExamContent()}
                </div>
            `;

            document.body.appendChild(examWindow);

            // Démarrer le timer
            startExamTimer(examStartTime);

            // Charger les réponses sauvegardées s'il y en a
            loadSavedAnswers('juin2024');

            // Ajouter les event listeners pour les réponses
            setupExamInteractivity();
        }

        function getJuin2024ExamContent() {
            return `
                <!-- En-tête officiel identique au PDF -->
                <div style="border: 2px solid #000; padding: 1rem; margin-bottom: 2rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <p><strong>Académie :</strong> <input type="text" class="exam-input" data-question="academie" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Examen :</strong> <input type="text" class="exam-input" data-question="examen" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Spécialité/option :</strong> <input type="text" class="exam-input" data-question="specialite" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Épreuve/sous épreuve :</strong> <input type="text" class="exam-input" data-question="epreuve" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                        </div>
                        <div style="text-align: center;">
                            <p><strong>NOM :</strong> <input type="text" class="exam-input" data-question="nom" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 160px;"></p>
                            <p style="font-size: 0.8rem;"><strong>(en majuscule, suivi s'il y a lieu, du nom d'épouse)</strong></p>
                            <p><strong>Prénoms :</strong> <input type="text" class="exam-input" data-question="prenoms" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 160px;"></p>
                            <p><strong>Né(e) le :</strong> <input type="text" class="exam-input" data-question="naissance" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                        </div>
                        <div style="text-align: right;">
                            <p><strong>Session :</strong> <input type="text" class="exam-input" data-question="session" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Série :</strong> <input type="text" class="exam-input" data-question="serie" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Repère de l'épreuve :</strong> <input type="text" class="exam-input" data-question="repere" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <div style="margin-top: 1rem; border: 1px solid black; padding: 0.5rem;">
                                <p><strong>N° du candidat</strong></p>
                                <p style="font-size: 0.7rem;">(le numéro est celui qui figure sur la convocation ou liste d'appel)</p>
                                <input type="text" class="exam-input" data-question="numero" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; height: 30px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                        <div style="border: 1px solid black; padding: 0.5rem;">
                            <p><strong>Note :</strong></p>
                            <div style="height: 30px; border-bottom: 1px dotted #000;"></div>
                        </div>
                        <div style="border: 1px solid black; padding: 0.5rem;">
                            <p><strong>Appréciation du correcteur</strong></p>
                            <div style="height: 30px; border-bottom: 1px dotted #000;"></div>
                        </div>
                    </div>
                </div>

                <!-- Titre principal et instructions -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">CAP BOULANGER EP1</h1>
                    <h2 style="font-size: 1.2rem; margin-bottom: 0.5rem;">Technologie professionnelle, sciences appliquées et gestion appliquée</h2>
                    <p style="margin-bottom: 0.5rem;"><strong>Session 2024 - SUJET</strong></p>
                    <p style="font-size: 0.8rem; margin-bottom: 1rem;">Il est interdit aux candidats de signer leur composition ou d'y mettre un signe quelconque pouvant indiquer sa provenance.</p>
                    
                    <div style="font-size: 0.8rem; margin-bottom: 1rem;">
                        <p>Toutes les pages du présent sujet sont à rendre avec la copie, y compris celles qui ne seront pas traitées.</p>
                        <p>Ne pas utiliser le stylo rouge, qui est réservé à la correction.</p>
                        <p>L'usage de la calculatrice avec mode examen actif est autorisé.</p>
                        <p>L'usage de la calculatrice sans mémoire « type collège » est autorisé.</p>
                    </div>
                </div>

                <!-- Barème -->
                <div style="margin-bottom: 2rem;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="border: 1px solid #000; padding: 8px; text-align: left;">Parties du sujet</th>
                                <th style="border: 1px solid #000; padding: 8px;">Durée à titre indicatif</th>
                                <th style="border: 1px solid #000; padding: 8px;">Barème et note obtenue</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="border: 1px solid #000; padding: 8px;">
                                    <strong>1ère partie : Technologie professionnelle</strong><br>
                                    <small>- La culture professionnelle et la production biologique<br>
                                    - Les matières premières<br>
                                    - Les techniques et le matériel professionnel associé</small>
                                </td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: center;">1h</td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: center;"><strong>....../ 30 points</strong></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 8px;">
                                    <strong>2ème partie : Sciences appliquées</strong><br>
                                    <small>- Sciences appliquées à l'alimentation<br>
                                    - Sciences appliquées à l'hygiène<br>
                                    - Sciences appliquées à l'environnement professionnel</small>
                                </td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: center;">30 min</td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: center;"><strong>....../ 30 points</strong></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 8px;">
                                    <strong>3ème partie : Gestion appliquée</strong><br>
                                    <small>- Le contexte professionnel<br>
                                    - Le salarié et l'entreprise<br>
                                    - L'insertion dans l'entreprise<br>
                                    - L'organisation de l'activité</small>
                                </td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: center;">30 min</td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: center;"><strong>....../ 20 points</strong></td>
                            </tr>
                            <tr style="background: #f0f0f0;">
                                <td colspan="2" style="border: 1px solid #000; padding: 8px;"><strong>TOTAL GÉNÉRAL</strong></td>
                                <td style="border: 1px solid #000; padding: 8px; text-align: center;"><strong>....../ 80 points</strong></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Contexte professionnel -->
                <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                    <h2 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 1rem; text-align: center;">CONTEXTE PROFESSIONNEL</h2>
                    <p style="margin-bottom: 1rem;">Madame Laurence Marziau, est gérante de <strong>la boulangerie « LM », située à Vieux-Boucau-les-Bains dans les Landes.</strong></p>
                    <p style="margin-bottom: 1rem;"><strong>Les clients sont demandeurs de produits qui favorisent les circuits courts.</strong></p>
                    <p style="margin-bottom: 1rem;">Pour répondre à une demande croissante de produits de qualité, madame Marziau décide d'augmenter la production de pains de Tradition Française et de proposer une gamme de pains biologiques.</p>
                    <p style="margin-bottom: 1rem;">Vous venez d'être embauché en qualité de boulanger pour compléter l'équipe en place qui se compose d'un chef de production, d'un boulanger et de deux vendeuses.</p>
                    
                    <div style="border: 1px solid black; padding: 1rem; margin-top: 1rem;">
                        <h3 style="font-weight: bold; text-align: center; margin-bottom: 0.5rem;">Fiche d'identité de l'entreprise</h3>
                        <div style="text-align: center;">
                            <h4 style="font-weight: bold; font-size: 1.1rem;">Boulangerie LM</h4>
                            <p>40480 Vieux-Boucau-les-Bains</p>
                            <p>05 40 24 XX XX</p>
                            <p>boulangerielm@gmail.fr</p>
                            <p>Gérante : Laurence Marziau</p>
                            <p>EURL au capital de 20 000 €</p>
                            <p>RM 856 741 236</p>
                            <p>Code APE : 10.71 C</p>
                            <p>Effectif : 6 salariés</p>
                        </div>
                    </div>
                </div>

                <!-- 1ère partie : Technologie professionnelle -->
                <div style="margin-top: 2rem;">
                    <h1 style="font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; background: #e3f2fd; padding: 1rem;">1ère partie : Technologie professionnelle</h1>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <p style="margin-bottom: 1rem;">L'enseigne « boulangerie » est apposée sur la façade de la boulangerie LM.</p>
                        <h3 style="font-weight: bold; margin-bottom: 0.5rem;">1.1. Définir l'appellation réglementaire « Boulanger » ou « Boulangerie » à partir des affirmations données ci-dessous.</h3>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead>
                                <tr>
                                    <th style="border: 1px solid #000; padding: 8px; width: 60px;">Vrai</th>
                                    <th style="border: 1px solid #000; padding: 8px; width: 60px;">Faux</th>
                                    <th style="border: 1px solid #000; padding: 8px;">Affirmations</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.a" data-answer="vrai">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.a" data-answer="faux">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px;">Tout commerçant peut obtenir l'appellation boulanger sur l'enseigne dès lors qu'il vend du pain.</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.b" data-answer="vrai">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.b" data-answer="faux">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px;">Le professionnel doit effectuer le pétrissage de la pâte.</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.c" data-answer="vrai">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.c" data-answer="faux">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px;">Le professionnel doit effectuer la fermentation de la pâte.</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.d" data-answer="vrai">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.d" data-answer="faux">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px;">Le professionnel ne doit pas vendre des produits de restauration boulangère.</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.e" data-answer="vrai">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.e" data-answer="faux">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px;">Le professionnel doit réaliser la mise en forme des pâtons.</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.f" data-answer="vrai">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">
                                        <input type="checkbox" class="exam-checkbox" data-question="1.1.f" data-answer="faux">
                                    </td>
                                    <td style="border: 1px solid #000; padding: 8px;">La surgélation est uniquement autorisée après la cuisson.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <p style="margin-bottom: 1rem;">La connaissance des caractéristiques des farines est déterminante pour mener à bien la production des pains.</p>
                        <h3 style="font-weight: bold; margin-bottom: 0.5rem;">1.2. Placer dans l'ordre chronologique les différentes étapes de la transformation du blé en farine.</h3>
                        <p style="margin-bottom: 0.5rem;"><strong>Broyage - Convertissage - Nettoyage - Claquage - Blutage</strong></p>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem;">
                            <div>1- <input type="text" class="exam-input" data-question="1.2.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100px;"></div>
                            <div>2- <input type="text" class="exam-input" data-question="1.2.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100px;"></div>
                            <div>3- <input type="text" class="exam-input" data-question="1.2.3" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100px;"></div>
                            <div>4- <input type="text" class="exam-input" data-question="1.2.4" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100px;"></div>
                            <div>5- <input type="text" class="exam-input" data-question="1.2.5" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100px;"></div>
                        </div>
                        <p style="font-size: 0.8rem; margin-top: 0.5rem; font-style: italic;">Source : Espace pain information</p>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold; margin-bottom: 0.5rem;">1.3. Préciser l'intérêt de l'analyse du taux de cendres d'une farine.</h3>
                        <textarea class="exam-textarea" data-question="1.3" style="width: 100%; height: 80px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical;"></textarea>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <p style="margin-bottom: 1rem;">Madame Marziau souhaite privilégier les produits locaux. Elle décide de s'approvisionner en sel auprès de la Compagnie Salins du Midi située à Dax. Le sel joue un rôle important pendant la panification.</p>
                        <h3 style="font-weight: bold; margin-bottom: 0.5rem;">1.4. Indiquer la quantité de sel recommandée par l'Anses (Agence Nationale de Sécurité Sanitaire de l'Alimentation de l'Environnement et du travail) au kilogramme de farine.</h3>
                        <input type="text" class="exam-input" data-question="1.4" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 200px;">
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold; margin-bottom: 0.5rem;">1.5. Cocher les bonnes réponses parmi les propositions suivantes relatives au rôle du sel pendant la panification.</h3>
                        <div style="margin-top: 0.5rem;">
                            <div style="margin: 0.3rem 0;"><input type="checkbox" class="exam-checkbox" data-question="1.5.a"> Le sel a une influence sur la ténacité de la pâte.</div>
                            <div style="margin: 0.3rem 0;"><input type="checkbox" class="exam-checkbox" data-question="1.5.b"> Le sel accélère la fermentation.</div>
                            <div style="margin: 0.3rem 0;"><input type="checkbox" class="exam-checkbox" data-question="1.5.c"> Le sel favorise la coloration de la pâte.</div>
                            <div style="margin: 0.3rem 0;"><input type="checkbox" class="exam-checkbox" data-question="1.5.d"> Le sel améliore la saveur du pain.</div>
                            <div style="margin: 0.3rem 0;"><input type="checkbox" class="exam-checkbox" data-question="1.5.e"> Le sel diminue la conservation du pain.</div>
                        </div>
                    </div>

                    <!-- Continuer avec les autres questions... -->
                    <!-- Pour la démo, je vais ajouter quelques questions supplémentaires -->
                    
                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <p style="margin-bottom: 1rem;">Une des spécialités de la boulangerie LM est la baguette de Tradition Française. La gérante vous questionne sur la réalisation de ce produit, conformément au décret Pain de Tradition Française du 13/04/1993.</p>
                        <h3 style="font-weight: bold; margin-bottom: 0.5rem;">1.6. Définir l'appellation réglementaire du Pain de Tradition Française.</h3>
                        <textarea class="exam-textarea" data-question="1.6" style="width: 100%; height: 120px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical;"></textarea>
                                         </div>
                 </div>

                 <!-- 2ème partie : Sciences appliquées -->
                 <div style="margin-top: 2rem;">
                     <h1 style="font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; background: #2196f3; color: white; padding: 1rem; border-radius: 8px;">2ème partie : Sciences appliquées (30 points)</h1>

                     <div style="background: white; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 1rem;">
                         <p style="font-style: italic; margin-bottom: 0;">Votre responsable vous confie la responsabilité d'améliorer le rayon sandwicherie et de proposer une gamme de produits plus attractive. Vous décidez d'ajouter un sandwich au thon à la carte. Voici la liste des ingrédients : Pain - Salade - Thon - Concombre - Mayonnaise - Tomate</p>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.1. Pour chaque ingrédient du sandwich, nommer le groupe d'aliment auquel il appartient, le constituant alimentaire principal et son rôle dans l'organisme.</h3>
                         <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                             <tr>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Ingrédients</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Groupes d'aliments</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Constituant alimentaire principal</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Rôle dans notre organisme</th>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Thon</td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.thon.groupe" style="border: none; background: transparent; width: 100%;"></td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.thon.constituant" style="border: none; background: transparent; width: 100%;"></td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.thon.role" style="border: none; background: transparent; width: 100%;"></td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Mayonnaise</td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.mayo.groupe" style="border: none; background: transparent; width: 100%;"></td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.mayo.constituant" style="border: none; background: transparent; width: 100%;"></td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.mayo.role" style="border: none; background: transparent; width: 100%;"></td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Concombre - Salade - Tomate</td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.legumes.groupe" style="border: none; background: transparent; width: 100%;"></td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">Fibres</td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.legumes.role" style="border: none; background: transparent; width: 100%;"></td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Pain</td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.pain.groupe" style="border: none; background: transparent; width: 100%;"></td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.pain.constituant" style="border: none; background: transparent; width: 100%;"></td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="2.1.pain.role" style="border: none; background: transparent; width: 100%;"></td>
                             </tr>
                         </table>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.2. À partir de la composition nutritionnelle du sandwich au thon, ci-dessous, calculer la valeur énergétique de 100 g de sandwich.</h3>
                         <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                             <tr>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Constituant alimentaire</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Valeur énergétique pour 1 gramme</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Quantité pour 100 g de sandwich</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Valeur énergétique pour 100 g de sandwich</th>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Protéines</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">17 kJ</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">10.2 g</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">........ x ........ = ......... kJ</td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Glucides</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">17 kJ</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">32.1 g</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">........ x ........ = ......... kJ</td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Lipides</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">38 kJ</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">11.3 g</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;">........ x ........ = ......... kJ</td>
                             </tr>
                             <tr>
                                 <td colspan="3" style="border: 1px solid #000; padding: 8px;"><strong>TOTAL =</strong></td>
                                 <td style="border: 1px solid #000; padding: 8px;"><strong>.................. kJ</strong></td>
                             </tr>
                         </table>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.3. Sélectionner un dessert et une boisson dans la liste suivante pour accompagner le sandwich au thon. Veiller à bien respecter l'équilibre alimentaire et justifier votre choix.</h3>
                         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                             <div>
                                 <h4 style="font-weight: bold;">Desserts au choix :</h4>
                                 <ul style="margin: 0; padding-left: 1.5rem;">
                                     <li>• Tarte au chocolat</li>
                                     <li>• Flan pâtissier</li>
                                     <li>• Cookies</li>
                                 </ul>
                             </div>
                             <div>
                                 <h4 style="font-weight: bold;">Boissons au choix :</h4>
                                 <ul style="margin: 0; padding-left: 1.5rem;">
                                     <li>• Eau plate</li>
                                     <li>• Soda</li>
                                     <li>• Jus de pommes</li>
                                 </ul>
                             </div>
                         </div>
                         <div style="margin-top: 1rem;">
                             <div style="margin: 0.5rem 0;"><strong>Choix dessert :</strong> <input type="text" class="exam-input" data-question="2.3.dessert" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                             <div style="margin: 0.5rem 0;"><strong>Justification :</strong> <textarea class="exam-textarea" data-question="2.3.justif_dessert" style="width: 100%; height: 40px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea></div>
                             <div style="margin: 0.5rem 0;"><strong>Choix boisson :</strong> <input type="text" class="exam-input" data-question="2.3.boisson" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                             <div style="margin: 0.5rem 0;"><strong>Justification :</strong> <textarea class="exam-textarea" data-question="2.3.justif_boisson" style="width: 100%; height: 40px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea></div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.4. Citer 2 conséquences pour la santé d'une surconsommation en glucides.</h3>
                         <div style="margin-top: 1rem;">
                             <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="2.4.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                             <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="2.4.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">Analyse microbiologique du sandwich thon mayonnaise</h3>
                         <div style="background: white; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; margin: 1rem 0;">
                             <p style="font-size: 0.9rem; margin-bottom: 1rem;"><strong>Identification :</strong> Sandwich thon mayonnaise | <strong>Lieu :</strong> vitrine réfrigérée | <strong>Prélevé le :</strong> 10/06/2024 à 12h00 | <strong>Température :</strong> +4°C | <strong>Date de fabrication :</strong> 10/06/2024</p>
                             <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                 <tr>
                                     <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Recherche de micro-organismes</th>
                                     <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Résultats</th>
                                     <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Critères de satisfaction</th>
                                 </tr>
                                 <tr><td style="border: 1px solid #000; padding: 8px;">Flore aérobie mésophile totale</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">12000/g</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">&lt;300000/g</td></tr>
                                 <tr><td style="border: 1px solid #000; padding: 8px;">Coliformes totaux</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">400/g</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">&lt;1000/g</td></tr>
                                 <tr><td style="border: 1px solid #000; padding: 8px;">Coliformes fécaux</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">4/g</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">&lt;10/g</td></tr>
                                 <tr><td style="border: 1px solid #000; padding: 8px;">Salmonelles dans 25g</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">9</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">Absence</td></tr>
                                 <tr><td style="border: 1px solid #000; padding: 8px;">Staphylococcus aureus</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">10/g</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">&lt;100/g</td></tr>
                             </table>
                         </div>

                         <div style="margin-top: 1rem;">
                             <div style="margin-bottom: 1rem;">
                                 <h4 style="font-weight: bold;">2.5. Indiquer le micro-organisme non conforme aux critères de satisfaction de cette analyse.</h4>
                                 <input type="text" class="exam-input" data-question="2.5" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px; margin-top: 0.5rem;">
                             </div>

                             <div style="margin-bottom: 1rem;">
                                 <h4 style="font-weight: bold;">2.6. Identifier l'ingrédient du sandwich responsable de cette non-conformité.</h4>
                                 <input type="text" class="exam-input" data-question="2.6" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px; margin-top: 0.5rem;">
                             </div>

                             <div style="margin-bottom: 1rem;">
                                 <h4 style="font-weight: bold;">2.7. Préciser la conséquence de ce micro-organisme sur la santé des clients.</h4>
                                 <textarea class="exam-textarea" data-question="2.7" style="width: 100%; height: 60px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea>
                             </div>

                             <div style="margin-bottom: 1rem;">
                                 <h4 style="font-weight: bold;">2.8. Citer 2 symptômes développés suite à la consommation d'un aliment contaminé.</h4>
                                 <div style="margin-top: 0.5rem;">
                                     <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="2.8.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                     <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="2.8.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                 </div>
                             </div>

                             <div style="margin-bottom: 1rem;">
                                 <h4 style="font-weight: bold;">2.9. Proposer 2 précautions à prendre pour que l'analyse microbiologique soit conforme.</h4>
                                 <div style="margin-top: 0.5rem;">
                                     <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="2.9.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                     <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="2.9.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                 </div>
                             </div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.10. Identifier le matériau qui constitue ce matériel (cul de poule et fouet professionnel).</h3>
                         <input type="text" class="exam-input" data-question="2.10" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px; margin-top: 0.5rem;">
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.11. Indiquer si l'information concernant l'inox est vraie ou fausse.</h3>
                         <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                             <tr>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">L'inox</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Vrai</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Faux</th>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Se nettoie facilement.</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;"><input type="checkbox" class="exam-checkbox" data-question="2.11.a" data-answer="vrai"></td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;"><input type="checkbox" class="exam-checkbox" data-question="2.11.a" data-answer="faux"></td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Est bon marché.</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;"><input type="checkbox" class="exam-checkbox" data-question="2.11.b" data-answer="vrai"></td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;"><input type="checkbox" class="exam-checkbox" data-question="2.11.b" data-answer="faux"></td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Est résistant aux chocs.</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;"><input type="checkbox" class="exam-checkbox" data-question="2.11.c" data-answer="vrai"></td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;"><input type="checkbox" class="exam-checkbox" data-question="2.11.c" data-answer="faux"></td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">Est léger.</td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;"><input type="checkbox" class="exam-checkbox" data-question="2.11.d" data-answer="vrai"></td>
                                 <td style="border: 1px solid #000; padding: 8px; text-align: center;"><input type="checkbox" class="exam-checkbox" data-question="2.11.d" data-answer="faux"></td>
                             </tr>
                         </table>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.12. Justifier l'utilisation de ce produit (Brioxol) pour les métiers de l'alimentation.</h3>
                         <div style="background: white; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; margin: 1rem 0; font-size: 0.9rem;">
                             <strong>FICHE TECHNIQUE BRIOXOL :</strong> Le nettoyant désinfecte les surfaces et le matériel pouvant entrer en contact avec les denrées alimentaires : plans de travail, tables, mobilier, murs, poignées de porte, trancheurs, évaporateurs... Il est idéal pour la désinfection des boîtes de conserves.
                         </div>
                         <textarea class="exam-textarea" data-question="2.12" style="width: 100%; height: 80px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.13. Citer 2 précautions à prendre lors de l'utilisation de ce produit.</h3>
                         <div style="margin-top: 1rem;">
                             <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="2.13.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                             <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="2.13.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.14. Préciser le type d'énergie utilisé pour le fonctionnement du four (nouveau four électrique).</h3>
                         <input type="text" class="exam-input" data-question="2.14" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px; margin-top: 0.5rem;">
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">2.15. Définir l'effet Joule en vous aidant du document ci-dessus.</h3>
                         <div style="background: white; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; margin: 1rem 0; font-size: 0.9rem;">
                             <strong>L'effet Joule :</strong> [Schéma montrant : Énergie électrique → Résistance → Chaleur]
                         </div>
                         <textarea class="exam-textarea" data-question="2.15" style="width: 100%; height: 80px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea>
                     </div>
                 </div>

                 <!-- 3ème partie : Gestion appliquée -->
                 <div style="margin-top: 2rem;">
                     <h1 style="font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; background: #9c27b0; color: white; padding: 1rem; border-radius: 8px;">3ème partie : Gestion appliquée (20 points)</h1>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">3.1. Identifier les différentes activités de l'entreprise.</h3>
                         <div style="margin-top: 1rem;">
                             <div style="margin: 0.5rem 0;"><strong>Activité principale :</strong> <input type="text" class="exam-input" data-question="3.1.principale" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                             <div style="margin: 0.5rem 0;"><strong>Activité secondaire :</strong> <input type="text" class="exam-input" data-question="3.1.secondaire" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">Documents commerciaux</h3>
                         <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                             <div style="background: white; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; font-size: 0.9rem;">
                                 <h4 style="font-weight: bold;">BON DE LIVRAISON N°321</h4>
                                 <p><strong>PRODUITS FRAIS EXPRESS</strong><br>2 rue d'ANJOU - 56000 VANNES<br>Livraison du 18 mai 2024<br>REF : BC N° 123 du 11 mai 2024</p>
                                 <p><strong>Destinataire :</strong> LA MAISON DU PAIN<br>Route des plages - 56370 SARZEAU</p>
                                 <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 0.5rem;">
                                     <tr><th style="border: 1px solid #000; padding: 4px;">Désignation</th><th style="border: 1px solid #000; padding: 4px;">Réf</th><th style="border: 1px solid #000; padding: 4px;">Unité</th><th style="border: 1px solid #000; padding: 4px;">Quantité</th></tr>
                                     <tr><td style="border: 1px solid #000; padding: 4px;">Lardons fumés 250 g</td><td style="border: 1px solid #000; padding: 4px;">LF 250</td><td style="border: 1px solid #000; padding: 4px;">Boîte de 250 g</td><td style="border: 1px solid #000; padding: 4px;">10</td></tr>
                                     <tr><td style="border: 1px solid #000; padding: 4px;">Fromage de chèvre frais en bûche</td><td style="border: 1px solid #000; padding: 4px;">FCF250</td><td style="border: 1px solid #000; padding: 4px;">Bûche de 250 g</td><td style="border: 1px solid #000; padding: 4px;">6</td></tr>
                                 </table>
                             </div>
                             
                             <div style="background: white; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; font-size: 0.9rem;">
                                 <h4 style="font-weight: bold;">BON DE COMMANDE N°123</h4>
                                 <p><strong>LA MAISON DU PAIN</strong><br>Route des plages - 56370 Sarzeau<br>du 11 mai 2024</p>
                                 <p>Date de livraison : 13 mai 2024 impérativement<br>Condition de transport : Franco de port</p>
                                 <p><strong>Fournisseur :</strong> PRODUITS FRAIS EXPRESS<br>2 rue d'ANJOU - 56000 VANNES</p>
                                 <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem; margin-top: 0.5rem;">
                                     <tr><th style="border: 1px solid #000; padding: 4px;">Référence</th><th style="border: 1px solid #000; padding: 4px;">Désignation</th><th style="border: 1px solid #000; padding: 4px;">Unité</th><th style="border: 1px solid #000; padding: 4px;">Qté</th><th style="border: 1px solid #000; padding: 4px;">PU HT</th><th style="border: 1px solid #000; padding: 4px;">Montant HT</th></tr>
                                     <tr><td style="border: 1px solid #000; padding: 4px;">LF 500</td><td style="border: 1px solid #000; padding: 4px;">Lardons fumés</td><td style="border: 1px solid #000; padding: 4px;">Boîte 500g</td><td style="border: 1px solid #000; padding: 4px;">10</td><td style="border: 1px solid #000; padding: 4px;">3,10</td><td style="border: 1px solid #000; padding: 4px;">31,00</td></tr>
                                     <tr><td style="border: 1px solid #000; padding: 4px;">FCF 250</td><td style="border: 1px solid #000; padding: 4px;">Fromage chèvre frais</td><td style="border: 1px solid #000; padding: 4px;">Bûche 250g</td><td style="border: 1px solid #000; padding: 4px;">5</td><td style="border: 1px solid #000; padding: 4px;">2,42</td><td style="border: 1px solid #000; padding: 4px;">12,10</td></tr>
                                     <tr><td colspan="5" style="border: 1px solid #000; padding: 4px;"><strong>TOTAL HT</strong></td><td style="border: 1px solid #000; padding: 4px;"><strong>43,10</strong></td></tr>
                                 </table>
                             </div>
                         </div>

                         <div style="margin-top: 1rem;">
                             <div style="margin-bottom: 1rem;">
                                 <h4 style="font-weight: bold;">3.2. Classer les documents, dans l'ordre de réalisation en indiquant leur nom.</h4>
                                 <div style="margin-top: 0.5rem;">
                                     <div style="margin: 0.5rem 0;">1- <input type="text" class="exam-input" data-question="3.2.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                                     <div style="margin: 0.5rem 0;">2- <input type="text" class="exam-input" data-question="3.2.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                                 </div>
                             </div>

                             <div style="margin-bottom: 1rem;">
                                 <h4 style="font-weight: bold;">3.3. Nommer les parties liées par ces 2 documents.</h4>
                                 <div style="margin-top: 0.5rem;">
                                     <div style="margin: 0.5rem 0;"><strong>Nom du client :</strong> <input type="text" class="exam-input" data-question="3.3.client" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                                     <div style="margin: 0.5rem 0;"><strong>Nom du fournisseur :</strong> <input type="text" class="exam-input" data-question="3.3.fournisseur" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                                 </div>
                             </div>

                             <div style="margin-bottom: 1rem;">
                                 <h4 style="font-weight: bold;">3.4. Vérifier et relever 3 anomalies entre le bon de commande et le bon de livraison.</h4>
                                 <div style="margin-top: 0.5rem;">
                                     <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="3.4.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                     <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="3.4.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                     <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="3.4.3" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                 </div>
                             </div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">3.5. Indiquer 3 contrôles que vous devez effectuer lors de la réception des marchandises.</h3>
                         <div style="margin-top: 1rem;">
                             <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="3.5.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                             <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="3.5.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                             <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="3.5.3" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">3.6. Donner la signification des sigles suivants ou explication du type de contrat dont il s'agit.</h3>
                         <div style="margin-top: 1rem;">
                             <div style="margin: 0.5rem 0;"><strong>CDI :</strong> <textarea class="exam-textarea" data-question="3.6.cdi" style="width: 100%; height: 40px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea></div>
                             <div style="margin: 0.5rem 0;"><strong>CDD :</strong> <textarea class="exam-textarea" data-question="3.6.cdd" style="width: 100%; height: 40px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea></div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">3.7. Indiquer quel est le contrat de travail le plus adapté (pour un serveur saisonnier 3 mois). Justifier votre réponse.</h3>
                         <div style="margin-top: 1rem;">
                             <div style="margin: 0.5rem 0;"><strong>Nom du contrat :</strong> <input type="text" class="exam-input" data-question="3.7.contrat" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                             <div style="margin: 0.5rem 0;"><strong>Justification :</strong> <textarea class="exam-textarea" data-question="3.7.justification" style="width: 100%; height: 60px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea></div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">3.8. Préciser 2 intérêts d'une période d'essai pour chaque partie au contrat dans le tableau ci-dessous.</h3>
                         <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                             <tr>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0; width: 50%;">Pour l'employeur</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0; width: 50%;">Pour le salarié</th>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px; height: 60px; vertical-align: top;"><textarea class="exam-textarea" data-question="3.8.employeur1" style="width: 100%; height: 50px; border: none; background: transparent; resize: none; padding: 4px;"></textarea></td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 60px; vertical-align: top;"><textarea class="exam-textarea" data-question="3.8.salarie1" style="width: 100%; height: 50px; border: none; background: transparent; resize: none; padding: 4px;"></textarea></td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px; height: 60px; vertical-align: top;"><textarea class="exam-textarea" data-question="3.8.employeur2" style="width: 100%; height: 50px; border: none; background: transparent; resize: none; padding: 4px;"></textarea></td>
                                 <td style="border: 1px solid #000; padding: 8px; height: 60px; vertical-align: top;"><textarea class="exam-textarea" data-question="3.8.salarie2" style="width: 100%; height: 50px; border: none; background: transparent; resize: none; padding: 4px;"></textarea></td>
                             </tr>
                         </table>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">3.9. Repérer le statut juridique actuel de l'entreprise « La maison du pain ».</h3>
                         <div style="margin-top: 1rem;">
                             <div style="margin: 0.5rem 0;"><strong>Statut juridique :</strong> <input type="text" class="exam-input" data-question="3.9.statut" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 60%; padding: 5px;"></div>
                             <div style="margin: 0.5rem 0;"><strong>Signification du sigle :</strong> <textarea class="exam-textarea" data-question="3.9.signification" style="width: 100%; height: 40px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea></div>
                         </div>
                     </div>

                     <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                         <h3 style="font-weight: bold;">3.10. Proposer le statut juridique à mettre en place si vous deveniez associé à monsieur Lartigau.</h3>
                         <div style="background: white; padding: 1rem; border: 1px solid #ccc; border-radius: 8px; margin: 1rem 0; font-size: 0.9rem;">
                             <table style="width: 100%; border-collapse: collapse;">
                                 <tr>
                                     <th style="border: 1px solid #000; padding: 4px; background: #f0f0f0;"></th>
                                     <th style="border: 1px solid #000; padding: 4px; background: #f0f0f0;">Entreprendre seul</th>
                                     <th style="border: 1px solid #000; padding: 4px; background: #f0f0f0;">Entreprendre à plusieurs</th>
                                     <th style="border: 1px solid #000; padding: 4px; background: #f0f0f0;">Entreprendre à plusieurs</th>
                                 </tr>
                                 <tr>
                                     <th style="border: 1px solid #000; padding: 4px; background: #f0f0f0;"></th>
                                     <th style="border: 1px solid #000; padding: 4px; background: #f0f0f0;">EURL</th>
                                     <th style="border: 1px solid #000; padding: 4px; background: #f0f0f0;">SARL</th>
                                     <th style="border: 1px solid #000; padding: 4px; background: #f0f0f0;">SA</th>
                                 </tr>
                                 <tr><td style="border: 1px solid #000; padding: 4px;"><strong>Nombre d'associés</strong></td><td style="border: 1px solid #000; padding: 4px;">1</td><td style="border: 1px solid #000; padding: 4px;">2 à 100 associés maximum</td><td style="border: 1px solid #000; padding: 4px;">2 associés minimum</td></tr>
                                 <tr><td style="border: 1px solid #000; padding: 4px;"><strong>Capital</strong></td><td style="border: 1px solid #000; padding: 4px;">libre</td><td style="border: 1px solid #000; padding: 4px;">libre</td><td style="border: 1px solid #000; padding: 4px;">37 000 €</td></tr>
                                 <tr><td style="border: 1px solid #000; padding: 4px;"><strong>Responsabilité</strong></td><td style="border: 1px solid #000; padding: 4px;">limitée aux apports</td><td style="border: 1px solid #000; padding: 4px;">limitée aux apports</td><td style="border: 1px solid #000; padding: 4px;">limitée aux apports</td></tr>
                             </table>
                         </div>
                         <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                             <tr>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Statut envisageable ?</th>
                                 <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Justification</th>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">SARL : ☐ OUI ☐ NON</td>
                                 <td style="border: 1px solid #000; padding: 8px; width: 66%;"><textarea class="exam-textarea" data-question="3.10.sarl" style="width: 100%; height: 40px; border: none; background: transparent; resize: none; padding: 4px;"></textarea></td>
                             </tr>
                             <tr>
                                 <td style="border: 1px solid #000; padding: 8px;">SA : ☐ OUI ☐ NON</td>
                                 <td style="border: 1px solid #000; padding: 8px;"><textarea class="exam-textarea" data-question="3.10.sa" style="width: 100%; height: 40px; border: none; background: transparent; resize: none; padding: 4px;"></textarea></td>
                             </tr>
                         </table>
                     </div>
                 </div>

                 <!-- Message de fin d'examen -->
                <div style="text-align: center; margin: 2rem 0; padding: 1rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
                    <h3 style="color: #856404; margin-bottom: 0.5rem;">📝 Examen en cours</h3>
                    <p style="color: #856404; margin: 0;">
                        Vous pouvez sauvegarder vos réponses à tout moment en cliquant sur "Sauvegarder" dans la barre du haut.
                        <br>Cliquez sur "Terminer" pour finaliser votre examen et voir votre score.
                    </p>
                </div>
            `;
        }

        // =============================================================================
        // EXAMEN SEPTEMBRE 2024 - MODE COMPLET AVEC INTERFACE PDF-LIKE
        // =============================================================================

        function startSeptembre2024Exam() {
            closeExam2024Modal();
            
            // Initialiser les données de l'examen
            const examStartTime = new Date().getTime();
            let examAnswers = {};
            
            // Créer la fenêtre d'examen sur fond noir
            const examWindow = document.createElement('div');
            examWindow.id = 'examWindow';
            examWindow.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: #000000;
                z-index: 15000;
                overflow-y: auto;
                font-family: 'Times New Roman', serif;
            `;

            examWindow.innerHTML = `
                <!-- Barre de navigation fixe -->
                <div id="examNavBar" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    background: rgba(0, 0, 0, 0.9);
                    padding: 10px 20px;
                    z-index: 15001;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 2px solid #FFD700;
                ">
                    <div style="color: #FFD700; font-weight: bold; font-size: 1.1rem;">
                        🎓 CAP Boulanger EP1 - Septembre 2024
                    </div>
                    <div style="color: white; font-size: 1rem;" id="examTimer">
                        ⏱️ Temps: 00:00:00
                    </div>
                    <div style="display: flex; gap: 15px;">
                        <button onclick="saveExamProgress()" style="
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">💾 Sauvegarder</button>
                        <button onclick="submitExam()" style="
                            background: #FF5722;
                            color: white;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 0.9rem;
                        ">📝 Terminer</button>
                        <button onclick="exitExam()" style="
                            background: #FFD700;
                            color: #000;
                            border: none;
                            padding: 8px 15px;
                            border-radius: 5px;
                            cursor: pointer;
                            font-size: 0.9rem;
                            font-weight: bold;
                        ">✕ Quitter</button>
                    </div>
                </div>

                <!-- Contenu de l'examen (reproduction exacte du PDF) -->
                <div style="
                    background: white;
                    max-width: 900px;
                    margin: 80px auto 40px auto;
                    padding: 40px;
                    box-shadow: 0 20px 40px rgba(255, 215, 0, 0.5);
                    border: 3px solid #FFD700;
                    border-radius: 10px;
                    color: black;
                    line-height: 1.4;
                ">
                    ${getSeptembre2024ExamContent()}
                </div>
            `;

            document.body.appendChild(examWindow);

            // Démarrer le timer
            startExamTimer(examStartTime);

            // Charger les réponses sauvegardées s'il y en a
            loadSavedAnswers('septembre2024');

            // Ajouter les event listeners pour les réponses
            setupExamInteractivity();
        }

        function getSeptembre2024ExamContent() {
            return `
                <!-- En-tête officiel identique au PDF -->
                <div style="border: 2px solid #000; padding: 1rem; margin-bottom: 2rem;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <p><strong>Académie :</strong> <input type="text" class="exam-input" data-question="academie" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Examen :</strong> <input type="text" class="exam-input" data-question="examen" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Spécialité/option :</strong> <input type="text" class="exam-input" data-question="specialite" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Épreuve/sous épreuve :</strong> <input type="text" class="exam-input" data-question="epreuve" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                        </div>
                        <div style="text-align: center;">
                            <p><strong>NOM :</strong> <input type="text" class="exam-input" data-question="nom" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 160px;"></p>
                            <p style="font-size: 0.8rem;"><strong>(en majuscule, suivi s'il y a lieu, du nom d'épouse)</strong></p>
                            <p><strong>Prénoms :</strong> <input type="text" class="exam-input" data-question="prenoms" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 160px;"></p>
                            <p><strong>Né(e) le :</strong> <input type="text" class="exam-input" data-question="naissance" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                        </div>
                        <div style="text-align: right;">
                            <p><strong>Session :</strong> <input type="text" class="exam-input" data-question="session" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Série :</strong> <input type="text" class="exam-input" data-question="serie" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <p><strong>Repère de l'épreuve :</strong> <input type="text" class="exam-input" data-question="repere" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 120px;"></p>
                            <div style="margin-top: 1rem; border: 1px solid black; padding: 0.5rem;">
                                <p><strong>N° du candidat</strong></p>
                                <p style="font-size: 0.7rem;">(le numéro est celui qui figure sur la convocation ou liste d'appel)</p>
                                <input type="text" class="exam-input" data-question="numero" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; height: 30px;">
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                        <div style="border: 1px solid black; padding: 0.5rem;">
                            <p><strong>Note :</strong></p>
                            <div style="height: 30px; border-bottom: 1px dotted #000;"></div>
                        </div>
                        <div style="border: 1px solid black; padding: 0.5rem;">
                            <p><strong>Appréciation du correcteur</strong></p>
                            <div style="height: 30px; border-bottom: 1px dotted #000;"></div>
                        </div>
                    </div>
                </div>

                <!-- Titre principal et instructions -->
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h1 style="font-size: 2rem; font-weight: bold; margin-bottom: 0.5rem;">CAP BOULANGER EP1</h1>
                    <h2 style="font-size: 1.2rem; margin-bottom: 0.5rem;">Technologie professionnelle, sciences appliquées et gestion appliquée</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div>Session 2024 - SUJET</div>
                        <div>Durée : 2 h - Coefficient : 4</div>
                    </div>
                    <div style="font-size: 0.8rem; margin-bottom: 1rem;">
                        <p>Toutes les pages du présent sujet sont à rendre avec la copie, y compris celles qui ne seront pas traitées.</p>
                        <p>Ne pas utiliser le stylo rouge, qui est réservé à la correction.</p>
                        <p>L'usage de la calculatrice avec mode examen actif est autorisé.</p>
                    </div>
                </div>

                <!-- Contexte professionnel -->
                <div style="background: #e3f2fd; padding: 1rem; margin: 1rem 0; border-radius: 8px;">
                    <h2 style="font-size: 1.3rem; font-weight: bold; margin-bottom: 1rem; text-align: center; color: #1565c0;">CONTEXTE PROFESSIONNEL</h2>
                    <p style="margin-bottom: 1rem;">Vous êtes boulanger dans l'entreprise de monsieur Lartigau, <strong>« La maison du pain »</strong> qui fête ses 10 ans. L'entreprise se situe à la périphérie de la ville de Sarzeau, près d'un axe routier très touristique et dispose d'un parking ombragé attenant à la boutique.</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                        <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #ccc;">
                            <h3 style="font-weight: bold; color: #1565c0; margin-bottom: 0.5rem;">Équipe de production :</h3>
                            <ul style="margin: 0; padding-left: 1.5rem;">
                                <li>• Monsieur Lartigau, boulanger et pâtissier, employeur</li>
                                <li>• Un boulanger, vous-même</li>
                                <li>• Gaël, apprenti boulanger CAP en 2ème année</li>
                                <li>• Julie, pâtissière</li>
                            </ul>
                        </div>
                        
                        <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #ccc;">
                            <h3 style="font-weight: bold; color: #1565c0; margin-bottom: 0.5rem;">Fiche d'identité :</h3>
                            <div style="margin: 0;">
                                <p><strong>La Maison du pain</strong></p>
                                <p>Route des plages - 56370 Sarzeau</p>
                                <p>02 56 xx xx xx</p>
                                <p>Ouverture : 7h30 à 19h00 (mardi au dimanche)</p>
                                <p><strong>EURL</strong> au capital de 15 000 €</p>
                            </div>
                        </div>
                    </div>
                    
                    <p style="margin-top: 1rem; font-style: italic;">Monsieur Lartigau envisage de développer pour l'été un coin snacking avec des places assises et quelques mange-debout à l'ombre, sur le parking. À l'occasion de l'anniversaire de la boulangerie, monsieur Lartigau organise une réception avec ses nouveaux produits de snacking et viennoiseries.</p>
                </div>

                <!-- Barème -->
                <div style="margin-bottom: 2rem; background: #f5f5f5; padding: 1rem; border-radius: 8px;">
                    <h2 style="font-weight: bold; margin-bottom: 1rem; text-align: center;">Barème de l'épreuve</h2>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; text-align: center;">
                        <div style="background: #c8e6c9; padding: 1rem; border-radius: 8px;">
                            <div style="font-weight: bold;">1ère partie</div>
                            <div>Technologie professionnelle</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #2e7d32;">30 points</div>
                        </div>
                        <div style="background: #bbdefb; padding: 1rem; border-radius: 8px;">
                            <div style="font-weight: bold;">2ème partie</div>
                            <div>Sciences appliquées</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #1565c0;">30 points</div>
                        </div>
                        <div style="background: #e1bee7; padding: 1rem; border-radius: 8px;">
                            <div style="font-weight: bold;">3ème partie</div>
                            <div>Gestion appliquée</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: #7b1fa2;">20 points</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 1rem; background: #e0e0e0; padding: 1rem; border-radius: 8px;">
                        <strong>TOTAL GÉNÉRAL : 80 points</strong>
                    </div>
                </div>

                <!-- 1ère partie : Technologie professionnelle -->
                <div style="margin-top: 2rem;">
                    <h1 style="font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; background: #4caf50; color: white; padding: 1rem; border-radius: 8px;">1ère partie : Technologie professionnelle (30 points)</h1>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.1. Citer 4 actions que vous pouvez mettre en place en faveur du développement durable.</h3>
                        <div style="margin-top: 1rem;">
                            <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.1.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.1.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.1.3" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.1.4" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                        </div>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.2. Relier les différents acteurs de la filière en fonction de leurs rôles.</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <h4 style="font-weight: bold;">Acteurs :</h4>
                                <ul style="margin: 0; padding-left: 1.5rem;">
                                    <li>• Céréalier</li>
                                    <li>• Semencier</li>
                                    <li>• Organisme stockeur</li>
                                    <li>• Boulanger</li>
                                    <li>• Meunier</li>
                                </ul>
                            </div>
                            <div>
                                <h4 style="font-weight: bold;">Rôles :</h4>
                                <ul style="margin: 0; padding-left: 1.5rem;">
                                    <li>• Transforme le blé en farine</li>
                                    <li>• Créer les variétés</li>
                                    <li>• Stocker les céréales</li>
                                    <li>• Produit les céréales</li>
                                    <li>• Transforme la farine en pain</li>
                                </ul>
                            </div>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">Reliez chaque acteur à son rôle correspondant en écrivant le numéro de l'acteur à côté du rôle approprié.</p>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.3. Nommer 2 produits de restauration boulangère qu'il pourrait proposer à sa clientèle pour chaque gamme.</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <h4 style="font-weight: bold;">Gamme froide :</h4>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.3.froide1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.3.froide2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            </div>
                            <div>
                                <h4 style="font-weight: bold;">Gamme chaude :</h4>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.3.chaude1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.3.chaude2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            </div>
                        </div>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.4. Définir ces appellations en boulangerie.</h3>
                        <div style="margin-top: 1rem;">
                            <div style="margin-bottom: 1rem;">
                                <strong>Pain maison :</strong>
                                <textarea class="exam-textarea" data-question="1.4.pain_maison" style="width: 100%; height: 60px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea>
                            </div>
                            <div>
                                <strong>Viennoiserie maison :</strong>
                                <textarea class="exam-textarea" data-question="1.4.viennoiserie_maison" style="width: 100%; height: 60px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea>
                            </div>
                        </div>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.5. Compléter le tableau en indiquant 2 conditions de stockage de cette farine (T150 biologique).</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <tr>
                                <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Conditions de stockage</th>
                            </tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="1.5.1" style="border: none; background: transparent; width: 100%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="1.5.2" style="border: none; background: transparent; width: 100%;"></td></tr>
                        </table>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.6. Citer l'analyse qui permet de classer ces types de farine (T65 et T45).</h3>
                        <input type="text" class="exam-input" data-question="1.6" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px; margin-top: 0.5rem;">
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.7. Expliquer la différence essentielle entre la farine de seigle et la farine de blé.</h3>
                        <textarea class="exam-textarea" data-question="1.7" style="width: 100%; height: 80px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.8. Nommer 2 types de levure utilisées en panification.</h3>
                        <div style="margin-top: 1rem;">
                            <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.8.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.8.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                        </div>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.9. Citer les ingrédients utilisés dans la recette de base de la pâte à brioche présentée ci-dessous selon les quantités proposées.</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <tr>
                                <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Ingrédients</th>
                                <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Quantité (en g)</th>
                            </tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="1.9.1" style="border: none; background: transparent; width: 100%;"></td><td style="border: 1px solid #000; padding: 8px; text-align: center;">1000</td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="1.9.2" style="border: none; background: transparent; width: 100%;"></td><td style="border: 1px solid #000; padding: 8px; text-align: center;">40</td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="1.9.3" style="border: none; background: transparent; width: 100%;"></td><td style="border: 1px solid #000; padding: 8px; text-align: center;">18</td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="1.9.4" style="border: none; background: transparent; width: 100%;"></td><td style="border: 1px solid #000; padding: 8px; text-align: center;">140</td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="1.9.5" style="border: none; background: transparent; width: 100%;"></td><td style="border: 1px solid #000; padding: 8px; text-align: center;">500</td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; text-align: center;">Lait</td><td style="border: 1px solid #000; padding: 8px; text-align: center;">150</td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;"><input type="text" class="exam-input" data-question="1.9.6" style="border: none; background: transparent; width: 100%;"></td><td style="border: 1px solid #000; padding: 8px; text-align: center;">450</td></tr>
                        </table>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.10. Replacer, dans le tableau ci-dessous, les différentes étapes de la fabrication de la brioche dans l'ordre chronologique.</h3>
                        <p style="margin-bottom: 1rem;"><strong>Étapes à classer :</strong> Apprêt - Pétrissage - Cuisson - Frasage - Incorporation du beurre - Dorer - Pesage/Division - Pointage - Pesage des ingrédients - Ressuage - Façonnage</p>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <tr><th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">ÉTAPES DE FABRICATION</th></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">1. <input type="text" class="exam-input" data-question="1.10.1" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">2. <input type="text" class="exam-input" data-question="1.10.2" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">3. <input type="text" class="exam-input" data-question="1.10.3" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">4. <input type="text" class="exam-input" data-question="1.10.4" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">5. <input type="text" class="exam-input" data-question="1.10.5" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">6. <input type="text" class="exam-input" data-question="1.10.6" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">7. <input type="text" class="exam-input" data-question="1.10.7" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">8. <input type="text" class="exam-input" data-question="1.10.8" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">9. <input type="text" class="exam-input" data-question="1.10.9" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">10. <input type="text" class="exam-input" data-question="1.10.10" style="border: none; background: transparent; width: 80%;"></td></tr>
                            <tr><td style="border: 1px solid #000; padding: 8px; height: 30px;">11. <input type="text" class="exam-input" data-question="1.10.11" style="border: none; background: transparent; width: 80%;"></td></tr>
                        </table>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.11. Expliquer le terme pointage.</h3>
                        <textarea class="exam-textarea" data-question="1.11" style="width: 100%; height: 80px; border: 1px solid #ccc; padding: 8px; background: transparent; resize: vertical; margin-top: 0.5rem;"></textarea>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.12. Citer 2 avantages d'incorporer du lait dans une pâte de viennoiserie.</h3>
                        <div style="margin-top: 1rem;">
                            <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.12.1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.12.2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                        </div>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.13. Préciser 2 avantages et 2 inconvénients liés à l'utilisation des ovoproduits.</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <h4 style="font-weight: bold;">Avantages :</h4>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.13.avantage1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.13.avantage2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            </div>
                            <div>
                                <h4 style="font-weight: bold;">Inconvénients :</h4>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.13.inconvenient1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.13.inconvenient2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            </div>
                        </div>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.14. Classer les caractéristiques suivantes selon les types de fours.</h3>
                        <p style="margin-bottom: 1rem;"><strong>Caractéristiques :</strong> Gain de place - Monte rapidement en température - Meilleur développement de la viennoiserie (brioche) - Température de cuisson plus élevée</p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
                            <div>
                                <h4 style="font-weight: bold; background: #f0f0f0; padding: 0.5rem;">Four ventilé :</h4>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.14.ventile1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.14.ventile2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            </div>
                            <div>
                                <h4 style="font-weight: bold; background: #f0f0f0; padding: 0.5rem;">Four à sole :</h4>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.14.sole1" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                                <div style="margin: 0.5rem 0;"><input type="text" class="exam-input" data-question="1.14.sole2" style="border-bottom: 1px dotted #000; background: transparent; border: none; width: 100%; padding: 5px;"></div>
                            </div>
                        </div>
                    </div>

                    <div style="border: 1px solid #ccc; padding: 1rem; margin: 1rem 0; background-color: #f9f9f9;">
                        <h3 style="font-weight: bold;">1.15. Sélectionner les matériels indispensables pour stocker les matières premières et les produits alimentaires « snacking » fabriqués et compléter leur rôle.</h3>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <tr>
                                <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Matériel</th>
                                <th style="border: 1px solid #000; padding: 8px; background: #f0f0f0;">Rôle des matériels sélectionnés</th>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 8px;">☐ Cellule de refroidissement</td>
                                <td style="border: 1px solid #000; padding: 8px; width: 50%;"><input type="text" class="exam-input" data-question="1.15.cellule" style="border: none; background: transparent; width: 100%;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 8px;">☐ Vitrine non réfrigérée</td>
                                <td style="border: 1px solid #000; padding: 8px;"><input type="text" class="exam-input" data-question="1.15.vitrine_non" style="border: none; background: transparent; width: 100%;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 8px;">☐ Conservateur congélateur</td>
                                <td style="border: 1px solid #000; padding: 8px;"><input type="text" class="exam-input" data-question="1.15.congelateur" style="border: none; background: transparent; width: 100%;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 8px;">☐ Réserve sèche</td>
                                <td style="border: 1px solid #000; padding: 8px;"><input type="text" class="exam-input" data-question="1.15.reserve" style="border: none; background: transparent; width: 100%;"></td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #000; padding: 8px;">☐ Vitrine réfrigérée</td>
                                <td style="border: 1px solid #000; padding: 8px;"><input type="text" class="exam-input" data-question="1.15.vitrine_ref" style="border: none; background: transparent; width: 100%;"></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Message de fin d'examen -->
                <div style="text-align: center; margin: 2rem 0; padding: 1rem; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
                    <h3 style="color: #856404; margin-bottom: 0.5rem;">📝 Examen en cours</h3>
                    <p style="color: #856404; margin: 0;">
                        Vous pouvez sauvegarder vos réponses à tout moment en cliquant sur "Sauvegarder" dans la barre du haut.
                        <br>Cliquez sur "Terminer" pour finaliser votre examen et voir votre score.
                    </p>
                </div>
            `;
        }

        function startExamTimer(startTime) {
            const timer = setInterval(() => {
                const elapsed = new Date().getTime() - startTime;
                const hours = Math.floor(elapsed / (1000 * 60 * 60));
                const minutes = Math.floor((elapsed % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((elapsed % (1000 * 60)) / 1000);
                
                const timerElement = document.getElementById('examTimer');
                if (timerElement) {
                    timerElement.textContent = `⏱️ Temps: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    clearInterval(timer);
                }
            }, 1000);
            
            // Sauvegarder le timer ID pour pouvoir l'arrêter plus tard
            window.examTimerId = timer;
        }

        function setupExamInteractivity() {
            // Gérer les checkboxes mutuellement exclusives
            document.querySelectorAll('.exam-checkbox[data-answer]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        const question = this.getAttribute('data-question');
                        // Décocher l'autre option de la même question
                        document.querySelectorAll(`.exam-checkbox[data-question="${question}"]`).forEach(cb => {
                            if (cb !== this) cb.checked = false;
                        });
                    }
                });
            });

            // Auto-sauvegarde des réponses
            document.querySelectorAll('.exam-input, .exam-textarea, .exam-checkbox').forEach(element => {
                element.addEventListener('change', saveCurrentAnswers);
                if (element.type !== 'checkbox') {
                    element.addEventListener('input', saveCurrentAnswers);
                }
            });
        }

        function saveCurrentAnswers() {
            const answers = {};
            
            // Sauvegarder les inputs et textareas
            document.querySelectorAll('.exam-input, .exam-textarea').forEach(element => {
                const question = element.getAttribute('data-question');
                if (question) {
                    answers[question] = element.value;
                }
            });

            // Sauvegarder les checkboxes
            document.querySelectorAll('.exam-checkbox').forEach(element => {
                const question = element.getAttribute('data-question');
                if (question && element.checked) {
                    const answer = element.getAttribute('data-answer');
                    answers[question] = answer || 'checked';
                }
            });

            // Sauvegarder dans localStorage
            const examData = getExamData();
            // Déterminer quel examen est actuellement ouvert
            const examWindow = document.getElementById('examWindow');
            if (examWindow) {
                const navBar = document.getElementById('examNavBar');
                if (navBar && navBar.textContent.includes('Septembre 2024')) {
                    examData.sessions["2024"].septembre.answers = answers;
                } else {
                    examData.sessions["2024"].juin.answers = answers;
                }
            }
            saveExamData(examData);
        }

        function loadSavedAnswers(examId) {
            const examData = getExamData();
            let answers;
            
            if (examId === 'juin2024') {
                answers = examData.sessions["2024"].juin.answers;
            } else if (examId === 'septembre2024') {
                answers = examData.sessions["2024"].septembre.answers;
            }
            
            if (answers) {
                // Charger les inputs et textareas
                Object.keys(answers).forEach(question => {
                    const element = document.querySelector(`[data-question="${question}"]`);
                    if (element && (element.type === 'text' || element.tagName === 'TEXTAREA')) {
                        element.value = answers[question];
                    } else if (element && element.type === 'checkbox') {
                        if (answers[question] === 'checked' || answers[question] === element.getAttribute('data-answer')) {
                            element.checked = true;
                        }
                    }
                });
            }
        }

        function saveExamProgress() {
            saveCurrentAnswers();
            showAlert('💾 Progression sauvegardée avec succès !', 'success');
        }

        function exitExam() {
            if (confirm('⚠️ Êtes-vous sûr de vouloir quitter l\'examen ? Votre progression sera sauvegardée.')) {
                saveCurrentAnswers();
                if (window.examTimerId) {
                    clearInterval(window.examTimerId);
                }
                const examWindow = document.getElementById('examWindow');
                if (examWindow) {
                    examWindow.remove();
                }
                // Retourner à la liste des examens 2024
                showExam2024();
            }
        }

        function submitExam() {
            if (confirm('📝 Êtes-vous sûr de vouloir terminer et soumettre votre examen ?')) {
                saveCurrentAnswers();
                calculateScore();
            }
        }

        function calculateScore() {
            const answers = {};
            
            // Récupérer toutes les réponses
            document.querySelectorAll('.exam-input, .exam-textarea').forEach(element => {
                const question = element.getAttribute('data-question');
                if (question) {
                    answers[question] = element.value.trim();
                }
            });

            document.querySelectorAll('.exam-checkbox:checked').forEach(element => {
                const question = element.getAttribute('data-question');
                if (question) {
                    const answer = element.getAttribute('data-answer');
                    answers[question] = answer || 'checked';
                }
            });

            // Calculer le score (système de correction basique)
            let score = 0;
            const totalPoints = 80;

            // Correction automatique simplifiée
            // Question 1.1 - Appellation boulanger (6 points)
            const q11Correct = {
                '1.1.a': 'faux', // Tout commerçant ne peut pas
                '1.1.b': 'vrai', // Pétrissage obligatoire
                '1.1.c': 'vrai', // Fermentation obligatoire
                '1.1.d': 'faux', // Peut vendre produits restauration
                '1.1.e': 'vrai', // Mise en forme obligatoire
                '1.1.f': 'faux'  // Surgélation autorisée avant aussi
            };

            let q11Score = 0;
            Object.keys(q11Correct).forEach(q => {
                if (answers[q] === q11Correct[q]) q11Score++;
            });
            score += Math.round((q11Score / 6) * 6);

            // Question 1.2 - Ordre chronologique (5 points)
            const q12Correct = ['Nettoyage', 'Broyage', 'Claquage', 'Convertissage', 'Blutage'];
            let q12Score = 0;
            for (let i = 1; i <= 5; i++) {
                const userAnswer = answers[`1.2.${i}`];
                if (userAnswer && q12Correct[i-1].toLowerCase().includes(userAnswer.toLowerCase().substring(0, 3))) {
                    q12Score++;
                }
            }
            score += q12Score;

            // Question 1.4 - Quantité sel (2 points)
            if (answers['1.4']) {
                const saltAnswer = answers['1.4'].toLowerCase();
                if (saltAnswer.includes('18') || saltAnswer.includes('1.8') || saltAnswer.includes('1,8')) {
                    score += 2;
                }
            }

            // Question 1.5 - Rôle du sel (5 points)
            const q15Correct = ['1.5.a', '1.5.c', '1.5.d']; // Vrai: ténacité, coloration, saveur
            let q15Score = 0;
            q15Correct.forEach(q => {
                if (answers[q] === 'checked') q15Score++;
            });
            // Points négatifs pour mauvaises réponses
            if (answers['1.5.b'] === 'checked') q15Score--; // Faux: accélère
            if (answers['1.5.e'] === 'checked') q15Score--; // Faux: diminue conservation
            score += Math.max(0, q15Score);

            // Autres questions - scoring basique pour les réponses textuelles
            if (answers['1.3'] && answers['1.3'].length > 20) score += 3;
            if (answers['1.6'] && answers['1.6'].length > 50) score += 4;

            // Bonus pour complétion
            const completedAnswers = Object.keys(answers).filter(k => answers[k] && answers[k].length > 0).length;
            if (completedAnswers > 10) score += 2;

            // Normaliser le score sur 20
            const finalScore = Math.min(20, Math.round((score / totalPoints) * 20));

            // Sauvegarder les résultats
            const examData = getExamData();
            examData.sessions["2024"].juin.attempts++;
            examData.sessions["2024"].juin.completed = true;
            examData.sessions["2024"].juin.lastScore = finalScore;
            if (finalScore > examData.sessions["2024"].juin.bestScore) {
                examData.sessions["2024"].juin.bestScore = finalScore;
            }

            // Mettre à jour les stats générales
            examData.stats.totalExams++;
            const allScores = [];
            Object.values(examData.sessions).forEach(year => {
                Object.values(year).forEach(exam => {
                    if (exam.completed) allScores.push(exam.bestScore);
                });
            });
            examData.stats.averageScore = allScores.length > 0 ? 
                allScores.reduce((a, b) => a + b, 0) / allScores.length : 0;
            examData.stats.bestScore = Math.max(...allScores, examData.stats.bestScore);

            saveExamData(examData);

            // Afficher les résultats
            showExamResults(finalScore, score, totalPoints);
        }

        function showExamResults(finalScore, rawScore, totalPoints) {
            if (window.examTimerId) {
                clearInterval(window.examTimerId);
            }

            const examWindow = document.getElementById('examWindow');
            if (examWindow) {
                examWindow.remove();
            }

            const mention = getScoreMention(finalScore);
            const resultModal = document.createElement('div');
            resultModal.id = 'resultModal';
            resultModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.95);
                z-index: 15000;
                display: flex;
                align-items: center;
                justify-content: center;
                backdrop-filter: blur(15px);
            `;

            const scoreColor = finalScore >= 16 ? '#4CAF50' : 
                             finalScore >= 14 ? '#FF9800' : 
                             finalScore >= 10 ? '#FFC107' : '#F44336';

            resultModal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1A1A1A, #2D2D2D);
                    border: 3px solid ${scoreColor};
                    border-radius: 20px;
                    width: 90vw;
                    max-width: 600px;
                    padding: 40px;
                    text-align: center;
                    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                    color: white;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">${finalScore >= 10 ? '🎉' : '📚'}</div>
                    
                    <h1 style="color: ${scoreColor}; font-size: 2.5rem; margin-bottom: 20px;">
                        ${finalScore}/20
                    </h1>
                    
                    <div style="font-size: 1.5rem; color: #FFD700; margin-bottom: 30px;">
                        ${mention}
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="color: #FFD700; margin-bottom: 15px;">📊 Détails de la correction</h3>
                        <p style="color: #B8B8B8; margin-bottom: 10px;">
                            Score brut: ${rawScore}/${totalPoints} points
                        </p>
                        <p style="color: #B8B8B8; margin-bottom: 10px;">
                            Score final: ${finalScore}/20
                        </p>
                        <p style="color: #B8B8B8;">
                            ${finalScore >= 10 ? '✅ Examen réussi' : '❌ Examen non validé (≥10/20 requis)'}
                        </p>
                    </div>

                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="viewCorrection('juin2024')" style="
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 25px;
                            font-size: 1rem;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">📖 Voir la correction</button>
                        
                        <button onclick="retakeExam('juin2024')" style="
                            background: #FF9800;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 25px;
                            font-size: 1rem;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">🔄 Repasser l'examen</button>
                        
                        <button onclick="closeResultModal()" style="
                            background: #607D8B;
                            color: white;
                            border: none;
                            padding: 15px 25px;
                            border-radius: 25px;
                            font-size: 1rem;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        ">🏠 Retour au menu</button>
                    </div>
                </div>
            `;

            document.body.appendChild(resultModal);

            // Effet d'apparition
            resultModal.style.opacity = '0';
            setTimeout(() => {
                resultModal.style.transition = 'opacity 0.3s ease';
                resultModal.style.opacity = '1';
            }, 10);
        }

        function closeResultModal() {
            const modal = document.getElementById('resultModal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => modal.remove(), 300);
            }
            showExam2024();
        }

        function retakeExam(examId) {
            closeResultModal();
            if (examId === 'juin2024') {
                startJuin2024Exam();
            }
        }

        function viewCorrection(examId) {
            showAlert('📖 Correction détaillée - Fonction en développement', 'info');
        }

        // Modal pour les calculs et conversions
        function openCalculsModal() {
            showModal('🧮 Calculs et Conversions', `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🧮</div>
                    <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">Calculateurs Boulangers</h3>
                    <p style="color: var(--text-dark); margin-bottom: 1rem;">
                        Outils de calcul spécialisés pour la boulangerie
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Calculateur Quantités - Redimensionnement -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #4A90E2; grid-column: 1 / -1;">
                        <h4 style="color: #4A90E2; margin-bottom: 1rem; text-align: center;">⚖️ Redimensionnement de Recette</h4>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem; text-align: center;">
                            Sélectionnez une recette et modifiez n'importe quel ingrédient pour recalculer automatiquement tous les autres
                        </p>
                        
                        <!-- Sélection de recette -->
                        <div class="form-group">
                            <label class="form-label">Sélectionner une recette</label>
                            <select id="recetteSelection" class="form-select" onchange="chargerRecettePourRedimensionnement()">
                                <option value="">-- Choisir une recette --</option>
                            </select>
                        </div>
                        
                        <!-- Affichage des ingrédients -->
                        <div id="ingredientsRedimensionnement" style="display: none;">
                            <h5 style="color: #4A90E2; margin-bottom: 1rem; text-align: center;">Ingrédients de la recette</h5>
                            <div id="listeIngredients" style="overflow-y: visible;">
                                <!-- Les ingrédients seront générés ici -->
                            </div>
                            <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #4A90E2;">
                                <p style="margin: 0; font-size: 0.9rem; color: #666;">
                                    💡 <strong>Comment utiliser :</strong> Modifiez n'importe quelle quantité pour recalculer automatiquement tous les autres ingrédients proportionnellement.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Calculateur TB -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid var(--accent-brown);">
                        <h4 style="color: var(--accent-brown); margin-bottom: 1rem; text-align: center;">🌡️ Température de Base (TB)</h4>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem; text-align: center;">
                            Calcul automatique de la température de l'eau
                        </p>
                        <div class="form-group">
                            <label class="form-label">Température de l'air (°C)</label>
                            <input type="number" id="tempAir" class="form-input" value="20" min="-10" max="40">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Température de la farine (°C)</label>
                            <input type="number" id="tempFarine" class="form-input" value="20" min="-10" max="40">
                        </div>
                        <div class="form-group">
                            <label class="form-label">TB souhaitée</label>
                            <input type="number" id="tbSouhaitee" class="form-input" value="60" min="50" max="70">
                        </div>
                        <button class="btn" onclick="calculerTB()" style="width: 100%; margin-top: 1rem;">Calculer</button>
                        <div id="resultatTB" style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 6px; display: none;">
                            <strong style="color: #2d5a2d;">Température de l'eau : <span id="tempEauResultat"></span>°C</strong>
                        </div>
                    </div>

                    <!-- Calculateur Hydratation -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid var(--olive-green);">
                        <h4 style="color: var(--olive-green); margin-bottom: 1rem; text-align: center;">💧 Taux d'Hydratation</h4>
                        <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem; text-align: center;">
                            Calcul du pourcentage d'hydratation
                        </p>
                        <div class="form-group">
                            <label class="form-label">Poids de farine (g)</label>
                            <input type="number" id="poidsFarine" class="form-input" value="500" min="1" max="10000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Poids d'eau (g)</label>
                            <input type="number" id="poidsEau" class="form-input" value="300" min="1" max="10000">
                        </div>
                        <button class="btn" onclick="calculerHydratation()" style="width: 100%; margin-top: 1rem;">Calculer</button>
                        <div id="resultatHydratation" style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 6px; display: none;">
                            <strong style="color: #2d5a2d;">Taux d'hydratation : <span id="tauxHydratationResultat"></span>%</strong>
                            <div id="suggestionHydratation" style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;"></div>
                        </div>
                    </div>
                </div>

                <!-- Section Conversions d'unités -->
                <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #D2691E; margin-bottom: 2rem;">
                    <h4 style="color: #D2691E; margin-bottom: 1rem; text-align: center;">🔄 Conversions d'Unités</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Valeur à convertir</label>
                            <input type="number" id="valeurConversion" class="form-input" value="500" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unité source</label>
                            <select id="uniteSource" class="form-select">
                                <option value="g">Grammes (g)</option>
                                <option value="kg">Kilogrammes (kg)</option>
                                <option value="ml">Millilitres (ml)</option>
                                <option value="l">Litres (L)</option>
                                <option value="oz">Ounces (oz)</option>
                                <option value="cups">Cups (cups)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Unité cible</label>
                            <select id="uniteCible" class="form-select">
                                <option value="g">Grammes (g)</option>
                                <option value="kg">Kilogrammes (kg)</option>
                                <option value="ml">Millilitres (ml)</option>
                                <option value="l">Litres (L)</option>
                                <option value="oz">Ounces (oz)</option>
                                <option value="cups">Cups (cups)</option>
                            </select>
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button class="btn" onclick="convertirUnite()" style="width: 100%;">Convertir</button>
                        </div>
                    </div>
                    <div id="resultatConversion" style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 6px; display: none;">
                        <strong style="color: #2d5a2d;">Résultat : <span id="valeurConvertie"></span></strong>
                    </div>
                </div>
                
                <div class="btn-group mt-2" style="justify-content: center;">
                    <button class="btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            `);
            
            // Charger les recettes pour le redimensionnement après l'ouverture de la modal
            setTimeout(() => {
                chargerRecettesPourRedimensionnement();
            }, 100);
        }

        // Modal pour la gestion du temps
        function openTempsModal() {
            showModal('⏱️ Gestion du Temps Boulanger', `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">⏱️</div>
                    <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">Planificateur de Boulange</h3>
                    <p style="color: var(--text-dark); margin-bottom: 1rem;">
                        Outils spécialisés pour la gestion du temps en boulangerie
                    </p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Timer Intégré -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #17a2b8; grid-column: 1 / -1;">
                        <h4 style="color: #17a2b8; margin-bottom: 1rem; text-align: center;">⏰ Minuteur Boulanger</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                            <!-- Affichage et contrôles -->
                            <div style="text-align: center;">
                                <div id="timerAffichage" style="font-size: 3rem; font-weight: bold; color: #17a2b8; font-family: monospace; margin: 1rem 0;">
                                    00:00:00
                                </div>
                                <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1rem;">
                                    <button class="btn" id="btnTimerStart" onclick="startTimer()" style="background: #28a745;">▶️ Démarrer</button>
                                    <button class="btn" id="btnTimerPause" onclick="pauseTimer()" style="background: #ffc107; color: #000;" disabled>⏸️ Pause</button>
                                    <button class="btn" onclick="resetTimer()" style="background: #dc3545;">🔄 Reset</button>
                                </div>
                                
                                <!-- Saisie manuelle -->
                                <div style="margin-top: 1rem;">
                                    <h5 style="color: #17a2b8; margin-bottom: 0.5rem;">⏱️ Saisie Manuelle</h5>
                                    <div style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                                        <input type="number" id="minutesInput" class="form-input" placeholder="Min" min="0" max="999" style="width: 80px; text-align: center;">
                                        <span style="font-weight: bold; color: #17a2b8;">:</span>
                                        <input type="number" id="secondesInput" class="form-input" placeholder="Sec" min="0" max="59" style="width: 80px; text-align: center;">
                                        <button class="btn" onclick="setTimerManuel()" style="background: #17a2b8;">⚙️ Régler</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Presets de temps boulanger -->
                            <div>
                                <h5 style="color: #17a2b8; margin-bottom: 0.5rem;">⏱️ Temps Prédéfinis</h5>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.5rem;">
                                    <button class="btn" onclick="setTimerPreset('petrissage_v1', 4)" style="background: #fd7e14; font-size: 0.8rem;">Pétrissage V1 (4min)</button>
                                    <button class="btn" onclick="setTimerPreset('petrissage_v2', 6)" style="background: #fd7e14; font-size: 0.8rem;">Pétrissage V2 (6min)</button>
                                    <button class="btn" onclick="setTimerPreset('autolyse', 45)" style="background: #6f42c1; font-size: 0.8rem;">Autolyse (45min)</button>
                                    <button class="btn" onclick="setTimerPreset('cuisson_baguette', 12)" style="background: #e83e8c; font-size: 0.8rem;">Cuisson Baguette (12min)</button>
                                    <button class="btn" onclick="setTimerPreset('repos', 60)" style="background: #20c997; font-size: 0.8rem;">Repos (1h)</button>
                                    <button class="btn" onclick="setTimerPreset('cuisson', 45)" style="background: #e83e8c; font-size: 0.8rem;">Cuisson (45min)</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Planificateur de Boulange -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #FF6B35; grid-column: 1 / -1;">
                        <h4 style="color: #FF6B35; margin-bottom: 1rem; text-align: center;">📅 Planificateur de Boulange</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Type de pain</label>
                                <select id="typePain" class="form-select" onchange="calculerTempsFermentation()">
                                    <option value="">-- Choisir un type --</option>
                                    <option value="baguette">🥖 Baguette traditionnelle</option>
                                    <option value="pain_campagne">🍞 Pain de campagne</option>
                                    <option value="brioche">🥐 Brioche</option>
                                    <option value="pain_complet">🌾 Pain complet</option>
                                    <option value="focaccia">🫓 Focaccia</option>
                                    <option value="ciabatta">🥖 Ciabatta</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Température ambiante (°C)</label>
                                <input type="number" id="tempAmbiante" class="form-input" value="22" min="15" max="30" onchange="calculerTempsFermentation()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Hydratation (%)</label>
                                <input type="number" id="hydratation" class="form-input" value="65" min="50" max="85" onchange="calculerTempsFermentation()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Heure souhaitée de sortie</label>
                                <input type="time" id="heureSortie" class="form-input" onchange="calculerPlanning()">
                            </div>
                        </div>
                        <div id="resultatPlanning" style="margin-top: 1rem; padding: 1rem; background: #e8f5e8; border-radius: 6px; display: none;">
                            <!-- Le planning sera affiché ici -->
                        </div>
                    </div>


                </div>

                <!-- Section Rappels et Notifications -->
                <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #D2691E; margin-bottom: 2rem;">
                    <h4 style="color: #D2691E; margin-bottom: 1rem; text-align: center;">🔔 Rappels et Notifications</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Rappel personnalisé</label>
                            <input type="text" id="rappelPersonnalise" class="form-input" placeholder="ex: Vérifier le levain, Retirer du four">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Délai (minutes)</label>
                            <input type="number" id="delaiRappel" class="form-input" value="30" min="1" max="480">
                        </div>
                        <div class="form-group" style="display: flex; align-items: end;">
                            <button class="btn" onclick="ajouterRappel()" style="background: #D2691E;">🔔 Ajouter</button>
                        </div>
                    </div>
                    <div id="listeRappels" style="margin-top: 1rem;">
                        <!-- Les rappels seront affichés ici -->
                    </div>
                </div>
                
                <div class="btn-group mt-2" style="justify-content: center;">
                    <button class="btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            `);
            
            // Initialiser les fonctionnalités de temps
            setTimeout(() => {
                initialiserGestionTemps();
            }, 100);
        }

        // Fonctions pour les calculateurs boulangers

        // 1. Calculateur de Température de Base (TB)
        function calculerTB() {
            const tempAir = parseFloat(document.getElementById('tempAir').value);
            const tempFarine = parseFloat(document.getElementById('tempFarine').value);
            const tbSouhaitee = parseFloat(document.getElementById('tbSouhaitee').value);
            
            if (isNaN(tempAir) || isNaN(tempFarine) || isNaN(tbSouhaitee)) {
                alert('Veuillez remplir tous les champs avec des valeurs numériques');
                return;
            }
            
            // Formule TB : TB = Température de l'air + Température de la farine + Température de l'eau
            // Donc : Température de l'eau = TB - Température de l'air - Température de la farine
            const tempEau = tbSouhaitee - tempAir - tempFarine;
            
            document.getElementById('tempEauResultat').textContent = tempEau.toFixed(1);
            document.getElementById('resultatTB').style.display = 'block';
            
            // Avertissement si l'eau est trop froide ou trop chaude
            let message = '';
            if (tempEau < 5) {
                message = '⚠️ Attention : Eau très froide. Vérifiez que votre levain est bien actif.';
            } else if (tempEau > 35) {
                message = '⚠️ Attention : Eau très chaude. Risque de tuer la levure.';
            } else if (tempEau < 10) {
                message = '💡 Conseil : Eau fraîche, parfait pour l\'été ou les levains très actifs.';
            } else if (tempEau > 25) {
                message = '💡 Conseil : Eau tiède, parfait pour l\'hiver ou les levains moins actifs.';
            } else {
                message = '✅ Température idéale pour la plupart des recettes.';
            }
            
            if (message) {
                document.getElementById('resultatTB').innerHTML += `<div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">${message}</div>`;
            }
        }

        // 2. Calculateur d'Hydratation
        function calculerHydratation() {
            const poidsFarine = parseFloat(document.getElementById('poidsFarine').value);
            const poidsEau = parseFloat(document.getElementById('poidsEau').value);
            
            if (isNaN(poidsFarine) || isNaN(poidsEau) || poidsFarine <= 0) {
                alert('Veuillez remplir tous les champs avec des valeurs numériques valides');
                return;
            }
            
            // Calcul du taux d'hydratation : (Eau / Farine) × 100
            const tauxHydratation = (poidsEau / poidsFarine) * 100;
            
            document.getElementById('tauxHydratationResultat').textContent = tauxHydratation.toFixed(1);
            document.getElementById('resultatHydratation').style.display = 'block';
            
            // Suggestions selon le taux d'hydratation
            let suggestion = '';
            if (tauxHydratation < 50) {
                suggestion = '🥖 Pain très ferme (baguette traditionnelle)';
            } else if (tauxHydratation < 60) {
                suggestion = '🍞 Pain classique (pain de mie, brioche)';
            } else if (tauxHydratation < 70) {
                suggestion = '🥖 Pain de campagne, pain rustique';
            } else if (tauxHydratation < 80) {
                suggestion = '🥖 Pain de campagne hydraté, ciabatta';
            } else if (tauxHydratation < 90) {
                suggestion = '🥖 Focaccia, pain très hydraté';
            } else {
                suggestion = '🥖 Pâte très liquide (pour certains pains spéciaux)';
            }
            
            document.getElementById('suggestionHydratation').textContent = suggestion;
        }

        // 3. Calculateur de Redimensionnement Intelligent
        let recetteSelectionnee = null;
        let ingredientsOriginaux = [];

        function chargerRecettesPourRedimensionnement() {
            const select = document.getElementById('recetteSelection');
            select.innerHTML = '<option value="">-- Choisir une recette --</option>';
            
            // Parcourir toutes les familles de recettes
            Object.keys(currentData.recipes).forEach(family => {
                currentData.recipes[family].forEach(recipe => {
                    const option = document.createElement('option');
                    option.value = `${family}|${recipe.name}`;
                    option.textContent = `${recipe.name} (${family})`;
                    select.appendChild(option);
                });
            });
        }

        function chargerRecettePourRedimensionnement() {
            const selection = document.getElementById('recetteSelection').value;
            if (!selection) {
                document.getElementById('ingredientsRedimensionnement').style.display = 'none';
                return;
            }

            const [family, recipeName] = selection.split('|');
            const recipe = currentData.recipes[family].find(r => r.name === recipeName);
            
            if (!recipe || !recipe.ingredients) {
                alert('Recette non trouvée ou sans ingrédients');
                return;
            }

            recetteSelectionnee = recipe;
            ingredientsOriginaux = [...recipe.ingredients];
            
            afficherIngredientsRedimensionnement();
        }

        function afficherIngredientsRedimensionnement() {
            const container = document.getElementById('listeIngredients');
            container.innerHTML = '';
            
            ingredientsOriginaux.forEach((ingredient, index) => {
                const div = document.createElement('div');
                div.style.cssText = 'display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 6px; border: 1px solid #dee2e6;';
                
                div.innerHTML = `
                    <div style="flex: 2;">
                        <strong style="color: var(--accent-brown);">${ingredient.name}</strong>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 0.2rem;">
                            Quantité originale : ${ingredient.quantity} ${ingredient.unit}
                        </div>
                    </div>
                    <div style="flex: 1;">
                        <input type="number" 
                               class="form-input" 
                               value="${ingredient.quantity}" 
                               min="0" 
                               step="0.1" 
                               style="width: 100%;"
                               onchange="recalculerIngredients(${index}, this.value)"
                               data-index="${index}">
                    </div>
                    <div style="flex: 1;">
                        <span style="color: var(--accent-brown); font-weight: bold;">${ingredient.unit}</span>
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            document.getElementById('ingredientsRedimensionnement').style.display = 'block';
        }

        function recalculerIngredients(indexModifie, nouvelleQuantite) {
            if (!recetteSelectionnee || !ingredientsOriginaux[indexModifie]) return;
            
            const ingredientModifie = ingredientsOriginaux[indexModifie];
            const quantiteOriginale = parseFloat(ingredientModifie.quantity);
            const nouvelleQuantiteFloat = parseFloat(nouvelleQuantite);
            
            if (isNaN(nouvelleQuantiteFloat) || nouvelleQuantiteFloat <= 0) {
                alert('Veuillez entrer une quantité valide');
                return;
            }
            
            // Calculer le facteur de multiplication
            const facteur = nouvelleQuantiteFloat / quantiteOriginale;
            
            // Mettre à jour tous les autres ingrédients
            const inputs = document.querySelectorAll('#listeIngredients input[type="number"]');
            inputs.forEach((input, index) => {
                if (index !== indexModifie) {
                    const ingredientOriginal = ingredientsOriginaux[index];
                    const nouvelleQuantiteIngredient = parseFloat(ingredientOriginal.quantity) * facteur;
                    input.value = nouvelleQuantiteIngredient.toFixed(1);
                }
            });
            
            // Mettre à jour les quantités originales affichées
            const labels = document.querySelectorAll('#listeIngredients div[style*="flex: 2"] div');
            labels.forEach((label, index) => {
                const ingredientOriginal = ingredientsOriginaux[index];
                const nouvelleQuantiteIngredient = parseFloat(ingredientOriginal.quantity) * facteur;
                label.textContent = `Quantité originale : ${ingredientOriginal.quantity} ${ingredientOriginal.unit} → Nouvelle : ${nouvelleQuantiteIngredient.toFixed(1)} ${ingredientOriginal.unit}`;
            });
        }

        // 4. Convertisseur d'unités
        function convertirUnite() {
            const valeur = parseFloat(document.getElementById('valeurConversion').value);
            const uniteSource = document.getElementById('uniteSource').value;
            const uniteCible = document.getElementById('uniteCible').value;
            
            if (isNaN(valeur) || valeur < 0) {
                alert('Veuillez entrer une valeur numérique valide');
                return;
            }
            
            if (uniteSource === uniteCible) {
                document.getElementById('valeurConvertie').textContent = `${valeur} ${uniteSource}`;
                document.getElementById('resultatConversion').style.display = 'block';
                return;
            }
            
            // Conversion en grammes d'abord
            let valeurEnGrammes = 0;
            switch (uniteSource) {
                case 'g':
                    valeurEnGrammes = valeur;
                    break;
                case 'kg':
                    valeurEnGrammes = valeur * 1000;
                    break;
                case 'ml':
                    valeurEnGrammes = valeur; // 1ml d'eau = 1g
                    break;
                case 'l':
                    valeurEnGrammes = valeur * 1000;
                    break;
                case 'oz':
                    valeurEnGrammes = valeur * 28.35;
                    break;
                case 'cups':
                    valeurEnGrammes = valeur * 236.59; // 1 cup = 236.59ml
                    break;
            }
            
            // Conversion vers l'unité cible
            let resultat = 0;
            let unite = '';
            switch (uniteCible) {
                case 'g':
                    resultat = valeurEnGrammes;
                    unite = 'g';
                    break;
                case 'kg':
                    resultat = valeurEnGrammes / 1000;
                    unite = 'kg';
                    break;
                case 'ml':
                    resultat = valeurEnGrammes;
                    unite = 'ml';
                    break;
                case 'l':
                    resultat = valeurEnGrammes / 1000;
                    unite = 'L';
                    break;
                case 'oz':
                    resultat = valeurEnGrammes / 28.35;
                    unite = 'oz';
                    break;
                case 'cups':
                    resultat = valeurEnGrammes / 236.59;
                    unite = 'cups';
                    break;
            }
            
            document.getElementById('valeurConvertie').textContent = `${resultat.toFixed(2)} ${unite}`;
            document.getElementById('resultatConversion').style.display = 'block';
        }

        function moveIngredient(index, direction) {
            const hierarchy = currentData.settings.ingredientHierarchy;
            if (index + direction < 0 || index + direction >= hierarchy.length) return;
            
            [hierarchy[index], hierarchy[index + direction]] = [hierarchy[index + direction], hierarchy[index]];
            openSettingsModal(); // Rafraîchir l'affichage
        }

        function removeIngredient(index) {
            currentData.settings.ingredientHierarchy.splice(index, 1);
            openSettingsModal();
        }

        function addIngredientToHierarchy() {
            const newIngredient = document.getElementById('newIngredient').value.trim();
            if (newIngredient && !currentData.settings.ingredientHierarchy.includes(newIngredient)) {
                currentData.settings.ingredientHierarchy.push(newIngredient);
                openSettingsModal();
            }
        }





        function saveSettings() {
            saveDataToStorage();
            renderAllRecipes(); // Rafraîchir l'affichage des recettes
            closeModal();
            alert('Paramètres sauvegardés !');
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function resetAllData() {
            if (confirm('⚠️ ATTENTION ⚠️\n\nCette action supprimera TOUTES vos données :\n- Toutes les recettes\n- Tous les levains\n- Toutes les images\n- Tous les paramètres\n\nCette action est IRRÉVERSIBLE !\n\nÊtes-vous absolument sûr ?')) {
                if (confirm('Dernière confirmation : voulez-vous vraiment TOUT supprimer ?')) {
                    localStorage.removeItem('bakeryData');
                    location.reload();
                }
            }
        }

        function compressImages() {
            if (currentData.gallery.length === 0) {
                alert('Aucune image à compresser');
                return;
            }
            
            let compressed = 0;
            const originalSize = JSON.stringify(currentData.gallery).length;
            
            currentData.gallery.forEach(image => {
                if (image.data && image.data.length > 200000) { // > 200KB
                    // Recompresser l'image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    
                    img.onload = function() {
                        canvas.width = img.width * 0.8; // Réduire de 20%
                        canvas.height = img.height * 0.8;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        const newData = canvas.toDataURL('image/jpeg', 0.6);
                        if (newData.length < image.data.length) {
                            image.data = newData;
                            compressed++;
                        }
                    };
                    
                    img.src = image.data;
                }
            });
            
            setTimeout(() => {
                const newSize = JSON.stringify(currentData.gallery).length;
                const saved = originalSize - newSize;
                saveDataToStorage();
                alert(`Compression terminée !\n${compressed} images compressées\n${formatBytes(saved)} économisés`);
            }, 1000);
        }

        // Gestionnaire d'événements pour les paramètres
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('settingsBtn').addEventListener('click', openSettingsModal);
        });

        // Fonctions utilitaires finales
        function generateDemoData() {
            // Générer des données de démonstration pour les tests
            const demoRecipes = [
                {
                    id: '1',
                    name: 'Pain de campagne au levain',
                    rating: 5,
                    comment: 'Ma recette fétiche, toujours réussie !',
                    createdDate: new Date().toISOString(),
                    ingredients: [
                        { name: 'Farine', quantity: '500', unit: 'g' },
                        { name: 'Eau', quantity: '350', unit: 'ml' },
                        { name: 'Levain', quantity: '100', unit: 'g' },
                        { name: 'Sel', quantity: '10', unit: 'g' }
                    ]
                },
                {
                    id: '2',
                    name: 'Brioche du dimanche',
                    rating: 4,
                    comment: 'Moelleuse et parfumée',
                    createdDate: new Date().toISOString(),
                    ingredients: [
                        { name: 'Farine', quantity: '500', unit: 'g' },
                        { name: 'Œufs', quantity: '3', unit: 'pièces' },
                        { name: 'Beurre', quantity: '200', unit: 'g' },
                        { name: 'Sucre', quantity: '50', unit: 'g' },
                        { name: 'Levure', quantity: '10', unit: 'g' },
                        { name: 'Lait', quantity: '100', unit: 'ml' }
                    ]
                }
            ];
            
            currentData.recipes.pain.push(demoRecipes[0]);
            currentData.recipes.viennoiseries.push(demoRecipes[1]);
            
            // Levain de démonstration
            currentData.levains.push({
                id: 'demo1',
                name: 'Levain Chef',
                createdDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 jours
                lastRefresh: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(), // 2 jours
                phase: 'adult',
                notes: [
                    {
                        date: new Date().toISOString(),
                        comment: 'Levain très actif, double de volume en 4h',
                        automatic: false
                    }
                ]
            });
            
            saveDataToStorage();
        }

        // Auto-sauvegarde périodique
        setInterval(() => {
            if (typeof currentData !== 'undefined') {
                saveDataToStorage();
            }
        }, 5 * 60 * 1000); // Toutes les 5 minutes

        // Gestion des raccourcis clavier
        document.addEventListener('keydown', function(e) {
            // Ctrl+S pour sauvegarder
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveDataToStorage();
                
                // Feedback visuel
                const notification = document.createElement('div');
                notification.textContent = '💾 Données sauvegardées';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: var(--olive-green);
                    color: white;
                    padding: 1rem;
                    border-radius: var(--border-radius);
                    z-index: 3000;
                    animation: slideIn 0.3s ease;
                `;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 2000);
            }
            
            // Escape pour fermer les modales
            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Gestion de la visibilité de la page (sauvegarde avant fermeture)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'hidden') {
                saveDataToStorage();
            }
        });

        // Sauvegarde avant fermeture de l'onglet
        window.addEventListener('beforeunload', function() {
            saveDataToStorage();
        });

        // Styles CSS additionnels pour les animations
        const additionalStyles = `
            <style>
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                

                
                .settings-container h4 {
                    color: var(--accent-brown);
                    border-bottom: 2px solid var(--accent-brown);
                    padding-bottom: 0.5rem;
                    margin-bottom: 1rem;
                }
                
                /* Animation de chargement */
                .loading {
                    display: inline-block;
                    width: 20px;
                    height: 20px;
                    border: 3px solid var(--cream-white);
                    border-radius: 50%;
                    border-top-color: var(--accent-brown);
                    animation: spin 1s ease-in-out infinite;
                }

                /* Styles pour l'auto-complétion des ingrédients */
                .ingredient-suggestions {
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                    border-radius: 0 0 var(--border-radius) var(--border-radius);
                }

                .suggestion-item {
                    transition: background-color 0.2s ease;
                    font-size: 0.95rem;
                }

                .suggestion-item:last-child {
                    border-bottom: none;
                    border-radius: 0 0 var(--border-radius) var(--border-radius);
                }

                .suggestion-item:hover {
                    background-color: #f0f0f0 !important;
                }

                /* Style spécial pour les suggestions d'ajout de nouvel ingrédient */
                .suggestion-item[onclick*="proposeNewIngredient"] {
                    background-color: #f8fff8;
                    border-top: 2px solid var(--olive-green);
                }

                .suggestion-item[onclick*="proposeNewIngredient"]:hover {
                    background-color: #e8f5e8 !important;
                }
                
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
                
                /* Responsive amélioré */
                @media (max-width: 480px) {
                    .chat-input-container {
                        flex-direction: column;
                        gap: 0.5rem;
                    }
                    
                    .chat-input {
                        margin-right: 0;
                    }
                    
                                .hierarchy-item {
                flex-direction: column;
                align-items: stretch !important;
                gap: 0.5rem;
            }
            
            .hierarchy-item > div {
                display: flex;
                justify-content: center;
                gap: 0.5rem;
            }
                }
            </style>
        `;

        // Injecter les styles additionnels
        document.head.insertAdjacentHTML('beforeend', additionalStyles);

        // Message de bienvenue dans la console
        console.log(`
⚜️ Boulangerie Artisanale Française - Application chargée avec succès !

Fonctionnalités disponibles :
✅ Gestion complète des recettes avec tri et hiérarchie
✅ Système de levains avec phase naissance Tamagotchi
✅ Galerie d'images avec compression automatique
✅ Chatbot intelligent pour l'aide boulangère
✅ Import/Export JSON complet
✅ Paramètres avancés et personnalisation
✅ Sauvegarde automatique et raccourcis clavier

Raccourcis :
• Ctrl+S : Sauvegarde manuelle
• Escape : Fermer les modales

Version : 1.0 - 100% local, aucune dépendance externe
        `);

        // Initialisation finale
        if (typeof initializeApp === 'function') {
            console.log('🚀 Initialisation de l\'application...');
        }

        function renderCustomTabs() {
            // Supprimer les onglets personnalisés existants
            const familyTabsContainer = document.getElementById('familyTabsContainer');
            const existingCustomTabs = familyTabsContainer.querySelectorAll('.custom-tab');
            existingCustomTabs.forEach(tab => tab.remove());
            
            // Référence au bouton d'ajout pour insérer les nouveaux onglets avant
            const addBtn = document.getElementById('addTabBtn');
            
            currentData.settings.customTabs.forEach((tab, idx) => {
                const btn = document.createElement('button');
                btn.className = 'tab-button family-tab custom-tab';
                btn.setAttribute('data-tab', 'custom-' + idx);
                btn.innerHTML = `<span>${tab.icon || '📝'}</span> <span>${tab.name}</span><button class="remove-tab-btn" title="Supprimer l\'onglet">×</button>`;
                btn.querySelector('.remove-tab-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (confirm('Supprimer cet onglet personnalisé ?')) {
                        currentData.settings.customTabs.splice(idx, 1);
                        saveDataToStorage();
                        renderCustomTabs();
                        if (btn.classList.contains('active')) showPage('accueil');
                    }
                });
                btn.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-tab-btn')) return;
                    showPage('custom-' + idx);
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
                // Insérer l'onglet juste avant le bouton d'ajout
                familyTabsContainer.insertBefore(btn, addBtn);
            });
        }

        document.getElementById('addTabBtn').addEventListener('click', function() {
            const icons = ['🧁','🥨','🍰','🍪','🍩','🍫','🍕','🥯','🥗','🍞','🧇','🥜','🍔','🍦','🍎','🍋','🍒','🍇','🍓','🍠','🧀','🍯','🥛','🍳','🧈','🥚','🧄','🧅','🥒','🥕','🌽','🍆','🍅','🍠','🍚','🍙','🍤','🍣','🍱','🍲','🍜','🍝','🥟','🥠','🥡','🍢','🍡','🍧','🍨','🍧','🍦','🍰','🎂','🍮','🍭','🍬','🍫','🍿','🍩','🍪','🥧','🧁','🥨','🥐','��','🥯','🥞','🧇'];
            showModal('Nouvel onglet personnalisé', `
                <div class="form-group">
                    <label class="form-label">Nom de l'onglet</label>
                    <input type="text" class="form-input" id="customTabName" maxlength="20" placeholder="Ex: Sans gluten">
                </div>
                <div class="form-group">
                    <label class="form-label">Icône</label>
                    <div id="iconChoices" style="display:flex;flex-wrap:wrap;gap:0.3rem;max-height:100px;overflow-y:auto;">
                        ${icons.map(ic => '<button type="button" class="btn-secondary" style="font-size:1.3rem;padding:0.3rem 0.6rem;" onclick="document.getElementById(\'customTabIcon\').value=\'' + ic + '\';Array.from(document.querySelectorAll(\'#iconChoices button\')).forEach(b=>b.classList.remove(\'active\'));this.classList.add(\'active\');">' + ic + '</button>').join('')}
                    </div>
                    <input type="text" class="form-input" id="customTabIcon" maxlength="2" placeholder="Ou collez un emoji" style="margin-top:0.5rem;">
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="addCustomTab()">Ajouter</button>
                    <button class="btn-secondary" onclick="closeModal()">Annuler</button>
                </div>
            `);
        });

        function addCustomTab() {
            const name = document.getElementById('customTabName').value.trim();
            const icon = document.getElementById('customTabIcon').value.trim() || '📝';
            if (!name) { alert('Veuillez saisir un nom d\'onglet'); return; }
            currentData.settings.customTabs.push({ name, icon });
            saveDataToStorage();
            closeModal();
            renderCustomTabs();
            // Créer dynamiquement la page de contenu si besoin
            if (!document.getElementById('page-custom-' + (currentData.settings.customTabs.length - 1))) {
                const mainContainer = document.querySelector('.main-container');
                const div = document.createElement('div');
                div.className = 'page-content';
                div.id = 'page-custom-' + (currentData.settings.customTabs.length - 1);
                div.innerHTML = `<div class='recipes-controls'><h2 class='section-title'>${icon} ${name}</h2><div class="sort-controls"><label>Trier par :</label><select class="sort-select" data-family="custom-${currentData.settings.customTabs.length - 1}"><option value="name">Nom</option><option value="rating">Note</option><option value="date">Date</option><option value="status">Statut</option></select></div><button class='btn' onclick='openAddRecipeModal("custom-${currentData.settings.customTabs.length - 1}")'>➕ Ajouter Recette</button><button class='btn btn-secondary' onclick='openAudioRecipeModal("custom-${currentData.settings.customTabs.length - 1}")' title="Saisir une recette par reconnaissance vocale">🎤 Recette Audio</button></div><div class='recipes-grid' id='recipes-custom-${currentData.settings.customTabs.length - 1}'></div>`;
                mainContainer.appendChild(div);
            }
            // Activer le nouvel onglet
            showPage('custom-' + (currentData.settings.customTabs.length - 1));
            document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            document.querySelector('.tab-button[data-tab="custom-' + (currentData.settings.customTabs.length - 1) + '"]').classList.add('active');
            renderRecipesForFamily('custom-' + (currentData.settings.customTabs.length - 1));
        }

        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            renderCustomTabs();
        });

        // Fonction d'export PDF
        function exportToPDF() {
            // Créer le contenu HTML du rapport
            const stats = calculateStats();
            const reportDate = new Date().toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const reportHTML = `
                <!DOCTYPE html>
                <html lang="fr">
                <head>
                    <meta charset="UTF-8">
                    <title>Rapport Boulangerie Artisanale Française</title>
                    <style>
                        body {
                            font-family: 'Georgia', serif;
                            margin: 0;
                            padding: 20px;
                            background: linear-gradient(135deg, #F5E6D3 0%, #E8D5B7 25%, #F0E68C 50%, #D2B48C 75%, #DEB887 100%);
                            color: #3E2723;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            padding: 20px;
                            background: linear-gradient(135deg, #FFF8DC, #F0E68C);
                            border-radius: 8px;
                            border: 2px solid #8B4513;
                        }
                        .title {
                            font-size: 28px;
                            font-weight: bold;
                            color: #8B4513;
                            margin-bottom: 10px;
                        }
                        .subtitle {
                            font-size: 14px;
                            color: #556B2F;
                        }
                        .section {
                            margin: 25px 0;
                            padding: 15px;
                            background: #FFFACD;
                            border-radius: 8px;
                            border-left: 4px solid #8B4513;
                        }
                        .section-title {
                            font-size: 20px;
                            font-weight: bold;
                            color: #8B4513;
                            margin-bottom: 15px;
                        }
                        .stats-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                            gap: 15px;
                            margin: 15px 0;
                        }
                        .stat-item {
                            background: white;
                            padding: 10px;
                            border-radius: 6px;
                            border: 1px solid #D2B48C;
                            text-align: center;
                        }
                        .stat-value {
                            font-size: 24px;
                            font-weight: bold;
                            color: #8B4513;
                        }
                        .stat-label {
                            font-size: 12px;
                            color: #666;
                            margin-top: 5px;
                        }
                        .levain-item {
                            background: white;
                            margin: 10px 0;
                            padding: 12px;
                            border-radius: 6px;
                            border: 1px solid #90C695;
                        }
                        .levain-name {
                            font-weight: bold;
                            color: #556B2F;
                            font-size: 16px;
                        }
                        .levain-avatar {
                            display: inline-block;
                            width: 24px;
                            height: 24px;
                            background: linear-gradient(135deg, #556B2F, #90C695);
                            border-radius: 50%;
                            text-align: center;
                            line-height: 24px;
                            margin-right: 8px;
                            font-size: 14px;
                        }
                        .levain-details {
                            margin-top: 8px;
                            font-size: 14px;
                            color: #666;
                        }
                        .family-section {
                            margin: 20px 0;
                        }
                        .family-title {
                            font-size: 18px;
                            font-weight: bold;
                            color: #8B4513;
                            margin-bottom: 10px;
                        }
                        .recipe-item {
                            background: white;
                            margin: 8px 0;
                            padding: 10px;
                            border-radius: 4px;
                            border-left: 3px solid #D2B48C;
                        }
                        .recipe-name {
                            font-weight: bold;
                            color: #3E2723;
                        }
                        .recipe-rating {
                            color: #8B4513;
                            font-size: 14px;
                        }
                        .recipe-note {
                            margin-top: 5px;
                            font-style: italic;
                            color: #666;
                            font-size: 13px;
                        }
                        .recipe-ingredients {
                            margin-top: 8px;
                        }
                        .recipe-ingredients strong {
                            color: #8B4513;
                            font-size: 14px;
                        }
                        .recipe-ingredients ul {
                            margin: 5px 0;
                            padding-left: 20px;
                            font-size: 13px;
                        }
                        .recipe-ingredients li {
                            margin: 2px 0;
                            color: #555;
                        }
                        .recipe-procedure {
                            margin-top: 8px;
                        }
                        .recipe-procedure strong {
                            color: #8B4513;
                            font-size: 14px;
                        }
                        .recipe-procedure-content {
                            margin-top: 5px;
                            white-space: pre-line;
                            font-size: 13px;
                            color: #555;
                            background: #f9f9f9;
                            padding: 8px;
                            border-radius: 4px;
                            border-left: 3px solid #D2B48C;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 40px;
                            padding: 20px;
                            border-top: 2px solid #8B4513;
                            color: #666;
                            font-size: 12px;
                        }
                        @media print {
                            body { background: white; }
                            .section { background: #f9f9f9; }
                            .levain-item, .recipe-item, .stat-item { background: white; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="title">⚜️ Boulangerie Artisanale Française 🥖</div>
                        <div class="subtitle">Rapport généré le ${reportDate}</div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">📊 Statistiques Générales</div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">${stats.totalRecipes}</div>
                                <div class="stat-label">Recettes totales</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${stats.avgRating}/5</div>
                                <div class="stat-label">Note moyenne</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${currentData.levains.length}</div>
                                <div class="stat-label">Levains actifs</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${currentData.gallery.length}</div>
                                <div class="stat-label">Images</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="section">
                        <div class="section-title">🍞 État des Levains</div>
                        ${currentData.levains.map(levain => {
                            const timeSinceRefresh = Math.floor((Date.now() - new Date(levain.lastRefresh).getTime()) / (1000 * 60 * 60 * 24));
                            const avatar = getLevainAvatar(timeSinceRefresh, levain.phase);
                            const ageResult = calculateLevainAge(levain.birthDate || levain.createdDate);
                            return `
                                <div class="levain-item">
                                    <div class="levain-name"><span class="levain-avatar">${avatar}</span>${levain.name}</div>
                                    <div class="levain-details">
                                        <div>Âge : ${ageResult.text}</div>
                                        <div>Phase : ${levain.phase === 'birth' ? 'Naissance' : 'Mature'}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="section">
                        <div class="section-title">📝 Recettes par Famille</div>
                        ${Object.entries(currentData.recipes).map(([family, recipes]) => `
                            <div class="family-section">
                                <div class="family-title">🏷️ ${family} (${recipes.length} recette${recipes.length > 1 ? 's' : ''})</div>
                                ${recipes.map(recipe => {
                                    const status = recipe.status || 'nouvelle';
                                    const statusLabels = {
                                        'nouvelle': '🆕 Nouvelle',
                                        'validee': '✅ Validée'
                                    };
                                    return `
                                    <div class="recipe-item">
                                        <div class="recipe-name">• ${recipe.name}</div>
                                        <div class="recipe-rating">Note : ${recipe.rating}/5</div>
                                        <div class="recipe-status">Statut : ${statusLabels[status]}</div>
                                        ${recipe.note ? `<div class="recipe-note">Note : ${recipe.note}</div>` : ''}
                                        ${recipe.ingredients && recipe.ingredients.length > 0 ? `
                                            <div class="recipe-ingredients">
                                                <strong>Ingrédients :</strong>
                                                <ul>
                                                    ${recipe.ingredients.map(ing => {
                                                        const ingredient = typeof ing === 'object' ? ing.name || ing.ingredient || JSON.stringify(ing) : ing;
                                                        const quantity = typeof ing === 'object' && ing.quantity ? ing.quantity : '';
                                                        const unit = typeof ing === 'object' && ing.unit ? ing.unit : '';
                                                        return `<li>${quantity ? quantity + (unit ? ' ' + unit + ' ' : ' ') : ''}${ingredient}</li>`;
                                                    }).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                                                            ${recipe.procedure ? `
                                            <div class="recipe-procedure">
                                                <strong>Procédé :</strong>
                                                <div class="recipe-procedure-content">${recipe.procedure}</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="footer">
                        ⚜️ Boulangerie Artisanale Française - Rapport généré automatiquement
                    </div>
                </body>
                </html>
            `;
            
            // Créer une nouvelle fenêtre avec le rapport
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            
            // Attendre que le contenu soit chargé puis imprimer
            reportWindow.onload = function() {
                setTimeout(() => {
                    reportWindow.print();
                    showSuccessNotification('📄 Rapport PDF généré avec succès !');
                }, 500);
            };
        }

        // ========================================
        // FONCTIONS DE GESTION DU TEMPS BOULANGER
        // ========================================

        // Variables globales pour la gestion du temps boulanger
        let timerInterval = null;
        let timerTemps = 0;
        let timerTempsInitial = 0;
        let timerEnCours = false;
        let rappels = [];
        let tempsFermentation = {};

        // Initialisation de la gestion du temps
        function initialiserGestionTemps() {
            // Charger les données sauvegardées
            chargerDonneesTemps();
            
            // Initialiser l'affichage du timer
            mettreAJourAffichageTimer();
            
            // Charger les rappels existants
            afficherRappels();
        }

        // ========================================
        // PLANIFICATEUR DE BOULANGE
        // ========================================

        // Formules de temps de fermentation basées sur la recherche boulangère
        const formulesFermentation = {
            baguette: {
                autolyse: 30,
                petrissage: 15,
                repos_1: 60,
                fermentation_1: 120,
                repos_2: 30,
                fermentation_2: 90,
                cuisson: 25
            },
            pain_campagne: {
                autolyse: 45,
                petrissage: 20,
                repos_1: 90,
                fermentation_1: 180,
                repos_2: 60,
                fermentation_2: 120,
                cuisson: 35
            },
            brioche: {
                autolyse: 20,
                petrissage: 25,
                repos_1: 120,
                fermentation_1: 240,
                repos_2: 90,
                fermentation_2: 180,
                cuisson: 30
            },
            pain_complet: {
                autolyse: 60,
                petrissage: 18,
                repos_1: 120,
                fermentation_1: 240,
                repos_2: 90,
                fermentation_2: 150,
                cuisson: 40
            },
            focaccia: {
                autolyse: 30,
                petrissage: 12,
                repos_1: 60,
                fermentation_1: 180,
                repos_2: 45,
                fermentation_2: 120,
                cuisson: 25
            },
            ciabatta: {
                autolyse: 45,
                petrissage: 10,
                repos_1: 90,
                fermentation_1: 240,
                repos_2: 60,
                fermentation_2: 180,
                cuisson: 30
            }
        };

        function calculerTempsFermentation() {
            const typePain = document.getElementById('typePain').value;
            const tempAmbiante = parseFloat(document.getElementById('tempAmbiante').value);
            const hydratation = parseFloat(document.getElementById('hydratation').value);
            
            if (!typePain || !tempAmbiante || !hydratation) return;
            
            const formule = formulesFermentation[typePain];
            if (!formule) return;
            
            // Ajuster les temps selon la température et l'hydratation
            const facteurTemp = (22 - tempAmbiante) * 0.1; // +10% par degré en dessous de 22°C
            const facteurHydratation = (hydratation - 65) * 0.02; // +2% par point d'hydratation au-dessus de 65%
            
            tempsFermentation = {
                type: typePain,
                autolyse: Math.round(formule.autolyse * (1 + facteurTemp + facteurHydratation)),
                petrissage: Math.round(formule.petrissage * (1 + facteurTemp)),
                repos_1: Math.round(formule.repos_1 * (1 + facteurTemp + facteurHydratation)),
                fermentation_1: Math.round(formule.fermentation_1 * (1 + facteurTemp + facteurHydratation)),
                repos_2: Math.round(formule.repos_2 * (1 + facteurTemp + facteurHydratation)),
                fermentation_2: Math.round(formule.fermentation_2 * (1 + facteurTemp + facteurHydratation)),
                cuisson: formule.cuisson
            };
            
            // Afficher les résultats
            afficherTempsFermentation();
        }

        function afficherTempsFermentation() {
            const container = document.getElementById('resultatPlanning');
            if (!container || !tempsFermentation.type) return;
            
            const totalTemps = tempsFermentation.autolyse + tempsFermentation.petrissage + 
                              tempsFermentation.repos_1 + tempsFermentation.fermentation_1 + 
                              tempsFermentation.repos_2 + tempsFermentation.fermentation_2 + 
                              tempsFermentation.cuisson;
            
            container.innerHTML = `
                <h5 style="color: #FF6B35; margin-bottom: 1rem;">⏱️ Temps de Fermentation Calculés</h5>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #6f42c1;">
                        <strong style="color: #6f42c1;">Autolyse</strong><br>
                        <span style="font-size: 1.2rem; font-weight: bold;">${tempsFermentation.autolyse} min</span>
                    </div>
                    <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #fd7e14;">
                        <strong style="color: #fd7e14;">Pétrissage</strong><br>
                        <span style="font-size: 1.2rem; font-weight: bold;">${tempsFermentation.petrissage} min</span>
                    </div>
                    <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #20c997;">
                        <strong style="color: #20c997;">Repos 1</strong><br>
                        <span style="font-size: 1.2rem; font-weight: bold;">${tempsFermentation.repos_1} min</span>
                    </div>
                    <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #17a2b8;">
                        <strong style="color: #17a2b8;">Fermentation 1</strong><br>
                        <span style="font-size: 1.2rem; font-weight: bold;">${tempsFermentation.fermentation_1} min</span>
                    </div>
                    <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <strong style="color: #ffc107;">Repos 2</strong><br>
                        <span style="font-size: 1.2rem; font-weight: bold;">${tempsFermentation.repos_2} min</span>
                    </div>
                    <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #e83e8c;">
                        <strong style="color: #e83e8c;">Fermentation 2</strong><br>
                        <span style="font-size: 1.2rem; font-weight: bold;">${tempsFermentation.fermentation_2} min</span>
                    </div>
                    <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; border-left: 4px solid #dc3545;">
                        <strong style="color: #dc3545;">Cuisson</strong><br>
                        <span style="font-size: 1.2rem; font-weight: bold;">${tempsFermentation.cuisson} min</span>
                    </div>
                </div>
                <div style="background: #e8f5e8; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                    <strong style="color: #2d5a2d;">⏰ Temps total estimé : ${Math.round(totalTemps / 60 * 10) / 10} heures</strong>
                </div>
            `;
            container.style.display = 'block';
        }

        function calculerPlanning() {
            const heureSortie = document.getElementById('heureSortie').value;
            if (!heureSortie || !tempsFermentation.type) {
                showErrorNotification('Veuillez d\'abord calculer les temps de fermentation');
                return;
            }
            
            const [heuresSortie, minutesSortie] = heureSortie.split(':').map(Number);
            const dateSortie = new Date();
            dateSortie.setHours(heuresSortie, minutesSortie, 0, 0);
            
            const totalMinutes = tempsFermentation.autolyse + tempsFermentation.petrissage + 
                               tempsFermentation.repos_1 + tempsFermentation.fermentation_1 + 
                               tempsFermentation.repos_2 + tempsFermentation.fermentation_2 + 
                               tempsFermentation.cuisson;
            
            const dateDebut = new Date(dateSortie.getTime() - totalMinutes * 60000);
            
            const planning = {
                debut: dateDebut.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                autolyse: new Date(dateDebut.getTime() + tempsFermentation.autolyse * 60000).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                petrissage: new Date(dateDebut.getTime() + (tempsFermentation.autolyse + tempsFermentation.petrissage) * 60000).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                repos1: new Date(dateDebut.getTime() + (tempsFermentation.autolyse + tempsFermentation.petrissage + tempsFermentation.repos_1) * 60000).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                fermentation1: new Date(dateDebut.getTime() + (tempsFermentation.autolyse + tempsFermentation.petrissage + tempsFermentation.repos_1 + tempsFermentation.fermentation_1) * 60000).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                repos2: new Date(dateDebut.getTime() + (tempsFermentation.autolyse + tempsFermentation.petrissage + tempsFermentation.repos_1 + tempsFermentation.fermentation_1 + tempsFermentation.repos_2) * 60000).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                fermentation2: new Date(dateDebut.getTime() + (tempsFermentation.autolyse + tempsFermentation.petrissage + tempsFermentation.repos_1 + tempsFermentation.fermentation_1 + tempsFermentation.repos_2 + tempsFermentation.fermentation_2) * 60000).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                cuisson: new Date(dateDebut.getTime() + (totalMinutes - tempsFermentation.cuisson) * 60000).toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
                fin: heureSortie
            };
            
            afficherPlanning(planning);
        }

        function afficherPlanning(planning) {
            const container = document.getElementById('resultatPlanning');
            if (!container) return;
            
            container.innerHTML += `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid #FF6B35;">
                    <h5 style="color: #FF6B35; margin-bottom: 1rem;">📅 Planning de la Journée</h5>
                    <div style="background: #fff3cd; padding: 1rem; border-radius: 6px; border-left: 4px solid #ffc107;">
                        <strong style="color: #856404;">🕐 Début : ${planning.debut}</strong>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-top: 1rem;">
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                            <strong style="color: #6f42c1;">Autolyse</strong><br>${planning.autolyse}
                        </div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                            <strong style="color: #fd7e14;">Pétrissage</strong><br>${planning.petrissage}
                        </div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                            <strong style="color: #20c997;">Repos 1</strong><br>${planning.repos1}
                        </div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                            <strong style="color: #17a2b8;">Fermentation 1</strong><br>${planning.fermentation1}
                        </div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                            <strong style="color: #ffc107;">Repos 2</strong><br>${planning.repos2}
                        </div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                            <strong style="color: #e83e8c;">Fermentation 2</strong><br>${planning.fermentation2}
                        </div>
                        <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 4px; font-size: 0.9rem;">
                            <strong style="color: #dc3545;">Cuisson</strong><br>${planning.cuisson}
                        </div>
                    </div>
                    <div style="background: #d4edda; padding: 1rem; border-radius: 6px; border-left: 4px solid #28a745; margin-top: 1rem;">
                        <strong style="color: #155724;">✅ Sortie : ${planning.fin}</strong>
                    </div>
                </div>
            `;
        }

        // ========================================
        // TIMER INTÉGRÉ
        // ========================================

        // Fonction d'alerte sonore améliorée
        function jouerAlerteSonore() {
            // Méthode 1: Utiliser l'API Web Audio pour générer un son
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.3);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                // Jouer plusieurs fois pour être sûr
                setTimeout(() => {
                    const oscillator2 = audioContext.createOscillator();
                    const gainNode2 = audioContext.createGain();
                    
                    oscillator2.connect(gainNode2);
                    gainNode2.connect(audioContext.destination);
                    
                    oscillator2.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator2.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                    
                    gainNode2.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator2.start(audioContext.currentTime);
                    oscillator2.stop(audioContext.currentTime + 0.3);
                }, 600);
                
            } catch (e) {
                // Méthode 2: Son encodé en base64 (fallback)
                try {
                    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                    audio.volume = 0.5;
                    audio.play().catch(() => {});
                } catch (e2) {
                    // Méthode 3: Utiliser la synthèse vocale comme fallback
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance('Minuteur terminé');
                        utterance.lang = 'fr-FR';
                        utterance.volume = 0.8;
                        utterance.rate = 0.8;
                        speechSynthesis.speak(utterance);
                    }
                }
            }
        }

        function startTimer() {
            if (!timerEnCours && timerTemps > 0) {
                timerEnCours = true;
                timerInterval = setInterval(() => {
                    timerTemps--;
                    mettreAJourAffichageTimer();
                    sauvegarderDonneesTemps();
                    
                                            // Alerte sonore quand le timer arrive à 0
                        if (timerTemps <= 0) {
                            clearInterval(timerInterval);
                            timerEnCours = false;
                            timerTemps = 0;
                            
                            // Alerte sonore améliorée
                            jouerAlerteSonore();
                            
                            // Notification
                            if ('Notification' in window && Notification.permission === 'granted') {
                                new Notification('⏰ Minuteur terminé !');
                            }
                            
                            showSuccessNotification('⏰ Minuteur terminé !');
                            
                            // Réinitialiser les boutons
                            document.getElementById('btnTimerStart').disabled = false;
                            document.getElementById('btnTimerPause').disabled = true;
                            document.getElementById('btnTimerStart').textContent = '▶️ Démarrer';
                            document.getElementById('btnTimerStart').onclick = startTimer;
                            
                            sauvegarderDonneesTemps();
                        }
                }, 1000);
                
                document.getElementById('btnTimerStart').disabled = true;
                document.getElementById('btnTimerPause').disabled = false;
                document.getElementById('btnTimerStart').textContent = '⏸️ Pause';
                document.getElementById('btnTimerStart').onclick = pauseTimer;
                
                sauvegarderDonneesTemps();
            }
        }

        function pauseTimer() {
            if (timerEnCours) {
                timerEnCours = false;
                clearInterval(timerInterval);
                
                document.getElementById('btnTimerStart').disabled = false;
                document.getElementById('btnTimerPause').disabled = true;
                document.getElementById('btnTimerStart').textContent = '▶️ Démarrer';
                document.getElementById('btnTimerStart').onclick = startTimer;
                
                sauvegarderDonneesTemps();
            }
        }

        function resetTimer() {
            timerTemps = timerTempsInitial;
            timerEnCours = false;
            clearInterval(timerInterval);
            
            document.getElementById('btnTimerStart').disabled = false;
            document.getElementById('btnTimerPause').disabled = true;
            document.getElementById('btnTimerStart').textContent = '▶️ Démarrer';
            document.getElementById('btnTimerStart').onclick = startTimer;
            
            mettreAJourAffichageTimer();
            sauvegarderDonneesTemps();
        }

        function mettreAJourAffichageTimer() {
            const heures = Math.floor(timerTemps / 3600);
            const minutes = Math.floor((timerTemps % 3600) / 60);
            const secondes = timerTemps % 60;
            
            const affichage = `${heures.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondes.toString().padStart(2, '0')}`;
            const element = document.getElementById('timerAffichage');
            if (element) element.textContent = affichage;
        }

        function setTimerPreset(type, minutes) {
            timerTemps = minutes * 60;
            timerTempsInitial = timerTemps;
            mettreAJourAffichageTimer();
            sauvegarderDonneesTemps();
            
            showSuccessNotification(`⏱️ Minuteur réglé sur ${minutes} minutes pour ${type}`);
        }

        function setTimerManuel() {
            const minutes = parseInt(document.getElementById('minutesInput').value) || 0;
            const secondes = parseInt(document.getElementById('secondesInput').value) || 0;
            
            if (minutes === 0 && secondes === 0) {
                showErrorNotification('Veuillez saisir un temps valide');
                return;
            }
            
            timerTemps = minutes * 60 + secondes;
            timerTempsInitial = timerTemps;
            mettreAJourAffichageTimer();
            sauvegarderDonneesTemps();
            
            showSuccessNotification(`⏱️ Minuteur réglé sur ${minutes}:${secondes.toString().padStart(2, '0')}`);
        }



        // ========================================
        // RAPPELS ET NOTIFICATIONS
        // ========================================

        function ajouterRappel() {
            const texte = document.getElementById('rappelPersonnalise').value.trim();
            const delai = parseInt(document.getElementById('delaiRappel').value);
            
            if (!texte || !delai || delai <= 0) {
                showErrorNotification('Veuillez remplir tous les champs avec des valeurs valides');
                return;
            }
            
            const rappel = {
                id: Date.now(),
                texte: texte,
                delai: delai,
                dateCreation: new Date().toLocaleString('fr-FR'),
                actif: true,
                timeout: null
            };
            
            rappels.push(rappel);
            afficherRappels();
            sauvegarderDonneesTemps();
            
            // Programmer la notification
            rappel.timeout = setTimeout(() => {
                // Notification sonore et visuelle
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(`🔔 Rappel Boulangerie: ${rappel.texte}`);
                }
                
                // Son d'alerte
                jouerAlerteSonore();
                
                showSuccessNotification(`🔔 Rappel: ${rappel.texte}`);
                
                // Marquer comme terminé
                rappel.actif = false;
                afficherRappels();
                sauvegarderDonneesTemps();
            }, delai * 60000);
            
            // Réinitialiser les champs
            document.getElementById('rappelPersonnalise').value = '';
            document.getElementById('delaiRappel').value = '30';
        }

        function supprimerRappel(id) {
            const rappel = rappels.find(r => r.id === id);
            if (rappel && rappel.timeout) {
                clearTimeout(rappel.timeout);
            }
            
            rappels = rappels.filter(r => r.id !== id);
            afficherRappels();
            sauvegarderDonneesTemps();
        }

        function afficherRappels() {
            const container = document.getElementById('listeRappels');
            if (!container) return;
            
            container.innerHTML = rappels.map(rappel => `
                <div style="background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius); border: 2px solid ${rappel.actif ? '#D2691E' : '#28a745'}; margin-bottom: 0.5rem; opacity: ${rappel.actif ? '1' : '0.7'};">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div style="flex: 1;">
                            <div style="text-decoration: ${rappel.actif ? 'none' : 'line-through'}; margin-bottom: 0.5rem;">${rappel.texte}</div>
                            <div style="font-size: 0.8rem; color: #666;">
                                ${rappel.actif ? `⏰ Dans ${rappel.delai} minutes` : '✅ Terminé'} - ${rappel.dateCreation}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn" onclick="supprimerRappel(${rappel.id})" style="background: #dc3545; font-size: 0.8rem;">🗑️</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ========================================
        // SAUVEGARDE ET CHARGEMENT
        // ========================================

        function sauvegarderDonneesTemps() {
            const donnees = {
                timerTemps: timerTemps,
                timerTempsInitial: timerTempsInitial,
                rappels: rappels,
                tempsFermentation: tempsFermentation
            };
            localStorage.setItem('tempsBoulangerie', JSON.stringify(donnees));
        }

        function chargerDonneesTemps() {
            const donnees = localStorage.getItem('tempsBoulangerie');
            if (donnees) {
                try {
                    const parsed = JSON.parse(donnees);
                    timerTemps = parsed.timerTemps || 0;
                    timerTempsInitial = parsed.timerTempsInitial || 0;
                    rappels = parsed.rappels || [];
                    tempsFermentation = parsed.tempsFermentation || {};
                } catch (e) {
                    console.error('Erreur lors du chargement des données de temps:', e);
                }
            }
        }

        // ========================================
        // FONCTIONS BETA
        // ========================================

        function analyzeRecipes() {
            const allRecipes = Object.values(currentData.recipes).flat();
            const testedRecipes = allRecipes.filter(r => r.status === 'testee');
            const favoriteRecipes = allRecipes.filter(r => r.rating >= 4);
            
            // Calculer les statistiques
            const totalRecipes = allRecipes.length;
            const testedCount = testedRecipes.length;
            const favoriteCount = favoriteRecipes.length;
            const averageRating = totalRecipes > 0 ? (allRecipes.reduce((sum, r) => sum + (r.rating || 0), 0) / totalRecipes).toFixed(1) : '0.0';
            
            // Calculer le temps moyen de préparation
            const recipesWithTime = allRecipes.filter(r => r.preparationTime);
            const avgPrepTime = recipesWithTime.length > 0 ? 
                Math.round(recipesWithTime.reduce((sum, r) => sum + (parseInt(r.preparationTime) || 0), 0) / recipesWithTime.length) : 0;
            
            // Analyser les taux de réussite
            const successRates = {};
            Object.keys(currentData.recipes).forEach(family => {
                const familyRecipes = currentData.recipes[family];
                const testedInFamily = familyRecipes.filter(r => r.status === 'testee');
                const successfulInFamily = testedInFamily.filter(r => r.rating >= 3);
                successRates[family] = testedInFamily.length > 0 ? 
                    Math.round((successfulInFamily.length / testedInFamily.length) * 100) : 0;
            });
            
            // Trouver les recettes les plus populaires
            const topRecipes = allRecipes
                .filter(r => r.rating > 0)
                .sort((a, b) => (b.rating || 0) - (a.rating || 0))
                .slice(0, 5);
            
            // Trouver les recettes récentes
            const recentRecipes = allRecipes
                .filter(r => r.dateCreated)
                .sort((a, b) => new Date(b.dateCreated) - new Date(a.dateCreated))
                .slice(0, 3);
            
            showModal('🔬 Analyse Avancée des Recettes', `
                <div style="max-height: 80vh; overflow-y: auto;">
                    <!-- En-tête avec statistiques principales -->
                    <div style="text-align: center; margin-bottom: 2rem; background: linear-gradient(135deg, #FF6B35, #F7931E); padding: 2rem; border-radius: var(--border-radius); color: white;">
                        <h2 style="margin-bottom: 1rem; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">📊 Tableau de Bord Complet</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1.5rem;">
                            <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">📝</div>
                                <div style="font-size: 1.5rem; font-weight: bold;">${totalRecipes}</div>
                                <div style="font-size: 0.9rem;">Total Recettes</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">✅</div>
                                <div style="font-size: 1.5rem; font-weight: bold;">${testedCount}</div>
                                <div style="font-size: 0.9rem;">Testées</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">⭐</div>
                                <div style="font-size: 1.5rem; font-weight: bold;">${averageRating}</div>
                                <div style="font-size: 0.9rem;">Note Moyenne</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">⏱️</div>
                                <div style="font-size: 1.5rem; font-weight: bold;">${avgPrepTime}min</div>
                                <div style="font-size: 0.9rem;">Temps Moyen</div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques de réussite par famille -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">📈 Taux de Réussite par Famille</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            ${Object.entries(successRates).map(([family, rate]) => `
                                <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px; border-left: 4px solid ${rate >= 80 ? '#28a745' : rate >= 60 ? '#ffc107' : '#dc3545'};">
                                    <div style="font-weight: bold; color: #D2691E;">${getFamilyDisplayName(family)}</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; color: ${rate >= 80 ? '#28a745' : rate >= 60 ? '#ffc107' : '#dc3545'};">${rate}%</div>
                                    <div style="font-size: 0.8rem; color: #666;">Taux de réussite</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Recettes les mieux notées -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">🏆 Top 5 des Recettes</h4>
                        ${topRecipes.length > 0 ? `
                            <div style="display: grid; gap: 0.5rem;">
                                ${topRecipes.map((recipe, index) => `
                                    <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #FFD700;">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="font-size: 1.5rem; font-weight: bold; color: #FFD700;">#${index + 1}</div>
                                            <div>
                                                <div style="font-weight: bold;">${recipe.name}</div>
                                                <div style="font-size: 0.8rem; color: #666;">${getFamilyDisplayName(recipe.family)}</div>
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 1.2rem; font-weight: bold; color: #D2691E;">${recipe.rating}/5</div>
                                            <div style="font-size: 0.8rem; color: #666;">${recipe.preparationTime || 'N/A'} min</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="text-align: center; color: #666;">Aucune recette notée pour le moment</p>'}
                    </div>

                    <!-- Recettes récentes -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">🆕 Recettes Récentes</h4>
                        ${recentRecipes.length > 0 ? `
                            <div style="display: grid; gap: 0.5rem;">
                                ${recentRecipes.map(recipe => `
                                    <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: bold;">${recipe.name}</div>
                                            <div style="font-size: 0.8rem; color: #666;">Créée le ${new Date(recipe.dateCreated).toLocaleDateString()}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 0.9rem; color: #666;">${recipe.status || 'Non testée'}</div>
                                            <div style="font-size: 0.8rem; color: #666;">${recipe.rating ? recipe.rating + '/5' : 'Non notée'}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="text-align: center; color: #666;">Aucune recette récente</p>'}
                    </div>

                    <!-- Analyse des temps de préparation -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">⏱️ Analyse des Temps de Préparation</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div style="background: #E8F5E8; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #28a745;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">${recipesWithTime.length}</div>
                                <div style="font-size: 0.9rem;">Avec temps défini</div>
                            </div>
                            <div style="background: #FFF3CD; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #ffc107;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #ffc107;">${avgPrepTime}</div>
                                <div style="font-size: 0.9rem;">Minutes moyennes</div>
                            </div>
                            <div style="background: #F8D7DA; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #dc3545;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #dc3545;">${totalRecipes - recipesWithTime.length}</div>
                                <div style="font-size: 0.9rem;">Sans temps défini</div>
                            </div>
                        </div>
                    </div>

                    <!-- Suggestions intelligentes -->
                    <div style="background: #E3F2FD; padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #2196F3; margin-bottom: 1rem;">
                        <h4 style="color: #0D47A1; margin-bottom: 1rem;">💡 Suggestions d'Amélioration</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            ${totalRecipes === 0 ? `
                                <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px;">
                                    <strong>🎯 Commencez par créer votre première recette !</strong>
                                    <p style="margin-top: 0.5rem; font-size: 0.9rem;">Utilisez l'onglet "Nouvelle Recette" pour commencer votre collection.</p>
                                </div>
                            ` : `
                                ${testedCount === 0 ? `
                                    <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px;">
                                        <strong>🧪 Testez vos recettes !</strong>
                                        <p style="margin-top: 0.5rem; font-size: 0.9rem;">Marquez vos recettes comme "testées" pour obtenir des statistiques de réussite.</p>
                                    </div>
                                ` : ''}
                                ${recipesWithTime.length < totalRecipes * 0.5 ? `
                                    <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px;">
                                        <strong>⏱️ Ajoutez des temps de préparation</strong>
                                        <p style="margin-top: 0.5rem; font-size: 0.9rem;">Définissez les temps de préparation pour mieux planifier vos sessions de boulangerie.</p>
                                    </div>
                                ` : ''}
                                ${favoriteCount < testedCount * 0.3 ? `
                                    <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px;">
                                        <strong>⭐ Notez vos recettes</strong>
                                        <p style="margin-top: 0.5rem; font-size: 0.9rem;">Attribuez des notes à vos recettes pour identifier vos préférences.</p>
                                    </div>
                                ` : ''}
                            `}
                        </div>
                    </div>

                    <!-- Boutons d'action -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <button class="btn" onclick="showAdvancedStats()" style="background: linear-gradient(135deg, #4CAF50, #45a049);">
                            📊 Statistiques Avancées
                        </button>
                        <button class="btn" onclick="getAISuggestions()" style="background: linear-gradient(135deg, #2196F3, #1976D2);">
                            🤖 Suggestions IA
                        </button>
                        <button class="btn" onclick="exportRecipeStats()" style="background: linear-gradient(135deg, #FF9800, #F57C00);">
                            📤 Exporter Données
                        </button>
                    </div>
                </div>
                
                <div class="btn-group mt-2" style="justify-content: center;">
                    <button class="btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            `);
        }

        function showAdvancedStats() {
            const allRecipes = Object.values(currentData.recipes).flat();
            
            // Statistiques temporelles
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            
            const recipesThisMonth = allRecipes.filter(r => {
                const date = new Date(r.dateCreated || Date.now());
                return date.getMonth() === thisMonth && date.getFullYear() === thisYear;
            }).length;
            
            const recipesThisWeek = allRecipes.filter(r => {
                const date = new Date(r.lastModified || r.dateCreated || Date.now());
                const diffDays = (now - date) / (1000 * 60 * 60 * 24);
                return diffDays <= 7;
            }).length;
            
            // Analyse des ingrédients les plus utilisés
            const ingredientUsage = {};
            allRecipes.forEach(recipe => {
                if (recipe.ingredients) {
                    recipe.ingredients.forEach(ing => {
                        const name = ing.name.toLowerCase();
                        ingredientUsage[name] = (ingredientUsage[name] || 0) + 1;
                    });
                }
            });
            
            const topIngredients = Object.entries(ingredientUsage)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            // Analyse des difficultés
            const difficultyStats = {};
            allRecipes.forEach(recipe => {
                const difficulty = recipe.difficulty || 'Non définie';
                difficultyStats[difficulty] = (difficultyStats[difficulty] || 0) + 1;
            });
            
            // Analyse des notes détaillées
            const ratingDistribution = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0};
            allRecipes.forEach(recipe => {
                if (recipe.rating && recipe.rating >= 1 && recipe.rating <= 5) {
                    ratingDistribution[recipe.rating]++;
                }
            });
            
            showModal('📊 Statistiques Avancées Détaillées', `
                <div style="max-height: 80vh; overflow-y: auto;">
                    <!-- Statistiques temporelles -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">📅 Évolution Temporelle</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div style="background: #E8F5E8; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #28a745;">
                                <div style="font-size: 2rem; font-weight: bold; color: #28a745;">${recipesThisMonth}</div>
                                <div style="font-size: 0.9rem;">Ce mois</div>
                            </div>
                            <div style="background: #FFF3CD; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #ffc107;">
                                <div style="font-size: 2rem; font-weight: bold; color: #ffc107;">${recipesThisWeek}</div>
                                <div style="font-size: 0.9rem;">Cette semaine</div>
                            </div>
                            <div style="background: #E3F2FD; padding: 1rem; border-radius: 8px; text-align: center; border: 2px solid #2196F3;">
                                <div style="font-size: 2rem; font-weight: bold; color: #2196F3;">${allRecipes.length}</div>
                                <div style="font-size: 0.9rem;">Total</div>
                            </div>
                        </div>
                    </div>

                    <!-- Distribution des notes -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">⭐ Distribution des Notes</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            ${Object.entries(ratingDistribution).map(([rating, count]) => `
                                <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <div style="font-size: 1.2rem;">${'⭐'.repeat(parseInt(rating))}</div>
                                        <div style="font-weight: bold;">Note ${rating}</div>
                                    </div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #D2691E;">${count}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Ingrédients les plus populaires -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">🥖 Ingrédients les Plus Utilisés</h4>
                        ${topIngredients.length > 0 ? `
                            <div style="display: grid; gap: 0.5rem;">
                                ${topIngredients.map(([ingredient, count], index) => `
                                    <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid ${index < 3 ? '#FFD700' : '#D2691E'};">
                                        <div style="display: flex; align-items: center; gap: 1rem;">
                                            <div style="font-size: 1.2rem; font-weight: bold; color: ${index < 3 ? '#FFD700' : '#D2691E'};">#${index + 1}</div>
                                            <div style="font-weight: bold; text-transform: capitalize;">${ingredient}</div>
                                        </div>
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #D2691E;">${count} recettes</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="text-align: center; color: #666;">Aucun ingrédient enregistré</p>'}
                    </div>

                    <!-- Analyse des difficultés -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">🎯 Répartition par Difficulté</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            ${Object.entries(difficultyStats).map(([difficulty, count]) => `
                                <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-weight: bold;">${difficulty}</div>
                                    <div style="font-size: 1.2rem; font-weight: bold; color: #D2691E;">${count}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Objectifs et recommandations -->
                    <div style="background: #E8F5E8; padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #28a745; margin-bottom: 1rem;">
                        <h4 style="color: #155724; margin-bottom: 1rem;">🎯 Recommandations Personnalisées</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            ${recipesThisMonth < 2 ? `
                                <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px;">
                                    <strong>📝 Créativité :</strong> Créez au moins 2 nouvelles recettes ce mois pour enrichir votre collection.
                                </div>
                            ` : ''}
                            ${Object.values(ratingDistribution).reduce((a, b) => a + b, 0) < allRecipes.length * 0.5 ? `
                                <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px;">
                                    <strong>⭐ Évaluation :</strong> Notez plus de recettes pour mieux comprendre vos préférences.
                                </div>
                            ` : ''}
                            ${topIngredients.length > 0 && topIngredients[0][1] > 5 ? `
                                <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px;">
                                    <strong>🔄 Diversité :</strong> Essayez de varier vos ingrédients. "${topIngredients[0][0]}" est très utilisé.
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
                
                <div class="btn-group mt-2" style="justify-content: center;">
                    <button class="btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            `);
        }

        function getAISuggestions() {
            const allRecipes = Object.values(currentData.recipes).flat();
            const favoriteRecipes = allRecipes.filter(r => r.rating >= 4);
            const testedRecipes = allRecipes.filter(r => r.status === 'testee');
            
            // Analyser les préférences
            const familyPreferences = {};
            favoriteRecipes.forEach(recipe => {
                const family = recipe.family || 'Autre';
                familyPreferences[family] = (familyPreferences[family] || 0) + 1;
            });
            
            // Trouver les ingrédients préférés
            const favoriteIngredients = {};
            favoriteRecipes.forEach(recipe => {
                if (recipe.ingredients) {
                    recipe.ingredients.forEach(ing => {
                        const name = ing.name.toLowerCase();
                        favoriteIngredients[name] = (favoriteIngredients[name] || 0) + 1;
                    });
                }
            });
            
            const topFavoriteIngredients = Object.entries(favoriteIngredients)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            // Générer des suggestions personnalisées
            const suggestions = [];
            const tips = [];
            
            if (favoriteRecipes.length > 0) {
                const topFamily = Object.entries(familyPreferences)
                    .sort(([,a], [,b]) => b - a)[0];
                
                if (topFamily) {
                    suggestions.push(`Explorez plus de recettes de ${getFamilyDisplayName(topFamily[0])} - vous semblez apprécier cette famille !`);
                }
                
                if (topFavoriteIngredients.length > 0) {
                    suggestions.push(`Intégrez "${topFavoriteIngredients[0][0]}" dans de nouvelles recettes - c'est votre ingrédient préféré !`);
                }
            }
            
            if (testedRecipes.length < allRecipes.length * 0.3) {
                suggestions.push('Testez plus de recettes pour découvrir de nouveaux favoris !');
            }
            
            // Conseils techniques
            const avgRating = allRecipes.length > 0 ? 
                allRecipes.reduce((sum, r) => sum + (r.rating || 0), 0) / allRecipes.length : 0;
            
            if (avgRating < 3) {
                tips.push('Concentrez-vous sur les techniques de base pour améliorer vos résultats');
            } else if (avgRating >= 4) {
                tips.push('Vous maîtrisez bien les bases ! Essayez des recettes plus complexes');
            }
            
            if (allRecipes.filter(r => r.difficulty === 'Facile').length > allRecipes.length * 0.7) {
                tips.push('Osez les recettes de difficulté moyenne pour progresser');
            }
            
            showModal('🎯 Suggestions IA Intelligentes', `
                <div style="max-height: 80vh; overflow-y: auto;">
                    <!-- Analyse des préférences -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">🤖 Analyse de vos Préférences</h4>
                        ${favoriteRecipes.length > 0 ? `
                            <div style="display: grid; gap: 1rem;">
                                <div style="background: #E8F5E8; padding: 1rem; border-radius: 8px; border: 2px solid #28a745;">
                                    <h5 style="color: #155724; margin-bottom: 0.5rem;">🏆 Familles Préférées</h5>
                                    <div style="display: grid; gap: 0.5rem;">
                                        ${Object.entries(familyPreferences)
                                            .sort(([,a], [,b]) => b - a)
                                            .slice(0, 3)
                                            .map(([family, count]) => `
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-weight: bold;">${getFamilyDisplayName(family)}</span>
                                                    <span style="color: #28a745; font-weight: bold;">${count} recettes</span>
                                                </div>
                                            `).join('')}
                                    </div>
                                </div>
                                
                                ${topFavoriteIngredients.length > 0 ? `
                                    <div style="background: #FFF3CD; padding: 1rem; border-radius: 8px; border: 2px solid #ffc107;">
                                        <h5 style="color: #856404; margin-bottom: 0.5rem;">🥖 Ingrédients Favoris</h5>
                                        <div style="display: grid; gap: 0.5rem;">
                                            ${topFavoriteIngredients.map(([ingredient, count]) => `
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <span style="font-weight: bold; text-transform: capitalize;">${ingredient}</span>
                                                    <span style="color: #ffc107; font-weight: bold;">${count} fois</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : '<p style="text-align: center; color: #666;">Notez vos recettes pour obtenir des suggestions personnalisées</p>'}
                    </div>

                    <!-- Suggestions personnalisées -->
                    <div style="background: #E3F2FD; padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #2196F3; margin-bottom: 1rem;">
                        <h4 style="color: #0D47A1; margin-bottom: 1rem;">💡 Suggestions Personnalisées</h4>
                        ${suggestions.length > 0 ? `
                            <div style="display: grid; gap: 0.5rem;">
                                ${suggestions.map(suggestion => `
                                    <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px;">
                                        <div style="font-weight: bold; color: #0D47A1;">🎯</div>
                                        <div style="margin-top: 0.5rem;">${suggestion}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="text-align: center; color: #666;">Continuez sur votre lancée !</p>'}
                    </div>

                    <!-- Conseils techniques -->
                    <div style="background: #F3E5F5; padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #9C27B0; margin-bottom: 1rem;">
                        <h4 style="color: #4A148C; margin-bottom: 1rem;">👨‍🍳 Conseils Techniques</h4>
                        ${tips.length > 0 ? `
                            <div style="display: grid; gap: 0.5rem;">
                                ${tips.map(tip => `
                                    <div style="background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 8px;">
                                        <div style="font-weight: bold; color: #4A148C;">💡</div>
                                        <div style="margin-top: 0.5rem;">${tip}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p style="text-align: center; color: #666;">Vos techniques sont excellentes !</p>'}
                    </div>

                    <!-- Recettes recommandées -->
                    <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: #D2691E; margin-bottom: 1rem;">🥖 Recettes Recommandées</h4>
                        <div style="display: grid; gap: 0.5rem;">
                            <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
                                <div style="font-weight: bold; color: #28a745;">Pain de campagne aux noix</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Basé sur vos préférences pour les pains rustiques</div>
                            </div>
                            <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <div style="font-weight: bold; color: #ffc107;">Brioche tressée</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Pour développer vos compétences en tressage</div>
                            </div>
                            <div style="background: #F8F9FA; padding: 1rem; border-radius: 8px; border-left: 4px solid #2196F3;">
                                <div style="font-weight: bold; color: #2196F3;">Focaccia aux herbes</div>
                                <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">Une variante savoureuse de vos recettes préférées</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="btn-group mt-2" style="justify-content: center;">
                    <button class="btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            `);
        }

        function exportRecipeStats() {
            const allRecipes = Object.values(currentData.recipes).flat();
            const exportData = {
                exportDate: new Date().toISOString(),
                totalRecipes: allRecipes.length,
                recipes: allRecipes.map(recipe => ({
                    name: recipe.name,
                    family: recipe.family,
                    rating: recipe.rating,
                    status: recipe.status,
                    difficulty: recipe.difficulty,
                    preparationTime: recipe.preparationTime,
                    dateCreated: recipe.dateCreated,
                    lastModified: recipe.lastModified,
                    ingredients: recipe.ingredients,
                    steps: recipe.steps
                })),
                statistics: {
                    testedRecipes: allRecipes.filter(r => r.status === 'testee').length,
                    favoriteRecipes: allRecipes.filter(r => r.rating >= 4).length,
                    averageRating: allRecipes.length > 0 ? 
                        (allRecipes.reduce((sum, r) => sum + (r.rating || 0), 0) / allRecipes.length).toFixed(2) : '0.00'
                }
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `boulangerie_stats_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showAlert('📤 Données exportées avec succès !', 'success');
        }

        function syncData() {
            showModal('🔄 Synchronisation', `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h3 style="color: #D2691E;">Synchronisation BETA</h3>
                    <div style="font-size: 2rem; margin: 1rem 0;">🔄</div>
                </div>
                
                <div style="background: var(--cream-white); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                    <h4 style="color: #D2691E; margin-bottom: 1rem;">⚠️ Fonctionnalité en développement</h4>
                    <p>La synchronisation entre appareils sera bientôt disponible !</p>
                    <p>Pour l'instant, utilisez l'export/import pour transférer vos données.</p>
                </div>

                <div style="background: #FFF3CD; padding: 1rem; border-radius: var(--border-radius); border: 2px solid #FFC107;">
                    <h4 style="color: #856404;">📱 Prochainement</h4>
                    <ul style="color: #856404; text-align: left;">
                        <li>Synchronisation automatique</li>
                        <li>Partage de recettes</li>
                        <li>Backup cloud</li>
                    </ul>
                </div>
                
                <div class="btn-group mt-2" style="justify-content: center;">
                    <button class="btn" onclick="exportData()" style="background: #D2691E;">📤 Exporter maintenant</button>
                    <button class="btn-secondary" onclick="closeModal()">Fermer</button>
                </div>
            `);
        }

        // Fonctions pour les tooltips du graphique
        function showTooltip(event, familyName, count, percentage, recipeNames) {
            const tooltip = document.getElementById('chartTooltip');
            if (!tooltip) return;
            
            const title = document.getElementById('tooltipTitle');
            const countDiv = document.getElementById('tooltipCount');
            const recipesDiv = document.getElementById('tooltipRecipes');
            
            if (title) title.textContent = familyName;
            if (countDiv) countDiv.textContent = `${count} recette${count > 1 ? 's' : ''} (${percentage}%)`;
            if (recipesDiv) {
                if (recipeNames && recipeNames.trim()) {
                    recipesDiv.textContent = `Recettes : ${recipeNames}`;
                } else {
                    recipesDiv.textContent = 'Aucune recette détaillée';
                }
            }
            
            // Positionner le tooltip
            const rect = event.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = event.clientX + 10;
            let top = event.clientY - tooltipRect.height - 10;
            
            // Ajuster si le tooltip sort de l'écran
            if (left + tooltipRect.width > window.innerWidth) {
                left = event.clientX - tooltipRect.width - 10;
            }
            if (top < 0) {
                top = event.clientY + 10;
            }
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
            tooltip.style.display = 'block';
        }

        function hideTooltip() {
            const tooltip = document.getElementById('chartTooltip');
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        // Amélioration de l'interactivité du graphique
        function enhanceChartInteractivity() {
            // Ajouter des événements de clic pour naviguer vers les familles
            document.querySelectorAll('.bar-group').forEach(group => {
                group.addEventListener('click', function() {
                    const family = this.getAttribute('data-family');
                    if (family) {
                        // Fermer la modale et naviguer vers la famille
                        closeModal();
                        showPage(family);
                        // Activer le bon onglet
                        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                        const tabBtn = document.querySelector(`[data-tab="${family}"]`);
                        if (tabBtn) tabBtn.classList.add('active');
                    }
                });
            });
        }

        // Fonction pour améliorer l'apparence du graphique au chargement
        function initializeChartEnhancements() {
            // Ajouter des animations d'apparition pour les barres
            setTimeout(() => {
                const bars = document.querySelectorAll('.bar-rect');
                bars.forEach((bar, index) => {
                    bar.style.opacity = '0';
                    bar.style.transform = 'scale(0.8)';
                    
                    setTimeout(() => {
                        bar.style.transition = 'all 0.6s ease';
                        bar.style.opacity = '1';
                        bar.style.transform = 'scale(1)';
                    }, index * 100);
                });
            }, 100);
        }

        // Animation de bulles pour l'indicateur de levain de la page d'accueil
        function setupLevainStatBubbleAnimation() {
            const levainStatCard = document.querySelector('.levain-stat-card');
            if (!levainStatCard) return;

            // Nettoyer les bulles existantes
            const existingBubbles = levainStatCard.querySelectorAll('.bubble');
            existingBubbles.forEach(bubble => bubble.remove());

            // Trouver le levain le moins frais (le plus ancien)
            let oldestDaysSinceRefresh = 0;
            if (currentData.levains.length > 0) {
                currentData.levains.forEach(levain => {
                    if (levain.lastRefresh) {
                        const daysSince = Math.floor((Date.now() - new Date(levain.lastRefresh).getTime()) / (1000 * 60 * 60 * 24));
                        if (daysSince > oldestDaysSinceRefresh) {
                            oldestDaysSinceRefresh = daysSince;
                        }
                    } else {
                        // Si jamais rafraîchi, considérer comme très ancien
                        oldestDaysSinceRefresh = Math.max(oldestDaysSinceRefresh, 999);
                    }
                });
            }

            // Définir les paramètres selon le levain le moins frais
            let bubbleCount, interval;
            if (oldestDaysSinceRefresh <= 10) {
                // 0-10 jours : beaucoup de bulles
                bubbleCount = 12;
                interval = 250; // 250ms entre chaque bulle
            } else if (oldestDaysSinceRefresh <= 20) {
                // 11-20 jours : bulles moyennes
                bubbleCount = 8;
                interval = 400; // 400ms entre chaque bulle
            } else {
                // Plus de 20 jours : très peu de bulles
                bubbleCount = 3;
                interval = 1000; // 1000ms entre chaque bulle
            }

            // Créer une animation en boucle permanente
            createContinuousBubbles(levainStatCard, bubbleCount, interval);
        }

        // ===== FONCTIONS DE RECONNAISSANCE VOCALE =====
        
        // Variables globales pour la reconnaissance vocale
        let recognition = null;
        let isRecording = false;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let dataArray = null;
        let animationId = null;
        let audioRecipeData = {
            name: '',
            rating: null,
            ingredients: [],
            currentStep: 'name' // 'name', 'rating', 'ingredients', 'finished'
        };

        // Initialiser la reconnaissance vocale
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('La reconnaissance vocale n\'est pas supportée par votre navigateur. Veuillez utiliser Chrome ou Edge.');
                return false;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'fr-FR';
            
            recognition.onstart = function() {
                updateAudioStatus('listening', '🎤 Écoute en cours... Parlez maintenant !');
            };
            
            recognition.onresult = function(event) {
                let finalTranscript = '';
                let interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                updateTranscriptDisplay(finalTranscript, interimTranscript);
                
                if (finalTranscript) {
                    processAudioInput(finalTranscript);
                }
            };
            
            recognition.onerror = function(event) {
                console.error('Erreur de reconnaissance vocale:', event.error);
                isRecording = false;
                updateAudioStatus('error', `❌ Erreur: ${event.error}`);
                stopVolumeAnalysis();
            };
            
            recognition.onend = function() {
                console.log('Reconnaissance vocale terminée, isRecording:', isRecording);
                if (isRecording) {
                    // Redémarrer automatiquement seulement si on était en train d'enregistrer
                    setTimeout(() => {
                        if (isRecording) {
                            console.log('Redémarrage automatique de la reconnaissance vocale');
                            recognition.start();
                        }
                    }, 100);
                } else {
                    updateAudioStatus('processing', '🔄 Enregistrement arrêté');
                }
            };
            
            return true;
        }

        // Ouvrir la modale de saisie vocale
        function openAudioRecipeModal(family) {
            if (!initSpeechRecognition()) {
                return;
            }
            
            // Réinitialiser les données
            audioRecipeData = {
                name: '',
                rating: null,
                ingredients: [],
                procedure: '',
                currentStep: 'name',
                family: family
            };
            
            showModal('🎤 Saisie Vocale de Recette', `
                <div class="audio-instructions">
                    <h4>📋 Instructions de saisie vocale</h4>
                    <ul>
                        <li><strong>Nom de la recette :</strong> "Nom de la recette" ou "Appelle cette recette [nom]"</li>
                        <li><strong>Note (optionnelle) :</strong> "Note 4" ou "Donne une note de 3"</li>
                        <li><strong>Ingrédients :</strong> "500 grammes de farine", "2 œufs", "100 millilitres d'huile", "de l'eau", "du beurre"</li>
                        <li><strong>Procédé :</strong> Dites "procédé" puis les étapes. Utilisez "à la ligne", "virgule", "point", "ouvrir/fermer la parenthèse", "ensuite" pour formater</li>
                        <li><strong>Arrêter l'enregistrement :</strong> "C'est fini", "Fini", "Stop", "Arrêter" ou "Terminer"</li>
                    </ul>
                </div>
                
                <div class="audio-controls">
                    <button class="audio-recording" id="recordButton" onclick="toggleRecording()">
                        🎤 Commencer l'enregistrement
                    </button>
                    <button class="btn-secondary" onclick="testMicrophone()" style="margin-left: 1rem;">
                        🔍 Tester le microphone
                    </button>
                </div>
                
                <div class="volume-indicator" id="volumeIndicator" style="display: none;">
                    <span class="volume-icon">🎤</span>
                    <div class="volume-bar">
                        <div class="volume-fill" id="volumeFill"></div>
                    </div>
                    <span class="volume-text" id="volumeText">0%</span>
                </div>
                
                <div class="audio-debug" id="audioDebug" style="display: none; background: #f5f5f5; padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; font-size: 0.8rem; font-family: monospace;">
                    <div>Debug: <span id="debugInfo">En attente...</span></div>
                </div>
                
                <div class="audio-status" id="audioStatus">
                    Prêt à écouter
                </div>
                
                <div class="transcript-display" id="transcriptDisplay">
                    En attente de parole...
                </div>
                
                <div class="ingredient-preview" id="ingredientPreview" style="display: none;">
                    <h4>📝 Aperçu des ingrédients détectés</h4>
                    <div id="ingredientList"></div>
                </div>
                
                <div class="procedure-preview" id="procedurePreview" style="display: none;">
                    <h4>📋 Aperçu du procédé</h4>
                    <div id="procedureText" style="background: #f9f9f9; padding: 1rem; border-radius: 4px; white-space: pre-line; font-family: monospace; max-height: 200px; overflow-y: auto;"></div>
                </div>
                
                <div class="btn-group" style="justify-content: center; margin-top: 2rem;">
                    <button class="btn-secondary" onclick="closeModal()">❌ Annuler</button>
                    <button class="btn" onclick="saveAudioRecipe()" id="saveButton" disabled style="opacity: 0.6; cursor: not-allowed;">💾 Enregistrer la recette</button>
                </div>
            `);
        }

        // Basculer l'enregistrement
        function toggleRecording() {
            const recordButton = document.getElementById('recordButton');
            
            console.log('Toggle recording, état actuel:', isRecording);
            
            if (!isRecording) {
                // Commencer l'enregistrement
                console.log('Démarrage de l\'enregistrement');
                startRecording();
                recordButton.textContent = '⏹️ Arrêter l\'enregistrement';
                recordButton.classList.add('recording');
            } else {
                // Arrêter l'enregistrement
                console.log('Arrêt de l\'enregistrement');
                stopRecording();
                recordButton.textContent = '🎤 Recommencer l\'enregistrement';
                recordButton.classList.remove('recording');
            }
        }

        // Commencer l'enregistrement
        function startRecording() {
            try {
                console.log('Démarrage de la reconnaissance vocale');
                
                // Marquer le début de l'enregistrement
                isRecording = true;
                
                // Démarrer la reconnaissance vocale
                recognition.start();
                
                // Démarrer l'analyse du volume
                startVolumeAnalysis();
                
                // Afficher l'indicateur de volume et le debug
                const volumeIndicator = document.getElementById('volumeIndicator');
                const audioDebug = document.getElementById('audioDebug');
                
                if (volumeIndicator) {
                    volumeIndicator.style.display = 'flex';
                }
                
                if (audioDebug) {
                    audioDebug.style.display = 'block';
                }
                
                console.log('Enregistrement démarré avec succès');
            } catch (error) {
                console.error('Erreur lors du démarrage de l\'enregistrement:', error);
                updateAudioStatus('error', '❌ Erreur lors du démarrage de l\'enregistrement');
                isRecording = false;
            }
        }

        // Arrêter l'enregistrement
        function stopRecording() {
            try {
                // Marquer l'arrêt pour éviter le redémarrage automatique
                isRecording = false;
                
                // Arrêter la reconnaissance vocale
                if (recognition) {
                    recognition.stop();
                }
                
                // Arrêter l'analyse du volume
                stopVolumeAnalysis();
                
                // Masquer l'indicateur de volume et le debug
                const volumeIndicator = document.getElementById('volumeIndicator');
                const audioDebug = document.getElementById('audioDebug');
                
                if (volumeIndicator) {
                    volumeIndicator.style.display = 'none';
                }
                
                if (audioDebug) {
                    audioDebug.style.display = 'none';
                }
                
                // Mettre à jour le statut
                updateAudioStatus('processing', '🔄 Enregistrement arrêté');
                
                console.log('Enregistrement arrêté avec succès');
            } catch (error) {
                console.error('Erreur lors de l\'arrêt de l\'enregistrement:', error);
                updateAudioStatus('error', '❌ Erreur lors de l\'arrêt de l\'enregistrement');
                
                // Forcer l'arrêt même en cas d'erreur
                isRecording = false;
                stopVolumeAnalysis();
            }
        }

        // Démarrer l'analyse du volume
        async function startVolumeAnalysis() {
            try {
                console.log('Démarrage de l\'analyse du volume');
                
                // Obtenir la liste des périphériques audio
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                
                console.log('Périphériques audio détectés:', audioInputs);
                
                // Constraintes audio améliorées pour les casques Bluetooth
                const audioConstraints = {
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100,
                        channelCount: 1
                    }
                };
                
                // Demander l'accès au microphone
                const stream = await navigator.mediaDevices.getUserMedia(audioConstraints);
                
                console.log('Flux audio obtenu:', stream);
                
                // Créer le contexte audio
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                
                // Configurer l'analyseur pour les casques Bluetooth
                analyser.fftSize = 1024; // Plus de précision
                analyser.smoothingTimeConstant = 0.6; // Moins de lissage pour plus de réactivité
                analyser.minDecibels = -100; // Détection des sons très faibles
                analyser.maxDecibels = -20; // Évite la saturation
                
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                // Connecter le microphone à l'analyseur
                microphone.connect(analyser);
                
                console.log('Analyseur configuré avec succès');
                
                // Démarrer l'animation de l'indicateur de volume
                updateVolumeIndicator();
                
            } catch (error) {
                console.error('Erreur lors de l\'accès au microphone:', error);
                
                // Messages d'erreur plus spécifiques
                let errorMessage = '❌ Impossible d\'accéder au microphone';
                if (error.name === 'NotAllowedError') {
                    errorMessage = '❌ Accès au microphone refusé. Veuillez autoriser l\'accès au microphone.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = '❌ Aucun microphone détecté. Vérifiez votre casque Bluetooth.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = '❌ Microphone déjà utilisé par une autre application.';
                }
                
                updateAudioStatus('error', errorMessage);
            }
        }

        // Arrêter l'analyse du volume
        function stopVolumeAnalysis() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            if (microphone && microphone.mediaStream) {
                microphone.mediaStream.getTracks().forEach(track => track.stop());
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            analyser = null;
            microphone = null;
            dataArray = null;
        }

        // Mettre à jour l'indicateur de volume
        function updateVolumeIndicator() {
            if (!analyser || !dataArray) return;
            
            analyser.getByteFrequencyData(dataArray);
            
            // Calculer le volume avec une meilleure sensibilité pour les casques Bluetooth
            let sum = 0;
            let maxValue = 0;
            let activeSamples = 0;
            
            for (let i = 0; i < dataArray.length; i++) {
                const value = dataArray[i];
                sum += value;
                if (value > maxValue) {
                    maxValue = value;
                }
                if (value > 5) { // Seuil plus bas pour les casques Bluetooth
                    activeSamples++;
                }
            }
            
            const average = sum / dataArray.length;
            
            // Algorithme optimisé pour les casques Bluetooth
            let volumePercent;
            if (activeSamples > 0) {
                // Algorithme plus sensible pour les casques Bluetooth
                const normalizedAverage = average / 255;
                const normalizedMax = maxValue / 255;
                
                // Pondération plus importante pour le maximum (casques Bluetooth)
                volumePercent = Math.min(100, Math.round(((normalizedAverage * 0.4 + normalizedMax * 0.6) * 100)));
            } else {
                // Si pas d'activité détectée, utiliser une valeur minimale
                volumePercent = Math.min(100, Math.round((average / 255) * 100));
            }
            
            // Seuil plus bas pour les casques Bluetooth
            if (volumePercent < 2) {
                volumePercent = 0;
            }
            
            // Mettre à jour l'affichage
            const volumeFill = document.getElementById('volumeFill');
            const volumeText = document.getElementById('volumeText');
            
            if (volumeFill) {
                volumeFill.style.width = volumePercent + '%';
                
                // Changer la couleur selon le niveau
                if (volumePercent > 50) {
                    volumeFill.style.background = 'linear-gradient(90deg, #4CAF50, #66BB6A, #81C784)';
                } else if (volumePercent > 20) {
                    volumeFill.style.background = 'linear-gradient(90deg, #FF9800, #FFB74D, #FFCC80)';
                } else {
                    volumeFill.style.background = 'linear-gradient(90deg, #F44336, #EF5350, #E57373)';
                }
            }
            
            if (volumeText) {
                volumeText.textContent = volumePercent + '%';
            }
            
            // Debug: afficher les valeurs en temps réel
            const debugInfo = document.getElementById('debugInfo');
            const audioDebug = document.getElementById('audioDebug');
            
            if (debugInfo && audioDebug) {
                debugInfo.textContent = `Vol: ${volumePercent}% | Moy: ${Math.round(average)} | Max: ${maxValue} | Actifs: ${activeSamples}`;
                audioDebug.style.display = 'block';
            }
            
            // Debug dans la console aussi
            if (volumePercent > 0) {
                console.log('Volume détecté:', volumePercent + '%, Moyenne:', average, 'Max:', maxValue, 'Actifs:', activeSamples);
            }
            
            // Continuer l'animation
            animationId = requestAnimationFrame(updateVolumeIndicator);
        }

        // Mettre à jour le statut audio
        function updateAudioStatus(type, message) {
            const statusElement = document.getElementById('audioStatus');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.className = `audio-status ${type}`;
            }
        }

        // Mettre à jour l'affichage de la transcription
        function updateTranscriptDisplay(final, interim) {
            const display = document.getElementById('transcriptDisplay');
            if (display) {
                let content = '';
                if (final) content += `<strong>Reconnu :</strong> ${final}<br><br>`;
                if (interim) content += `<em>En cours :</em> ${interim}`;
                display.innerHTML = content;
            }
        }

        // Traiter l'entrée vocale
        function processAudioInput(text) {
            const lowerText = text.toLowerCase().trim();
            
            // Vérifier d'abord si c'est un mot d'arrêt global
            if (isStopCommand(lowerText)) {
                handleStopCommand();
                return;
            }
            
            switch (audioRecipeData.currentStep) {
                case 'name':
                    processRecipeName(lowerText);
                    break;
                case 'rating':
                    processRecipeRating(lowerText);
                    break;
                case 'ingredients':
                    processIngredient(lowerText);
                    break;
                case 'procedure':
                    processProcedure(lowerText);
                    break;
            }
        }

        // Vérifier si c'est un mot d'arrêt
        function isStopCommand(text) {
            const stopWords = ['c\'est fini', 'terminé', 'fini', 'fin', 'stop', 'arrêter', 'terminer', 'arrêt', 'finir'];
            return stopWords.some(word => text.includes(word));
        }

        // Gérer l'arrêt de l'enregistrement
        function handleStopCommand() {
            audioRecipeData.currentStep = 'finished';
            updateAudioStatus('listening', '✅ Arrêt de l\'enregistrement...');
            
            console.log('Arrêt de l\'enregistrement demandé');
            
            // Arrêter automatiquement l'enregistrement
            setTimeout(() => {
                stopRecording();
                
                // Mettre à jour le bouton d'enregistrement
                const recordButton = document.getElementById('recordButton');
                if (recordButton) {
                    recordButton.textContent = '🎤 Recommencer l\'enregistrement';
                    recordButton.classList.remove('recording');
                }
                
                // Vérifier et activer le bouton de sauvegarde
                checkAndEnableSaveButton();
                
                updateAudioStatus('processing', '✅ Enregistrement arrêté. Cliquez sur "Enregistrer la recette".');
            }, 1000);
        }

        // Traiter le nom de la recette
        function processRecipeName(text) {
            // Patterns pour détecter le nom de la recette
            const namePatterns = [
                /appelle cette recette (.+)/i,
                /nom de la recette (.+)/i,
                /nom (.+)/i,
                /recette (.+)/i
            ];
            
            for (const pattern of namePatterns) {
                const match = text.match(pattern);
                if (match) {
                    audioRecipeData.name = match[1].trim();
                    audioRecipeData.currentStep = 'rating';
                    updateAudioStatus('listening', `✅ Nom enregistré : "${audioRecipeData.name}". Dites maintenant la note (1 à 5) ou "pas de note".`);
                    return;
                }
            }
            
            // Si pas de pattern spécifique, prendre tout le texte comme nom
            if (text.length > 2) {
                audioRecipeData.name = text;
                audioRecipeData.currentStep = 'rating';
                updateAudioStatus('listening', `✅ Nom enregistré : "${audioRecipeData.name}". Dites maintenant la note (1 à 5) ou "pas de note".`);
                checkAndEnableSaveButton();
            }
        }

        // Traiter la note de la recette
        function processRecipeRating(text) {
            const ratingPatterns = [
                /note (\d)/i,
                /donne une note de (\d)/i,
                /note de (\d)/i,
                /(\d) étoiles?/i,
                /(\d) étoile/i
            ];
            
            for (const pattern of ratingPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const rating = parseInt(match[1]);
                    if (rating >= 1 && rating <= 5) {
                        audioRecipeData.rating = rating;
                        audioRecipeData.currentStep = 'ingredients';
                        updateAudioStatus('listening', `✅ Note enregistrée : ${rating}/5. Dites maintenant les ingrédients un par un.`);
                        showIngredientPreview();
                        return;
                    }
                }
            }
            
            // Si on dit "pas de note" ou similaire
            if (text.includes('pas de note') || text.includes('aucune note') || text.includes('sans note')) {
                audioRecipeData.rating = null;
                audioRecipeData.currentStep = 'ingredients';
                updateAudioStatus('listening', '✅ Aucune note. Dites maintenant les ingrédients un par un.');
                showIngredientPreview();
                return;
            }
            
            // Si on dit directement des ingrédients, passer à cette étape
            if (isIngredientText(text)) {
                audioRecipeData.currentStep = 'ingredients';
                showIngredientPreview();
                processIngredient(text);
            }
        }

        // Traiter un ingrédient
        function processIngredient(text) {
            // Vérifier si l'utilisateur veut passer au procédé
            if (text.includes('procédé') || text.includes('procedure') || text.includes('étapes') || text.includes('etapes')) {
                audioRecipeData.currentStep = 'procedure';
                updateAudioStatus('listening', '✅ Passage au procédé. Dites maintenant les étapes de préparation. Utilisez "à la ligne", "virgule" ou "ensuite" pour formater.');
                showProcedurePreview();
                return;
            }
            
            // Parser l'ingrédient
            const ingredient = parseIngredient(text);
            if (ingredient) {
                audioRecipeData.ingredients.push(ingredient);
                updateIngredientPreview();
                updateAudioStatus('listening', `✅ Ingrédient ajouté : ${ingredient.name} ${ingredient.quantity} ${ingredient.unit}. Dites le suivant ou "procédé" pour passer aux étapes.`);
                checkAndEnableSaveButton();
            }
        }

        // Traiter le procédé
        function processProcedure(text) {
            // Commandes de formatage
            if (text.includes('à la ligne') || text.includes('sauter une ligne') || text.includes('nouvelle ligne')) {
                audioRecipeData.procedure += '\n';
                updateAudioStatus('listening', '✅ Ligne ajoutée. Continuez le procédé...');
                updateProcedurePreview();
                return;
            }
            
            if (text.includes('virgule')) {
                audioRecipeData.procedure += ', ';
                updateAudioStatus('listening', '✅ Virgule ajoutée. Continuez le procédé...');
                updateProcedurePreview();
                return;
            }
            
            if (text.includes('point')) {
                audioRecipeData.procedure += '. ';
                updateAudioStatus('listening', '✅ Point ajouté. Continuez le procédé...');
                updateProcedurePreview();
                return;
            }
            
            if (text.includes('ouvrir la parenthèse') || text.includes('ouvrir parenthese')) {
                audioRecipeData.procedure += ' (';
                updateAudioStatus('listening', '✅ Parenthèse ouverte. Continuez le procédé...');
                updateProcedurePreview();
                return;
            }
            
            if (text.includes('fermer la parenthèse') || text.includes('fermer parenthese')) {
                audioRecipeData.procedure += ') ';
                updateAudioStatus('listening', '✅ Parenthèse fermée. Continuez le procédé...');
                updateProcedurePreview();
                return;
            }
            
            if (text.includes('ensuite')) {
                audioRecipeData.procedure += '\n';
                updateAudioStatus('listening', '✅ Nouvelle étape. Continuez le procédé...');
                updateProcedurePreview();
                return;
            }
            
            // Ajouter le texte au procédé
            if (audioRecipeData.procedure) {
                audioRecipeData.procedure += ' ' + text;
            } else {
                audioRecipeData.procedure = text;
            }
            
            updateAudioStatus('listening', `✅ Procédé mis à jour. Continuez ou dites "c'est fini" pour terminer.`);
            updateProcedurePreview();
            checkAndEnableSaveButton();
        }

        // Parser un ingrédient à partir du texte vocal
        function parseIngredient(text) {
            console.log('Parsing ingredient:', text);
            
            // Patterns pour détecter les ingrédients
            const patterns = [
                // Format: "500 grammes de farine", "500 grammes d'œuf", "500 grammes du beurre", "12.5 grammes de farine"
                /(\d+(?:\.\d+)?)\s*(grammes?|g|kilos?|kg|millilitres?|ml|centilitres?|cl|litres?|l|cuillères?|pièces?)\s*(?:de\s+|d'\s+|du\s+)?(.+)/i,
                // Format: "2 œufs", "3 œufs"
                /(\d+)\s+(œufs?|œuf|oeufs?|oeuf)\s*(.+)?/i,
                // Format: "farine 500 grammes", "farine 12.5 grammes"
                /(.+?)\s+(\d+(?:\.\d+)?)\s*(grammes?|g|kilos?|kg|millilitres?|ml|centilitres?|cl|litres?|l|cuillères?|pièces?)/i,
                // Format: "de la farine", "d'œuf", "du beurre" (sans quantité, on met 1 par défaut)
                /(?:de\s+la\s+|d'\s+|du\s+|de\s+)(.+)/i
            ];
            
            for (let i = 0; i < patterns.length; i++) {
                const pattern = patterns[i];
                const match = text.match(pattern);
                if (match) {
                    let quantity, unit, name;
                    
                    if (i === 0) {
                        // Format: "500 grammes de farine"
                        quantity = parseFloat(match[1]);
                        unit = normalizeUnit(match[2]);
                        name = match[3].trim();
                        console.log('Pattern 0 - Quantité:', match[1], 'Parsé:', quantity);
                    } else if (i === 1) {
                        // Format: "2 œufs"
                        quantity = parseInt(match[1]);
                        unit = 'pièces';
                        name = match[2].trim();
                        console.log('Pattern 1 - Quantité:', match[1], 'Parsé:', quantity);
                    } else if (i === 2) {
                        // Format: "farine 500 grammes"
                        name = match[1].trim();
                        quantity = parseFloat(match[2]);
                        unit = normalizeUnit(match[3]);
                        console.log('Pattern 2 - Quantité:', match[2], 'Parsé:', quantity);
                    } else if (i === 3) {
                        // Format: "de la farine", "d'œuf", "du beurre"
                        name = match[1].trim();
                        quantity = 1; // Quantité par défaut
                        unit = 'g'; // Unité par défaut
                        console.log('Pattern 3 - Quantité par défaut:', quantity);
                    }
                    
                    if (name && quantity && unit) {
                        console.log('Ingrédient parsé:', { name, quantity, unit });
                        
                        // Normaliser le nom de l'ingrédient selon la hiérarchie
                        const normalizedName = normalizeIngredientName(name);
                        console.log('Nom normalisé:', normalizedName);
                        
                        return {
                            name: normalizedName,
                            quantity: quantity,
                            unit: unit
                        };
                    }
                }
            }
            
            console.log('Aucun pattern trouvé pour:', text);
            return null;
        }

        // Normaliser les unités
        function normalizeUnit(unit) {
            const unitMap = {
                'grammes': 'g',
                'gramme': 'g',
                'kilos': 'kg',
                'kilo': 'kg',
                'millilitres': 'ml',
                'millilitre': 'ml',
                'centilitres': 'cl',
                'centilitre': 'cl',
                'litres': 'l',
                'litre': 'l',
                'cuillères': 'cuillères',
                'cuillère': 'cuillères',
                'pièces': 'pièces',
                'pièce': 'pièces'
            };
            
            return unitMap[unit.toLowerCase()] || unit.toLowerCase();
        }

        // Normaliser le nom de l'ingrédient selon la hiérarchie
        function normalizeIngredientName(name) {
            const hierarchy = currentData.settings.ingredientHierarchy || [];
            
            // Nettoyer le nom en enlevant les prépositions et articles
            let cleanName = name.toLowerCase()
                .replace(/^(de\s+|du\s+|d'\s+|des\s+|le\s+|la\s+|les\s+|un\s+|une\s+)/, '')
                .trim();
            
            console.log('Nom original:', name, 'Nom nettoyé:', cleanName);
            
            // Chercher une correspondance exacte dans la hiérarchie
            for (const ingredient of hierarchy) {
                const lowerIngredient = ingredient.toLowerCase();
                if (lowerIngredient === cleanName) {
                    console.log('Correspondance exacte trouvée:', ingredient);
                    return ingredient; // Garder l'orthographe exacte
                }
            }
            
            // Chercher une correspondance partielle (le nom nettoyé contient l'ingrédient ou vice versa)
            for (const ingredient of hierarchy) {
                const lowerIngredient = ingredient.toLowerCase();
                if (cleanName.includes(lowerIngredient) || lowerIngredient.includes(cleanName)) {
                    console.log('Correspondance partielle trouvée:', ingredient);
                    return ingredient; // Garder l'orthographe exacte
                }
            }
            
            // Si pas trouvé, proposer une orthographe standardisée
            const capitalizedName = cleanName.charAt(0).toUpperCase() + cleanName.slice(1).toLowerCase();
            console.log('Nouvel ingrédient proposé:', capitalizedName);
            return capitalizedName;
        }

        // Vérifier si le texte contient un ingrédient
        function isIngredientText(text) {
            const ingredientKeywords = [
                'grammes', 'g', 'kilos', 'kg', 'millilitres', 'ml', 'centilitres', 'cl', 'litres', 'l',
                'cuillères', 'pièces', 'œufs', 'œuf', 'oeufs', 'oeuf'
            ];
            
            return ingredientKeywords.some(keyword => text.toLowerCase().includes(keyword));
        }

        // Afficher l'aperçu des ingrédients
        function showIngredientPreview() {
            const preview = document.getElementById('ingredientPreview');
            if (preview) {
                preview.style.display = 'block';
            }
        }

        // Mettre à jour l'aperçu des ingrédients
        function updateIngredientPreview() {
            const list = document.getElementById('ingredientList');
            if (list) {
                list.innerHTML = audioRecipeData.ingredients.map(ingredient => `
                    <div class="ingredient-item">
                        <span class="ingredient-name">${ingredient.name}</span>
                        <span class="ingredient-quantity">${ingredient.quantity} ${ingredient.unit}</span>
                    </div>
                `).join('');
            }
        }

        // Afficher l'aperçu du procédé
        function showProcedurePreview() {
            const preview = document.getElementById('procedurePreview');
            if (preview) {
                preview.style.display = 'block';
            }
        }

        // Mettre à jour l'aperçu du procédé
        function updateProcedurePreview() {
            const text = document.getElementById('procedureText');
            if (text && audioRecipeData.procedure) {
                text.textContent = audioRecipeData.procedure;
            }
        }

        // Sauvegarder la recette audio
        function saveAudioRecipe() {
            console.log('Tentative de sauvegarde de la recette:', audioRecipeData);
            
            if (!audioRecipeData.name || audioRecipeData.name.trim() === '') {
                alert('Veuillez saisir un nom de recette.');
                return;
            }
            
            if (audioRecipeData.ingredients.length === 0) {
                alert('Veuillez saisir au moins un ingrédient.');
                return;
            }
            
            // Vérifier les nouveaux ingrédients
            const hierarchy = currentData.settings.ingredientHierarchy || [];
            const newIngredients = [];
            const existingIngredients = [];
            
            audioRecipeData.ingredients.forEach(ingredient => {
                const isExisting = hierarchy.some(h => h.toLowerCase() === ingredient.name.toLowerCase());
                if (isExisting) {
                    existingIngredients.push(ingredient);
                } else {
                    newIngredients.push(ingredient);
                }
            });
            
            // Si il y a de nouveaux ingrédients, les proposer à l'utilisateur
            if (newIngredients.length > 0) {
                const newIngredientsList = newIngredients.map(ing => `• ${ing.name}`).join('\n');
                const message = `Nouveaux ingrédients détectés :\n\n${newIngredientsList}\n\nVoulez-vous les ajouter à votre liste d'ingrédients ?`;
                
                if (confirm(message)) {
                    // Ajouter les nouveaux ingrédients à la hiérarchie
                    newIngredients.forEach(ingredient => {
                        if (!hierarchy.includes(ingredient.name)) {
                            hierarchy.push(ingredient.name);
                        }
                    });
                    
                    // Sauvegarder la hiérarchie mise à jour
                    currentData.settings.ingredientHierarchy = hierarchy;
                    saveDataToStorage();
                    
                    console.log('Nouveaux ingrédients ajoutés à la hiérarchie:', newIngredients.map(ing => ing.name));
                }
            }
            
            // Créer la recette
            const recipe = {
                name: audioRecipeData.name,
                rating: audioRecipeData.rating,
                ingredients: audioRecipeData.ingredients,
                comment: audioRecipeData.procedure || 'Recette créée par saisie vocale',
                status: 'nouvelle',
                createdDate: new Date().toISOString()
            };
            
            // Ajouter à la famille appropriée
            const family = audioRecipeData.family;
            if (!currentData.recipes[family]) {
                currentData.recipes[family] = [];
            }
            
            currentData.recipes[family].push(recipe);
            saveDataToStorage();
            
            // Nettoyer les ressources audio
            cleanupAudioResources();
            
            // Fermer la modale et rafraîchir l'affichage
            closeModal();
            renderAllRecipes();
            
            // Notification de succès
            const successMessage = newIngredients.length > 0 
                ? `✅ Recette "${recipe.name}" créée avec ${newIngredients.length} nouveau(x) ingrédient(s) !`
                : `✅ Recette "${recipe.name}" créée avec succès par saisie vocale !`;
            
            showAlert(successMessage, 'success');
            
            // Proposer de créer une autre recette
            setTimeout(() => {
                if (confirm('Voulez-vous créer une autre recette par saisie vocale ?')) {
                    openAudioRecipeModal(family);
                }
            }, 1000);
        }

        // Vérifier et activer le bouton de sauvegarde
        function checkAndEnableSaveButton() {
            const saveButton = document.getElementById('saveButton');
            if (!saveButton) return;
            
            const hasName = audioRecipeData.name && audioRecipeData.name.trim() !== '';
            const hasIngredients = audioRecipeData.ingredients.length > 0;
            const isFinished = audioRecipeData.currentStep === 'finished';
            
            if (hasName && hasIngredients && isFinished) {
                saveButton.disabled = false;
                saveButton.style.opacity = '1';
                saveButton.style.cursor = 'pointer';
                console.log('Bouton de sauvegarde activé');
            } else {
                saveButton.disabled = true;
                saveButton.style.opacity = '0.6';
                saveButton.style.cursor = 'not-allowed';
            }
        }

        // Nettoyer les ressources audio
        function cleanupAudioResources() {
            console.log('Nettoyage des ressources audio');
            
            // Arrêter l'enregistrement si actif
            if (isRecording) {
                console.log('Arrêt forcé de l\'enregistrement');
                stopRecording();
            }
            
            // Nettoyer les variables
            isRecording = false;
            audioRecipeData = {
                name: '',
                rating: null,
                ingredients: [],
                procedure: '',
                currentStep: 'name'
            };
            
            console.log('Ressources audio nettoyées');
        }

        // Tester le microphone
        async function testMicrophone() {
            try {
                console.log('Test du microphone...');
                updateAudioStatus('processing', '🔍 Test du microphone en cours...');
                
                // Obtenir la liste des périphériques
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                
                let deviceInfo = '📱 Périphériques audio détectés:\n\n';
                audioInputs.forEach((device, index) => {
                    deviceInfo += `${index + 1}. ${device.label || 'Microphone inconnu'}\n`;
                    deviceInfo += `   ID: ${device.deviceId}\n`;
                    deviceInfo += `   Groupe: ${device.groupId}\n\n`;
                });
                
                // Tester l'accès au microphone
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                deviceInfo += '✅ Accès au microphone réussi!\n';
                deviceInfo += `📊 Tracks audio: ${stream.getAudioTracks().length}\n`;
                
                stream.getAudioTracks().forEach((track, index) => {
                    deviceInfo += `   Track ${index + 1}: ${track.label}\n`;
                    deviceInfo += `   Actif: ${track.enabled}\n`;
                    deviceInfo += `   Muted: ${track.muted}\n`;
                });
                
                // Arrêter le flux de test
                stream.getTracks().forEach(track => track.stop());
                
                showModal('🔍 Test du Microphone', `
                    <div style="background: var(--cream-white); padding: 1rem; border-radius: var(--border-radius); margin-bottom: 1rem;">
                        <h4 style="color: var(--accent-brown); margin-bottom: 1rem;">Résultats du test</h4>
                        <pre style="background: #f5f5f5; padding: 1rem; border-radius: 4px; font-size: 0.9rem; white-space: pre-wrap;">${deviceInfo}</pre>
                    </div>
                    
                    <div style="background: #FFF3CD; padding: 1rem; border-radius: var(--border-radius); border: 2px solid #FFC107;">
                        <h4 style="color: #856404; margin-bottom: 0.5rem;">💡 Conseils pour les casques Bluetooth</h4>
                        <ul style="color: #856404; margin: 0; padding-left: 1.2rem;">
                            <li>Assurez-vous que votre casque est connecté et actif</li>
                            <li>Vérifiez que le microphone du casque n'est pas désactivé</li>
                            <li>Testez dans les paramètres Windows (Paramètres > Système > Son)</li>
                            <li>Redémarrez votre casque si nécessaire</li>
                        </ul>
                    </div>
                    
                    <div class="btn-group" style="justify-content: center; margin-top: 1rem;">
                        <button class="btn" onclick="closeModal()">Fermer</button>
                    </div>
                `);
                
                updateAudioStatus('listening', '✅ Test terminé - Vérifiez les résultats ci-dessus');
                
            } catch (error) {
                console.error('Erreur lors du test du microphone:', error);
                
                let errorMessage = '❌ Erreur lors du test du microphone';
                if (error.name === 'NotAllowedError') {
                    errorMessage = '❌ Accès refusé - Autorisez l\'accès au microphone';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = '❌ Aucun microphone détecté - Vérifiez votre casque Bluetooth';
                }
                
                updateAudioStatus('error', errorMessage);
                
                showModal('❌ Erreur de Test', `
                    <div style="background: #FFEBEE; padding: 1rem; border-radius: var(--border-radius); border: 2px solid #F44336;">
                        <h4 style="color: #C62828; margin-bottom: 1rem;">Erreur détectée</h4>
                        <p style="color: #C62828; margin-bottom: 1rem;"><strong>${error.name}:</strong> ${error.message}</p>
                        
                        <div style="background: #FFF3CD; padding: 1rem; border-radius: var(--border-radius); border: 2px solid #FFC107;">
                            <h5 style="color: #856404; margin-bottom: 0.5rem;">🔧 Solutions possibles :</h5>
                            <ul style="color: #856404; margin: 0; padding-left: 1.2rem;">
                                <li>Vérifiez que votre casque Bluetooth est connecté</li>
                                <li>Autorisez l'accès au microphone dans les paramètres du navigateur</li>
                                <li>Testez le microphone dans les paramètres Windows</li>
                                <li>Redémarrez votre casque et reconnectez-le</li>
                                <li>Essayez avec un autre navigateur (Chrome recommandé)</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="btn-group" style="justify-content: center; margin-top: 1rem;">
                        <button class="btn" onclick="closeModal()">Fermer</button>
                    </div>
                `);
            }
        }

        // Fonctions pour le calibrateur de four
        function openCalibrateurFourModal() {
            const content = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; height: 100%;">
                    <!-- Section gauche : Test de température -->
                    <div style="border-right: 2px solid var(--accent-brown); padding-right: 1rem;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1.5rem; text-align: center;">🌡️ Test de Température</h3>
                        
                        <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #ffc107;">
                            <h4 style="color: #856404; margin-bottom: 1rem;">📋 Guide de test sans thermomètre</h4>
                            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h5 style="color: var(--accent-brown); margin-bottom: 0.5rem;">1. Test du papier</h5>
                                <p style="margin-bottom: 0.5rem;">Placez une feuille de papier blanc au centre du four préchauffé à 180°C.</p>
                                <ul style="margin: 0; padding-left: 1.2rem;">
                                    <li><strong>2-3 minutes :</strong> Four trop chaud</li>
                                    <li><strong>4-5 minutes :</strong> Four correct</li>
                                    <li><strong>6+ minutes :</strong> Four trop froid</li>
                                </ul>
                            </div>
                            
                            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h5 style="color: var(--accent-brown); margin-bottom: 0.5rem;">2. Test du sucre</h5>
                                <p style="margin-bottom: 0.5rem;">Placez 1 cuillère à soupe de sucre blanc au centre du four à 180°C.</p>
                                <ul style="margin: 0; padding-left: 1.2rem;">
                                    <li><strong>2-3 minutes :</strong> Four trop chaud</li>
                                    <li><strong>4-6 minutes :</strong> Four correct</li>
                                    <li><strong>7+ minutes :</strong> Four trop froid</li>
                                </ul>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #d1ecf1, #bee5eb); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #17a2b8;">
                            <h4 style="color: #0c5460; margin-bottom: 1rem;">🎯 Placement optimal du pain</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                    <h6 style="color: #0c5460; margin-bottom: 0.5rem;">Four classique</h6>
                                    <p style="margin: 0; font-size: 0.9rem;">Placez au centre, sur la grille du milieu</p>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                    <h6 style="color: #0c5460; margin-bottom: 0.5rem;">Four à convection</h6>
                                    <p style="margin: 0; font-size: 0.9rem;">Placez sur la grille du bas</p>
                                </div>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #d4edda, #c3e6cb); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #28a745;">
                            <h4 style="color: #155724; margin-bottom: 1rem;">⚙️ Calibration manuelle</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Température affichée :</label>
                                    <input type="number" id="tempAffichage" class="form-input" placeholder="180" min="50" max="300">
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Température réelle :</label>
                                    <input type="number" id="tempReelle" class="form-input" placeholder="175" min="50" max="300">
                                </div>
                            </div>
                            <button class="btn" onclick="calculerCorrection()" style="width: 100%;">🔧 Calculer la correction</button>
                        </div>
                    </div>

                    <!-- Section droite : Profils et corrections -->
                    <div style="padding-left: 1rem;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1.5rem; text-align: center;">⚙️ Profils de Cuisson</h3>
                        
                        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #2196f3;">
                            <h4 style="color: #1976d2; margin-bottom: 1rem;">📊 Résultat de calibration</h4>
                            <div id="resultatCalibration" style="background: white; padding: 1rem; border-radius: 8px; min-height: 80px; display: flex; align-items: center; justify-content: center; border: 2px dashed #ccc;">
                                <p style="color: #666; margin: 0; text-align: center;">Effectuez un test de calibration pour voir les résultats</p>
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #f3e5f5, #e1bee7); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #9c27b0;">
                            <h4 style="color: #7b1fa2; margin-bottom: 1rem;">💾 Profils sauvegardés</h4>
                            <div id="profilsFour" style="max-height: 200px; overflow-y: auto;">
                                <!-- Les profils seront affichés ici -->
                            </div>
                            <button class="btn btn-secondary" onclick="sauvegarderProfil()" style="width: 100%; margin-top: 1rem;">💾 Sauvegarder ce profil</button>
                        </div>

                        <div style="background: linear-gradient(135deg, #fff8e1, #ffecb3); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #ff9800;">
                            <h4 style="color: #e65100; margin-bottom: 1rem;">🔄 Correction automatique des recettes</h4>
                            <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <h5 style="color: var(--accent-brown); margin-bottom: 0.5rem;">Recettes à corriger :</h5>
                                <div id="recettesACorriger" style="max-height: 150px; overflow-y: auto;">
                                    <!-- Les recettes seront listées ici -->
                                </div>
                            </div>
                            <button class="btn" onclick="appliquerCorrections()" style="width: 100%;">🔄 Appliquer les corrections</button>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('Calibrateur de Four 🔥', content, true);
            
            // Charger les profils existants après un délai pour que la modal soit créée
            setTimeout(() => {
                chargerProfilsFour();
                chargerRecettesACorriger();
            }, 100);
        }

        function calculerCorrection() {
            const tempAffichage = parseFloat(document.getElementById('tempAffichage').value);
            const tempReelle = parseFloat(document.getElementById('tempReelle').value);
            
            if (!tempAffichage || !tempReelle) {
                alert('Veuillez saisir les deux températures');
                return;
            }
            
            const difference = tempReelle - tempAffichage;
            const pourcentage = ((difference / tempAffichage) * 100).toFixed(1);
            
            let resultatHTML = '';
            let couleur = '';
            
            if (Math.abs(difference) <= 5) {
                resultatHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">✅</div>
                        <h5 style="color: #28a745; margin-bottom: 0.5rem;">Four bien calibré</h5>
                        <p style="margin-bottom: 0.5rem;">Différence : ${difference > 0 ? '+' : ''}${difference}°C</p>
                        <p style="margin-bottom: 0; font-size: 0.9rem; color: #666;">Aucune correction nécessaire</p>
                    </div>
                `;
                couleur = '#28a745';
            } else if (Math.abs(difference) <= 15) {
                resultatHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">⚠️</div>
                        <h5 style="color: #ffc107; margin-bottom: 0.5rem;">Correction recommandée</h5>
                        <p style="margin-bottom: 0.5rem;">Différence : ${difference > 0 ? '+' : ''}${difference}°C (${pourcentage}%)</p>
                        <p style="margin-bottom: 0; font-size: 0.9rem; color: #666;">Ajustez la température de ${difference > 0 ? '-' : '+'}${Math.abs(difference)}°C</p>
                    </div>
                `;
                couleur = '#ffc107';
            } else {
                resultatHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔧</div>
                        <h5 style="color: #dc3545; margin-bottom: 0.5rem;">Calibration nécessaire</h5>
                        <p style="margin-bottom: 0.5rem;">Différence : ${difference > 0 ? '+' : ''}${difference}°C (${pourcentage}%)</p>
                        <p style="margin-bottom: 0; font-size: 0.9rem; color: #666;">Ajustez la température de ${difference > 0 ? '-' : '+'}${Math.abs(difference)}°C</p>
                    </div>
                `;
                couleur = '#dc3545';
            }
            
            document.getElementById('resultatCalibration').innerHTML = resultatHTML;
            document.getElementById('resultatCalibration').style.borderColor = couleur;
            
            // Sauvegarder le résultat pour les corrections automatiques
            window.derniereCalibration = {
                tempAffichage,
                tempReelle,
                difference,
                pourcentage,
                date: new Date().toISOString()
            };
        }

        function sauvegarderProfil() {
            if (!window.derniereCalibration) {
                alert('Effectuez d\'abord un test de calibration');
                return;
            }
            
            const nomProfil = prompt('Nom du profil de four :');
            if (!nomProfil) return;
            
            // Charger les profils existants
            let profils = JSON.parse(localStorage.getItem('profilsFour') || '[]');
            
            // Ajouter le nouveau profil
            profils.push({
                id: Date.now(),
                nom: nomProfil,
                ...window.derniereCalibration,
                dateCreation: new Date().toISOString()
            });
            
            // Sauvegarder
            localStorage.setItem('profilsFour', JSON.stringify(profils));
            
            // Recharger l'affichage
            chargerProfilsFour();
            
            alert('Profil sauvegardé avec succès !');
        }

        function chargerProfilsFour() {
            const profils = JSON.parse(localStorage.getItem('profilsFour') || '[]');
            const container = document.getElementById('profilsFour');
            
            if (!container) return;
            
            if (profils.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">Aucun profil sauvegardé</p>';
                return;
            }
            
            container.innerHTML = profils.map(profil => `
                <div style="background: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; border-left: 4px solid var(--accent-brown);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--accent-brown);">${profil.nom}</strong>
                            <br>
                            <span style="font-size: 0.9rem; color: #666;">
                                ${profil.tempAffichage}°C → ${profil.tempReelle}°C (${profil.difference > 0 ? '+' : ''}${profil.difference}°C)
                            </span>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn-compact" onclick="utiliserProfil(${profil.id})">Utiliser</button>
                            <button class="btn-compact btn-danger" onclick="supprimerProfil(${profil.id})">Supprimer</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function utiliserProfil(profilId) {
            const profils = JSON.parse(localStorage.getItem('profilsFour') || '[]');
            const profil = profils.find(p => p.id === profilId);
            
            if (profil) {
                document.getElementById('tempAffichage').value = profil.tempAffichage;
                document.getElementById('tempReelle').value = profil.tempReelle;
                calculerCorrection();
            }
        }

        function supprimerProfil(profilId) {
            if (!confirm('Supprimer ce profil ?')) return;
            
            let profils = JSON.parse(localStorage.getItem('profilsFour') || '[]');
            profils = profils.filter(p => p.id !== profilId);
            localStorage.setItem('profilsFour', JSON.stringify(profils));
            
            chargerProfilsFour();
        }

        function chargerRecettesACorriger() {
            const recettes = [];
            
            // Parcourir toutes les familles de recettes
            Object.keys(currentData.recipes).forEach(famille => {
                currentData.recipes[famille].forEach(recette => {
                    if (recette.temperature || recette.tempsCuisson) {
                        recettes.push({
                            ...recette,
                            famille
                        });
                    }
                });
            });
            
            const container = document.getElementById('recettesACorriger');
            
            if (!container) return;
            
            if (recettes.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">Aucune recette avec température/temps</p>';
                return;
            }
            
            container.innerHTML = recettes.map(recette => `
                <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 3px solid var(--accent-brown);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: var(--accent-brown);">${recette.name}</strong>
                            <br>
                            <span style="font-size: 0.85rem; color: #666;">
                                ${recette.temperature ? `${recette.temperature}°C` : ''} 
                                ${recette.tempsCuisson ? `• ${recette.tempsCuisson}min` : ''}
                            </span>
                        </div>
                        <div style="font-size: 0.8rem; color: #666;">
                            ${recette.famille}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function appliquerCorrections() {
            if (!window.derniereCalibration) {
                alert('Effectuez d\'abord un test de calibration');
                return;
            }
            
            const { difference } = window.derniereCalibration;
            let correctionsAppliquees = 0;
            
            // Parcourir toutes les familles de recettes
            Object.keys(currentData.recipes).forEach(famille => {
                currentData.recipes[famille].forEach(recette => {
                    if (recette.temperature) {
                        const nouvelleTemp = Math.round(recette.temperature + difference);
                        recette.temperature = nouvelleTemp;
                        correctionsAppliquees++;
                    }
                });
            });
            
            // Sauvegarder les modifications
            saveDataToStorage();
            
            alert(`${correctionsAppliquees} recettes ont été corrigées avec succès !`);
            
            // Recharger l'affichage des recettes
            renderAllRecipes();
        }

        // =============================================================================
        // BIBLIOTHÈQUE DE TECHNIQUES - BASE DE DONNÉES COMPLÈTE
        // =============================================================================

        function openBibliothequeTechniques() {
            const content = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; height: 100%;">
                    <!-- Section gauche : Navigation et filtres -->
                    <div style="border-right: 2px solid var(--accent-brown); padding-right: 1rem;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1.5rem; text-align: center;">🔍 Recherche de Techniques</h3>
                        
                        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #2196f3;">
                            <h4 style="color: #1976d2; margin-bottom: 1rem;">📋 Filtres de recherche</h4>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Niveau de difficulté :</label>
                                <select id="difficulteFilter" class="form-select" onchange="filtrerTechniques()">
                                    <option value="">Tous les niveaux</option>
                                    <option value="debutant">Débutant</option>
                                    <option value="intermediaire">Intermédiaire</option>
                                    <option value="avance">Avancé</option>
                                    <option value="expert">Expert</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Temps disponible :</label>
                                <select id="tempsFilter" class="form-select" onchange="filtrerTechniques()">
                                    <option value="">Tous les temps</option>
                                    <option value="rapide">Rapide (< 30 min)</option>
                                    <option value="moyen">Moyen (30-60 min)</option>
                                    <option value="long">Long (> 60 min)</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Catégorie :</label>
                                <select id="categorieFilter" class="form-select" onchange="filtrerTechniques()">
                                    <option value="">Toutes les catégories</option>
                                    <option value="petrissage">Pétrissage</option>
                                    <option value="façonnage">Façonnage</option>
                                    <option value="fermentation">Fermentation</option>
                                    <option value="cuisson">Cuisson</option>
                                    <option value="decoration">Décoration</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Recherche :</label>
                                <input type="text" id="searchTechnique" class="form-input" placeholder="Rechercher une technique..." onkeyup="filtrerTechniques()">
                            </div>
                        </div>

                        <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #ffc107;">
                            <h4 style="color: #856404; margin-bottom: 1rem;">📊 Statistiques</h4>
                            <div id="statsTechniques" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; color: var(--accent-brown); font-weight: bold;">0</div>
                                    <div style="font-size: 0.9rem; color: #666;">Techniques</div>
                                </div>
                                <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 1.5rem; color: var(--accent-brown); font-weight: bold;">0</div>
                                    <div style="font-size: 0.9rem; color: #666;">Vidéos</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section droite : Affichage des techniques -->
                    <div style="padding-left: 1rem;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1.5rem; text-align: center;">📚 Techniques Disponibles</h3>
                        
                        <div id="techniquesContainer" style="max-height: 600px; overflow-y: auto;">
                            <!-- Les techniques seront affichées ici -->
                        </div>
                    </div>
                </div>
            `;
            
            showModal('📚 Bibliothèque de Techniques', content, true);
            
            // Charger les techniques après un délai
            setTimeout(() => {
                chargerTechniques();
            }, 100);
        }

        function chargerTechniques() {
            const techniques = getTechniquesData();
            const container = document.getElementById('techniquesContainer');
            
            if (!container) return;
            
            if (techniques.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">Aucune technique disponible</p>';
                return;
            }
            
            container.innerHTML = techniques.map(technique => `
                <div class="technique-card" data-difficulte="${technique.difficulte}" data-temps="${technique.temps}" data-categorie="${technique.categorie}" style="
                    background: white; 
                    padding: 1.5rem; 
                    border-radius: 8px; 
                    margin-bottom: 1rem; 
                    border-left: 4px solid ${getCouleurDifficulte(technique.difficulte)};
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onclick="afficherDetailTechnique('${technique.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="color: var(--accent-brown); margin-bottom: 0.5rem; font-size: 1.2rem;">${technique.nom}</h4>
                            <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">${technique.description}</p>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <span style="background: ${getCouleurDifficulte(technique.difficulte)}; color: white; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">${technique.difficulte}</span>
                                <span style="background: #e3f2fd; color: #1976d2; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">${technique.temps}</span>
                                <span style="background: #f3e5f5; color: #7b1fa2; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">${technique.categorie}</span>
                            </div>
                        </div>
                        <div style="font-size: 2rem; margin-left: 1rem;">${technique.icone}</div>
                    </div>
                </div>
            `).join('');
            
            // Mettre à jour les statistiques
            mettreAJourStatsTechniques();
        }

        function getTechniquesData() {
            // Données des techniques de boulangerie
            return [
                {
                    id: 'petrissage-francais',
                    nom: 'Pétrissage Français',
                    description: 'Technique traditionnelle de pétrissage à la main avec rabats successifs.',
                    difficulte: 'intermediaire',
                    temps: 'moyen',
                    categorie: 'petrissage',
                    icone: '👐',
                    materiel: ['Plan de travail', 'Farine', 'Eau'],
                    etapes: [
                        'Mélanger farine et eau',
                        'Pétrir 5-10 minutes',
                        'Rabats toutes les 30 minutes',
                        'Pointage 2-4 heures'
                    ],
                    video: 'https://www.youtube.com/watch?v=lq_pxzzCF4g',
                    conseils: 'Maintenir une température constante de 23-25°C'
                },
                {
                    id: 'façonnage-baguette',
                    nom: 'Façonnage Baguette',
                    description: 'Technique de façonnage pour obtenir une baguette traditionnelle.',
                    difficulte: 'avance',
                    temps: 'rapide',
                    categorie: 'façonnage',
                    icone: '🥖',
                    materiel: ['Couteau', 'Plan de travail', 'Farine'],
                    etapes: [
                        'Diviser la pâte',
                        'Préformer en boudin',
                        'Repos 15 minutes',
                        'Façonnage final',
                        'Grignage'
                    ],
                    video: 'https://www.youtube.com/watch?v=60K3Fe5j_J8',
                    conseils: 'Travailler avec des mains légèrement farinées'
                },
                {
                    id: 'grignage-artistique',
                    nom: 'Grignage Artistique',
                    description: 'Techniques de grignage pour décorer le pain.',
                    difficulte: 'expert',
                    temps: 'rapide',
                    categorie: 'decoration',
                    icone: '✂️',
                    materiel: ['Lame de rasoir', 'Couteau', 'Pinceau'],
                    etapes: [
                        'Préparer la lame',
                        'Choisir le motif',
                        'Grigner délicatement',
                        'Vaporiser d\'eau'
                    ],
                    video: 'https://www.youtube.com/watch?v=PP1b4XWXOk0',
                    conseils: 'Utiliser une lame très fine et bien aiguisée'
                },
                {
                    id: 'fermentation-levain',
                    nom: 'Fermentation au Levain',
                    description: 'Gestion de la fermentation avec levain naturel.',
                    difficulte: 'avance',
                    temps: 'long',
                    categorie: 'fermentation',
                    icone: '🫓',
                    materiel: ['Levain', 'Thermomètre', 'Banneton'],
                    etapes: [
                        'Nourrir le levain',
                        'Pointage 4-6 heures',
                        'Façonnage',
                        'Apprêt 2-4 heures'
                    ],
                    video: 'https://www.youtube.com/watch?v=vD_aufrBTjU',
                    conseils: 'Surveiller la température et l\'activité du levain'
                },
                {
                    id: 'cuisson-cocotte',
                    nom: 'Cuisson en Cocotte',
                    description: 'Technique de cuisson en cocotte pour un pain parfait.',
                    difficulte: 'debutant',
                    temps: 'moyen',
                    categorie: 'cuisson',
                    icone: '🍳',
                    materiel: ['Cocotte en fonte', 'Four', 'Papier sulfurisé'],
                    etapes: [
                        'Préchauffer four 30 min',
                        'Placer cocotte',
                        'Enfourner 20 min couvert',
                        'Découvrir 20 min'
                    ],
                    video: 'https://www.youtube.com/watch?v=lq_pxzzCF4g',
                    conseils: 'Ne pas ouvrir le four pendant la cuisson'
                }
            ];
        }

        function getCouleurDifficulte(difficulte) {
            const couleurs = {
                'debutant': '#4CAF50',
                'intermediaire': '#FF9800',
                'avance': '#F44336',
                'expert': '#9C27B0'
            };
            return couleurs[difficulte] || '#666';
        }

        function filtrerTechniques() {
            const difficulte = document.getElementById('difficulteFilter').value;
            const temps = document.getElementById('tempsFilter').value;
            const categorie = document.getElementById('categorieFilter').value;
            const search = document.getElementById('searchTechnique').value.toLowerCase();
            
            const techniques = document.querySelectorAll('.technique-card');
            
            techniques.forEach(technique => {
                const matchDifficulte = !difficulte || technique.dataset.difficulte === difficulte;
                const matchTemps = !temps || technique.dataset.temps === temps;
                const matchCategorie = !categorie || technique.dataset.categorie === categorie;
                const matchSearch = !search || technique.textContent.toLowerCase().includes(search);
                
                if (matchDifficulte && matchTemps && matchCategorie && matchSearch) {
                    technique.style.display = 'block';
                } else {
                    technique.style.display = 'none';
                }
            });
            
            mettreAJourStatsTechniques();
        }

        function mettreAJourStatsTechniques() {
            const techniquesVisibles = document.querySelectorAll('.technique-card[style*="display: block"], .technique-card:not([style*="display: none"])');
            const statsContainer = document.getElementById('statsTechniques');
            
            if (statsContainer) {
                statsContainer.innerHTML = `
                    <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: var(--accent-brown); font-weight: bold;">${techniquesVisibles.length}</div>
                        <div style="font-size: 0.9rem; color: #666;">Techniques</div>
                    </div>
                    <div style="background: white; padding: 1rem; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; color: var(--accent-brown); font-weight: bold;">5</div>
                        <div style="font-size: 0.9rem; color: #666;">Vidéos</div>
                    </div>
                `;
            }
        }

        function afficherDetailTechnique(techniqueId) {
            const techniques = getTechniquesData();
            const technique = techniques.find(t => t.id === techniqueId);
            
            if (!technique) return;
            
            const content = `
                <div style="background: white; padding: 2rem; border-radius: var(--border-radius);">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">${technique.icone}</div>
                        <h2 style="color: var(--accent-brown); margin-bottom: 0.5rem;">${technique.nom}</h2>
                        <p style="color: #666; font-size: 1.1rem;">${technique.description}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">📋 Étapes</h3>
                            <ol style="padding-left: 1.5rem;">
                                ${technique.etapes.map((etape, index) => `<li style="margin-bottom: 0.5rem; color: #333;">${etape}</li>`).join('')}
                            </ol>
                        </div>
                        
                        <div>
                            <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">🛠️ Matériel nécessaire</h3>
                            <ul style="padding-left: 1.5rem;">
                                ${technique.materiel.map(materiel => `<li style="margin-bottom: 0.5rem; color: #333;">${materiel}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 1.5rem; border-radius: var(--border-radius); margin-top: 2rem; border: 2px solid #ffc107;">
                        <h3 style="color: #856404; margin-bottom: 1rem;">💡 Conseils</h3>
                        <p style="color: #856404; font-style: italic;">${technique.conseils}</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <a href="${technique.video}" target="_blank" class="btn" style="background: #ff0000; color: white; border-color: #ff0000;">
                            🎥 Voir la vidéo
                        </a>
                    </div>
                </div>
            `;
            
            showModal(`${technique.icone} ${technique.nom}`, content);
        }

        // =============================================================================
        // PARTAGE DE RECETTES ET COMMUNAUTÉ
        // =============================================================================

        function openPartageRecettes() {
            const content = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; height: 100%;">
                    <!-- Section gauche : Publier et rechercher -->
                    <div style="border-right: 2px solid var(--accent-brown); padding-right: 1rem;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1.5rem; text-align: center;">📤 Publier une Recette</h3>
                        
                        <div style="background: linear-gradient(135deg, #e8f5e8, #c8e6c9); padding: 1.5rem; border-radius: var(--border-radius); margin-bottom: 1.5rem; border: 2px solid #4caf50;">
                            <h4 style="color: #2e7d32; margin-bottom: 1rem;">✨ Nouvelle Publication</h4>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Titre de la recette :</label>
                                <input type="text" id="titreRecette" class="form-input" placeholder="Ex: Pain au levain traditionnel">
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Description :</label>
                                <textarea id="descriptionRecette" class="form-textarea" placeholder="Décrivez votre recette, ses particularités..." rows="3"></textarea>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Catégorie :</label>
                                <select id="categorieRecette" class="form-select">
                                    <option value="pain">Pain</option>
                                    <option value="viennoiserie">Viennoiserie</option>
                                    <option value="patisserie">Pâtisserie</option>
                                    <option value="technique">Technique</option>
                                </select>
                            </div>
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; color: var(--accent-brown); font-weight: bold;">Niveau de difficulté :</label>
                                <select id="difficulteRecette" class="form-select">
                                    <option value="debutant">Débutant</option>
                                    <option value="intermediaire">Intermédiaire</option>
                                    <option value="avance">Avancé</option>
                                    <option value="expert">Expert</option>
                                </select>
                            </div>
                            
                            <button class="btn" onclick="publierRecette()" style="width: 100%; background: #4caf50; border-color: #4caf50;">
                                📤 Publier ma recette
                            </button>
                        </div>

                        <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 1.5rem; border-radius: var(--border-radius); border: 2px solid #2196f3;">
                            <h4 style="color: #1976d2; margin-bottom: 1rem;">🔍 Rechercher</h4>
                            
                            <div style="margin-bottom: 1rem;">
                                <input type="text" id="searchRecette" class="form-input" placeholder="Rechercher une recette..." onkeyup="filtrerRecettesPartagees()">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <select id="filterCategorie" class="form-select" onchange="filtrerRecettesPartagees()">
                                    <option value="">Toutes catégories</option>
                                    <option value="pain">Pain</option>
                                    <option value="viennoiserie">Viennoiserie</option>
                                    <option value="patisserie">Pâtisserie</option>
                                    <option value="technique">Technique</option>
                                </select>
                                
                                <select id="filterDifficulte" class="form-select" onchange="filtrerRecettesPartagees()">
                                    <option value="">Tous niveaux</option>
                                    <option value="debutant">Débutant</option>
                                    <option value="intermediaire">Intermédiaire</option>
                                    <option value="avance">Avancé</option>
                                    <option value="expert">Expert</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Section droite : Recettes partagées -->
                    <div style="padding-left: 1rem;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1.5rem; text-align: center;">🌐 Recettes de la Communauté</h3>
                        
                        <div id="recettesPartageesContainer" style="max-height: 600px; overflow-y: auto;">
                            <!-- Les recettes partagées seront affichées ici -->
                        </div>
                    </div>
                </div>
            `;
            
            showModal('🌐 Partage de Recettes', content, true);
            
            // Charger les recettes partagées après un délai
            setTimeout(() => {
                chargerRecettesPartagees();
            }, 100);
        }

        function chargerRecettesPartagees() {
            const recettes = getRecettesPartageesData();
            const container = document.getElementById('recettesPartageesContainer');
            
            if (!container) return;
            
            if (recettes.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; font-style: italic;">Aucune recette partagée pour le moment</p>';
                return;
            }
            
            container.innerHTML = recettes.map(recette => `
                <div class="recette-partagee-card" data-categorie="${recette.categorie}" data-difficulte="${recette.difficulte}" style="
                    background: white; 
                    padding: 1.5rem; 
                    border-radius: 8px; 
                    margin-bottom: 1rem; 
                    border-left: 4px solid ${getCouleurDifficulte(recette.difficulte)};
                    cursor: pointer;
                    transition: all 0.3s ease;
                " onclick="afficherDetailRecettePartagee('${recette.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h4 style="color: var(--accent-brown); margin-bottom: 0.5rem; font-size: 1.2rem;">${recette.titre}</h4>
                            <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">${recette.description}</p>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <span style="background: ${getCouleurDifficulte(recette.difficulte)}; color: white; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">${recette.difficulte}</span>
                                    <span style="background: #e3f2fd; color: #1976d2; padding: 0.3rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">${recette.categorie}</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <div style="display: flex; align-items: center;">
                                        ${'⭐'.repeat(recette.note)}
                                        <span style="margin-left: 0.3rem; font-size: 0.8rem; color: #666;">(${recette.note}/5)</span>
                                    </div>
                                    <span style="font-size: 0.8rem; color: #666;">par ${recette.auteur}</span>
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 2rem; margin-left: 1rem;">${recette.icone}</div>
                    </div>
                </div>
            `).join('');
        }

        function getRecettesPartageesData() {
            // Données des recettes partagées (simulation)
            return [
                {
                    id: 'pain-levain-traditionnel',
                    titre: 'Pain au Levain Traditionnel',
                    description: 'Recette traditionnelle de pain au levain avec une croûte dorée et une mie aérée.',
                    categorie: 'pain',
                    difficulte: 'avance',
                    icone: '🥖',
                    auteur: 'Marie Boulanger',
                    note: 5,
                    date: '2024-01-15',
                    ingredients: ['Farine T65', 'Levain', 'Eau', 'Sel'],
                    etapes: [
                        'Préparer le levain 12h avant',
                        'Mélanger les ingrédients',
                        'Pétrir 15 minutes',
                        'Pointage 4 heures',
                        'Façonnage et apprêt 2h',
                        'Cuisson 45 min à 250°C'
                    ],
                    conseils: 'Maintenir une température constante et ne pas précipiter les étapes de fermentation.',
                    commentaires: [
                        { auteur: 'Jean Pain', note: 5, commentaire: 'Excellent pain, très bien expliqué !', date: '2024-01-16' },
                        { auteur: 'Sophie Farine', note: 4, commentaire: 'Très bonne recette, je recommande.', date: '2024-01-17' }
                    ]
                },
                {
                    id: 'croissants-maison',
                    titre: 'Croissants Maison',
                    description: 'Croissants feuilletés faits maison avec beurre AOP.',
                    categorie: 'viennoiserie',
                    difficulte: 'expert',
                    icone: '🥐',
                    auteur: 'Pierre Viennoiserie',
                    note: 4,
                    date: '2024-01-10',
                    ingredients: ['Farine T45', 'Beurre AOP', 'Levure', 'Lait', 'Œufs'],
                    etapes: [
                        'Préparer la détrempe',
                        'Incorporer le beurre',
                        'Tourner 3 fois',
                        'Repos au frais',
                        'Façonnage en croissant',
                        'Cuisson 20 min à 200°C'
                    ],
                    conseils: 'Travailler avec des ingrédients très froids et ne pas précipiter les tours.',
                    commentaires: [
                        { auteur: 'Luc Croissant', note: 5, commentaire: 'Parfait ! Mes croissants sont magnifiques.', date: '2024-01-11' }
                    ]
                },
                {
                    id: 'technique-petrissage',
                    titre: 'Pétrissage à la Main',
                    description: 'Guide complet du pétrissage manuel pour débutants.',
                    categorie: 'technique',
                    difficulte: 'debutant',
                    icone: '👐',
                    auteur: 'École Boulangerie',
                    note: 5,
                    date: '2024-01-05',
                    ingredients: ['Farine', 'Eau', 'Sel', 'Levure'],
                    etapes: [
                        'Mélanger les ingrédients',
                        'Pétrir 10-15 minutes',
                        'Rabats toutes les 30 min',
                        'Pointage 2-4 heures'
                    ],
                    conseils: 'Prendre son temps et sentir la pâte évoluer sous les mains.',
                    commentaires: [
                        { auteur: 'Débutant Boulanger', note: 5, commentaire: 'Très clair pour débuter !', date: '2024-01-06' },
                        { auteur: 'Apprenti Pain', note: 4, commentaire: 'Bien expliqué, merci !', date: '2024-01-07' }
                    ]
                }
            ];
        }

        function filtrerRecettesPartagees() {
            const search = document.getElementById('searchRecette').value.toLowerCase();
            const categorie = document.getElementById('filterCategorie').value;
            const difficulte = document.getElementById('filterDifficulte').value;
            
            const recettes = document.querySelectorAll('.recette-partagee-card');
            
            recettes.forEach(recette => {
                const matchSearch = !search || recette.textContent.toLowerCase().includes(search);
                const matchCategorie = !categorie || recette.dataset.categorie === categorie;
                const matchDifficulte = !difficulte || recette.dataset.difficulte === difficulte;
                
                if (matchSearch && matchCategorie && matchDifficulte) {
                    recette.style.display = 'block';
                } else {
                    recette.style.display = 'none';
                }
            });
        }

        function publierRecette() {
            const titre = document.getElementById('titreRecette').value;
            const description = document.getElementById('descriptionRecette').value;
            const categorie = document.getElementById('categorieRecette').value;
            const difficulte = document.getElementById('difficulteRecette').value;
            
            if (!titre || !description) {
                alert('Veuillez remplir le titre et la description');
                return;
            }
            
            // Simuler la publication
            alert(`Recette "${titre}" publiée avec succès ! Elle sera visible par la communauté.`);
            
            // Réinitialiser le formulaire
            document.getElementById('titreRecette').value = '';
            document.getElementById('descriptionRecette').value = '';
            document.getElementById('categorieRecette').value = 'pain';
            document.getElementById('difficulteRecette').value = 'debutant';
        }

        function afficherDetailRecettePartagee(recetteId) {
            const recettes = getRecettesPartageesData();
            const recette = recettes.find(r => r.id === recetteId);
            
            if (!recette) return;
            
            const content = `
                <div style="background: white; padding: 2rem; border-radius: var(--border-radius);">
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">${recette.icone}</div>
                        <h2 style="color: var(--accent-brown); margin-bottom: 0.5rem;">${recette.titre}</h2>
                        <p style="color: #666; font-size: 1.1rem;">${recette.description}</p>
                        <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1rem;">
                            <span style="background: ${getCouleurDifficulte(recette.difficulte)}; color: white; padding: 0.5rem 1rem; border-radius: 20px;">${recette.difficulte}</span>
                            <span style="background: #e3f2fd; color: #1976d2; padding: 0.5rem 1rem; border-radius: 20px;">${recette.categorie}</span>
                            <div style="display: flex; align-items: center;">
                                ${'⭐'.repeat(recette.note)}
                                <span style="margin-left: 0.5rem;">(${recette.note}/5)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                        <div>
                            <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">📋 Ingrédients</h3>
                            <ul style="padding-left: 1.5rem;">
                                ${recette.ingredients.map(ingredient => `<li style="margin-bottom: 0.5rem; color: #333;">${ingredient}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div>
                            <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">👨‍🍳 Étapes</h3>
                            <ol style="padding-left: 1.5rem;">
                                ${recette.etapes.map((etape, index) => `<li style="margin-bottom: 0.5rem; color: #333;">${etape}</li>`).join('')}
                            </ol>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); padding: 1.5rem; border-radius: var(--border-radius); margin-top: 2rem; border: 2px solid #ffc107;">
                        <h3 style="color: #856404; margin-bottom: 1rem;">💡 Conseils de ${recette.auteur}</h3>
                        <p style="color: #856404; font-style: italic;">${recette.conseils}</p>
                    </div>
                    
                    <div style="margin-top: 2rem;">
                        <h3 style="color: var(--accent-brown); margin-bottom: 1rem;">💬 Commentaires (${recette.commentaires.length})</h3>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${recette.commentaires.map(commentaire => `
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid var(--accent-brown);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <strong style="color: var(--accent-brown);">${commentaire.auteur}</strong>
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            ${'⭐'.repeat(commentaire.note)}
                                            <span style="font-size: 0.8rem; color: #666;">${commentaire.date}</span>
                                        </div>
                                    </div>
                                    <p style="color: #333; margin: 0;">${commentaire.commentaire}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="btn" onclick="noterRecette('${recette.id}')" style="background: #ffc107; color: #856404; border-color: #ffc107; margin-right: 1rem;">
                            ⭐ Noter cette recette
                        </button>
                        <button class="btn btn-secondary" onclick="ajouterCommentaire('${recette.id}')">
                            💬 Ajouter un commentaire
                        </button>
                    </div>
                </div>
            `;
            
            showModal(`${recette.icone} ${recette.titre}`, content);
        }

        function noterRecette(recetteId) {
            const note = prompt('Donnez une note de 1 à 5 :');
            if (note && !isNaN(note) && note >= 1 && note <= 5) {
                alert(`Merci ! Vous avez donné ${note}/5 à cette recette.`);
            } else {
                alert('Note invalide. Veuillez entrer un nombre entre 1 et 5.');
            }
        }

        function ajouterCommentaire(recetteId) {
            const commentaire = prompt('Votre commentaire :');
            if (commentaire && commentaire.trim()) {
                alert('Commentaire ajouté avec succès !');
            } else {
                alert('Commentaire vide. Veuillez saisir un commentaire.');
            }
        }

    </script>
</body>
</html>